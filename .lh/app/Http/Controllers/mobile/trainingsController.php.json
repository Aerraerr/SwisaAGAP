{
    "sourceFile": "app/Http/Controllers/mobile/trainingsController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763798852002,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763816076888,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,207 @@\n+<?php\r\n+\r\n+namespace App\\Http\\Controllers\\mobile;\r\n+\r\n+use App\\Http\\Controllers\\Controller;\r\n+use App\\Models\\Training;\r\n+use Illuminate\\Http\\Request;\r\n+use Illuminate\\Support\\Facades\\DB;\r\n+use Carbon\\Carbon;\r\n+class TrainingsController extends Controller\r\n+{\r\n+    \r\n+public function index(Request $request)\r\n+{\r\n+    $userId = $request->user()->id; // token from sanctum\r\n+\r\n+    // Today in app timezone\r\n+    $today = Carbon::today(config('app.timezone'));\r\n+\r\n+    // Get trainings that Have date today or in the future and user is NOT attending yet\r\n+    $trainings = Training::whereDate('date', '>=', $today)\r\n+        ->whereDoesntHave('participants', function ($query) use ($userId) {\r\n+            $query->where('user_id', $userId);\r\n+        })\r\n+        ->withCount('participants')\r\n+        ->with('sector', 'documents')\r\n+        ->paginate(10);\r\n+\r\n+    // Transform each training for additional info\r\n+    $trainings->getCollection()->transform(function ($training) use ($today) {\r\n+        $eventDate = Carbon::parse($training->date)\r\n+        ->timezone(config('app.timezone'))\r\n+        ->startOfDay();\r\n+\r\n+        //  Set image URL if there’s at least one related document\r\n+        $training->image_url = $training->documents->first()\r\n+            ? asset('storage/' . str_replace(' ', '%20', $training->documents->first()->file_path))\r\n+\r\n+            : null;\r\n+\r\n+        // Set status\r\n+        $training->status = $eventDate->isSameDay($today) ? 'Today' : 'Upcoming';\r\n+\r\n+        return $training;\r\n+    });\r\n+\r\n+    return response()->json([\r\n+        'success' => true,\r\n+        'data' => $trainings,\r\n+    ]);\r\n+}\r\n+\r\n+\r\n+\r\n+    // To attend a training\r\n+public function attend(Request $request, $trainingId)\r\n+{\r\n+    \r\n+    //  Get the authenticated user\r\n+    $userId = $request->user()->id;\r\n+\r\n+    //  Check if user already attending\r\n+    $exists = DB::table('participants')\r\n+        ->where('training_id', $trainingId)\r\n+        ->where('user_id', $userId)\r\n+        ->exists();\r\n+\r\n+    if ($exists) {\r\n+        return response()->json(['message' => 'Already attending this training'], 400);\r\n+    }\r\n+\r\n+    //  Fetch the training before attaching\r\n+    $training = Training::findOrFail($trainingId);\r\n+\r\n+    //  Attach using Eloquent relationship (cleaner than raw DB insert)\r\n+    $training->participants()->attach($userId);\r\n+\r\n+    //  Create notification entry\r\n+    DB::table('notifications')->insert([\r\n+        'user_id' => $userId,\r\n+        'message' => \"You are now attending '{$training->title}' on {$training->date} at {$training->venue}.\",\r\n+        'is_read' => false,\r\n+        'sent_at' => now(),\r\n+        'created_at' => now(),\r\n+        'updated_at' => now(),\r\n+    ]);\r\n+\r\n+    return response()->json([\r\n+    'success' => true,\r\n+    'message' => 'You are now attending this training',\r\n+    'data' => $training\r\n+    ]);\r\n+\r\n+}\r\n+\r\n+\r\n+\r\n+// Get all trainings the user attends\r\n+public function myEvents(Request $request)\r\n+{\r\n+    $userId = $request->user()->id;\r\n+    $filter = $request->query('filter'); // Ongoing, Did not attend, Attended, All\r\n+\r\n+    $trainings = Training::whereHas('participants', function ($q) use ($userId) {\r\n+    $q->where('user_id', $userId);\r\n+})\r\n+->withCount('participants')\r\n+->with('sector', 'documents')\r\n+->get()\r\n+->map(function ($training) use ($userId) {\r\n+    $participant = $training->participants()->where('user_id', $userId)->first();\r\n+    $attended = $participant ? (bool)$participant->pivot->qr_scanned : false;\r\n+    $eventDate = Carbon::parse($training->date)->startOfDay();\r\n+    $today = Carbon::today();\r\n+\r\n+    // Set status\r\n+    if ($attended) {\r\n+    $training->status = 'Attended';\r\n+    } else if ($eventDate->isBefore($today)) {\r\n+    $training->status = 'Did not attend';\r\n+    } else {\r\n+    $training->status = 'Ongoing';\r\n+    }\r\n+\r\n+    $training->attended = $attended;\r\n+    $training->qr_scanned = $attended;\r\n+\r\n+    // Set is_attending\r\n+    $training->is_attending = $training->participants()\r\n+        ->where('user_id', $userId)\r\n+        ->exists();\r\n+\r\n+           // image_url if document exists\r\n+       $training->image_url = $training->documents->first()\r\n+    ? asset('storage/' . str_replace(' ', '%20', $training->documents->first()->file_path))\r\n+    : null;\r\n+\r\n+\r\n+    return $training;\r\n+});\r\n+\r\n+    // Apply filter\r\n+    if ($filter && $filter !== 'All') {\r\n+        $trainings = $trainings->filter(function ($training) use ($filter) {\r\n+            return $training->status === $filter;\r\n+        })->values();\r\n+    }\r\n+\r\n+    return response()->json($trainings);\r\n+}\r\n+\r\n+\r\n+public function show(Request $request, $trainingId)\r\n+{\r\n+    $userId = $request->user()->id;\r\n+\r\n+    $training = Training::withCount('participants')\r\n+        ->with('sector', 'documents')\r\n+        ->findOrFail($trainingId);\r\n+\r\n+    // Add is_attending flag if user_id is given\r\n+    $training->is_attending = false;\r\n+    if ($userId) {\r\n+        $training->is_attending = $training->participants()\r\n+            ->where('user_id', $userId)\r\n+            ->exists();\r\n+    }\r\n+\r\n+        // Add image_url if document exists\r\n+    $training->image_url = $training->documents->first()\r\n+        ? asset('storage/' . str_replace(' ', '%20', $training->documents->first()->file_path))\r\n+        : null;\r\n+\r\n+    return response()->json($training);\r\n+}\r\n+\r\n+public function cancelAttendance(Request $request, $trainingId)\r\n+{\r\n+    $userId = $request->user()->id;\r\n+    $training = Training::find($trainingId);\r\n+\r\n+    if (!$training) {\r\n+        return response()->json(['message' => 'Training not found'], 404);\r\n+    }\r\n+\r\n+    if (!$training->participants()->where('user_id', $userId)->exists()) {\r\n+        return response()->json(['message' => 'Not attending this event'], 404);\r\n+    }\r\n+\r\n+    $training->participants()->detach($userId);\r\n+\r\n+    \r\n+    DB::table('notifications')->insert([\r\n+    'user_id' => $userId,\r\n+    'message' => \"You have cancelled your attendance for '{$training->title}'.\",\r\n+    'is_read' => false,\r\n+    'sent_at' => now(),\r\n+    'created_at' => now(),\r\n+    'updated_at' => now(),\r\n+    ]);\r\n+\r\n+    return response()->json(['message' => 'Attendance cancelled successfully', 'training' => $training]);\r\n+\r\n+}\r\n+    \r\n+}\r\n+\r\n"
                },
                {
                    "date": 1763816619414,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -204,211 +204,4 @@\n }\r\n     \r\n }\r\n \r\n-<?php\r\n-\r\n-namespace App\\Http\\Controllers\\mobile;\r\n-\r\n-use App\\Http\\Controllers\\Controller;\r\n-use App\\Models\\Training;\r\n-use Illuminate\\Http\\Request;\r\n-use Illuminate\\Support\\Facades\\DB;\r\n-use Carbon\\Carbon;\r\n-class TrainingsController extends Controller\r\n-{\r\n-    \r\n-public function index(Request $request)\r\n-{\r\n-    $userId = $request->user()->id; // token from sanctum\r\n-\r\n-    // Today in app timezone\r\n-    $today = Carbon::today(config('app.timezone'));\r\n-\r\n-    // Get trainings that Have date today or in the future and user is NOT attending yet\r\n-    $trainings = Training::whereDate('date', '>=', $today)\r\n-        ->whereDoesntHave('participants', function ($query) use ($userId) {\r\n-            $query->where('user_id', $userId);\r\n-        })\r\n-        ->withCount('participants')\r\n-        ->with('sector', 'documents')\r\n-        ->paginate(10);\r\n-\r\n-    // Transform each training for additional info\r\n-    $trainings->getCollection()->transform(function ($training) use ($today) {\r\n-        $eventDate = Carbon::parse($training->date)\r\n-        ->timezone(config('app.timezone'))\r\n-        ->startOfDay();\r\n-\r\n-        //  Set image URL if there’s at least one related document\r\n-        $training->image_url = $training->documents->first()\r\n-            ? asset('storage/' . str_replace(' ', '%20', $training->documents->first()->file_path))\r\n-\r\n-            : null;\r\n-\r\n-        // Set status\r\n-        $training->status = $eventDate->isSameDay($today) ? 'Today' : 'Upcoming';\r\n-\r\n-        return $training;\r\n-    });\r\n-\r\n-    return response()->json([\r\n-        'success' => true,\r\n-        'data' => $trainings,\r\n-    ]);\r\n-}\r\n-\r\n-\r\n-\r\n-    // To attend a training\r\n-public function attend(Request $request, $trainingId)\r\n-{\r\n-    \r\n-    //  Get the authenticated user\r\n-    $userId = $request->user()->id;\r\n-\r\n-    //  Check if user already attending\r\n-    $exists = DB::table('participants')\r\n-        ->where('training_id', $trainingId)\r\n-        ->where('user_id', $userId)\r\n-        ->exists();\r\n-\r\n-    if ($exists) {\r\n-        return response()->json(['message' => 'Already attending this training'], 400);\r\n-    }\r\n-\r\n-    //  Fetch the training before attaching\r\n-    $training = Training::findOrFail($trainingId);\r\n-\r\n-    //  Attach using Eloquent relationship (cleaner than raw DB insert)\r\n-    $training->participants()->attach($userId);\r\n-\r\n-    //  Create notification entry\r\n-    DB::table('notifications')->insert([\r\n-        'user_id' => $userId,\r\n-        'message' => \"You are now attending '{$training->title}' on {$training->date} at {$training->venue}.\",\r\n-        'is_read' => false,\r\n-        'sent_at' => now(),\r\n-        'created_at' => now(),\r\n-        'updated_at' => now(),\r\n-    ]);\r\n-\r\n-    return response()->json([\r\n-    'success' => true,\r\n-    'message' => 'You are now attending this training',\r\n-    'data' => $training\r\n-    ]);\r\n-\r\n-}\r\n-\r\n-\r\n-\r\n-// Get all trainings the user attends\r\n-public function myEvents(Request $request)\r\n-{\r\n-    $userId = $request->user()->id;\r\n-    $filter = $request->query('filter'); // Ongoing, Did not attend, Attended, All\r\n-\r\n-    $trainings = Training::whereHas('participants', function ($q) use ($userId) {\r\n-    $q->where('user_id', $userId);\r\n-})\r\n-->withCount('participants')\r\n-->with('sector', 'documents')\r\n-->get()\r\n-->map(function ($training) use ($userId) {\r\n-    $participant = $training->participants()->where('user_id', $userId)->first();\r\n-    $attended = $participant ? (bool)$participant->pivot->qr_scanned : false;\r\n-    $eventDate = Carbon::parse($training->date)->startOfDay();\r\n-    $today = Carbon::today();\r\n-\r\n-    // Set status\r\n-    if ($attended) {\r\n-    $training->status = 'Attended';\r\n-    } else if ($eventDate->isBefore($today)) {\r\n-    $training->status = 'Did not attend';\r\n-    } else {\r\n-    $training->status = 'Ongoing';\r\n-    }\r\n-\r\n-    $training->attended = $attended;\r\n-    $training->qr_scanned = $attended;\r\n-\r\n-    // Set is_attending\r\n-    $training->is_attending = $training->participants()\r\n-        ->where('user_id', $userId)\r\n-        ->exists();\r\n-\r\n-           // image_url if document exists\r\n-       $training->image_url = $training->documents->first()\r\n-    ? asset('storage/' . str_replace(' ', '%20', $training->documents->first()->file_path))\r\n-    : null;\r\n-\r\n-\r\n-    return $training;\r\n-});\r\n-\r\n-    // Apply filter\r\n-    if ($filter && $filter !== 'All') {\r\n-        $trainings = $trainings->filter(function ($training) use ($filter) {\r\n-            return $training->status === $filter;\r\n-        })->values();\r\n-    }\r\n-\r\n-    return response()->json($trainings);\r\n-}\r\n-\r\n-\r\n-public function show(Request $request, $trainingId)\r\n-{\r\n-    $userId = $request->user()->id;\r\n-\r\n-    $training = Training::withCount('participants')\r\n-        ->with('sector', 'documents')\r\n-        ->findOrFail($trainingId);\r\n-\r\n-    // Add is_attending flag if user_id is given\r\n-    $training->is_attending = false;\r\n-    if ($userId) {\r\n-        $training->is_attending = $training->participants()\r\n-            ->where('user_id', $userId)\r\n-            ->exists();\r\n-    }\r\n-\r\n-        // Add image_url if document exists\r\n-    $training->image_url = $training->documents->first()\r\n-        ? asset('storage/' . str_replace(' ', '%20', $training->documents->first()->file_path))\r\n-        : null;\r\n-\r\n-    return response()->json($training);\r\n-}\r\n-\r\n-public function cancelAttendance(Request $request, $trainingId)\r\n-{\r\n-    $userId = $request->user()->id;\r\n-    $training = Training::find($trainingId);\r\n-\r\n-    if (!$training) {\r\n-        return response()->json(['message' => 'Training not found'], 404);\r\n-    }\r\n-\r\n-    if (!$training->participants()->where('user_id', $userId)->exists()) {\r\n-        return response()->json(['message' => 'Not attending this event'], 404);\r\n-    }\r\n-\r\n-    $training->participants()->detach($userId);\r\n-\r\n-    \r\n-    DB::table('notifications')->insert([\r\n-    'user_id' => $userId,\r\n-    'message' => \"You have cancelled your attendance for '{$training->title}'.\",\r\n-    'is_read' => false,\r\n-    'sent_at' => now(),\r\n-    'created_at' => now(),\r\n-    'updated_at' => now(),\r\n-    ]);\r\n-\r\n-    return response()->json(['message' => 'Attendance cancelled successfully', 'training' => $training]);\r\n-\r\n-}\r\n-    \r\n-}\r\n-\r\n"
                }
            ],
            "date": 1763798852002,
            "name": "Commit-0",
            "content": "<?php\r\n\r\nnamespace App\\Http\\Controllers\\mobile;\r\n\r\nuse App\\Http\\Controllers\\Controller;\r\nuse App\\Models\\Training;\r\nuse Illuminate\\Http\\Request;\r\nuse Illuminate\\Support\\Facades\\DB;\r\nuse Carbon\\Carbon;\r\nclass TrainingsController extends Controller\r\n{\r\n    \r\npublic function index(Request $request)\r\n{\r\n    $userId = $request->user()->id; // token from sanctum\r\n\r\n    // Today in app timezone\r\n    $today = Carbon::today(config('app.timezone'));\r\n\r\n    // Get trainings that Have date today or in the future and user is NOT attending yet\r\n    $trainings = Training::whereDate('date', '>=', $today)\r\n        ->whereDoesntHave('participants', function ($query) use ($userId) {\r\n            $query->where('user_id', $userId);\r\n        })\r\n        ->withCount('participants')\r\n        ->with('sector', 'documents')\r\n        ->paginate(10);\r\n\r\n    // Transform each training for additional info\r\n    $trainings->getCollection()->transform(function ($training) use ($today) {\r\n        $eventDate = Carbon::parse($training->date)\r\n        ->timezone(config('app.timezone'))\r\n        ->startOfDay();\r\n\r\n        //  Set image URL if there’s at least one related document\r\n        $training->image_url = $training->documents->first()\r\n            ? asset('storage/' . str_replace(' ', '%20', $training->documents->first()->file_path))\r\n\r\n            : null;\r\n\r\n        // Set status\r\n        $training->status = $eventDate->isSameDay($today) ? 'Today' : 'Upcoming';\r\n\r\n        return $training;\r\n    });\r\n\r\n    return response()->json([\r\n        'success' => true,\r\n        'data' => $trainings,\r\n    ]);\r\n}\r\n\r\n\r\n\r\n    // To attend a training\r\npublic function attend(Request $request, $trainingId)\r\n{\r\n    \r\n    //  Get the authenticated user\r\n    $userId = $request->user()->id;\r\n\r\n    //  Check if user already attending\r\n    $exists = DB::table('participants')\r\n        ->where('training_id', $trainingId)\r\n        ->where('user_id', $userId)\r\n        ->exists();\r\n\r\n    if ($exists) {\r\n        return response()->json(['message' => 'Already attending this training'], 400);\r\n    }\r\n\r\n    //  Fetch the training before attaching\r\n    $training = Training::findOrFail($trainingId);\r\n\r\n    //  Attach using Eloquent relationship (cleaner than raw DB insert)\r\n    $training->participants()->attach($userId);\r\n\r\n    //  Create notification entry\r\n    DB::table('notifications')->insert([\r\n        'user_id' => $userId,\r\n        'message' => \"You are now attending '{$training->title}' on {$training->date} at {$training->venue}.\",\r\n        'is_read' => false,\r\n        'sent_at' => now(),\r\n        'created_at' => now(),\r\n        'updated_at' => now(),\r\n    ]);\r\n\r\n    return response()->json([\r\n    'success' => true,\r\n    'message' => 'You are now attending this training',\r\n    'data' => $training\r\n    ]);\r\n\r\n}\r\n\r\n\r\n\r\n// Get all trainings the user attends\r\npublic function myEvents(Request $request)\r\n{\r\n    $userId = $request->user()->id;\r\n    $filter = $request->query('filter'); // Ongoing, Did not attend, Attended, All\r\n\r\n    $trainings = Training::whereHas('participants', function ($q) use ($userId) {\r\n    $q->where('user_id', $userId);\r\n})\r\n->withCount('participants')\r\n->with('sector', 'documents')\r\n->get()\r\n->map(function ($training) use ($userId) {\r\n    $participant = $training->participants()->where('user_id', $userId)->first();\r\n    $attended = $participant ? (bool)$participant->pivot->qr_scanned : false;\r\n    $eventDate = Carbon::parse($training->date)->startOfDay();\r\n    $today = Carbon::today();\r\n\r\n    // Set status\r\n    if ($attended) {\r\n    $training->status = 'Attended';\r\n    } else if ($eventDate->isBefore($today)) {\r\n    $training->status = 'Did not attend';\r\n    } else {\r\n    $training->status = 'Ongoing';\r\n    }\r\n\r\n    $training->attended = $attended;\r\n    $training->qr_scanned = $attended;\r\n\r\n    // Set is_attending\r\n    $training->is_attending = $training->participants()\r\n        ->where('user_id', $userId)\r\n        ->exists();\r\n\r\n           // image_url if document exists\r\n       $training->image_url = $training->documents->first()\r\n    ? asset('storage/' . str_replace(' ', '%20', $training->documents->first()->file_path))\r\n    : null;\r\n\r\n\r\n    return $training;\r\n});\r\n\r\n    // Apply filter\r\n    if ($filter && $filter !== 'All') {\r\n        $trainings = $trainings->filter(function ($training) use ($filter) {\r\n            return $training->status === $filter;\r\n        })->values();\r\n    }\r\n\r\n    return response()->json($trainings);\r\n}\r\n\r\n\r\npublic function show(Request $request, $trainingId)\r\n{\r\n    $userId = $request->user()->id;\r\n\r\n    $training = Training::withCount('participants')\r\n        ->with('sector', 'documents')\r\n        ->findOrFail($trainingId);\r\n\r\n    // Add is_attending flag if user_id is given\r\n    $training->is_attending = false;\r\n    if ($userId) {\r\n        $training->is_attending = $training->participants()\r\n            ->where('user_id', $userId)\r\n            ->exists();\r\n    }\r\n\r\n        // Add image_url if document exists\r\n    $training->image_url = $training->documents->first()\r\n        ? asset('storage/' . str_replace(' ', '%20', $training->documents->first()->file_path))\r\n        : null;\r\n\r\n    return response()->json($training);\r\n}\r\n\r\npublic function cancelAttendance(Request $request, $trainingId)\r\n{\r\n    $userId = $request->user()->id;\r\n    $training = Training::find($trainingId);\r\n\r\n    if (!$training) {\r\n        return response()->json(['message' => 'Training not found'], 404);\r\n    }\r\n\r\n    if (!$training->participants()->where('user_id', $userId)->exists()) {\r\n        return response()->json(['message' => 'Not attending this event'], 404);\r\n    }\r\n\r\n    $training->participants()->detach($userId);\r\n\r\n    \r\n    DB::table('notifications')->insert([\r\n    'user_id' => $userId,\r\n    'message' => \"You have cancelled your attendance for '{$training->title}'.\",\r\n    'is_read' => false,\r\n    'sent_at' => now(),\r\n    'created_at' => now(),\r\n    'updated_at' => now(),\r\n    ]);\r\n\r\n    return response()->json(['message' => 'Attendance cancelled successfully', 'training' => $training]);\r\n\r\n}\r\n    \r\n}\r\n\r\n"
        }
    ]
}
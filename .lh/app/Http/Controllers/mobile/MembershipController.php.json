{
    "sourceFile": "app/Http/Controllers/mobile/MembershipController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 20,
            "patches": [
                {
                    "date": 1763626403925,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763626595618,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,9 +16,10 @@\n      */\n     public function store(Request $request)\n     {\n         $validatedData = $request->validate([\n-            'farmer_type' => 'required|string|in:Farmer,Fisher',\n+'farmer_type' => 'required|string|in:Agriculture,Fisheries,Livestock,Forestry,Agri-Business',\n+\n             'fname' => 'required|string',\n             'mname' => 'nullable|string',\n             'lname' => 'required|string',\n             'suffix' => 'nullable|string',\n"
                },
                {
                    "date": 1763626962178,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,9 +25,9 @@\n             'suffix' => 'nullable|string',\n             'birthdate' => 'required|date',\n             'civil_status' => 'nullable|string',\n             'gender' => 'required|string',\n-            'contact_no' => 'required|string',\n+            'contact_no' => 'nullable|string',\n             'province' => 'required|string',\n             'city' => 'required|string',\n             'house_no' => 'nullable|string', // ← ADD THIS\n             'barangay' => 'required|string',\n"
                },
                {
                    "date": 1763629238469,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,9 +25,9 @@\n             'suffix' => 'nullable|string',\n             'birthdate' => 'required|date',\n             'civil_status' => 'nullable|string',\n             'gender' => 'required|string',\n-            'contact_no' => 'nullable|string',\n+            'contact_no' => 'required|string',\n             'province' => 'required|string',\n             'city' => 'required|string',\n             'house_no' => 'nullable|string', // ← ADD THIS\n             'barangay' => 'required|string',\n"
                },
                {
                    "date": 1763629579850,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,9 +16,9 @@\n      */\n     public function store(Request $request)\n     {\n         $validatedData = $request->validate([\n-'farmer_type' => 'required|string|in:Agriculture,Fisheries,Livestock,Forestry,Agri-Business',\n+            'farmer_type' => 'required|string|in:Agriculture,Fisheries,Livestock,Forestry,Agri-Business',\n \n             'fname' => 'required|string',\n             'mname' => 'nullable|string',\n             'lname' => 'required|string',\n"
                },
                {
                    "date": 1765178032312,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,33 +4,40 @@\n \n use App\\Http\\Controllers\\Controller;\n use Illuminate\\Http\\Request;\n use App\\Models\\UserInfo;\n+use App\\Models\\Application;\n+use App\\Models\\Document;\n use Illuminate\\Support\\Str;\n+use App\\Services\\DocumentChecker;\n+use Barryvdh\\DomPDF\\Facade\\Pdf;\n+use Illuminate\\Support\\Facades\\Storage;\n+use Illuminate\\Support\\Facades\\Auth;\n use App\\Models\\CreditScore;\n use App\\Models\\CreditScoreHistory;\n+use App\\Services\\SMSService;\n+use App\\Models\\Notification;\n \n class MembershipController extends Controller\n {\n     /**\n-     * Validate and store a new membership application.\n+     * Submit membership application\n      */\n     public function store(Request $request)\n     {\n         $validatedData = $request->validate([\n-            'farmer_type' => 'required|string|in:Agriculture,Fisheries,Livestock,Forestry,Agri-Business',\n-\n+            'sector_id' => 'required|integer',\n             'fname' => 'required|string',\n             'mname' => 'nullable|string',\n             'lname' => 'required|string',\n             'suffix' => 'nullable|string',\n             'birthdate' => 'required|date',\n             'civil_status' => 'nullable|string',\n             'gender' => 'required|string',\n-            'contact_no' => 'required|string',\n+            'contact_info' => 'required|string',\n             'province' => 'required|string',\n             'city' => 'required|string',\n-            'house_no' => 'nullable|string', // ← ADD THIS\n+            'house_no' => 'nullable|string',\n             'barangay' => 'required|string',\n             'zone' => 'required|string',\n             'farm_location' => 'nullable|string',\n             'land_size' => 'nullable|string',\n@@ -39,45 +46,295 @@\n             'sc_mname' => 'nullable|string',\n             'sc_lname' => 'nullable|string',\n             'sc_suffix' => 'nullable|string',\n             'sc_gender' => 'nullable|string',\n-            'sc_contact_no' => 'nullable|string',\n-            'sc_email' => 'nullable|email',\n+            'sc_contact_info' => 'nullable|string',\n             'sc_province' => 'nullable|string',\n             'sc_city' => 'nullable|string',\n-            'sc_house_no' => 'nullable|string', // ← ADD THIS\n+            'sc_house_no' => 'nullable|string',\n             'sc_barangay' => 'nullable|string',\n             'sc_zone' => 'nullable|string',\n             'relationship' => 'nullable|string',\n+            'valid_id' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',\n         ]);\n \n         $user = $request->user();\n \n+        // Check if user already submitted\n         if ($user->userInfo) {\n-            return response()->json(['message' => 'Application already submitted.'], 409);\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already submitted.'\n+            ], 409);\n         }\n \n-        $userInfo = UserInfo::create(array_merge($validatedData, ['user_id' => $user->id]));\n+        // Auto-detect primary contact (phone or email)\n+        $primaryContact = $validatedData['contact_info'];\n+        $contactPhone = null;\n+        $contactEmail = null;\n+        \n+        if ($this->isEmail($primaryContact)) {\n+            $contactEmail = $primaryContact;\n+        } else {\n+            $contactPhone = $primaryContact;\n+        }\n+        \n+        // Auto-detect secondary contact (phone or email)\n+        $secondaryContact = $validatedData['sc_contact_info'] ?? null;\n+        $scPhone = null;\n+        $scEmail = null;\n+        \n+        if ($secondaryContact) {\n+            if ($this->isEmail($secondaryContact)) {\n+                $scEmail = $secondaryContact;\n+            } else {\n+                $scPhone = $secondaryContact;\n+            }\n+        }\n \n-        // Generate and save QR code\n-        $userInfo->qr_code = Str::uuid()->toString();\n-        $userInfo->save();\n+        // Create UserInfo with smart detection\n+        $userInfo = UserInfo::create([\n+            'user_id' => $user->id,\n+            'sector_id' => $validatedData['sector_id'],\n+            'fname' => $validatedData['fname'],\n+            'mname' => $validatedData['mname'],\n+            'lname' => $validatedData['lname'],\n+            'name' => $validatedData['fname'] . ' ' .($validatedData['mname'] ?? ' '). ' ' .$validatedData['lname'],\n+            'suffix' => $validatedData['suffix'],\n+            'birthdate' => $validatedData['birthdate'],\n+            'civil_status' => $validatedData['civil_status'],\n+            'gender' => $validatedData['gender'],\n+            \n+            // Store contact in both formats\n+            'contact_info' => $primaryContact,\n+            'phone_no' => $contactPhone,\n+            'email' => $contactEmail,\n+            \n+            'province' => $validatedData['province'],\n+            'city' => $validatedData['city'],\n+            'house_no' => $validatedData['house_no'],\n+            'barangay' => $validatedData['barangay'],\n+            'zone' => $validatedData['zone'],\n+            'farm_location' => $validatedData['farm_location'],\n+            'land_size' => $validatedData['land_size'],\n+            'water_source' => $validatedData['water_source'],\n+            \n+            // Secondary Contact\n+            'sc_fname' => $validatedData['sc_fname'],\n+            'sc_mname' => $validatedData['sc_mname'],\n+            'sc_lname' => $validatedData['sc_lname'],\n+            'sc_suffix' => $validatedData['sc_suffix'],\n+            'sc_gender' => $validatedData['sc_gender'],\n+            \n+            // Store secondary contact in both formats\n+            'sc_contact_info' => $secondaryContact,\n+            'sc_phone_no' => $scPhone,\n+            'sc_email' => $scEmail,\n+            \n+            'sc_province' => $validatedData['sc_province'],\n+            'sc_city' => $validatedData['sc_city'],\n+            'sc_house_no' => $validatedData['sc_house_no'],\n+            'sc_barangay' => $validatedData['sc_barangay'],\n+            'sc_zone' => $validatedData['sc_zone'],\n+            'relationship' => $validatedData['relationship'],\n+        ]);\n \n-        // Assign initial credit score\n-        $user->creditScore()->create(['score' => 80]);\n+        // Create Application with PENDING status\n+        $application = Application::create([\n+            'user_id' => $user->id,\n+            'grant_id' => null,\n+            'status_id' => 3, // PENDING STATUS // 3 ang pending\n+            'application_type' => 'Membership',\n+            'purpose' => 'Membership Application',\n+        ]);\n \n-        // Create first history record\n-        $user->creditScoreHistory()->create([\n-            'activity' => 'Membership Approved',\n-            'points' => 80\n+        // Store Valid ID document\n+        if ($request->hasFile('valid_id')) {\n+\n+            $file = $request->file('valid_id');\n+            $filename = time() . '_' . $file->getClientOriginalName();\n+            $path = $file->storeAs('application/membership', $filename, 'public');\n+\n+            // CREATE DOCUMENT ENTRY\n+            $document = Document::create([\n+                'grant_requirement_id' => null,\n+                'membership_requirement_id' => 1, // ⚠️ SET THE VALID ID REQUIREMENT ID HERE\n+                'status_id' => 3, // PENDING STATUS\n+                'file_path' => $path,\n+                'file_name' => $filename,\n+                'documentable_type' => 'App\\Models\\Application',\n+                'documentable_id' => $application->id,\n+            ]);\n+\n+            // Initialize checker\n+            $checker = new DocumentChecker();\n+\n+            // Get requirement name (example: \"Valid ID\")\n+            $requirement = \\App\\Models\\MembershipRequirement::find(1); // SAME ID AS ABOVE\n+            $requirementName = $requirement?->requirement?->requirement_name;\n+\n+            if ($requirementName) {\n+\n+                // RUN AUTO CHECKER (same as web)\n+                $result = $checker->verifyDocumentBelongsToUser(\n+                    storage_path('app/public/' . $path),\n+                    $requirementName,\n+                    $userInfo // same membership owner\n+                );\n+\n+                // UPDATE DOCUMENT WITH RESULT\n+                $document->update([\n+                    'check_result' => $result\n+                ]);\n+            }\n+        }\n+\n+        //create pdf file of the application form\n+        $application->load(['documents', 'status', 'user.user_info']);\n+        $pdf = Pdf::loadView('pdf.membership_application_form', ['application' => $application]);\n+\n+        $fileName = $request->lname . '_membership_application_form_' . $application->id . '.pdf';\n+        $filePath = 'applications/' . $fileName;\n+\n+        Storage::disk('public')->put($filePath, $pdf->output());\n+        $application->update(['form_img' => $filePath]);\n+\n+        //store a confirmation message to table\n+        Notification::create([ \n+            'user_id' => Auth::id(),\n+            'message' => 'Your membership application was submitted successfully and is now pending approval.' ,\n+            'sent_at' => now(),\n         ]);\n \n-        // Change user status to member\n-        $user->update(['role_id' => 3]);\n+        // Send SMS to applicant\n+        if ($userInfo && $userInfo->phone_no) {\n \n+            $number = $userInfo->phone_no;\n+\n+            // Convert \"09...\" to \"639...\"\n+            $number = preg_replace('/^0/', '63', $number);\n+\n+            $message = '[SWISA-AGAP] Your membership application was submitted successfully and is now pending approval.';\n+\n+            SMSService::send($number, $message);\n+        }\n+\n         return response()->json([\n             'success' => true,\n-            'message' => 'Membership application submitted successfully!',\n-            'user_info' => $userInfo\n+            'message' => 'Membership application submitted successfully! Please wait for admin approval.',\n+            'user_info' => $userInfo,\n+            'application' => $application\n         ], 201);\n     }\n-}\n+\n+    /**\n+     * Approve membership application (Admin only)\n+     */\n+    public function approveMembership(Request $request, $applicationId)\n+    {\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already approved\n+        if ($application->status_id == 4) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already approved.'\n+            ], 400);\n+        }\n+        \n+        $user = $application->user;\n+        //$userInfo = $user->userInfo;\n+        \n+        // Update application status to APPROVED\n+        $application->update(['status_id' => 4]); // 4 = Approved\n+        \n+        // Update document status to APPROVED\n+        $application->documents()->update(['status_id' => 4]);\n+        \n+        // Generate QR code\n+        /*if (!$userInfo->qr_code) {\n+            $userInfo->qr_code = Str::uuid()->toString();\n+            $userInfo->save();\n+        }*/\n+        \n+        // Assign initial credit score (if not exists)\n+        if (!$user->creditScore) {\n+            $user->creditScore()->create([\n+                'score' => 20,\n+            ]);\n+            \n+            // Create credit history\n+            $user->creditScoreHistory()->create([\n+                'activity' => 'Membership Approved',\n+                'points' => 20\n+            ]);\n+        }\n+        \n+        // Change user role to member\n+        $user->update(['role_id' => 1]); // 1 ang member nata 2 kinaag mo\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application approved successfully!',\n+            'application' => $application,\n+        ]);\n+    }\n+\n+    /**\n+     * Reject membership application (Admin only)\n+     */\n+    public function rejectMembership(Request $request, $applicationId)\n+    {\n+        $request->validate([\n+            'reason' => 'nullable|string|max:500',\n+        ]);\n+\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already rejected\n+        if ($application->status_id == 6) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already rejected.'\n+            ], 400);\n+        }\n+        \n+        // Update application status to REJECTED\n+        $application->update([\n+            'status_id' => 6, // 6 = Rejected\n+            'rejection_reason' => $request->input('reason'),\n+        ]);\n+        \n+        // Update document status to REJECTED\n+        $application->documents()->update(['status_id' => 6]);\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application rejected.',\n+            'application' => $application,\n+        ]);\n+    }\n+    \n+    /**\n+     * Helper method to detect if input is email\n+     */\n+    private function isEmail($value)\n+    {\n+        return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1765179263958,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -32,9 +32,9 @@\n             'suffix' => 'nullable|string',\n             'birthdate' => 'required|date',\n             'civil_status' => 'nullable|string',\n             'gender' => 'required|string',\n-            'contact_info' => 'required|string',\n+            'contact_info' => 'nullable|string',\n             'province' => 'required|string',\n             'city' => 'required|string',\n             'house_no' => 'nullable|string',\n             'barangay' => 'required|string',\n"
                },
                {
                    "date": 1765179400224,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -32,9 +32,9 @@\n             'suffix' => 'nullable|string',\n             'birthdate' => 'required|date',\n             'civil_status' => 'nullable|string',\n             'gender' => 'required|string',\n-            'contact_info' => 'nullable|string',\n+            'contact_info' => 'required|string',\n             'province' => 'required|string',\n             'city' => 'required|string',\n             'house_no' => 'nullable|string',\n             'barangay' => 'required|string',\n"
                },
                {
                    "date": 1765179588002,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -32,9 +32,9 @@\n             'suffix' => 'nullable|string',\n             'birthdate' => 'required|date',\n             'civil_status' => 'nullable|string',\n             'gender' => 'required|string',\n-            'contact_info' => 'required|string',\n+            'contact_info' => 'nullable|string',\n             'province' => 'required|string',\n             'city' => 'required|string',\n             'house_no' => 'nullable|string',\n             'barangay' => 'required|string',\n"
                },
                {
                    "date": 1765179717124,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,9 +67,10 @@\n             ], 409);\n         }\n \n         // Auto-detect primary contact (phone or email)\n-        $primaryContact = $validatedData['contact_info'];\n+$primaryContact = $validatedData['contact_info'] ?? null;\n+\n         $contactPhone = null;\n         $contactEmail = null;\n         \n         if ($this->isEmail($primaryContact)) {\n"
                },
                {
                    "date": 1765179759458,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,9 +67,9 @@\n             ], 409);\n         }\n \n         // Auto-detect primary contact (phone or email)\n-$primaryContact = $validatedData['contact_info'] ?? null;\n+        $primaryContact = $validatedData['contact_info'] ?? null;\n \n         $contactPhone = null;\n         $contactEmail = null;\n         \n"
                },
                {
                    "date": 1765180304559,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,40 +4,33 @@\n \n use App\\Http\\Controllers\\Controller;\n use Illuminate\\Http\\Request;\n use App\\Models\\UserInfo;\n-use App\\Models\\Application;\n-use App\\Models\\Document;\n use Illuminate\\Support\\Str;\n-use App\\Services\\DocumentChecker;\n-use Barryvdh\\DomPDF\\Facade\\Pdf;\n-use Illuminate\\Support\\Facades\\Storage;\n-use Illuminate\\Support\\Facades\\Auth;\n use App\\Models\\CreditScore;\n use App\\Models\\CreditScoreHistory;\n-use App\\Services\\SMSService;\n-use App\\Models\\Notification;\n \n class MembershipController extends Controller\n {\n     /**\n-     * Submit membership application\n+     * Validate and store a new membership application.\n      */\n     public function store(Request $request)\n     {\n         $validatedData = $request->validate([\n-            'sector_id' => 'required|integer',\n+            'farmer_type' => 'required|string|in:Agriculture,Fisheries,Livestock,Forestry,Agri-Business',\n+\n             'fname' => 'required|string',\n             'mname' => 'nullable|string',\n             'lname' => 'required|string',\n             'suffix' => 'nullable|string',\n             'birthdate' => 'required|date',\n             'civil_status' => 'nullable|string',\n             'gender' => 'required|string',\n-            'contact_info' => 'nullable|string',\n+            'contact_no' => 'required|string',\n             'province' => 'required|string',\n             'city' => 'required|string',\n-            'house_no' => 'nullable|string',\n+            'house_no' => 'nullable|string', // ← ADD THIS\n             'barangay' => 'required|string',\n             'zone' => 'required|string',\n             'farm_location' => 'nullable|string',\n             'land_size' => 'nullable|string',\n@@ -46,296 +39,45 @@\n             'sc_mname' => 'nullable|string',\n             'sc_lname' => 'nullable|string',\n             'sc_suffix' => 'nullable|string',\n             'sc_gender' => 'nullable|string',\n-            'sc_contact_info' => 'nullable|string',\n+            'sc_contact_no' => 'nullable|string',\n+            'sc_email' => 'nullable|email',\n             'sc_province' => 'nullable|string',\n             'sc_city' => 'nullable|string',\n-            'sc_house_no' => 'nullable|string',\n+            'sc_house_no' => 'nullable|string', // ← ADD THIS\n             'sc_barangay' => 'nullable|string',\n             'sc_zone' => 'nullable|string',\n             'relationship' => 'nullable|string',\n-            'valid_id' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',\n         ]);\n \n         $user = $request->user();\n \n-        // Check if user already submitted\n         if ($user->userInfo) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already submitted.'\n-            ], 409);\n+            return response()->json(['message' => 'Application already submitted.'], 409);\n         }\n \n-        // Auto-detect primary contact (phone or email)\n-        $primaryContact = $validatedData['contact_info'] ?? null;\n+        $userInfo = UserInfo::create(array_merge($validatedData, ['user_id' => $user->id]));\n \n-        $contactPhone = null;\n-        $contactEmail = null;\n-        \n-        if ($this->isEmail($primaryContact)) {\n-            $contactEmail = $primaryContact;\n-        } else {\n-            $contactPhone = $primaryContact;\n-        }\n-        \n-        // Auto-detect secondary contact (phone or email)\n-        $secondaryContact = $validatedData['sc_contact_info'] ?? null;\n-        $scPhone = null;\n-        $scEmail = null;\n-        \n-        if ($secondaryContact) {\n-            if ($this->isEmail($secondaryContact)) {\n-                $scEmail = $secondaryContact;\n-            } else {\n-                $scPhone = $secondaryContact;\n-            }\n-        }\n+        // Generate and save QR code\n+        $userInfo->qr_code = Str::uuid()->toString();\n+        $userInfo->save();\n \n-        // Create UserInfo with smart detection\n-        $userInfo = UserInfo::create([\n-            'user_id' => $user->id,\n-            'sector_id' => $validatedData['sector_id'],\n-            'fname' => $validatedData['fname'],\n-            'mname' => $validatedData['mname'],\n-            'lname' => $validatedData['lname'],\n-            'name' => $validatedData['fname'] . ' ' .($validatedData['mname'] ?? ' '). ' ' .$validatedData['lname'],\n-            'suffix' => $validatedData['suffix'],\n-            'birthdate' => $validatedData['birthdate'],\n-            'civil_status' => $validatedData['civil_status'],\n-            'gender' => $validatedData['gender'],\n-            \n-            // Store contact in both formats\n-            'contact_info' => $primaryContact,\n-            'phone_no' => $contactPhone,\n-            'email' => $contactEmail,\n-            \n-            'province' => $validatedData['province'],\n-            'city' => $validatedData['city'],\n-            'house_no' => $validatedData['house_no'],\n-            'barangay' => $validatedData['barangay'],\n-            'zone' => $validatedData['zone'],\n-            'farm_location' => $validatedData['farm_location'],\n-            'land_size' => $validatedData['land_size'],\n-            'water_source' => $validatedData['water_source'],\n-            \n-            // Secondary Contact\n-            'sc_fname' => $validatedData['sc_fname'],\n-            'sc_mname' => $validatedData['sc_mname'],\n-            'sc_lname' => $validatedData['sc_lname'],\n-            'sc_suffix' => $validatedData['sc_suffix'],\n-            'sc_gender' => $validatedData['sc_gender'],\n-            \n-            // Store secondary contact in both formats\n-            'sc_contact_info' => $secondaryContact,\n-            'sc_phone_no' => $scPhone,\n-            'sc_email' => $scEmail,\n-            \n-            'sc_province' => $validatedData['sc_province'],\n-            'sc_city' => $validatedData['sc_city'],\n-            'sc_house_no' => $validatedData['sc_house_no'],\n-            'sc_barangay' => $validatedData['sc_barangay'],\n-            'sc_zone' => $validatedData['sc_zone'],\n-            'relationship' => $validatedData['relationship'],\n-        ]);\n+        // Assign initial credit score\n+        $user->creditScore()->create(['score' => 80]);\n \n-        // Create Application with PENDING status\n-        $application = Application::create([\n-            'user_id' => $user->id,\n-            'grant_id' => null,\n-            'status_id' => 3, // PENDING STATUS // 3 ang pending\n-            'application_type' => 'Membership',\n-            'purpose' => 'Membership Application',\n+        // Create first history record\n+        $user->creditScoreHistory()->create([\n+            'activity' => 'Membership Approved',\n+            'points' => 80\n         ]);\n \n-        // Store Valid ID document\n-        if ($request->hasFile('valid_id')) {\n+        // Change user status to member\n+        $user->update(['role_id' => 3]);\n \n-            $file = $request->file('valid_id');\n-            $filename = time() . '_' . $file->getClientOriginalName();\n-            $path = $file->storeAs('application/membership', $filename, 'public');\n-\n-            // CREATE DOCUMENT ENTRY\n-            $document = Document::create([\n-                'grant_requirement_id' => null,\n-                'membership_requirement_id' => 1, // ⚠️ SET THE VALID ID REQUIREMENT ID HERE\n-                'status_id' => 3, // PENDING STATUS\n-                'file_path' => $path,\n-                'file_name' => $filename,\n-                'documentable_type' => 'App\\Models\\Application',\n-                'documentable_id' => $application->id,\n-            ]);\n-\n-            // Initialize checker\n-            $checker = new DocumentChecker();\n-\n-            // Get requirement name (example: \"Valid ID\")\n-            $requirement = \\App\\Models\\MembershipRequirement::find(1); // SAME ID AS ABOVE\n-            $requirementName = $requirement?->requirement?->requirement_name;\n-\n-            if ($requirementName) {\n-\n-                // RUN AUTO CHECKER (same as web)\n-                $result = $checker->verifyDocumentBelongsToUser(\n-                    storage_path('app/public/' . $path),\n-                    $requirementName,\n-                    $userInfo // same membership owner\n-                );\n-\n-                // UPDATE DOCUMENT WITH RESULT\n-                $document->update([\n-                    'check_result' => $result\n-                ]);\n-            }\n-        }\n-\n-        //create pdf file of the application form\n-        $application->load(['documents', 'status', 'user.user_info']);\n-        $pdf = Pdf::loadView('pdf.membership_application_form', ['application' => $application]);\n-\n-        $fileName = $request->lname . '_membership_application_form_' . $application->id . '.pdf';\n-        $filePath = 'applications/' . $fileName;\n-\n-        Storage::disk('public')->put($filePath, $pdf->output());\n-        $application->update(['form_img' => $filePath]);\n-\n-        //store a confirmation message to table\n-        Notification::create([ \n-            'user_id' => Auth::id(),\n-            'message' => 'Your membership application was submitted successfully and is now pending approval.' ,\n-            'sent_at' => now(),\n-        ]);\n-\n-        // Send SMS to applicant\n-        if ($userInfo && $userInfo->phone_no) {\n-\n-            $number = $userInfo->phone_no;\n-\n-            // Convert \"09...\" to \"639...\"\n-            $number = preg_replace('/^0/', '63', $number);\n-\n-            $message = '[SWISA-AGAP] Your membership application was submitted successfully and is now pending approval.';\n-\n-            SMSService::send($number, $message);\n-        }\n-\n         return response()->json([\n             'success' => true,\n-            'message' => 'Membership application submitted successfully! Please wait for admin approval.',\n-            'user_info' => $userInfo,\n-            'application' => $application\n+            'message' => 'Membership application submitted successfully!',\n+            'user_info' => $userInfo\n         ], 201);\n     }\n-\n-    /**\n-     * Approve membership application (Admin only)\n-     */\n-    public function approveMembership(Request $request, $applicationId)\n-    {\n-        $application = Application::findOrFail($applicationId);\n-        \n-        // Check if application is for membership\n-        if ($application->application_type !== 'Membership') {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'This is not a membership application.'\n-            ], 400);\n-        }\n-        \n-        // Check if already approved\n-        if ($application->status_id == 4) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already approved.'\n-            ], 400);\n-        }\n-        \n-        $user = $application->user;\n-        //$userInfo = $user->userInfo;\n-        \n-        // Update application status to APPROVED\n-        $application->update(['status_id' => 4]); // 4 = Approved\n-        \n-        // Update document status to APPROVED\n-        $application->documents()->update(['status_id' => 4]);\n-        \n-        // Generate QR code\n-        /*if (!$userInfo->qr_code) {\n-            $userInfo->qr_code = Str::uuid()->toString();\n-            $userInfo->save();\n-        }*/\n-        \n-        // Assign initial credit score (if not exists)\n-        if (!$user->creditScore) {\n-            $user->creditScore()->create([\n-                'score' => 20,\n-            ]);\n-            \n-            // Create credit history\n-            $user->creditScoreHistory()->create([\n-                'activity' => 'Membership Approved',\n-                'points' => 20\n-            ]);\n-        }\n-        \n-        // Change user role to member\n-        $user->update(['role_id' => 1]); // 1 ang member nata 2 kinaag mo\n-        \n-        return response()->json([\n-            'success' => true,\n-            'message' => 'Membership application approved successfully!',\n-            'application' => $application,\n-        ]);\n-    }\n-\n-    /**\n-     * Reject membership application (Admin only)\n-     */\n-    public function rejectMembership(Request $request, $applicationId)\n-    {\n-        $request->validate([\n-            'reason' => 'nullable|string|max:500',\n-        ]);\n-\n-        $application = Application::findOrFail($applicationId);\n-        \n-        // Check if application is for membership\n-        if ($application->application_type !== 'Membership') {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'This is not a membership application.'\n-            ], 400);\n-        }\n-        \n-        // Check if already rejected\n-        if ($application->status_id == 6) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already rejected.'\n-            ], 400);\n-        }\n-        \n-        // Update application status to REJECTED\n-        $application->update([\n-            'status_id' => 6, // 6 = Rejected\n-            'rejection_reason' => $request->input('reason'),\n-        ]);\n-        \n\\ No newline at end of file\n-        // Update document status to REJECTED\n-        $application->documents()->update(['status_id' => 6]);\n-        \n-        return response()->json([\n-            'success' => true,\n-            'message' => 'Membership application rejected.',\n-            'application' => $application,\n-        ]);\n-    }\n-    \n-    /**\n-     * Helper method to detect if input is email\n-     */\n-    private function isEmail($value)\n-    {\n-        return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n-    }\n-}\n+}\n"
                },
                {
                    "date": 1765180348624,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,33 +4,40 @@\n \n use App\\Http\\Controllers\\Controller;\n use Illuminate\\Http\\Request;\n use App\\Models\\UserInfo;\n+use App\\Models\\Application;\n+use App\\Models\\Document;\n use Illuminate\\Support\\Str;\n+use App\\Services\\DocumentChecker;\n+use Barryvdh\\DomPDF\\Facade\\Pdf;\n+use Illuminate\\Support\\Facades\\Storage;\n+use Illuminate\\Support\\Facades\\Auth;\n use App\\Models\\CreditScore;\n use App\\Models\\CreditScoreHistory;\n+use App\\Services\\SMSService;\n+use App\\Models\\Notification;\n \n class MembershipController extends Controller\n {\n     /**\n-     * Validate and store a new membership application.\n+     * Submit membership application\n      */\n     public function store(Request $request)\n     {\n         $validatedData = $request->validate([\n-            'farmer_type' => 'required|string|in:Agriculture,Fisheries,Livestock,Forestry,Agri-Business',\n-\n+            'sector_id' => 'required|integer',\n             'fname' => 'required|string',\n             'mname' => 'nullable|string',\n             'lname' => 'required|string',\n             'suffix' => 'nullable|string',\n             'birthdate' => 'required|date',\n             'civil_status' => 'nullable|string',\n             'gender' => 'required|string',\n-            'contact_no' => 'required|string',\n+            'contact_info' => 'nullable|string',\n             'province' => 'required|string',\n             'city' => 'required|string',\n-            'house_no' => 'nullable|string', // ← ADD THIS\n+            'house_no' => 'nullable|string',\n             'barangay' => 'required|string',\n             'zone' => 'required|string',\n             'farm_location' => 'nullable|string',\n             'land_size' => 'nullable|string',\n@@ -39,45 +46,296 @@\n             'sc_mname' => 'nullable|string',\n             'sc_lname' => 'nullable|string',\n             'sc_suffix' => 'nullable|string',\n             'sc_gender' => 'nullable|string',\n-            'sc_contact_no' => 'nullable|string',\n-            'sc_email' => 'nullable|email',\n+            'sc_contact_info' => 'nullable|string',\n             'sc_province' => 'nullable|string',\n             'sc_city' => 'nullable|string',\n-            'sc_house_no' => 'nullable|string', // ← ADD THIS\n+            'sc_house_no' => 'nullable|string',\n             'sc_barangay' => 'nullable|string',\n             'sc_zone' => 'nullable|string',\n             'relationship' => 'nullable|string',\n+            'valid_id' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',\n         ]);\n \n         $user = $request->user();\n \n+        // Check if user already submitted\n         if ($user->userInfo) {\n-            return response()->json(['message' => 'Application already submitted.'], 409);\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already submitted.'\n+            ], 409);\n         }\n \n-        $userInfo = UserInfo::create(array_merge($validatedData, ['user_id' => $user->id]));\n+        // Auto-detect primary contact (phone or email)\n+        $primaryContact = $validatedData['contact_info'] ?? null;\n \n-        // Generate and save QR code\n-        $userInfo->qr_code = Str::uuid()->toString();\n-        $userInfo->save();\n+        $contactPhone = null;\n+        $contactEmail = null;\n+        \n+        if ($this->isEmail($primaryContact)) {\n+            $contactEmail = $primaryContact;\n+        } else {\n+            $contactPhone = $primaryContact;\n+        }\n+        \n+        // Auto-detect secondary contact (phone or email)\n+        $secondaryContact = $validatedData['sc_contact_info'] ?? null;\n+        $scPhone = null;\n+        $scEmail = null;\n+        \n+        if ($secondaryContact) {\n+            if ($this->isEmail($secondaryContact)) {\n+                $scEmail = $secondaryContact;\n+            } else {\n+                $scPhone = $secondaryContact;\n+            }\n+        }\n \n-        // Assign initial credit score\n-        $user->creditScore()->create(['score' => 80]);\n+        // Create UserInfo with smart detection\n+        $userInfo = UserInfo::create([\n+            'user_id' => $user->id,\n+            'sector_id' => $validatedData['sector_id'],\n+            'fname' => $validatedData['fname'],\n+            'mname' => $validatedData['mname'],\n+            'lname' => $validatedData['lname'],\n+            'name' => $validatedData['fname'] . ' ' .($validatedData['mname'] ?? ' '). ' ' .$validatedData['lname'],\n+            'suffix' => $validatedData['suffix'],\n+            'birthdate' => $validatedData['birthdate'],\n+            'civil_status' => $validatedData['civil_status'],\n+            'gender' => $validatedData['gender'],\n+            \n+            // Store contact in both formats\n+            'contact_info' => $primaryContact,\n+            'phone_no' => $contactPhone,\n+            'email' => $contactEmail,\n+            \n+            'province' => $validatedData['province'],\n+            'city' => $validatedData['city'],\n+            'house_no' => $validatedData['house_no'],\n+            'barangay' => $validatedData['barangay'],\n+            'zone' => $validatedData['zone'],\n+            'farm_location' => $validatedData['farm_location'],\n+            'land_size' => $validatedData['land_size'],\n+            'water_source' => $validatedData['water_source'],\n+            \n+            // Secondary Contact\n+            'sc_fname' => $validatedData['sc_fname'],\n+            'sc_mname' => $validatedData['sc_mname'],\n+            'sc_lname' => $validatedData['sc_lname'],\n+            'sc_suffix' => $validatedData['sc_suffix'],\n+            'sc_gender' => $validatedData['sc_gender'],\n+            \n+            // Store secondary contact in both formats\n+            'sc_contact_info' => $secondaryContact,\n+            'sc_phone_no' => $scPhone,\n+            'sc_email' => $scEmail,\n+            \n+            'sc_province' => $validatedData['sc_province'],\n+            'sc_city' => $validatedData['sc_city'],\n+            'sc_house_no' => $validatedData['sc_house_no'],\n+            'sc_barangay' => $validatedData['sc_barangay'],\n+            'sc_zone' => $validatedData['sc_zone'],\n+            'relationship' => $validatedData['relationship'],\n+        ]);\n \n-        // Create first history record\n-        $user->creditScoreHistory()->create([\n-            'activity' => 'Membership Approved',\n-            'points' => 80\n+        // Create Application with PENDING status\n+        $application = Application::create([\n+            'user_id' => $user->id,\n+            'grant_id' => null,\n+            'status_id' => 3, // PENDING STATUS // 3 ang pending\n+            'application_type' => 'Membership',\n+            'purpose' => 'Membership Application',\n         ]);\n \n-        // Change user status to member\n-        $user->update(['role_id' => 3]);\n+        // Store Valid ID document\n+        if ($request->hasFile('valid_id')) {\n \n+            $file = $request->file('valid_id');\n+            $filename = time() . '_' . $file->getClientOriginalName();\n+            $path = $file->storeAs('application/membership', $filename, 'public');\n+\n+            // CREATE DOCUMENT ENTRY\n+            $document = Document::create([\n+                'grant_requirement_id' => null,\n+                'membership_requirement_id' => 1, // ⚠️ SET THE VALID ID REQUIREMENT ID HERE\n+                'status_id' => 3, // PENDING STATUS\n+                'file_path' => $path,\n+                'file_name' => $filename,\n+                'documentable_type' => 'App\\Models\\Application',\n+                'documentable_id' => $application->id,\n+            ]);\n+\n+            // Initialize checker\n+            $checker = new DocumentChecker();\n+\n+            // Get requirement name (example: \"Valid ID\")\n+            $requirement = \\App\\Models\\MembershipRequirement::find(1); // SAME ID AS ABOVE\n+            $requirementName = $requirement?->requirement?->requirement_name;\n+\n+            if ($requirementName) {\n+\n+                // RUN AUTO CHECKER (same as web)\n+                $result = $checker->verifyDocumentBelongsToUser(\n+                    storage_path('app/public/' . $path),\n+                    $requirementName,\n+                    $userInfo // same membership owner\n+                );\n+\n+                // UPDATE DOCUMENT WITH RESULT\n+                $document->update([\n+                    'check_result' => $result\n+                ]);\n+            }\n+        }\n+\n+        //create pdf file of the application form\n+        $application->load(['documents', 'status', 'user.user_info']);\n+        $pdf = Pdf::loadView('pdf.membership_application_form', ['application' => $application]);\n+\n+        $fileName = $request->lname . '_membership_application_form_' . $application->id . '.pdf';\n+        $filePath = 'applications/' . $fileName;\n+\n+        Storage::disk('public')->put($filePath, $pdf->output());\n+        $application->update(['form_img' => $filePath]);\n+\n+        //store a confirmation message to table\n+        Notification::create([ \n+            'user_id' => Auth::id(),\n+            'message' => 'Your membership application was submitted successfully and is now pending approval.' ,\n+            'sent_at' => now(),\n+        ]);\n+\n+        // Send SMS to applicant\n+        if ($userInfo && $userInfo->phone_no) {\n+\n+            $number = $userInfo->phone_no;\n+\n+            // Convert \"09...\" to \"639...\"\n+            $number = preg_replace('/^0/', '63', $number);\n+\n+            $message = '[SWISA-AGAP] Your membership application was submitted successfully and is now pending approval.';\n+\n+            SMSService::send($number, $message);\n+        }\n+\n         return response()->json([\n             'success' => true,\n-            'message' => 'Membership application submitted successfully!',\n-            'user_info' => $userInfo\n+            'message' => 'Membership application submitted successfully! Please wait for admin approval.',\n+            'user_info' => $userInfo,\n+            'application' => $application\n         ], 201);\n     }\n-}\n+\n+    /**\n+     * Approve membership application (Admin only)\n+     */\n+    public function approveMembership(Request $request, $applicationId)\n+    {\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already approved\n+        if ($application->status_id == 4) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already approved.'\n+            ], 400);\n+        }\n+        \n+        $user = $application->user;\n+        //$userInfo = $user->userInfo;\n+        \n+        // Update application status to APPROVED\n+        $application->update(['status_id' => 4]); // 4 = Approved\n+        \n+        // Update document status to APPROVED\n+        $application->documents()->update(['status_id' => 4]);\n+        \n+        // Generate QR code\n+        /*if (!$userInfo->qr_code) {\n+            $userInfo->qr_code = Str::uuid()->toString();\n+            $userInfo->save();\n+        }*/\n+        \n+        // Assign initial credit score (if not exists)\n+        if (!$user->creditScore) {\n+            $user->creditScore()->create([\n+                'score' => 20,\n+            ]);\n+            \n+            // Create credit history\n+            $user->creditScoreHistory()->create([\n+                'activity' => 'Membership Approved',\n+                'points' => 20\n+            ]);\n+        }\n+        \n+        // Change user role to member\n+        $user->update(['role_id' => 1]); // 1 ang member nata 2 kinaag mo\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application approved successfully!',\n+            'application' => $application,\n+        ]);\n+    }\n+\n+    /**\n+     * Reject membership application (Admin only)\n+     */\n+    public function rejectMembership(Request $request, $applicationId)\n+    {\n+        $request->validate([\n+            'reason' => 'nullable|string|max:500',\n+        ]);\n+\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already rejected\n+        if ($application->status_id == 6) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already rejected.'\n+            ], 400);\n+        }\n+        \n+        // Update application status to REJECTED\n+        $application->update([\n+            'status_id' => 6, // 6 = Rejected\n+            'rejection_reason' => $request->input('reason'),\n+        ]);\n+        \n+        // Update document status to REJECTED\n+        $application->documents()->update(['status_id' => 6]);\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application rejected.',\n+            'application' => $application,\n+        ]);\n+    }\n+    \n+    /**\n+     * Helper method to detect if input is email\n+     */\n+    private function isEmail($value)\n+    {\n+        return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1765180370097,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -337,5 +337,13 @@\n     private function isEmail($value)\n     {\n         return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n     }\n+        private function createDefaultChatForMember($memberId)\n+    {\n+        \\App\\Models\\Chat::create([\n+            'admin_id' => 1,\n+            'member_id' => $memberId,\n+            'support_staff_id' => null,\n+        ]);\n+    }\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1765180439872,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -257,9 +257,9 @@\n         $application->update(['status_id' => 4]); // 4 = Approved\n         \n         // Update document status to APPROVED\n         $application->documents()->update(['status_id' => 4]);\n-        \n+        $this->createDefaultChatForMember($user->id);\n         // Generate QR code\n         /*if (!$userInfo->qr_code) {\n             $userInfo->qr_code = Str::uuid()->toString();\n             $userInfo->save();\n"
                },
                {
                    "date": 1765180512654,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,349 @@\n+<?php\n+\n+namespace App\\Http\\Controllers\\mobile;\n+\n+use App\\Http\\Controllers\\Controller;\n+use Illuminate\\Http\\Request;\n+use App\\Models\\UserInfo;\n+use App\\Models\\Application;\n+use App\\Models\\Document;\n+use Illuminate\\Support\\Str;\n+use App\\Services\\DocumentChecker;\n+use Barryvdh\\DomPDF\\Facade\\Pdf;\n+use Illuminate\\Support\\Facades\\Storage;\n+use Illuminate\\Support\\Facades\\Auth;\n+use App\\Models\\CreditScore;\n+use App\\Models\\CreditScoreHistory;\n+use App\\Services\\SMSService;\n+use App\\Models\\Notification;\n+\n+class MembershipController extends Controller\n+{\n+    /**\n+     * Submit membership application\n+     */\n+    public function store(Request $request)\n+    {\n+        $validatedData = $request->validate([\n+            'sector_id' => 'required|integer',\n+            'fname' => 'required|string',\n+            'mname' => 'nullable|string',\n+            'lname' => 'required|string',\n+            'suffix' => 'nullable|string',\n+            'birthdate' => 'required|date',\n+            'civil_status' => 'nullable|string',\n+            'gender' => 'required|string',\n+            'contact_info' => 'nullable|string',\n+            'province' => 'required|string',\n+            'city' => 'required|string',\n+            'house_no' => 'nullable|string',\n+            'barangay' => 'required|string',\n+            'zone' => 'required|string',\n+            'farm_location' => 'nullable|string',\n+            'land_size' => 'nullable|string',\n+            'water_source' => 'nullable|string',\n+            'sc_fname' => 'nullable|string',\n+            'sc_mname' => 'nullable|string',\n+            'sc_lname' => 'nullable|string',\n+            'sc_suffix' => 'nullable|string',\n+            'sc_gender' => 'nullable|string',\n+            'sc_contact_info' => 'nullable|string',\n+            'sc_province' => 'nullable|string',\n+            'sc_city' => 'nullable|string',\n+            'sc_house_no' => 'nullable|string',\n+            'sc_barangay' => 'nullable|string',\n+            'sc_zone' => 'nullable|string',\n+            'relationship' => 'nullable|string',\n+            'valid_id' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',\n+        ]);\n+\n+        $user = $request->user();\n+\n+        // Check if user already submitted\n+        if ($user->userInfo) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already submitted.'\n+            ], 409);\n+        }\n+\n+        // Auto-detect primary contact (phone or email)\n+        $primaryContact = $validatedData['contact_info'] ?? null;\n+\n+        $contactPhone = null;\n+        $contactEmail = null;\n+        \n+        if ($this->isEmail($primaryContact)) {\n+            $contactEmail = $primaryContact;\n+        } else {\n+            $contactPhone = $primaryContact;\n+        }\n+        \n+        // Auto-detect secondary contact (phone or email)\n+        $secondaryContact = $validatedData['sc_contact_info'] ?? null;\n+        $scPhone = null;\n+        $scEmail = null;\n+        \n+        if ($secondaryContact) {\n+            if ($this->isEmail($secondaryContact)) {\n+                $scEmail = $secondaryContact;\n+            } else {\n+                $scPhone = $secondaryContact;\n+            }\n+        }\n+\n+        // Create UserInfo with smart detection\n+        $userInfo = UserInfo::create([\n+            'user_id' => $user->id,\n+            'sector_id' => $validatedData['sector_id'],\n+            'fname' => $validatedData['fname'],\n+            'mname' => $validatedData['mname'],\n+            'lname' => $validatedData['lname'],\n+            'name' => $validatedData['fname'] . ' ' .($validatedData['mname'] ?? ' '). ' ' .$validatedData['lname'],\n+            'suffix' => $validatedData['suffix'],\n+            'birthdate' => $validatedData['birthdate'],\n+            'civil_status' => $validatedData['civil_status'],\n+            'gender' => $validatedData['gender'],\n+            \n+            // Store contact in both formats\n+            'contact_info' => $primaryContact,\n+            'phone_no' => $contactPhone,\n+            'email' => $contactEmail,\n+            \n+            'province' => $validatedData['province'],\n+            'city' => $validatedData['city'],\n+            'house_no' => $validatedData['house_no'],\n+            'barangay' => $validatedData['barangay'],\n+            'zone' => $validatedData['zone'],\n+            'farm_location' => $validatedData['farm_location'],\n+            'land_size' => $validatedData['land_size'],\n+            'water_source' => $validatedData['water_source'],\n+            \n+            // Secondary Contact\n+            'sc_fname' => $validatedData['sc_fname'],\n+            'sc_mname' => $validatedData['sc_mname'],\n+            'sc_lname' => $validatedData['sc_lname'],\n+            'sc_suffix' => $validatedData['sc_suffix'],\n+            'sc_gender' => $validatedData['sc_gender'],\n+            \n+            // Store secondary contact in both formats\n+            'sc_contact_info' => $secondaryContact,\n+            'sc_phone_no' => $scPhone,\n+            'sc_email' => $scEmail,\n+            \n+            'sc_province' => $validatedData['sc_province'],\n+            'sc_city' => $validatedData['sc_city'],\n+            'sc_house_no' => $validatedData['sc_house_no'],\n+            'sc_barangay' => $validatedData['sc_barangay'],\n+            'sc_zone' => $validatedData['sc_zone'],\n+            'relationship' => $validatedData['relationship'],\n+        ]);\n+\n+        // Create Application with PENDING status\n+        $application = Application::create([\n+            'user_id' => $user->id,\n+            'grant_id' => null,\n+            'status_id' => 3, // PENDING STATUS // 3 ang pending\n+            'application_type' => 'Membership',\n+            'purpose' => 'Membership Application',\n+        ]);\n+\n+        // Store Valid ID document\n+        if ($request->hasFile('valid_id')) {\n+\n+            $file = $request->file('valid_id');\n+            $filename = time() . '_' . $file->getClientOriginalName();\n+            $path = $file->storeAs('application/membership', $filename, 'public');\n+\n+            // CREATE DOCUMENT ENTRY\n+            $document = Document::create([\n+                'grant_requirement_id' => null,\n+                'membership_requirement_id' => 1, // ⚠️ SET THE VALID ID REQUIREMENT ID HERE\n+                'status_id' => 3, // PENDING STATUS\n+                'file_path' => $path,\n+                'file_name' => $filename,\n+                'documentable_type' => 'App\\Models\\Application',\n+                'documentable_id' => $application->id,\n+            ]);\n+\n+            // Initialize checker\n+            $checker = new DocumentChecker();\n+\n+            // Get requirement name (example: \"Valid ID\")\n+            $requirement = \\App\\Models\\MembershipRequirement::find(1); // SAME ID AS ABOVE\n+            $requirementName = $requirement?->requirement?->requirement_name;\n+\n+            if ($requirementName) {\n+\n+                // RUN AUTO CHECKER (same as web)\n+                $result = $checker->verifyDocumentBelongsToUser(\n+                    storage_path('app/public/' . $path),\n+                    $requirementName,\n+                    $userInfo // same membership owner\n+                );\n+\n+                // UPDATE DOCUMENT WITH RESULT\n+                $document->update([\n+                    'check_result' => $result\n+                ]);\n+            }\n+        }\n+\n+        //create pdf file of the application form\n+        $application->load(['documents', 'status', 'user.user_info']);\n+        $pdf = Pdf::loadView('pdf.membership_application_form', ['application' => $application]);\n+\n+        $fileName = $request->lname . '_membership_application_form_' . $application->id . '.pdf';\n+        $filePath = 'applications/' . $fileName;\n+\n+        Storage::disk('public')->put($filePath, $pdf->output());\n+        $application->update(['form_img' => $filePath]);\n+\n+        //store a confirmation message to table\n+        Notification::create([ \n+            'user_id' => Auth::id(),\n+            'message' => 'Your membership application was submitted successfully and is now pending approval.' ,\n+            'sent_at' => now(),\n+        ]);\n+\n+        // Send SMS to applicant\n+        if ($userInfo && $userInfo->phone_no) {\n+\n+            $number = $userInfo->phone_no;\n+\n+            // Convert \"09...\" to \"639...\"\n+            $number = preg_replace('/^0/', '63', $number);\n+\n+            $message = '[SWISA-AGAP] Your membership application was submitted successfully and is now pending approval.';\n+\n+            SMSService::send($number, $message);\n+        }\n+\n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application submitted successfully! Please wait for admin approval.',\n+            'user_info' => $userInfo,\n+            'application' => $application\n+        ], 201);\n+    }\n+\n+    /**\n+     * Approve membership application (Admin only)\n+     */\n+    public function approveMembership(Request $request, $applicationId)\n+    {\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already approved\n+        if ($application->status_id == 4) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already approved.'\n+            ], 400);\n+        }\n+        \n+        $user = $application->user;\n+        //$userInfo = $user->userInfo;\n+        \n+        // Update application status to APPROVED\n+        $application->update(['status_id' => 4]); // 4 = Approved\n+        \n+        // Update document status to APPROVED\n+        $application->documents()->update(['status_id' => 4]);\n+        \n+        // Generate QR code\n+        /*if (!$userInfo->qr_code) {\n+            $userInfo->qr_code = Str::uuid()->toString();\n+            $userInfo->save();\n+        }*/\n+        \n+        // Assign initial credit score (if not exists)\n+        if (!$user->creditScore) {\n+            $user->creditScore()->create([\n+                'score' => 20,\n+            ]);\n+            \n+            // Create credit history\n+            $user->creditScoreHistory()->create([\n+                'activity' => 'Membership Approved',\n+                'points' => 20\n+            ]);\n+        }\n+        \n+        // Change user role to member\n+        $user->update(['role_id' => 1]); // 1 ang member nata 2 kinaag mo\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application approved successfully!',\n+            'application' => $application,\n+        ]);\n+    }\n+\n+    /**\n+     * Reject membership application (Admin only)\n+     */\n+    public function rejectMembership(Request $request, $applicationId)\n+    {\n+        $request->validate([\n+            'reason' => 'nullable|string|max:500',\n+        ]);\n+\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already rejected\n+        if ($application->status_id == 6) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already rejected.'\n+            ], 400);\n+        }\n+        \n+        // Update application status to REJECTED\n+        $application->update([\n+            'status_id' => 6, // 6 = Rejected\n+            'rejection_reason' => $request->input('reason'),\n+        ]);\n+        \n+        // Update document status to REJECTED\n+        $application->documents()->update(['status_id' => 6]);\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application rejected.',\n+            'application' => $application,\n+        ]);\n+    }\n+    \n+    /**\n+     * Helper method to detect if input is email\n+     */\n+    private function isEmail($value)\n+    {\n+        return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n+    }\n+        private function createDefaultChatForMember($memberId)\n+    {\n+        \\App\\Models\\Chat::create([\n+            'admin_id' => 1,\n+            'member_id' => $memberId,\n+            'support_staff_id' => null,\n+        ]);\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1765180579584,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,345 @@\n+<?php\n+\n+namespace App\\Http\\Controllers\\mobile;\n+\n+use App\\Http\\Controllers\\Controller;\n+use Illuminate\\Http\\Request;\n+use App\\Models\\UserInfo;\n+use App\\Models\\Application;\n+use App\\Models\\Document;\n+use Illuminate\\Support\\Str;\n+use App\\Services\\DocumentChecker;\n+use Barryvdh\\DomPDF\\Facade\\Pdf;\n+use Illuminate\\Support\\Facades\\Storage;\n+use Illuminate\\Support\\Facades\\Auth;\n+use App\\Models\\CreditScore;\n+use App\\Models\\CreditScoreHistory;\n+use App\\Services\\SMSService;\n+use App\\Models\\Notification;\n+\n+class MembershipController extends Controller\n+{\n+    /**\n+     * Submit membership application\n+     */\n+    public function store(Request $request)\n+    {\n+        $validatedData = $request->validate([\n+            'sector_id' => 'required|integer',\n+            'fname' => 'required|string',\n+            'mname' => 'nullable|string',\n+            'lname' => 'required|string',\n+            'suffix' => 'nullable|string',\n+            'birthdate' => 'required|date',\n+            'civil_status' => 'nullable|string',\n+            'gender' => 'required|string',\n+            'contact_info' => 'nullable|string',\n+            'province' => 'required|string',\n+            'city' => 'required|string',\n+            'house_no' => 'nullable|string',\n+            'barangay' => 'required|string',\n+            'zone' => 'required|string',\n+            'farm_location' => 'nullable|string',\n+            'land_size' => 'nullable|string',\n+            'water_source' => 'nullable|string',\n+            'sc_fname' => 'nullable|string',\n+            'sc_mname' => 'nullable|string',\n+            'sc_lname' => 'nullable|string',\n+            'sc_suffix' => 'nullable|string',\n+            'sc_gender' => 'nullable|string',\n+            'sc_contact_info' => 'nullable|string',\n+            'sc_province' => 'nullable|string',\n+            'sc_city' => 'nullable|string',\n+            'sc_house_no' => 'nullable|string',\n+            'sc_barangay' => 'nullable|string',\n+            'sc_zone' => 'nullable|string',\n+            'relationship' => 'nullable|string',\n+            'valid_id' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',\n+        ]);\n+\n+        $user = $request->user();\n+\n+        // Check if user already submitted\n+        if ($user->userInfo) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already submitted.'\n+            ], 409);\n+        }\n+\n+        // Auto-detect primary contact (phone or email)\n+        $primaryContact = $validatedData['contact_info'] ?? null;\n+\n+        $contactPhone = null;\n+        $contactEmail = null;\n+        \n+        if ($this->isEmail($primaryContact)) {\n+            $contactEmail = $primaryContact;\n+        } else {\n+            $contactPhone = $primaryContact;\n+        }\n+        \n+        // Auto-detect secondary contact (phone or email)\n+        $secondaryContact = $validatedData['sc_contact_info'] ?? null;\n+        $scPhone = null;\n+        $scEmail = null;\n+        \n+        if ($secondaryContact) {\n+            if ($this->isEmail($secondaryContact)) {\n+                $scEmail = $secondaryContact;\n+            } else {\n+                $scPhone = $secondaryContact;\n+            }\n+        }\n+\n+        // Create UserInfo with smart detection\n+        $userInfo = UserInfo::create([\n+            'user_id' => $user->id,\n+            'sector_id' => $validatedData['sector_id'],\n+            'fname' => $validatedData['fname'],\n+            'mname' => $validatedData['mname'],\n+            'lname' => $validatedData['lname'],\n+            'name' => $validatedData['fname'] . ' ' .($validatedData['mname'] ?? ' '). ' ' .$validatedData['lname'],\n+            'suffix' => $validatedData['suffix'],\n+            'birthdate' => $validatedData['birthdate'],\n+            'civil_status' => $validatedData['civil_status'],\n+            'gender' => $validatedData['gender'],\n+            \n+            // Store contact in both formats\n+            'contact_info' => $primaryContact,\n+            'phone_no' => $contactPhone,\n+            'email' => $contactEmail,\n+            \n+            'province' => $validatedData['province'],\n+            'city' => $validatedData['city'],\n+            'house_no' => $validatedData['house_no'],\n+            'barangay' => $validatedData['barangay'],\n+            'zone' => $validatedData['zone'],\n+            'farm_location' => $validatedData['farm_location'],\n+            'land_size' => $validatedData['land_size'],\n+            'water_source' => $validatedData['water_source'],\n+            \n+            // Secondary Contact\n+            'sc_fname' => $validatedData['sc_fname'],\n+            'sc_mname' => $validatedData['sc_mname'],\n+            'sc_lname' => $validatedData['sc_lname'],\n+            'sc_suffix' => $validatedData['sc_suffix'],\n+            'sc_gender' => $validatedData['sc_gender'],\n+            \n+            // Store secondary contact in both formats\n+            'sc_contact_info' => $secondaryContact,\n+            'sc_phone_no' => $scPhone,\n+            'sc_email' => $scEmail,\n+            \n+            'sc_province' => $validatedData['sc_province'],\n+            'sc_city' => $validatedData['sc_city'],\n+            'sc_house_no' => $validatedData['sc_house_no'],\n+            'sc_barangay' => $validatedData['sc_barangay'],\n+            'sc_zone' => $validatedData['sc_zone'],\n+            'relationship' => $validatedData['relationship'],\n+        ]);\n+\n+        // Create Application with PENDING status\n+        $application = Application::create([\n+            'user_id' => $user->id,\n+            'grant_id' => null,\n+            'status_id' => 3, // PENDING STATUS // 3 ang pending\n+            'application_type' => 'Membership',\n+            'purpose' => 'Membership Application',\n+        ]);\n+\n+        // Store Valid ID document\n+        if ($request->hasFile('valid_id')) {\n+\n+            $file = $request->file('valid_id');\n+            $filename = time() . '_' . $file->getClientOriginalName();\n+            $path = $file->storeAs('application/membership', $filename, 'public');\n+\n+            // CREATE DOCUMENT ENTRY\n+            $document = Document::create([\n+                'grant_requirement_id' => null,\n+                'membership_requirement_id' => 1, // ⚠️ SET THE VALID ID REQUIREMENT ID HERE\n+                'status_id' => 3, // PENDING STATUS\n+                'file_path' => $path,\n+                'file_name' => $filename,\n+                'documentable_type' => 'App\\Models\\Application',\n+                'documentable_id' => $application->id,\n+            ]);\n+\n+            // Initialize checker\n+            $checker = new DocumentChecker();\n+\n+            // Get requirement name (example: \"Valid ID\")\n+            $requirement = \\App\\Models\\MembershipRequirement::find(1); // SAME ID AS ABOVE\n+            $requirementName = $requirement?->requirement?->requirement_name;\n+\n+            if ($requirementName) {\n+\n+                // RUN AUTO CHECKER (same as web)\n+                $result = $checker->verifyDocumentBelongsToUser(\n+                    storage_path('app/public/' . $path),\n+                    $requirementName,\n+                    $userInfo // same membership owner\n+                );\n+\n+                // UPDATE DOCUMENT WITH RESULT\n+                $document->update([\n+                    'check_result' => $result\n+                ]);\n+            }\n+        }\n+\n+        //create pdf file of the application form\n+        $application->load(['documents', 'status', 'user.user_info']);\n+        $pdf = Pdf::loadView('pdf.membership_application_form', ['application' => $application]);\n+\n+        $fileName = $request->lname . '_membership_application_form_' . $application->id . '.pdf';\n+        $filePath = 'applications/' . $fileName;\n+\n+        Storage::disk('public')->put($filePath, $pdf->output());\n+        $application->update(['form_img' => $filePath]);\n+\n+        //store a confirmation message to table\n+        Notification::create([ \n+            'user_id' => Auth::id(),\n+            'message' => 'Your membership application was submitted successfully and is now pending approval.' ,\n+            'sent_at' => now(),\n+        ]);\n+\n+        // Send SMS to applicant\n+        if ($userInfo && $userInfo->phone_no) {\n+\n+            $number = $userInfo->phone_no;\n+\n+            // Convert \"09...\" to \"639...\"\n+            $number = preg_replace('/^0/', '63', $number);\n+\n+            $message = '[SWISA-AGAP] Your membership application was submitted successfully and is now pending approval.';\n+\n+            SMSService::send($number, $message);\n+        }\n+\n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application submitted successfully! Please wait for admin approval.',\n+            'user_info' => $userInfo,\n+            'application' => $application\n+        ], 201);\n+    }\n+\n+    /**\n+     * Approve membership application (Admin only)\n+     */\n+public function approveMembership(Request $request, $applicationId)\n+{\n+    $application = Application::findOrFail($applicationId);\n+    \n+    // Check if application is for membership\n+    if ($application->application_type !== 'Membership') {\n+        return response()->json([\n+            'success' => false,\n+            'message' => 'This is not a membership application.'\n+        ], 400);\n+    }\n+    \n+    // Check if already approved\n+    if ($application->status_id == 4) {\n+        return response()->json([\n+            'success' => false,\n+            'message' => 'Application already approved.'\n+        ], 400);\n+    }\n+    \n+    $user = $application->user;\n+    \n+    // Update application status to APPROVED\n+    $application->update(['status_id' => 4]); // 4 = Approved\n+    \n+    // Update document status to APPROVED\n+    $application->documents()->update(['status_id' => 4]);\n+    \n+    // Assign initial credit score (if not exists)\n+    if (!$user->creditScore) {\n+        $user->creditScore()->create([\n+            'score' => 20,\n+        ]);\n+        \n+        // Create credit history\n+        $user->creditScoreHistory()->create([\n+            'activity' => 'Membership Approved',\n+            'points' => 20\n+        ]);\n+    }\n+    \n+    // Change user role to member\n+    $user->update(['role_id' => 1]);\n+\n+    // Create default chat relationship for the approved member\n+    $this->createDefaultChatForMember($user->id);\n+    \n+    return response()->json([\n+        'success' => true,\n+        'message' => 'Membership application approved successfully!',\n+        'application' => $application,\n+    ]);\n+}\n+\n+    /**\n+     * Reject membership application (Admin only)\n+     */\n+    public function rejectMembership(Request $request, $applicationId)\n+    {\n+        $request->validate([\n+            'reason' => 'nullable|string|max:500',\n+        ]);\n+\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already rejected\n+        if ($application->status_id == 6) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already rejected.'\n+            ], 400);\n+        }\n+        \n+        // Update application status to REJECTED\n+        $application->update([\n+            'status_id' => 6, // 6 = Rejected\n+            'rejection_reason' => $request->input('reason'),\n+        ]);\n+        \n+        // Update document status to REJECTED\n+        $application->documents()->update(['status_id' => 6]);\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application rejected.',\n+            'application' => $application,\n+        ]);\n+    }\n+    \n+    /**\n+     * Helper method to detect if input is email\n+     */\n+    private function isEmail($value)\n+    {\n+        return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n+    }\n+        private function createDefaultChatForMember($memberId)\n+    {\n+        \\App\\Models\\Chat::create([\n+            'admin_id' => 1,\n+            'member_id' => $memberId,\n+            'support_staff_id' => null,\n+        ]);\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1765180594968,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,349 @@\n+<?php\n+\n+namespace App\\Http\\Controllers\\mobile;\n+\n+use App\\Http\\Controllers\\Controller;\n+use Illuminate\\Http\\Request;\n+use App\\Models\\UserInfo;\n+use App\\Models\\Application;\n+use App\\Models\\Document;\n+use Illuminate\\Support\\Str;\n+use App\\Services\\DocumentChecker;\n+use Barryvdh\\DomPDF\\Facade\\Pdf;\n+use Illuminate\\Support\\Facades\\Storage;\n+use Illuminate\\Support\\Facades\\Auth;\n+use App\\Models\\CreditScore;\n+use App\\Models\\CreditScoreHistory;\n+use App\\Services\\SMSService;\n+use App\\Models\\Notification;\n+\n+class MembershipController extends Controller\n+{\n+    /**\n+     * Submit membership application\n+     */\n+    public function store(Request $request)\n+    {\n+        $validatedData = $request->validate([\n+            'sector_id' => 'required|integer',\n+            'fname' => 'required|string',\n+            'mname' => 'nullable|string',\n+            'lname' => 'required|string',\n+            'suffix' => 'nullable|string',\n+            'birthdate' => 'required|date',\n+            'civil_status' => 'nullable|string',\n+            'gender' => 'required|string',\n+            'contact_info' => 'nullable|string',\n+            'province' => 'required|string',\n+            'city' => 'required|string',\n+            'house_no' => 'nullable|string',\n+            'barangay' => 'required|string',\n+            'zone' => 'required|string',\n+            'farm_location' => 'nullable|string',\n+            'land_size' => 'nullable|string',\n+            'water_source' => 'nullable|string',\n+            'sc_fname' => 'nullable|string',\n+            'sc_mname' => 'nullable|string',\n+            'sc_lname' => 'nullable|string',\n+            'sc_suffix' => 'nullable|string',\n+            'sc_gender' => 'nullable|string',\n+            'sc_contact_info' => 'nullable|string',\n+            'sc_province' => 'nullable|string',\n+            'sc_city' => 'nullable|string',\n+            'sc_house_no' => 'nullable|string',\n+            'sc_barangay' => 'nullable|string',\n+            'sc_zone' => 'nullable|string',\n+            'relationship' => 'nullable|string',\n+            'valid_id' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',\n+        ]);\n+\n+        $user = $request->user();\n+\n+        // Check if user already submitted\n+        if ($user->userInfo) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already submitted.'\n+            ], 409);\n+        }\n+\n+        // Auto-detect primary contact (phone or email)\n+        $primaryContact = $validatedData['contact_info'] ?? null;\n+\n+        $contactPhone = null;\n+        $contactEmail = null;\n+        \n+        if ($this->isEmail($primaryContact)) {\n+            $contactEmail = $primaryContact;\n+        } else {\n+            $contactPhone = $primaryContact;\n+        }\n+        \n+        // Auto-detect secondary contact (phone or email)\n+        $secondaryContact = $validatedData['sc_contact_info'] ?? null;\n+        $scPhone = null;\n+        $scEmail = null;\n+        \n+        if ($secondaryContact) {\n+            if ($this->isEmail($secondaryContact)) {\n+                $scEmail = $secondaryContact;\n+            } else {\n+                $scPhone = $secondaryContact;\n+            }\n+        }\n+\n+        // Create UserInfo with smart detection\n+        $userInfo = UserInfo::create([\n+            'user_id' => $user->id,\n+            'sector_id' => $validatedData['sector_id'],\n+            'fname' => $validatedData['fname'],\n+            'mname' => $validatedData['mname'],\n+            'lname' => $validatedData['lname'],\n+            'name' => $validatedData['fname'] . ' ' .($validatedData['mname'] ?? ' '). ' ' .$validatedData['lname'],\n+            'suffix' => $validatedData['suffix'],\n+            'birthdate' => $validatedData['birthdate'],\n+            'civil_status' => $validatedData['civil_status'],\n+            'gender' => $validatedData['gender'],\n+            \n+            // Store contact in both formats\n+            'contact_info' => $primaryContact,\n+            'phone_no' => $contactPhone,\n+            'email' => $contactEmail,\n+            \n+            'province' => $validatedData['province'],\n+            'city' => $validatedData['city'],\n+            'house_no' => $validatedData['house_no'],\n+            'barangay' => $validatedData['barangay'],\n+            'zone' => $validatedData['zone'],\n+            'farm_location' => $validatedData['farm_location'],\n+            'land_size' => $validatedData['land_size'],\n+            'water_source' => $validatedData['water_source'],\n+            \n+            // Secondary Contact\n+            'sc_fname' => $validatedData['sc_fname'],\n+            'sc_mname' => $validatedData['sc_mname'],\n+            'sc_lname' => $validatedData['sc_lname'],\n+            'sc_suffix' => $validatedData['sc_suffix'],\n+            'sc_gender' => $validatedData['sc_gender'],\n+            \n+            // Store secondary contact in both formats\n+            'sc_contact_info' => $secondaryContact,\n+            'sc_phone_no' => $scPhone,\n+            'sc_email' => $scEmail,\n+            \n+            'sc_province' => $validatedData['sc_province'],\n+            'sc_city' => $validatedData['sc_city'],\n+            'sc_house_no' => $validatedData['sc_house_no'],\n+            'sc_barangay' => $validatedData['sc_barangay'],\n+            'sc_zone' => $validatedData['sc_zone'],\n+            'relationship' => $validatedData['relationship'],\n+        ]);\n+\n+        // Create Application with PENDING status\n+        $application = Application::create([\n+            'user_id' => $user->id,\n+            'grant_id' => null,\n+            'status_id' => 3, // PENDING STATUS // 3 ang pending\n+            'application_type' => 'Membership',\n+            'purpose' => 'Membership Application',\n+        ]);\n+\n+        // Store Valid ID document\n+        if ($request->hasFile('valid_id')) {\n+\n+            $file = $request->file('valid_id');\n+            $filename = time() . '_' . $file->getClientOriginalName();\n+            $path = $file->storeAs('application/membership', $filename, 'public');\n+\n+            // CREATE DOCUMENT ENTRY\n+            $document = Document::create([\n+                'grant_requirement_id' => null,\n+                'membership_requirement_id' => 1, // ⚠️ SET THE VALID ID REQUIREMENT ID HERE\n+                'status_id' => 3, // PENDING STATUS\n+                'file_path' => $path,\n+                'file_name' => $filename,\n+                'documentable_type' => 'App\\Models\\Application',\n+                'documentable_id' => $application->id,\n+            ]);\n+\n+            // Initialize checker\n+            $checker = new DocumentChecker();\n+\n+            // Get requirement name (example: \"Valid ID\")\n+            $requirement = \\App\\Models\\MembershipRequirement::find(1); // SAME ID AS ABOVE\n+            $requirementName = $requirement?->requirement?->requirement_name;\n+\n+            if ($requirementName) {\n+\n+                // RUN AUTO CHECKER (same as web)\n+                $result = $checker->verifyDocumentBelongsToUser(\n+                    storage_path('app/public/' . $path),\n+                    $requirementName,\n+                    $userInfo // same membership owner\n+                );\n+\n+                // UPDATE DOCUMENT WITH RESULT\n+                $document->update([\n+                    'check_result' => $result\n+                ]);\n+            }\n+        }\n+\n+        //create pdf file of the application form\n+        $application->load(['documents', 'status', 'user.user_info']);\n+        $pdf = Pdf::loadView('pdf.membership_application_form', ['application' => $application]);\n+\n+        $fileName = $request->lname . '_membership_application_form_' . $application->id . '.pdf';\n+        $filePath = 'applications/' . $fileName;\n+\n+        Storage::disk('public')->put($filePath, $pdf->output());\n+        $application->update(['form_img' => $filePath]);\n+\n+        //store a confirmation message to table\n+        Notification::create([ \n+            'user_id' => Auth::id(),\n+            'message' => 'Your membership application was submitted successfully and is now pending approval.' ,\n+            'sent_at' => now(),\n+        ]);\n+\n+        // Send SMS to applicant\n+        if ($userInfo && $userInfo->phone_no) {\n+\n+            $number = $userInfo->phone_no;\n+\n+            // Convert \"09...\" to \"639...\"\n+            $number = preg_replace('/^0/', '63', $number);\n+\n+            $message = '[SWISA-AGAP] Your membership application was submitted successfully and is now pending approval.';\n+\n+            SMSService::send($number, $message);\n+        }\n+\n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application submitted successfully! Please wait for admin approval.',\n+            'user_info' => $userInfo,\n+            'application' => $application\n+        ], 201);\n+    }\n+\n+    /**\n+     * Approve membership application (Admin only)\n+     */\n+    public function approveMembership(Request $request, $applicationId)\n+    {\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already approved\n+        if ($application->status_id == 4) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already approved.'\n+            ], 400);\n+        }\n+        \n+        $user = $application->user;\n+        //$userInfo = $user->userInfo;\n+        \n+        // Update application status to APPROVED\n+        $application->update(['status_id' => 4]); // 4 = Approved\n+        \n+        // Update document status to APPROVED\n+        $application->documents()->update(['status_id' => 4]);\n+        \n+        // Generate QR code\n+        /*if (!$userInfo->qr_code) {\n+            $userInfo->qr_code = Str::uuid()->toString();\n+            $userInfo->save();\n+        }*/\n+        \n+        // Assign initial credit score (if not exists)\n+        if (!$user->creditScore) {\n+            $user->creditScore()->create([\n+                'score' => 20,\n+            ]);\n+            \n+            // Create credit history\n+            $user->creditScoreHistory()->create([\n+                'activity' => 'Membership Approved',\n+                'points' => 20\n+            ]);\n+        }\n+        \n+        // Change user role to member\n+        $user->update(['role_id' => 1]); // 1 ang member nata 2 kinaag mo\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application approved successfully!',\n+            'application' => $application,\n+        ]);\n+    }\n+\n+    /**\n+     * Reject membership application (Admin only)\n+     */\n+    public function rejectMembership(Request $request, $applicationId)\n+    {\n+        $request->validate([\n+            'reason' => 'nullable|string|max:500',\n+        ]);\n+\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already rejected\n+        if ($application->status_id == 6) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already rejected.'\n+            ], 400);\n+        }\n+        \n+        // Update application status to REJECTED\n+        $application->update([\n+            'status_id' => 6, // 6 = Rejected\n+            'rejection_reason' => $request->input('reason'),\n+        ]);\n+        \n+        // Update document status to REJECTED\n+        $application->documents()->update(['status_id' => 6]);\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application rejected.',\n+            'application' => $application,\n+        ]);\n+    }\n+    \n+    /**\n+     * Helper method to detect if input is email\n+     */\n+    private function isEmail($value)\n+    {\n+        return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n+    }\n+        private function createDefaultChatForMember($memberId)\n+    {\n+        \\App\\Models\\Chat::create([\n+            'admin_id' => 1,\n+            'member_id' => $memberId,\n+            'support_staff_id' => null,\n+        ]);\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1765180640406,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -345,1048 +345,5 @@\n             'member_id' => $memberId,\n             'support_staff_id' => null,\n         ]);\n     }\n-}\n-<?php\n-\n-namespace App\\Http\\Controllers\\mobile;\n-\n-use App\\Http\\Controllers\\Controller;\n-use Illuminate\\Http\\Request;\n-use App\\Models\\UserInfo;\n-use App\\Models\\Application;\n-use App\\Models\\Document;\n-use Illuminate\\Support\\Str;\n-use App\\Services\\DocumentChecker;\n-use Barryvdh\\DomPDF\\Facade\\Pdf;\n-use Illuminate\\Support\\Facades\\Storage;\n-use Illuminate\\Support\\Facades\\Auth;\n-use App\\Models\\CreditScore;\n-use App\\Models\\CreditScoreHistory;\n-use App\\Services\\SMSService;\n-use App\\Models\\Notification;\n-\n-class MembershipController extends Controller\n-{\n-    /**\n-     * Submit membership application\n-     */\n-    public function store(Request $request)\n-    {\n-        $validatedData = $request->validate([\n-            'sector_id' => 'required|integer',\n-            'fname' => 'required|string',\n-            'mname' => 'nullable|string',\n-            'lname' => 'required|string',\n-            'suffix' => 'nullable|string',\n-            'birthdate' => 'required|date',\n-            'civil_status' => 'nullable|string',\n-            'gender' => 'required|string',\n-            'contact_info' => 'nullable|string',\n-            'province' => 'required|string',\n-            'city' => 'required|string',\n-            'house_no' => 'nullable|string',\n-            'barangay' => 'required|string',\n-            'zone' => 'required|string',\n-            'farm_location' => 'nullable|string',\n-            'land_size' => 'nullable|string',\n-            'water_source' => 'nullable|string',\n-            'sc_fname' => 'nullable|string',\n-            'sc_mname' => 'nullable|string',\n-            'sc_lname' => 'nullable|string',\n-            'sc_suffix' => 'nullable|string',\n-            'sc_gender' => 'nullable|string',\n-            'sc_contact_info' => 'nullable|string',\n-            'sc_province' => 'nullable|string',\n-            'sc_city' => 'nullable|string',\n-            'sc_house_no' => 'nullable|string',\n-            'sc_barangay' => 'nullable|string',\n-            'sc_zone' => 'nullable|string',\n-            'relationship' => 'nullable|string',\n-            'valid_id' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',\n-        ]);\n-\n-        $user = $request->user();\n-\n-        // Check if user already submitted\n-        if ($user->userInfo) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already submitted.'\n-            ], 409);\n-        }\n-\n-        // Auto-detect primary contact (phone or email)\n-        $primaryContact = $validatedData['contact_info'] ?? null;\n-\n-        $contactPhone = null;\n-        $contactEmail = null;\n-        \n-        if ($this->isEmail($primaryContact)) {\n-            $contactEmail = $primaryContact;\n-        } else {\n-            $contactPhone = $primaryContact;\n-        }\n-        \n-        // Auto-detect secondary contact (phone or email)\n-        $secondaryContact = $validatedData['sc_contact_info'] ?? null;\n-        $scPhone = null;\n-        $scEmail = null;\n-        \n-        if ($secondaryContact) {\n-            if ($this->isEmail($secondaryContact)) {\n-                $scEmail = $secondaryContact;\n-            } else {\n-                $scPhone = $secondaryContact;\n-            }\n-        }\n-\n-        // Create UserInfo with smart detection\n-        $userInfo = UserInfo::create([\n-            'user_id' => $user->id,\n-            'sector_id' => $validatedData['sector_id'],\n-            'fname' => $validatedData['fname'],\n-            'mname' => $validatedData['mname'],\n-            'lname' => $validatedData['lname'],\n-            'name' => $validatedData['fname'] . ' ' .($validatedData['mname'] ?? ' '). ' ' .$validatedData['lname'],\n-            'suffix' => $validatedData['suffix'],\n-            'birthdate' => $validatedData['birthdate'],\n-            'civil_status' => $validatedData['civil_status'],\n-            'gender' => $validatedData['gender'],\n-            \n-            // Store contact in both formats\n-            'contact_info' => $primaryContact,\n-            'phone_no' => $contactPhone,\n-            'email' => $contactEmail,\n-            \n-            'province' => $validatedData['province'],\n-            'city' => $validatedData['city'],\n-            'house_no' => $validatedData['house_no'],\n-            'barangay' => $validatedData['barangay'],\n-            'zone' => $validatedData['zone'],\n-            'farm_location' => $validatedData['farm_location'],\n-            'land_size' => $validatedData['land_size'],\n-            'water_source' => $validatedData['water_source'],\n-            \n-            // Secondary Contact\n-            'sc_fname' => $validatedData['sc_fname'],\n-            'sc_mname' => $validatedData['sc_mname'],\n-            'sc_lname' => $validatedData['sc_lname'],\n-            'sc_suffix' => $validatedData['sc_suffix'],\n-            'sc_gender' => $validatedData['sc_gender'],\n-            \n-            // Store secondary contact in both formats\n-            'sc_contact_info' => $secondaryContact,\n-            'sc_phone_no' => $scPhone,\n-            'sc_email' => $scEmail,\n-            \n-            'sc_province' => $validatedData['sc_province'],\n-            'sc_city' => $validatedData['sc_city'],\n-            'sc_house_no' => $validatedData['sc_house_no'],\n-            'sc_barangay' => $validatedData['sc_barangay'],\n-            'sc_zone' => $validatedData['sc_zone'],\n-            'relationship' => $validatedData['relationship'],\n-        ]);\n-\n-        // Create Application with PENDING status\n-        $application = Application::create([\n-            'user_id' => $user->id,\n-            'grant_id' => null,\n-            'status_id' => 3, // PENDING STATUS // 3 ang pending\n-            'application_type' => 'Membership',\n-            'purpose' => 'Membership Application',\n-        ]);\n-\n-        // Store Valid ID document\n-        if ($request->hasFile('valid_id')) {\n-\n-            $file = $request->file('valid_id');\n-            $filename = time() . '_' . $file->getClientOriginalName();\n-            $path = $file->storeAs('application/membership', $filename, 'public');\n-\n-            // CREATE DOCUMENT ENTRY\n-            $document = Document::create([\n-                'grant_requirement_id' => null,\n-                'membership_requirement_id' => 1, // ⚠️ SET THE VALID ID REQUIREMENT ID HERE\n-                'status_id' => 3, // PENDING STATUS\n-                'file_path' => $path,\n-                'file_name' => $filename,\n-                'documentable_type' => 'App\\Models\\Application',\n-                'documentable_id' => $application->id,\n-            ]);\n-\n-            // Initialize checker\n-            $checker = new DocumentChecker();\n-\n-            // Get requirement name (example: \"Valid ID\")\n-            $requirement = \\App\\Models\\MembershipRequirement::find(1); // SAME ID AS ABOVE\n-            $requirementName = $requirement?->requirement?->requirement_name;\n-\n-            if ($requirementName) {\n-\n-                // RUN AUTO CHECKER (same as web)\n-                $result = $checker->verifyDocumentBelongsToUser(\n-                    storage_path('app/public/' . $path),\n-                    $requirementName,\n-                    $userInfo // same membership owner\n-                );\n-\n-                // UPDATE DOCUMENT WITH RESULT\n-                $document->update([\n-                    'check_result' => $result\n-                ]);\n-            }\n-        }\n-\n-        //create pdf file of the application form\n-        $application->load(['documents', 'status', 'user.user_info']);\n-        $pdf = Pdf::loadView('pdf.membership_application_form', ['application' => $application]);\n-\n-        $fileName = $request->lname . '_membership_application_form_' . $application->id . '.pdf';\n-        $filePath = 'applications/' . $fileName;\n-\n-        Storage::disk('public')->put($filePath, $pdf->output());\n-        $application->update(['form_img' => $filePath]);\n-\n-        //store a confirmation message to table\n-        Notification::create([ \n-            'user_id' => Auth::id(),\n-            'message' => 'Your membership application was submitted successfully and is now pending approval.' ,\n-            'sent_at' => now(),\n-        ]);\n-\n-        // Send SMS to applicant\n-        if ($userInfo && $userInfo->phone_no) {\n-\n-            $number = $userInfo->phone_no;\n-\n-            // Convert \"09...\" to \"639...\"\n-            $number = preg_replace('/^0/', '63', $number);\n-\n-            $message = '[SWISA-AGAP] Your membership application was submitted successfully and is now pending approval.';\n-\n-            SMSService::send($number, $message);\n-        }\n-\n-        return response()->json([\n-            'success' => true,\n-            'message' => 'Membership application submitted successfully! Please wait for admin approval.',\n-            'user_info' => $userInfo,\n-            'application' => $application\n-        ], 201);\n-    }\n-\n-    /**\n-     * Approve membership application (Admin only)\n-     */\n-public function approveMembership(Request $request, $applicationId)\n-{\n-    $application = Application::findOrFail($applicationId);\n-    \n-    // Check if application is for membership\n-    if ($application->application_type !== 'Membership') {\n-        return response()->json([\n-            'success' => false,\n-            'message' => 'This is not a membership application.'\n-        ], 400);\n-    }\n-    \n-    // Check if already approved\n-    if ($application->status_id == 4) {\n-        return response()->json([\n-            'success' => false,\n-            'message' => 'Application already approved.'\n-        ], 400);\n-    }\n-    \n-    $user = $application->user;\n-    \n-    // Update application status to APPROVED\n-    $application->update(['status_id' => 4]); // 4 = Approved\n-    \n-    // Update document status to APPROVED\n-    $application->documents()->update(['status_id' => 4]);\n-    \n-    // Assign initial credit score (if not exists)\n-    if (!$user->creditScore) {\n-        $user->creditScore()->create([\n-            'score' => 20,\n-        ]);\n-        \n-        // Create credit history\n-        $user->creditScoreHistory()->create([\n-            'activity' => 'Membership Approved',\n-            'points' => 20\n-        ]);\n-    }\n-    \n-    // Change user role to member\n-    $user->update(['role_id' => 1]);\n-\n-    // Create default chat relationship for the approved member\n-    $this->createDefaultChatForMember($user->id);\n-    \n-    return response()->json([\n-        'success' => true,\n-        'message' => 'Membership application approved successfully!',\n-        'application' => $application,\n-    ]);\n-}\n-\n-    /**\n-     * Reject membership application (Admin only)\n-     */\n-    public function rejectMembership(Request $request, $applicationId)\n-    {\n-        $request->validate([\n-            'reason' => 'nullable|string|max:500',\n-        ]);\n-\n-        $application = Application::findOrFail($applicationId);\n-        \n-        // Check if application is for membership\n-        if ($application->application_type !== 'Membership') {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'This is not a membership application.'\n-            ], 400);\n-        }\n-        \n-        // Check if already rejected\n-        if ($application->status_id == 6) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already rejected.'\n-            ], 400);\n-        }\n-        \n-        // Update application status to REJECTED\n-        $application->update([\n-            'status_id' => 6, // 6 = Rejected\n-            'rejection_reason' => $request->input('reason'),\n-        ]);\n-        \n-        // Update document status to REJECTED\n-        $application->documents()->update(['status_id' => 6]);\n-        \n-        return response()->json([\n-            'success' => true,\n-            'message' => 'Membership application rejected.',\n-            'application' => $application,\n-        ]);\n-    }\n-    \n-    /**\n-     * Helper method to detect if input is email\n-     */\n-    private function isEmail($value)\n-    {\n-        return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n-    }\n-        private function createDefaultChatForMember($memberId)\n-    {\n-        \\App\\Models\\Chat::create([\n-            'admin_id' => 1,\n-            'member_id' => $memberId,\n-            'support_staff_id' => null,\n-        ]);\n-    }\n-}\n-<?php\n-\n-namespace App\\Http\\Controllers\\mobile;\n-\n-use App\\Http\\Controllers\\Controller;\n-use Illuminate\\Http\\Request;\n-use App\\Models\\UserInfo;\n-use App\\Models\\Application;\n-use App\\Models\\Document;\n-use Illuminate\\Support\\Str;\n-use App\\Services\\DocumentChecker;\n-use Barryvdh\\DomPDF\\Facade\\Pdf;\n-use Illuminate\\Support\\Facades\\Storage;\n-use Illuminate\\Support\\Facades\\Auth;\n-use App\\Models\\CreditScore;\n-use App\\Models\\CreditScoreHistory;\n-use App\\Services\\SMSService;\n-use App\\Models\\Notification;\n-\n-class MembershipController extends Controller\n-{\n-    /**\n-     * Submit membership application\n-     */\n-    public function store(Request $request)\n-    {\n-        $validatedData = $request->validate([\n-            'sector_id' => 'required|integer',\n-            'fname' => 'required|string',\n-            'mname' => 'nullable|string',\n-            'lname' => 'required|string',\n-            'suffix' => 'nullable|string',\n-            'birthdate' => 'required|date',\n-            'civil_status' => 'nullable|string',\n-            'gender' => 'required|string',\n-            'contact_info' => 'nullable|string',\n-            'province' => 'required|string',\n-            'city' => 'required|string',\n-            'house_no' => 'nullable|string',\n-            'barangay' => 'required|string',\n-            'zone' => 'required|string',\n-            'farm_location' => 'nullable|string',\n-            'land_size' => 'nullable|string',\n-            'water_source' => 'nullable|string',\n-            'sc_fname' => 'nullable|string',\n-            'sc_mname' => 'nullable|string',\n-            'sc_lname' => 'nullable|string',\n-            'sc_suffix' => 'nullable|string',\n-            'sc_gender' => 'nullable|string',\n-            'sc_contact_info' => 'nullable|string',\n-            'sc_province' => 'nullable|string',\n-            'sc_city' => 'nullable|string',\n-            'sc_house_no' => 'nullable|string',\n-            'sc_barangay' => 'nullable|string',\n-            'sc_zone' => 'nullable|string',\n-            'relationship' => 'nullable|string',\n-            'valid_id' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',\n-        ]);\n-\n-        $user = $request->user();\n-\n-        // Check if user already submitted\n-        if ($user->userInfo) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already submitted.'\n-            ], 409);\n-        }\n-\n-        // Auto-detect primary contact (phone or email)\n-        $primaryContact = $validatedData['contact_info'] ?? null;\n-\n-        $contactPhone = null;\n-        $contactEmail = null;\n-        \n-        if ($this->isEmail($primaryContact)) {\n-            $contactEmail = $primaryContact;\n-        } else {\n-            $contactPhone = $primaryContact;\n-        }\n-        \n-        // Auto-detect secondary contact (phone or email)\n-        $secondaryContact = $validatedData['sc_contact_info'] ?? null;\n-        $scPhone = null;\n-        $scEmail = null;\n-        \n-        if ($secondaryContact) {\n-            if ($this->isEmail($secondaryContact)) {\n-                $scEmail = $secondaryContact;\n-            } else {\n-                $scPhone = $secondaryContact;\n-            }\n-        }\n-\n-        // Create UserInfo with smart detection\n-        $userInfo = UserInfo::create([\n-            'user_id' => $user->id,\n-            'sector_id' => $validatedData['sector_id'],\n-            'fname' => $validatedData['fname'],\n-            'mname' => $validatedData['mname'],\n-            'lname' => $validatedData['lname'],\n-            'name' => $validatedData['fname'] . ' ' .($validatedData['mname'] ?? ' '). ' ' .$validatedData['lname'],\n-            'suffix' => $validatedData['suffix'],\n-            'birthdate' => $validatedData['birthdate'],\n-            'civil_status' => $validatedData['civil_status'],\n-            'gender' => $validatedData['gender'],\n-            \n-            // Store contact in both formats\n-            'contact_info' => $primaryContact,\n-            'phone_no' => $contactPhone,\n-            'email' => $contactEmail,\n-            \n-            'province' => $validatedData['province'],\n-            'city' => $validatedData['city'],\n-            'house_no' => $validatedData['house_no'],\n-            'barangay' => $validatedData['barangay'],\n-            'zone' => $validatedData['zone'],\n-            'farm_location' => $validatedData['farm_location'],\n-            'land_size' => $validatedData['land_size'],\n-            'water_source' => $validatedData['water_source'],\n-            \n-            // Secondary Contact\n-            'sc_fname' => $validatedData['sc_fname'],\n-            'sc_mname' => $validatedData['sc_mname'],\n-            'sc_lname' => $validatedData['sc_lname'],\n-            'sc_suffix' => $validatedData['sc_suffix'],\n-            'sc_gender' => $validatedData['sc_gender'],\n-            \n-            // Store secondary contact in both formats\n-            'sc_contact_info' => $secondaryContact,\n-            'sc_phone_no' => $scPhone,\n-            'sc_email' => $scEmail,\n-            \n-            'sc_province' => $validatedData['sc_province'],\n-            'sc_city' => $validatedData['sc_city'],\n-            'sc_house_no' => $validatedData['sc_house_no'],\n-            'sc_barangay' => $validatedData['sc_barangay'],\n-            'sc_zone' => $validatedData['sc_zone'],\n-            'relationship' => $validatedData['relationship'],\n-        ]);\n-\n-        // Create Application with PENDING status\n-        $application = Application::create([\n-            'user_id' => $user->id,\n-            'grant_id' => null,\n-            'status_id' => 3, // PENDING STATUS // 3 ang pending\n-            'application_type' => 'Membership',\n-            'purpose' => 'Membership Application',\n-        ]);\n-\n-        // Store Valid ID document\n-        if ($request->hasFile('valid_id')) {\n-\n-            $file = $request->file('valid_id');\n-            $filename = time() . '_' . $file->getClientOriginalName();\n-            $path = $file->storeAs('application/membership', $filename, 'public');\n-\n-            // CREATE DOCUMENT ENTRY\n-            $document = Document::create([\n-                'grant_requirement_id' => null,\n-                'membership_requirement_id' => 1, // ⚠️ SET THE VALID ID REQUIREMENT ID HERE\n-                'status_id' => 3, // PENDING STATUS\n-                'file_path' => $path,\n-                'file_name' => $filename,\n-                'documentable_type' => 'App\\Models\\Application',\n-                'documentable_id' => $application->id,\n-            ]);\n-\n-            // Initialize checker\n-            $checker = new DocumentChecker();\n-\n-            // Get requirement name (example: \"Valid ID\")\n-            $requirement = \\App\\Models\\MembershipRequirement::find(1); // SAME ID AS ABOVE\n-            $requirementName = $requirement?->requirement?->requirement_name;\n-\n-            if ($requirementName) {\n-\n-                // RUN AUTO CHECKER (same as web)\n-                $result = $checker->verifyDocumentBelongsToUser(\n-                    storage_path('app/public/' . $path),\n-                    $requirementName,\n-                    $userInfo // same membership owner\n-                );\n-\n-                // UPDATE DOCUMENT WITH RESULT\n-                $document->update([\n-                    'check_result' => $result\n-                ]);\n-            }\n-        }\n-\n-        //create pdf file of the application form\n-        $application->load(['documents', 'status', 'user.user_info']);\n-        $pdf = Pdf::loadView('pdf.membership_application_form', ['application' => $application]);\n-\n-        $fileName = $request->lname . '_membership_application_form_' . $application->id . '.pdf';\n-        $filePath = 'applications/' . $fileName;\n-\n-        Storage::disk('public')->put($filePath, $pdf->output());\n-        $application->update(['form_img' => $filePath]);\n-\n-        //store a confirmation message to table\n-        Notification::create([ \n-            'user_id' => Auth::id(),\n-            'message' => 'Your membership application was submitted successfully and is now pending approval.' ,\n-            'sent_at' => now(),\n-        ]);\n-\n-        // Send SMS to applicant\n-        if ($userInfo && $userInfo->phone_no) {\n-\n-            $number = $userInfo->phone_no;\n-\n-            // Convert \"09...\" to \"639...\"\n-            $number = preg_replace('/^0/', '63', $number);\n-\n-            $message = '[SWISA-AGAP] Your membership application was submitted successfully and is now pending approval.';\n-\n-            SMSService::send($number, $message);\n-        }\n-\n-        return response()->json([\n-            'success' => true,\n-            'message' => 'Membership application submitted successfully! Please wait for admin approval.',\n-            'user_info' => $userInfo,\n-            'application' => $application\n-        ], 201);\n-    }\n-\n-    /**\n-     * Approve membership application (Admin only)\n-     */\n-    public function approveMembership(Request $request, $applicationId)\n-    {\n-        $application = Application::findOrFail($applicationId);\n-        \n-        // Check if application is for membership\n-        if ($application->application_type !== 'Membership') {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'This is not a membership application.'\n-            ], 400);\n-        }\n-        \n-        // Check if already approved\n-        if ($application->status_id == 4) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already approved.'\n-            ], 400);\n-        }\n-        \n-        $user = $application->user;\n-        //$userInfo = $user->userInfo;\n-        \n-        // Update application status to APPROVED\n-        $application->update(['status_id' => 4]); // 4 = Approved\n-        \n-        // Update document status to APPROVED\n-        $application->documents()->update(['status_id' => 4]);\n-        \n-        // Generate QR code\n-        /*if (!$userInfo->qr_code) {\n-            $userInfo->qr_code = Str::uuid()->toString();\n-            $userInfo->save();\n-        }*/\n-        \n-        // Assign initial credit score (if not exists)\n-        if (!$user->creditScore) {\n-            $user->creditScore()->create([\n-                'score' => 20,\n-            ]);\n-            \n-            // Create credit history\n-            $user->creditScoreHistory()->create([\n-                'activity' => 'Membership Approved',\n-                'points' => 20\n-            ]);\n-        }\n-        \n-        // Change user role to member\n-        $user->update(['role_id' => 1]); // 1 ang member nata 2 kinaag mo\n-        \n-        return response()->json([\n-            'success' => true,\n-            'message' => 'Membership application approved successfully!',\n-            'application' => $application,\n-        ]);\n-    }\n-\n-    /**\n-     * Reject membership application (Admin only)\n-     */\n-    public function rejectMembership(Request $request, $applicationId)\n-    {\n-        $request->validate([\n-            'reason' => 'nullable|string|max:500',\n-        ]);\n-\n-        $application = Application::findOrFail($applicationId);\n-        \n-        // Check if application is for membership\n-        if ($application->application_type !== 'Membership') {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'This is not a membership application.'\n-            ], 400);\n-        }\n-        \n-        // Check if already rejected\n-        if ($application->status_id == 6) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already rejected.'\n-            ], 400);\n-        }\n-        \n-        // Update application status to REJECTED\n-        $application->update([\n-            'status_id' => 6, // 6 = Rejected\n-            'rejection_reason' => $request->input('reason'),\n-        ]);\n-        \n-        // Update document status to REJECTED\n-        $application->documents()->update(['status_id' => 6]);\n-        \n-        return response()->json([\n-            'success' => true,\n-            'message' => 'Membership application rejected.',\n-            'application' => $application,\n-        ]);\n-    }\n-    \n-    /**\n-     * Helper method to detect if input is email\n-     */\n-    private function isEmail($value)\n-    {\n-        return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n-    }\n-        private function createDefaultChatForMember($memberId)\n-    {\n-        \\App\\Models\\Chat::create([\n-            'admin_id' => 1,\n-            'member_id' => $memberId,\n-            'support_staff_id' => null,\n-        ]);\n-    }\n-}\n-<?php\n-\n-namespace App\\Http\\Controllers\\mobile;\n-\n-use App\\Http\\Controllers\\Controller;\n-use Illuminate\\Http\\Request;\n-use App\\Models\\UserInfo;\n-use App\\Models\\Application;\n-use App\\Models\\Document;\n-use Illuminate\\Support\\Str;\n-use App\\Services\\DocumentChecker;\n-use Barryvdh\\DomPDF\\Facade\\Pdf;\n-use Illuminate\\Support\\Facades\\Storage;\n-use Illuminate\\Support\\Facades\\Auth;\n-use App\\Models\\CreditScore;\n-use App\\Models\\CreditScoreHistory;\n-use App\\Services\\SMSService;\n-use App\\Models\\Notification;\n-\n-class MembershipController extends Controller\n-{\n-    /**\n-     * Submit membership application\n-     */\n-    public function store(Request $request)\n-    {\n-        $validatedData = $request->validate([\n-            'sector_id' => 'required|integer',\n-            'fname' => 'required|string',\n-            'mname' => 'nullable|string',\n-            'lname' => 'required|string',\n-            'suffix' => 'nullable|string',\n-            'birthdate' => 'required|date',\n-            'civil_status' => 'nullable|string',\n-            'gender' => 'required|string',\n-            'contact_info' => 'nullable|string',\n-            'province' => 'required|string',\n-            'city' => 'required|string',\n-            'house_no' => 'nullable|string',\n-            'barangay' => 'required|string',\n-            'zone' => 'required|string',\n-            'farm_location' => 'nullable|string',\n-            'land_size' => 'nullable|string',\n-            'water_source' => 'nullable|string',\n-            'sc_fname' => 'nullable|string',\n-            'sc_mname' => 'nullable|string',\n-            'sc_lname' => 'nullable|string',\n-            'sc_suffix' => 'nullable|string',\n-            'sc_gender' => 'nullable|string',\n-            'sc_contact_info' => 'nullable|string',\n-            'sc_province' => 'nullable|string',\n-            'sc_city' => 'nullable|string',\n-            'sc_house_no' => 'nullable|string',\n-            'sc_barangay' => 'nullable|string',\n-            'sc_zone' => 'nullable|string',\n-            'relationship' => 'nullable|string',\n-            'valid_id' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',\n-        ]);\n-\n-        $user = $request->user();\n-\n-        // Check if user already submitted\n-        if ($user->userInfo) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already submitted.'\n-            ], 409);\n-        }\n-\n-        // Auto-detect primary contact (phone or email)\n-        $primaryContact = $validatedData['contact_info'] ?? null;\n-\n-        $contactPhone = null;\n-        $contactEmail = null;\n-        \n-        if ($this->isEmail($primaryContact)) {\n-            $contactEmail = $primaryContact;\n-        } else {\n-            $contactPhone = $primaryContact;\n-        }\n-        \n-        // Auto-detect secondary contact (phone or email)\n-        $secondaryContact = $validatedData['sc_contact_info'] ?? null;\n-        $scPhone = null;\n-        $scEmail = null;\n-        \n-        if ($secondaryContact) {\n-            if ($this->isEmail($secondaryContact)) {\n-                $scEmail = $secondaryContact;\n-            } else {\n-                $scPhone = $secondaryContact;\n-            }\n-        }\n-\n-        // Create UserInfo with smart detection\n-        $userInfo = UserInfo::create([\n-            'user_id' => $user->id,\n-            'sector_id' => $validatedData['sector_id'],\n-            'fname' => $validatedData['fname'],\n-            'mname' => $validatedData['mname'],\n-            'lname' => $validatedData['lname'],\n-            'name' => $validatedData['fname'] . ' ' .($validatedData['mname'] ?? ' '). ' ' .$validatedData['lname'],\n-            'suffix' => $validatedData['suffix'],\n-            'birthdate' => $validatedData['birthdate'],\n-            'civil_status' => $validatedData['civil_status'],\n-            'gender' => $validatedData['gender'],\n-            \n-            // Store contact in both formats\n-            'contact_info' => $primaryContact,\n-            'phone_no' => $contactPhone,\n-            'email' => $contactEmail,\n-            \n-            'province' => $validatedData['province'],\n-            'city' => $validatedData['city'],\n-            'house_no' => $validatedData['house_no'],\n-            'barangay' => $validatedData['barangay'],\n-            'zone' => $validatedData['zone'],\n-            'farm_location' => $validatedData['farm_location'],\n-            'land_size' => $validatedData['land_size'],\n-            'water_source' => $validatedData['water_source'],\n-            \n-            // Secondary Contact\n-            'sc_fname' => $validatedData['sc_fname'],\n-            'sc_mname' => $validatedData['sc_mname'],\n-            'sc_lname' => $validatedData['sc_lname'],\n-            'sc_suffix' => $validatedData['sc_suffix'],\n-            'sc_gender' => $validatedData['sc_gender'],\n-            \n-            // Store secondary contact in both formats\n-            'sc_contact_info' => $secondaryContact,\n-            'sc_phone_no' => $scPhone,\n-            'sc_email' => $scEmail,\n-            \n-            'sc_province' => $validatedData['sc_province'],\n-            'sc_city' => $validatedData['sc_city'],\n-            'sc_house_no' => $validatedData['sc_house_no'],\n-            'sc_barangay' => $validatedData['sc_barangay'],\n-            'sc_zone' => $validatedData['sc_zone'],\n-            'relationship' => $validatedData['relationship'],\n-        ]);\n-\n-        // Create Application with PENDING status\n-        $application = Application::create([\n-            'user_id' => $user->id,\n-            'grant_id' => null,\n-            'status_id' => 3, // PENDING STATUS // 3 ang pending\n-            'application_type' => 'Membership',\n-            'purpose' => 'Membership Application',\n-        ]);\n-\n-        // Store Valid ID document\n-        if ($request->hasFile('valid_id')) {\n-\n-            $file = $request->file('valid_id');\n-            $filename = time() . '_' . $file->getClientOriginalName();\n-            $path = $file->storeAs('application/membership', $filename, 'public');\n-\n-            // CREATE DOCUMENT ENTRY\n-            $document = Document::create([\n-                'grant_requirement_id' => null,\n-                'membership_requirement_id' => 1, // ⚠️ SET THE VALID ID REQUIREMENT ID HERE\n-                'status_id' => 3, // PENDING STATUS\n-                'file_path' => $path,\n-                'file_name' => $filename,\n-                'documentable_type' => 'App\\Models\\Application',\n-                'documentable_id' => $application->id,\n-            ]);\n-\n-            // Initialize checker\n-            $checker = new DocumentChecker();\n-\n-            // Get requirement name (example: \"Valid ID\")\n-            $requirement = \\App\\Models\\MembershipRequirement::find(1); // SAME ID AS ABOVE\n-            $requirementName = $requirement?->requirement?->requirement_name;\n-\n-            if ($requirementName) {\n-\n-                // RUN AUTO CHECKER (same as web)\n-                $result = $checker->verifyDocumentBelongsToUser(\n-                    storage_path('app/public/' . $path),\n-                    $requirementName,\n-                    $userInfo // same membership owner\n-                );\n-\n-                // UPDATE DOCUMENT WITH RESULT\n-                $document->update([\n-                    'check_result' => $result\n-                ]);\n-            }\n-        }\n-\n-        //create pdf file of the application form\n-        $application->load(['documents', 'status', 'user.user_info']);\n-        $pdf = Pdf::loadView('pdf.membership_application_form', ['application' => $application]);\n-\n-        $fileName = $request->lname . '_membership_application_form_' . $application->id . '.pdf';\n-        $filePath = 'applications/' . $fileName;\n-\n-        Storage::disk('public')->put($filePath, $pdf->output());\n-        $application->update(['form_img' => $filePath]);\n-\n-        //store a confirmation message to table\n-        Notification::create([ \n-            'user_id' => Auth::id(),\n-            'message' => 'Your membership application was submitted successfully and is now pending approval.' ,\n-            'sent_at' => now(),\n-        ]);\n-\n-        // Send SMS to applicant\n-        if ($userInfo && $userInfo->phone_no) {\n-\n-            $number = $userInfo->phone_no;\n-\n-            // Convert \"09...\" to \"639...\"\n-            $number = preg_replace('/^0/', '63', $number);\n-\n-            $message = '[SWISA-AGAP] Your membership application was submitted successfully and is now pending approval.';\n-\n-            SMSService::send($number, $message);\n-        }\n-\n-        return response()->json([\n-            'success' => true,\n-            'message' => 'Membership application submitted successfully! Please wait for admin approval.',\n-            'user_info' => $userInfo,\n-            'application' => $application\n-        ], 201);\n-    }\n-\n-    /**\n-     * Approve membership application (Admin only)\n-     */\n-    public function approveMembership(Request $request, $applicationId)\n-    {\n-        $application = Application::findOrFail($applicationId);\n-        \n-        // Check if application is for membership\n-        if ($application->application_type !== 'Membership') {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'This is not a membership application.'\n-            ], 400);\n-        }\n-        \n-        // Check if already approved\n-        if ($application->status_id == 4) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already approved.'\n-            ], 400);\n-        }\n-        \n-        $user = $application->user;\n-        //$userInfo = $user->userInfo;\n-        \n-        // Update application status to APPROVED\n-        $application->update(['status_id' => 4]); // 4 = Approved\n-        \n-        // Update document status to APPROVED\n-        $application->documents()->update(['status_id' => 4]);\n-        $this->createDefaultChatForMember($user->id);\n-        // Generate QR code\n-        /*if (!$userInfo->qr_code) {\n-            $userInfo->qr_code = Str::uuid()->toString();\n-            $userInfo->save();\n-        }*/\n-        \n-        // Assign initial credit score (if not exists)\n-        if (!$user->creditScore) {\n-            $user->creditScore()->create([\n-                'score' => 20,\n-            ]);\n-            \n-            // Create credit history\n-            $user->creditScoreHistory()->create([\n-                'activity' => 'Membership Approved',\n-                'points' => 20\n-            ]);\n-        }\n-        \n-        // Change user role to member\n-        $user->update(['role_id' => 1]); // 1 ang member nata 2 kinaag mo\n-        \n-        return response()->json([\n-            'success' => true,\n-            'message' => 'Membership application approved successfully!',\n-            'application' => $application,\n-        ]);\n-    }\n-\n-    /**\n-     * Reject membership application (Admin only)\n-     */\n-    public function rejectMembership(Request $request, $applicationId)\n-    {\n-        $request->validate([\n-            'reason' => 'nullable|string|max:500',\n-        ]);\n-\n-        $application = Application::findOrFail($applicationId);\n-        \n-        // Check if application is for membership\n-        if ($application->application_type !== 'Membership') {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'This is not a membership application.'\n-            ], 400);\n-        }\n-        \n-        // Check if already rejected\n-        if ($application->status_id == 6) {\n-            return response()->json([\n-                'success' => false,\n-                'message' => 'Application already rejected.'\n-            ], 400);\n-        }\n-        \n-        // Update application status to REJECTED\n-        $application->update([\n-            'status_id' => 6, // 6 = Rejected\n-            'rejection_reason' => $request->input('reason'),\n-        ]);\n-        \n-        // Update document status to REJECTED\n-        $application->documents()->update(['status_id' => 6]);\n-        \n-        return response()->json([\n-            'success' => true,\n-            'message' => 'Membership application rejected.',\n-            'application' => $application,\n-        ]);\n-    }\n-    \n-    /**\n-     * Helper method to detect if input is email\n-     */\n-    private function isEmail($value)\n-    {\n-        return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n-    }\n-        private function createDefaultChatForMember($memberId)\n-    {\n-        \\App\\Models\\Chat::create([\n-            'admin_id' => 1,\n-            'member_id' => $memberId,\n-            'support_staff_id' => null,\n-        ]);\n-    }\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1765182083199,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,83 @@\n+<?php\n+\n+namespace App\\Http\\Controllers\\mobile;\n+\n+use App\\Http\\Controllers\\Controller;\n+use Illuminate\\Http\\Request;\n+use App\\Models\\UserInfo;\n+use Illuminate\\Support\\Str;\n+use App\\Models\\CreditScore;\n+use App\\Models\\CreditScoreHistory;\n+\n+class MembershipController extends Controller\n+{\n+    /**\n+     * Validate and store a new membership application.\n+     */\n+    public function store(Request $request)\n+    {\n+        $validatedData = $request->validate([\n+            'farmer_type' => 'required|string|in:Agriculture,Fisheries,Livestock,Forestry,Agri-Business',\n+\n+            'fname' => 'required|string',\n+            'mname' => 'nullable|string',\n+            'lname' => 'required|string',\n+            'suffix' => 'nullable|string',\n+            'birthdate' => 'required|date',\n+            'civil_status' => 'nullable|string',\n+            'gender' => 'required|string',\n+            'contact_no' => 'required|string',\n+            'province' => 'required|string',\n+            'city' => 'required|string',\n+            'house_no' => 'nullable|string', // ← ADD THIS\n+            'barangay' => 'required|string',\n+            'zone' => 'required|string',\n+            'farm_location' => 'nullable|string',\n+            'land_size' => 'nullable|string',\n+            'water_source' => 'nullable|string',\n+            'sc_fname' => 'nullable|string',\n+            'sc_mname' => 'nullable|string',\n+            'sc_lname' => 'nullable|string',\n+            'sc_suffix' => 'nullable|string',\n+            'sc_gender' => 'nullable|string',\n+            'sc_contact_no' => 'nullable|string',\n+            'sc_email' => 'nullable|email',\n+            'sc_province' => 'nullable|string',\n+            'sc_city' => 'nullable|string',\n+            'sc_house_no' => 'nullable|string', // ← ADD THIS\n+            'sc_barangay' => 'nullable|string',\n+            'sc_zone' => 'nullable|string',\n+            'relationship' => 'nullable|string',\n+        ]);\n+\n+        $user = $request->user();\n+\n+        if ($user->userInfo) {\n+            return response()->json(['message' => 'Application already submitted.'], 409);\n+        }\n+\n+        $userInfo = UserInfo::create(array_merge($validatedData, ['user_id' => $user->id]));\n+\n+        // Generate and save QR code\n+        $userInfo->qr_code = Str::uuid()->toString();\n+        $userInfo->save();\n+\n+        // Assign initial credit score\n+        $user->creditScore()->create(['score' => 80]);\n+\n+        // Create first history record\n+        $user->creditScoreHistory()->create([\n+            'activity' => 'Membership Approved',\n+            'points' => 80\n+        ]);\n+\n+        // Change user status to member\n+        $user->update(['role_id' => 3]);\n+\n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application submitted successfully!',\n+            'user_info' => $userInfo\n+        ], 201);\n+    }\n+}\n"
                },
                {
                    "date": 1765182089386,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,341 @@\n+<?php\n+\n+namespace App\\Http\\Controllers\\mobile;\n+\n+use App\\Http\\Controllers\\Controller;\n+use Illuminate\\Http\\Request;\n+use App\\Models\\UserInfo;\n+use App\\Models\\Application;\n+use App\\Models\\Document;\n+use Illuminate\\Support\\Str;\n+use App\\Services\\DocumentChecker;\n+use Barryvdh\\DomPDF\\Facade\\Pdf;\n+use Illuminate\\Support\\Facades\\Storage;\n+use Illuminate\\Support\\Facades\\Auth;\n+use App\\Models\\CreditScore;\n+use App\\Models\\CreditScoreHistory;\n+use App\\Services\\SMSService;\n+use App\\Models\\Notification;\n+\n+class MembershipController extends Controller\n+{\n+    /**\n+     * Submit membership application\n+     */\n+    public function store(Request $request)\n+    {\n+        $validatedData = $request->validate([\n+            'sector_id' => 'required|integer',\n+            'fname' => 'required|string',\n+            'mname' => 'nullable|string',\n+            'lname' => 'required|string',\n+            'suffix' => 'nullable|string',\n+            'birthdate' => 'required|date',\n+            'civil_status' => 'nullable|string',\n+            'gender' => 'required|string',\n+            'contact_info' => 'nullable|string',\n+            'province' => 'required|string',\n+            'city' => 'required|string',\n+            'house_no' => 'nullable|string',\n+            'barangay' => 'required|string',\n+            'zone' => 'required|string',\n+            'farm_location' => 'nullable|string',\n+            'land_size' => 'nullable|string',\n+            'water_source' => 'nullable|string',\n+            'sc_fname' => 'nullable|string',\n+            'sc_mname' => 'nullable|string',\n+            'sc_lname' => 'nullable|string',\n+            'sc_suffix' => 'nullable|string',\n+            'sc_gender' => 'nullable|string',\n+            'sc_contact_info' => 'nullable|string',\n+            'sc_province' => 'nullable|string',\n+            'sc_city' => 'nullable|string',\n+            'sc_house_no' => 'nullable|string',\n+            'sc_barangay' => 'nullable|string',\n+            'sc_zone' => 'nullable|string',\n+            'relationship' => 'nullable|string',\n+            'valid_id' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',\n+        ]);\n+\n+        $user = $request->user();\n+\n+        // Check if user already submitted\n+        if ($user->userInfo) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already submitted.'\n+            ], 409);\n+        }\n+\n+        // Auto-detect primary contact (phone or email)\n+        $primaryContact = $validatedData['contact_info'] ?? null;\n+\n+        $contactPhone = null;\n+        $contactEmail = null;\n+        \n+        if ($this->isEmail($primaryContact)) {\n+            $contactEmail = $primaryContact;\n+        } else {\n+            $contactPhone = $primaryContact;\n+        }\n+        \n+        // Auto-detect secondary contact (phone or email)\n+        $secondaryContact = $validatedData['sc_contact_info'] ?? null;\n+        $scPhone = null;\n+        $scEmail = null;\n+        \n+        if ($secondaryContact) {\n+            if ($this->isEmail($secondaryContact)) {\n+                $scEmail = $secondaryContact;\n+            } else {\n+                $scPhone = $secondaryContact;\n+            }\n+        }\n+\n+        // Create UserInfo with smart detection\n+        $userInfo = UserInfo::create([\n+            'user_id' => $user->id,\n+            'sector_id' => $validatedData['sector_id'],\n+            'fname' => $validatedData['fname'],\n+            'mname' => $validatedData['mname'],\n+            'lname' => $validatedData['lname'],\n+            'name' => $validatedData['fname'] . ' ' .($validatedData['mname'] ?? ' '). ' ' .$validatedData['lname'],\n+            'suffix' => $validatedData['suffix'],\n+            'birthdate' => $validatedData['birthdate'],\n+            'civil_status' => $validatedData['civil_status'],\n+            'gender' => $validatedData['gender'],\n+            \n+            // Store contact in both formats\n+            'contact_info' => $primaryContact,\n+            'phone_no' => $contactPhone,\n+            'email' => $contactEmail,\n+            \n+            'province' => $validatedData['province'],\n+            'city' => $validatedData['city'],\n+            'house_no' => $validatedData['house_no'],\n+            'barangay' => $validatedData['barangay'],\n+            'zone' => $validatedData['zone'],\n+            'farm_location' => $validatedData['farm_location'],\n+            'land_size' => $validatedData['land_size'],\n+            'water_source' => $validatedData['water_source'],\n+            \n+            // Secondary Contact\n+            'sc_fname' => $validatedData['sc_fname'],\n+            'sc_mname' => $validatedData['sc_mname'],\n+            'sc_lname' => $validatedData['sc_lname'],\n+            'sc_suffix' => $validatedData['sc_suffix'],\n+            'sc_gender' => $validatedData['sc_gender'],\n+            \n+            // Store secondary contact in both formats\n+            'sc_contact_info' => $secondaryContact,\n+            'sc_phone_no' => $scPhone,\n+            'sc_email' => $scEmail,\n+            \n+            'sc_province' => $validatedData['sc_province'],\n+            'sc_city' => $validatedData['sc_city'],\n+            'sc_house_no' => $validatedData['sc_house_no'],\n+            'sc_barangay' => $validatedData['sc_barangay'],\n+            'sc_zone' => $validatedData['sc_zone'],\n+            'relationship' => $validatedData['relationship'],\n+        ]);\n+\n+        // Create Application with PENDING status\n+        $application = Application::create([\n+            'user_id' => $user->id,\n+            'grant_id' => null,\n+            'status_id' => 3, // PENDING STATUS // 3 ang pending\n+            'application_type' => 'Membership',\n+            'purpose' => 'Membership Application',\n+        ]);\n+\n+        // Store Valid ID document\n+        if ($request->hasFile('valid_id')) {\n+\n+            $file = $request->file('valid_id');\n+            $filename = time() . '_' . $file->getClientOriginalName();\n+            $path = $file->storeAs('application/membership', $filename, 'public');\n+\n+            // CREATE DOCUMENT ENTRY\n+            $document = Document::create([\n+                'grant_requirement_id' => null,\n+                'membership_requirement_id' => 1, // ⚠️ SET THE VALID ID REQUIREMENT ID HERE\n+                'status_id' => 3, // PENDING STATUS\n+                'file_path' => $path,\n+                'file_name' => $filename,\n+                'documentable_type' => 'App\\Models\\Application',\n+                'documentable_id' => $application->id,\n+            ]);\n+\n+            // Initialize checker\n+            $checker = new DocumentChecker();\n+\n+            // Get requirement name (example: \"Valid ID\")\n+            $requirement = \\App\\Models\\MembershipRequirement::find(1); // SAME ID AS ABOVE\n+            $requirementName = $requirement?->requirement?->requirement_name;\n+\n+            if ($requirementName) {\n+\n+                // RUN AUTO CHECKER (same as web)\n+                $result = $checker->verifyDocumentBelongsToUser(\n+                    storage_path('app/public/' . $path),\n+                    $requirementName,\n+                    $userInfo // same membership owner\n+                );\n+\n+                // UPDATE DOCUMENT WITH RESULT\n+                $document->update([\n+                    'check_result' => $result\n+                ]);\n+            }\n+        }\n+\n+        //create pdf file of the application form\n+        $application->load(['documents', 'status', 'user.user_info']);\n+        $pdf = Pdf::loadView('pdf.membership_application_form', ['application' => $application]);\n+\n+        $fileName = $request->lname . '_membership_application_form_' . $application->id . '.pdf';\n+        $filePath = 'applications/' . $fileName;\n+\n+        Storage::disk('public')->put($filePath, $pdf->output());\n+        $application->update(['form_img' => $filePath]);\n+\n+        //store a confirmation message to table\n+        Notification::create([ \n+            'user_id' => Auth::id(),\n+            'message' => 'Your membership application was submitted successfully and is now pending approval.' ,\n+            'sent_at' => now(),\n+        ]);\n+\n+        // Send SMS to applicant\n+        if ($userInfo && $userInfo->phone_no) {\n+\n+            $number = $userInfo->phone_no;\n+\n+            // Convert \"09...\" to \"639...\"\n+            $number = preg_replace('/^0/', '63', $number);\n+\n+            $message = '[SWISA-AGAP] Your membership application was submitted successfully and is now pending approval.';\n+\n+            SMSService::send($number, $message);\n+        }\n+\n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application submitted successfully! Please wait for admin approval.',\n+            'user_info' => $userInfo,\n+            'application' => $application\n+        ], 201);\n+    }\n+\n+    /**\n+     * Approve membership application (Admin only)\n+     */\n+    public function approveMembership(Request $request, $applicationId)\n+    {\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already approved\n+        if ($application->status_id == 4) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already approved.'\n+            ], 400);\n+        }\n+        \n+        $user = $application->user;\n+        //$userInfo = $user->userInfo;\n+        \n+        // Update application status to APPROVED\n+        $application->update(['status_id' => 4]); // 4 = Approved\n+        \n+        // Update document status to APPROVED\n+        $application->documents()->update(['status_id' => 4]);\n+        \n+        // Generate QR code\n+        /*if (!$userInfo->qr_code) {\n+            $userInfo->qr_code = Str::uuid()->toString();\n+            $userInfo->save();\n+        }*/\n+        \n+        // Assign initial credit score (if not exists)\n+        if (!$user->creditScore) {\n+            $user->creditScore()->create([\n+                'score' => 20,\n+            ]);\n+            \n+            // Create credit history\n+            $user->creditScoreHistory()->create([\n+                'activity' => 'Membership Approved',\n+                'points' => 20\n+            ]);\n+        }\n+        \n+        // Change user role to member\n+        $user->update(['role_id' => 1]); // 1 ang member nata 2 kinaag mo\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application approved successfully!',\n+            'application' => $application,\n+        ]);\n+    }\n+\n+    /**\n+     * Reject membership application (Admin only)\n+     */\n+    public function rejectMembership(Request $request, $applicationId)\n+    {\n+        $request->validate([\n+            'reason' => 'nullable|string|max:500',\n+        ]);\n+\n+        $application = Application::findOrFail($applicationId);\n+        \n+        // Check if application is for membership\n+        if ($application->application_type !== 'Membership') {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'This is not a membership application.'\n+            ], 400);\n+        }\n+        \n+        // Check if already rejected\n+        if ($application->status_id == 6) {\n+            return response()->json([\n+                'success' => false,\n+                'message' => 'Application already rejected.'\n+            ], 400);\n+        }\n+        \n+        // Update application status to REJECTED\n+        $application->update([\n+            'status_id' => 6, // 6 = Rejected\n+            'rejection_reason' => $request->input('reason'),\n+        ]);\n+        \n+        // Update document status to REJECTED\n+        $application->documents()->update(['status_id' => 6]);\n+        \n+        return response()->json([\n+            'success' => true,\n+            'message' => 'Membership application rejected.',\n+            'application' => $application,\n+        ]);\n+    }\n+    \n+    /**\n+     * Helper method to detect if input is email\n+     */\n+    private function isEmail($value)\n+    {\n+        return filter_var($value, FILTER_VALIDATE_EMAIL) !== false;\n+    }\n+}\n\\ No newline at end of file\n"
                }
            ],
            "date": 1763626403925,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace App\\Http\\Controllers\\mobile;\n\nuse App\\Http\\Controllers\\Controller;\nuse Illuminate\\Http\\Request;\nuse App\\Models\\UserInfo;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\CreditScore;\nuse App\\Models\\CreditScoreHistory;\n\nclass MembershipController extends Controller\n{\n    /**\n     * Validate and store a new membership application.\n     */\n    public function store(Request $request)\n    {\n        $validatedData = $request->validate([\n            'farmer_type' => 'required|string|in:Farmer,Fisher',\n            'fname' => 'required|string',\n            'mname' => 'nullable|string',\n            'lname' => 'required|string',\n            'suffix' => 'nullable|string',\n            'birthdate' => 'required|date',\n            'civil_status' => 'nullable|string',\n            'gender' => 'required|string',\n            'contact_no' => 'required|string',\n            'province' => 'required|string',\n            'city' => 'required|string',\n            'house_no' => 'nullable|string', // ← ADD THIS\n            'barangay' => 'required|string',\n            'zone' => 'required|string',\n            'farm_location' => 'nullable|string',\n            'land_size' => 'nullable|string',\n            'water_source' => 'nullable|string',\n            'sc_fname' => 'nullable|string',\n            'sc_mname' => 'nullable|string',\n            'sc_lname' => 'nullable|string',\n            'sc_suffix' => 'nullable|string',\n            'sc_gender' => 'nullable|string',\n            'sc_contact_no' => 'nullable|string',\n            'sc_email' => 'nullable|email',\n            'sc_province' => 'nullable|string',\n            'sc_city' => 'nullable|string',\n            'sc_house_no' => 'nullable|string', // ← ADD THIS\n            'sc_barangay' => 'nullable|string',\n            'sc_zone' => 'nullable|string',\n            'relationship' => 'nullable|string',\n        ]);\n\n        $user = $request->user();\n\n        if ($user->userInfo) {\n            return response()->json(['message' => 'Application already submitted.'], 409);\n        }\n\n        $userInfo = UserInfo::create(array_merge($validatedData, ['user_id' => $user->id]));\n\n        // Generate and save QR code\n        $userInfo->qr_code = Str::uuid()->toString();\n        $userInfo->save();\n\n        // Assign initial credit score\n        $user->creditScore()->create(['score' => 80]);\n\n        // Create first history record\n        $user->creditScoreHistory()->create([\n            'activity' => 'Membership Approved',\n            'points' => 80\n        ]);\n\n        // Change user status to member\n        $user->update(['role_id' => 3]);\n\n        return response()->json([\n            'success' => true,\n            'message' => 'Membership application submitted successfully!',\n            'user_info' => $userInfo\n        ], 201);\n    }\n}\n"
        }
    ]
}
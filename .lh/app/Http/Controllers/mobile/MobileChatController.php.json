{
    "sourceFile": "app/Http/Controllers/mobile/MobileChatController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 42,
            "patches": [
                {
                    "date": 1763535241324,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763535562973,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,157 @@\n+<?php\r\n+\r\n+namespace App\\Http\\Controllers\\mobile;\r\n+\r\n+use App\\Http\\Controllers\\Controller;\r\n+use Illuminate\\Http\\Request;\r\n+use App\\Models\\Chat;\r\n+use App\\Models\\Message;\r\n+use App\\Models\\QuickReply;\r\n+use App\\Models\\User;\r\n+use App\\Events\\MessageSent;\r\n+\r\n+class MobileChatController extends Controller\r\n+{\r\n+    // ==============================\r\n+    // GET OR CREATE CHAT FOR MEMBER\r\n+    // Accepts optional 'user_id' in request body if auth() isn't available.\r\n+    // ==============================\r\n+    public function getOrCreateChat(Request $request)\r\n+    {\r\n+        try {\r\n+            // Prefer authenticated user id, fall back to user_id provided by client\r\n+            $memberId = auth()->id() ?? $request->input('user_id');\r\n+\r\n+            if (!$memberId) {\r\n+                return response()->json([\r\n+                    'success' => false,\r\n+                    'message' => 'No user id provided and user is not authenticated.'\r\n+                ], 422);\r\n+            }\r\n+\r\n+            $admin = User::where('role_id', 3)->first();\r\n+\r\n+            // Try to find existing chat between this member and admin\r\n+            $chat = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $admin?->id)\r\n+                        ->first();\r\n+\r\n+            // If not found, create it\r\n+            if (!$chat) {\r\n+                $chat = Chat::create([\r\n+                    'user_id' => $memberId,\r\n+                    'admin_id' => $admin?->id,\r\n+                    'support_staff_id' => null,\r\n+                ]);\r\n+            }\r\n+\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $chat->id,\r\n+            ]);\r\n+        } catch (\\Exception $e) {\r\n+            \\Log::error('getOrCreateChat error: ' . $e->getMessage());\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // ==============================\r\n+    // FETCH CHAT HISTORY\r\n+    // ==============================\r\n+    public function getChatHistory($chatId)\r\n+    {\r\n+        try {\r\n+            $messages = Message::with('user:id,first_name,last_name,role_id')\r\n+                ->where('chat_id', $chatId)\r\n+                ->orderBy('created_at', 'asc')\r\n+                ->get();\r\n+\r\n+            return response()->json($messages);\r\n+        } catch (\\Exception $e) {\r\n+            \\Log::error('getChatHistory error: ' . $e->getMessage());\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // ==============================\r\n+    // SEND MESSAGE\r\n+    // ==============================\r\n+public function sendMessage(Request $request)\r\n+{\r\n+    $validated = $request->validate([\r\n+        'chat_id' => 'required|integer',\r\n+        'message' => 'required|string',\r\n+    ]);\r\n+\r\n+    try {\r\n+        $senderId = auth()->id(); // always from token\r\n+\r\n+        if (!$senderId) {\r\n+            return response()->json(['error' => 'Unauthenticated'], 401);\r\n+        }\r\n+\r\n+        $message = Message::create([\r\n+            'chat_id' => $validated['chat_id'],\r\n+            'user_id' => $senderId,\r\n+            'message' => $validated['message'],\r\n+            'is_read' => 0,\r\n+        ]);\r\n+\r\n+        $message->load('user');\r\n+        broadcast(new MessageSent($message))->toOthers();\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'message' => $message,\r\n+        ]);\r\n+\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n+    }\r\n+}\r\n+\r\n+\r\n+    // ==============================\r\n+    // MARK MESSAGES AS READ\r\n+    // expects 'chat_id' in request body\r\n+    // ==============================\r\n+    public function markAsRead(Request $request)\r\n+    {\r\n+        try {\r\n+            $chatId = $request->input('chat_id');\r\n+            if (!$chatId) {\r\n+                return response()->json(['success' => false, 'message' => 'chat_id required'], 422);\r\n+            }\r\n+\r\n+            $chat = Chat::findOrFail($chatId);\r\n+            $userId = auth()->id();\r\n+\r\n+            $chat->messages()\r\n+                ->where('user_id', '!=', $userId)\r\n+                ->where('is_read', false)\r\n+                ->update(['is_read' => true]);\r\n+\r\n+            return response()->json(['success' => true]);\r\n+        } catch (\\Exception $e) {\r\n+            \\Log::error('markAsRead error: ' . $e->getMessage());\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // ==============================\r\n+    // GET QUICK REPLIES\r\n+    // ==============================\r\n+    public function getQuickReplies($roleId)\r\n+    {\r\n+        try {\r\n+            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n+                ->select('id', 'question', 'answer', 'for_role_id')\r\n+                ->get();\r\n+\r\n+            return response()->json($quickReplies);\r\n+        } catch (\\Exception $e) {\r\n+            \\Log::error('getQuickReplies error: ' . $e->getMessage());\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1763536320996,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,337 +3,88 @@\n namespace App\\Http\\Controllers\\mobile;\r\n \r\n use App\\Http\\Controllers\\Controller;\r\n use Illuminate\\Http\\Request;\r\n-use App\\Models\\Chat;\r\n+use App\\Models\\MobileChat;\r\n use App\\Models\\Message;\r\n-use App\\Models\\QuickReply;\r\n-use App\\Models\\User;\r\n-use App\\Events\\MessageSent;\r\n-\r\n-class MobileChatController extends Controller\r\n-{\r\n-    // ==============================\r\n-    // GET OR CREATE CHAT FOR MEMBER\r\n-    // Accepts optional 'user_id' in request body if auth() isn't available.\r\n-    // ==============================\r\n-    public function getOrCreateChat(Request $request)\r\n-    {\r\n-        try {\r\n-            // Prefer authenticated user id, fall back to user_id provided by client\r\n-            $memberId = auth()->id() ?? $request->input('user_id');\r\n-\r\n-            if (!$memberId) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No user id provided and user is not authenticated.'\r\n-                ], 422);\r\n-            }\r\n-\r\n-            $admin = User::where('role_id', 3)->first();\r\n-\r\n-            // Try to find existing chat between this member and admin\r\n-            $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin?->id)\r\n-                        ->first();\r\n-\r\n-            // If not found, create it\r\n-            if (!$chat) {\r\n-                $chat = Chat::create([\r\n-                    'user_id' => $memberId,\r\n-                    'admin_id' => $admin?->id,\r\n-                    'support_staff_id' => null,\r\n-                ]);\r\n-            }\r\n-\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $chat->id,\r\n-            ]);\r\n-        } catch (\\Exception $e) {\r\n-            \\Log::error('getOrCreateChat error: ' . $e->getMessage());\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // ==============================\r\n-    // FETCH CHAT HISTORY\r\n-    // ==============================\r\n-    public function getChatHistory($chatId)\r\n-    {\r\n-        try {\r\n-            $messages = Message::with('user:id,first_name,last_name,role_id')\r\n-                ->where('chat_id', $chatId)\r\n-                ->orderBy('created_at', 'asc')\r\n-                ->get();\r\n-\r\n-            return response()->json($messages);\r\n-        } catch (\\Exception $e) {\r\n-            \\Log::error('getChatHistory error: ' . $e->getMessage());\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // ==============================\r\n-    // SEND MESSAGE\r\n-    // ==============================\r\n-public function sendMessage(Request $request)\r\n-{\r\n-    $validated = $request->validate([\r\n-        'chat_id' => 'required|integer',\r\n-        'message' => 'required|string',\r\n-    ]);\r\n-\r\n-    try {\r\n-        $senderId = auth()->id(); // always from token\r\n-\r\n-        if (!$senderId) {\r\n-            return response()->json(['error' => 'Unauthenticated'], 401);\r\n-        }\r\n-\r\n-        $message = Message::create([\r\n-            'chat_id' => $validated['chat_id'],\r\n-            'user_id' => $senderId,\r\n-            'message' => $validated['message'],\r\n-            'is_read' => 0,\r\n-        ]);\r\n-\r\n-        $message->load('user');\r\n-        broadcast(new MessageSent($message))->toOthers();\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'message' => $message,\r\n-        ]);\r\n-\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n-    }\r\n-}\r\n-\r\n-\r\n-    // ==============================\r\n-    // MARK MESSAGES AS READ\r\n-    // expects 'chat_id' in request body\r\n-    // ==============================\r\n-    public function markAsRead(Request $request)\r\n-    {\r\n-        try {\r\n-            $chatId = $request->input('chat_id');\r\n-            if (!$chatId) {\r\n-                return response()->json(['success' => false, 'message' => 'chat_id required'], 422);\r\n-            }\r\n-\r\n-            $chat = Chat::findOrFail($chatId);\r\n-            $userId = auth()->id();\r\n-\r\n-            $chat->messages()\r\n-                ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', false)\r\n-                ->update(['is_read' => true]);\r\n-\r\n-            return response()->json(['success' => true]);\r\n-        } catch (\\Exception $e) {\r\n-            \\Log::error('markAsRead error: ' . $e->getMessage());\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // ==============================\r\n-    // GET QUICK REPLIES\r\n-    // ==============================\r\n-    public function getQuickReplies($roleId)\r\n-    {\r\n-        try {\r\n-            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n-                ->select('id', 'question', 'answer', 'for_role_id')\r\n-                ->get();\r\n-\r\n-            return response()->json($quickReplies);\r\n-        } catch (\\Exception $e) {\r\n-            \\Log::error('getQuickReplies error: ' . $e->getMessage());\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-}\r\n-<?php\r\n-\r\n-namespace App\\Http\\Controllers\\mobile;\r\n-\r\n-use App\\Http\\Controllers\\Controller;\r\n-use Illuminate\\Http\\Request;\r\n use App\\Models\\Chat;\r\n-use App\\Models\\Message;\r\n-use App\\Models\\QuickReply;\r\n-use App\\Models\\User;\r\n-use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // ==============================\r\n-    // GET OR CREATE CHAT FOR MEMBER\r\n-    // Accepts optional 'user_id' in request body if auth() isn't available.\r\n-    // ==============================\r\n-    public function getOrCreateChat(Request $request)\r\n+    /**\r\n+     * Start or get existing chat for a member\r\n+     */\r\n+    public function startChat(Request $request)\r\n     {\r\n-        try {\r\n-            // Prefer authenticated user id, fall back to user_id provided by client\r\n-            $memberId = auth()->id() ?? $request->input('user_id');\r\n+        $userId = auth()->id();\r\n \r\n-            if (!$memberId) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No user id provided and user is not authenticated.'\r\n-                ], 422);\r\n-            }\r\n+        $chat = Chat::firstOrCreate(\r\n+            ['user_id' => $userId],\r\n+            ['status_id' => 1]\r\n+        );\r\n \r\n-            $admin = User::where('role_id', 3)->first();\r\n-\r\n-            // Try to find existing chat between this member and admin\r\n-            $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin?->id)\r\n-                        ->first();\r\n-\r\n-            // If not found, create it\r\n-            if (!$chat) {\r\n-                $chat = Chat::create([\r\n-                    'user_id' => $memberId,\r\n-                    'admin_id' => $admin?->id,\r\n-                    'support_staff_id' => null,\r\n-                ]);\r\n-            }\r\n-\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $chat->id,\r\n-            ]);\r\n-        } catch (\\Exception $e) {\r\n-            \\Log::error('getOrCreateChat error: ' . $e->getMessage());\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n+        return response()->json(['chat_id' => $chat->id], 200);\r\n     }\r\n \r\n-    // ==============================\r\n-    // FETCH CHAT HISTORY\r\n-    // ==============================\r\n-    public function getChatHistory($chatId)\r\n+    /**\r\n+     * Get Quick Replies\r\n+     */\r\n+    public function getQuickReplies($role_id)\r\n     {\r\n         try {\r\n-            $messages = Message::with('user:id,first_name,last_name,role_id')\r\n-                ->where('chat_id', $chatId)\r\n-                ->orderBy('created_at', 'asc')\r\n+            $quickReplies = MobileChat::where('for_role_id', $role_id)\r\n+                ->orderBy('id', 'asc')\r\n                 ->get();\r\n \r\n-            return response()->json($messages);\r\n+            return response()->json($quickReplies, 200);\r\n         } catch (\\Exception $e) {\r\n-            \\Log::error('getChatHistory error: ' . $e->getMessage());\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // ==============================\r\n-    // SEND MESSAGE\r\n-    // ==============================\r\n+    /**\r\n+     * Store a chat message (member or admin/bot)\r\n+     */\r\n     public function sendMessage(Request $request)\r\n     {\r\n         $validated = $request->validate([\r\n             'chat_id' => 'required|integer',\r\n             'message' => 'required|string',\r\n-            'user_id' => 'nullable|integer', // optional: client can pass user_id\r\n+            'user_id' => 'nullable|integer'\r\n         ]);\r\n \r\n         try {\r\n-            // Prefer provided user_id, then authenticated user\r\n-            $senderId = $validated['user_id'] ?? auth()->id();\r\n-\r\n-            if (!$senderId) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No sender user id provided and user is not authenticated.'\r\n-                ], 422);\r\n-            }\r\n-\r\n-            // Ensure chat exists\r\n-            $chat = Chat::find($validated['chat_id']);\r\n-            if (!$chat) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'Chat not found.'\r\n-                ], 404);\r\n-            }\r\n-\r\n-            // If chat exists but user_id is null, attach the sender as chat.user_id\r\n-            // (this prevents creating multiple empty chats if earlier chat was null)\r\n-            if ($chat->user_id === null) {\r\n-                // If the sender is not an admin/support staff, assume it's the member\r\n-                // We'll only attach if sender is not role_id 3 (admin) or 2 (support)\r\n-                $sender = User::find($senderId);\r\n-                if ($sender && $sender->role_id == 1) {\r\n-                    $chat->user_id = $senderId;\r\n-                    $chat->save();\r\n-                }\r\n-            }\r\n-\r\n             $message = Message::create([\r\n                 'chat_id' => $validated['chat_id'],\r\n-                'user_id' => $senderId,\r\n+                'user_id' => $validated['user_id'] ?? auth()->id(),\r\n                 'message' => $validated['message'],\r\n                 'is_read' => 0,\r\n             ]);\r\n \r\n-            $message->load('user');\r\n-            broadcast(new MessageSent($message))->toOthers();\r\n-\r\n             return response()->json([\r\n                 'success' => true,\r\n-                'message' => $message,\r\n-            ]);\r\n+                'data' => $message,\r\n+            ], 200);\r\n+\r\n         } catch (\\Exception $e) {\r\n-            \\Log::error('sendMessage error: ' . $e->getMessage());\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // ==============================\r\n-    // MARK MESSAGES AS READ\r\n-    // expects 'chat_id' in request body\r\n-    // ==============================\r\n-    public function markAsRead(Request $request)\r\n-    {\r\n-        try {\r\n-            $chatId = $request->input('chat_id');\r\n-            if (!$chatId) {\r\n-                return response()->json(['success' => false, 'message' => 'chat_id required'], 422);\r\n-            }\r\n \r\n-            $chat = Chat::findOrFail($chatId);\r\n-            $userId = auth()->id();\r\n-\r\n-            $chat->messages()\r\n-                ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', false)\r\n-                ->update(['is_read' => true]);\r\n-\r\n-            return response()->json(['success' => true]);\r\n-        } catch (\\Exception $e) {\r\n-            \\Log::error('markAsRead error: ' . $e->getMessage());\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // ==============================\r\n-    // GET QUICK REPLIES\r\n-    // ==============================\r\n-    public function getQuickReplies($roleId)\r\n+    /**\r\n+     * Get chat history\r\n+     */\r\n+    public function getChatHistory($chat_id)\r\n     {\r\n         try {\r\n-            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n-                ->select('id', 'question', 'answer', 'for_role_id')\r\n+            $messages = Message::where('chat_id', $chat_id)\r\n+                ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n \r\n-            return response()->json($quickReplies);\r\n+            return response()->json($messages, 200);\r\n+\r\n         } catch (\\Exception $e) {\r\n-            \\Log::error('getQuickReplies error: ' . $e->getMessage());\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n }\r\n"
                },
                {
                    "date": 1763536431566,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,88 +3,155 @@\n namespace App\\Http\\Controllers\\mobile;\r\n \r\n use App\\Http\\Controllers\\Controller;\r\n use Illuminate\\Http\\Request;\r\n-use App\\Models\\MobileChat;\r\n+use App\\Models\\Chat;\r\n use App\\Models\\Message;\r\n-use App\\Models\\Chat;\r\n+use App\\Models\\QuickReply;\r\n+use App\\Models\\User;\r\n+use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    /**\r\n-     * Start or get existing chat for a member\r\n-     */\r\n-    public function startChat(Request $request)\r\n+    // ==============================\r\n+    // GET OR CREATE CHAT FOR MEMBER\r\n+    // Accepts optional 'user_id' in request body if auth() isn't available.\r\n+    // ==============================\r\n+    public function getOrCreateChat(Request $request)\r\n     {\r\n-        $userId = auth()->id();\r\n+        try {\r\n+            // Prefer authenticated user id, fall back to user_id provided by client\r\n+            $memberId = auth()->id() ?? $request->input('user_id');\r\n \r\n-        $chat = Chat::firstOrCreate(\r\n-            ['user_id' => $userId],\r\n-            ['status_id' => 1]\r\n-        );\r\n+            if (!$memberId) {\r\n+                return response()->json([\r\n+                    'success' => false,\r\n+                    'message' => 'No user id provided and user is not authenticated.'\r\n+                ], 422);\r\n+            }\r\n \r\n-        return response()->json(['chat_id' => $chat->id], 200);\r\n+            $admin = User::where('role_id', 3)->first();\r\n+\r\n+            // Try to find existing chat between this member and admin\r\n+            $chat = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $admin?->id)\r\n+                        ->first();\r\n+\r\n+            // If not found, create it\r\n+            if (!$chat) {\r\n+                $chat = Chat::create([\r\n+                    'user_id' => $memberId,\r\n+                    'admin_id' => $admin?->id,\r\n+                    'support_staff_id' => null,\r\n+                ]);\r\n+            }\r\n+\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $chat->id,\r\n+            ]);\r\n+        } catch (\\Exception $e) {\r\n+            \\Log::error('getOrCreateChat error: ' . $e->getMessage());\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n     }\r\n \r\n-    /**\r\n-     * Get Quick Replies\r\n-     */\r\n-    public function getQuickReplies($role_id)\r\n+    // ==============================\r\n+    // FETCH CHAT HISTORY\r\n+    // ==============================\r\n+    public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n-            $quickReplies = MobileChat::where('for_role_id', $role_id)\r\n-                ->orderBy('id', 'asc')\r\n+            $messages = Message::with('user:id,first_name,last_name,role_id')\r\n+                ->where('chat_id', $chatId)\r\n+                ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n \r\n-            return response()->json($quickReplies, 200);\r\n+            return response()->json($messages);\r\n         } catch (\\Exception $e) {\r\n+            \\Log::error('getChatHistory error: ' . $e->getMessage());\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    /**\r\n-     * Store a chat message (member or admin/bot)\r\n-     */\r\n-    public function sendMessage(Request $request)\r\n-    {\r\n-        $validated = $request->validate([\r\n-            'chat_id' => 'required|integer',\r\n-            'message' => 'required|string',\r\n-            'user_id' => 'nullable|integer'\r\n+    // ==============================\r\n+    // SEND MESSAGE\r\n+    // ==============================\r\n+public function sendMessage(Request $request)\r\n+{\r\n+    $validated = $request->validate([\r\n+        'chat_id' => 'required|integer',\r\n+        'message' => 'required|string',\r\n+    ]);\r\n+\r\n+    try {\r\n+        $senderId = auth()->id(); // always from token\r\n+\r\n+        if (!$senderId) {\r\n+            return response()->json(['error' => 'Unauthenticated'], 401);\r\n+        }\r\n+\r\n+        $message = Message::create([\r\n+            'chat_id' => $validated['chat_id'],\r\n+            'user_id' => $senderId,\r\n+            'message' => $validated['message'],\r\n+            'is_read' => 0,\r\n         ]);\r\n \r\n+        $message->load('user');\r\n+        broadcast(new MessageSent($message))->toOthers();\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'message' => $message,\r\n+        ]);\r\n+\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n+    }\r\n+}\r\n+\r\n+\r\n+    // ==============================\r\n+    // MARK MESSAGES AS READ\r\n+    // expects 'chat_id' in request body\r\n+    // ==============================\r\n+    public function markAsRead(Request $request)\r\n+    {\r\n         try {\r\n-            $message = Message::create([\r\n-                'chat_id' => $validated['chat_id'],\r\n-                'user_id' => $validated['user_id'] ?? auth()->id(),\r\n-                'message' => $validated['message'],\r\n-                'is_read' => 0,\r\n-            ]);\r\n+            $chatId = $request->input('chat_id');\r\n+            if (!$chatId) {\r\n+                return response()->json(['success' => false, 'message' => 'chat_id required'], 422);\r\n+            }\r\n \r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'data' => $message,\r\n-            ], 200);\r\n+            $chat = Chat::findOrFail($chatId);\r\n+            $userId = auth()->id();\r\n \r\n+            $chat->messages()\r\n+                ->where('user_id', '!=', $userId)\r\n+                ->where('is_read', false)\r\n+                ->update(['is_read' => true]);\r\n+\r\n+            return response()->json(['success' => true]);\r\n         } catch (\\Exception $e) {\r\n+            \\Log::error('markAsRead error: ' . $e->getMessage());\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-\r\n-    /**\r\n-     * Get chat history\r\n-     */\r\n-    public function getChatHistory($chat_id)\r\n+    // ==============================\r\n+    // GET QUICK REPLIES\r\n+    // ==============================\r\n+    public function getQuickReplies($roleId)\r\n     {\r\n         try {\r\n-            $messages = Message::where('chat_id', $chat_id)\r\n-                ->orderBy('created_at', 'asc')\r\n+            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n+                ->select('id', 'question', 'answer', 'for_role_id')\r\n                 ->get();\r\n \r\n-            return response()->json($messages, 200);\r\n-\r\n+            return response()->json($quickReplies);\r\n         } catch (\\Exception $e) {\r\n+            \\Log::error('getQuickReplies error: ' . $e->getMessage());\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n }\r\n"
                },
                {
                    "date": 1763537601319,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,33 +11,19 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // ==============================\r\n     // GET OR CREATE CHAT FOR MEMBER\r\n-    // Accepts optional 'user_id' in request body if auth() isn't available.\r\n-    // ==============================\r\n-    public function getOrCreateChat(Request $request)\r\n+    public function getOrCreateChat()\r\n     {\r\n         try {\r\n-            // Prefer authenticated user id, fall back to user_id provided by client\r\n-            $memberId = auth()->id() ?? $request->input('user_id');\r\n-\r\n-            if (!$memberId) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No user id provided and user is not authenticated.'\r\n-                ], 422);\r\n-            }\r\n-\r\n+            $memberId = auth()->id();\r\n             $admin = User::where('role_id', 3)->first();\r\n \r\n-            // Try to find existing chat between this member and admin\r\n             $chat = Chat::where('user_id', $memberId)\r\n                         ->where('admin_id', $admin?->id)\r\n                         ->first();\r\n \r\n-            // If not found, create it\r\n             if (!$chat) {\r\n                 $chat = Chat::create([\r\n                     'user_id' => $memberId,\r\n                     'admin_id' => $admin?->id,\r\n@@ -49,81 +35,63 @@\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n         } catch (\\Exception $e) {\r\n-            \\Log::error('getOrCreateChat error: ' . $e->getMessage());\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // ==============================\r\n     // FETCH CHAT HISTORY\r\n-    // ==============================\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n-            $messages = Message::with('user:id,first_name,last_name,role_id')\r\n+            $messages = Message::with('user:id,name,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n \r\n             return response()->json($messages);\r\n         } catch (\\Exception $e) {\r\n-            \\Log::error('getChatHistory error: ' . $e->getMessage());\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // ==============================\r\n     // SEND MESSAGE\r\n-    // ==============================\r\n-public function sendMessage(Request $request)\r\n-{\r\n-    $validated = $request->validate([\r\n-        'chat_id' => 'required|integer',\r\n-        'message' => 'required|string',\r\n-    ]);\r\n+    public function sendMessage(Request $request)\r\n+    {\r\n+        $validated = $request->validate([\r\n+            'chat_id' => 'required|integer',\r\n+            'message' => 'required|string',\r\n+            'user_id' => 'nullable|integer',\r\n+        ]);\r\n \r\n-    try {\r\n-        $senderId = auth()->id(); // always from token\r\n+        try {\r\n+            $senderId = $validated['user_id'] ?? auth()->id();\r\n \r\n-        if (!$senderId) {\r\n-            return response()->json(['error' => 'Unauthenticated'], 401);\r\n-        }\r\n+            $message = Message::create([\r\n+                'chat_id' => $validated['chat_id'],\r\n+                'user_id' => $senderId,\r\n+                'message' => $validated['message'],\r\n+                'is_read' => 0,\r\n+            ]);\r\n \r\n-        $message = Message::create([\r\n-            'chat_id' => $validated['chat_id'],\r\n-            'user_id' => $senderId,\r\n-            'message' => $validated['message'],\r\n-            'is_read' => 0,\r\n-        ]);\r\n+            $message->load('user');\r\n+            broadcast(new MessageSent($message))->toOthers();\r\n \r\n-        $message->load('user');\r\n-        broadcast(new MessageSent($message))->toOthers();\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'message' => $message,\r\n-        ]);\r\n-\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'message' => $message,\r\n+            ]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n     }\r\n-}\r\n \r\n-\r\n-    // ==============================\r\n     // MARK MESSAGES AS READ\r\n-    // expects 'chat_id' in request body\r\n-    // ==============================\r\n     public function markAsRead(Request $request)\r\n     {\r\n         try {\r\n             $chatId = $request->input('chat_id');\r\n-            if (!$chatId) {\r\n-                return response()->json(['success' => false, 'message' => 'chat_id required'], 422);\r\n-            }\r\n-\r\n             $chat = Chat::findOrFail($chatId);\r\n             $userId = auth()->id();\r\n \r\n             $chat->messages()\r\n@@ -132,16 +100,13 @@\n                 ->update(['is_read' => true]);\r\n \r\n             return response()->json(['success' => true]);\r\n         } catch (\\Exception $e) {\r\n-            \\Log::error('markAsRead error: ' . $e->getMessage());\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // ==============================\r\n     // GET QUICK REPLIES\r\n-    // ==============================\r\n     public function getQuickReplies($roleId)\r\n     {\r\n         try {\r\n             $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n@@ -149,9 +114,8 @@\n                 ->get();\r\n \r\n             return response()->json($quickReplies);\r\n         } catch (\\Exception $e) {\r\n-            \\Log::error('getQuickReplies error: ' . $e->getMessage());\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n }\r\n"
                },
                {
                    "date": 1763538341833,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,133 @@\n+<?php\r\n+\r\n+namespace App\\Http\\Controllers\\mobile;\r\n+\r\n+use App\\Http\\Controllers\\Controller;\r\n+use Illuminate\\Http\\Request;\r\n+use App\\Models\\Chat;\r\n+use App\\Models\\Message;\r\n+use App\\Models\\QuickReply;\r\n+use App\\Models\\User;\r\n+use App\\Events\\MessageSent;\r\n+\r\n+class MobileChatController extends Controller\r\n+{\r\n+    // GET OR CREATE CHAT FOR MEMBER\r\n+public function getOrCreateChat()\r\n+{\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['error' => 'Unauthorized user'], 401);\r\n+        }\r\n+\r\n+        // Fetch a fixed admin with role_id = 3 (Adjust role_id if different)\r\n+        $admin = User::where('role_id', 3)->first();\r\n+        if (!$admin) {\r\n+            return response()->json(['error' => 'No admin user available'], 500);\r\n+        }\r\n+\r\n+        // Query for existing chat with both user and admin IDs non-null and matching exactly\r\n+        $chat = Chat::where('user_id', $memberId)\r\n+                    ->where('admin_id', $admin->id)\r\n+                    ->first();\r\n+\r\n+        if (!$chat) {\r\n+            // Use DB transaction to prevent race conditions creating multiple chats on concurrent requests\r\n+            $chat = \\DB::transaction(function() use ($memberId, $admin) {\r\n+                return Chat::create([\r\n+                    'user_id' => $memberId,\r\n+                    'admin_id' => $admin->id,\r\n+                    'support_staff_id' => null,\r\n+                ]);\r\n+            });\r\n+        }\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id,\r\n+        ]);\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n+    }\r\n+}\r\n+\r\n+    // FETCH CHAT HISTORY\r\n+    public function getChatHistory($chatId)\r\n+    {\r\n+        try {\r\n+            $messages = Message::with('user:id,name,role_id')\r\n+                ->where('chat_id', $chatId)\r\n+                ->orderBy('created_at', 'asc')\r\n+                ->get();\r\n+\r\n+            return response()->json($messages);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // SEND MESSAGE\r\n+    public function sendMessage(Request $request)\r\n+    {\r\n+        $validated = $request->validate([\r\n+            'chat_id' => 'required|integer',\r\n+            'message' => 'required|string',\r\n+            'user_id' => 'nullable|integer',\r\n+        ]);\r\n+\r\n+        try {\r\n+            $senderId = $validated['user_id'] ?? auth()->id();\r\n+\r\n+            $message = Message::create([\r\n+                'chat_id' => $validated['chat_id'],\r\n+                'user_id' => $senderId,\r\n+                'message' => $validated['message'],\r\n+                'is_read' => 0,\r\n+            ]);\r\n+\r\n+            $message->load('user');\r\n+            broadcast(new MessageSent($message))->toOthers();\r\n+\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'message' => $message,\r\n+            ]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // MARK MESSAGES AS READ\r\n+    public function markAsRead(Request $request)\r\n+    {\r\n+        try {\r\n+            $chatId = $request->input('chat_id');\r\n+            $chat = Chat::findOrFail($chatId);\r\n+            $userId = auth()->id();\r\n+\r\n+            $chat->messages()\r\n+                ->where('user_id', '!=', $userId)\r\n+                ->where('is_read', false)\r\n+                ->update(['is_read' => true]);\r\n+\r\n+            return response()->json(['success' => true]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // GET QUICK REPLIES\r\n+    public function getQuickReplies($roleId)\r\n+    {\r\n+        try {\r\n+            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n+                ->select('id', 'question', 'answer', 'for_role_id')\r\n+                ->get();\r\n+\r\n+            return response()->json($quickReplies);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1763538866813,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,158 +11,33 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET OR CREATE CHAT FOR MEMBER\r\n-public function getOrCreateChat()\r\n-{\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['error' => 'Unauthorized user'], 401);\r\n-        }\r\n-\r\n-        // Fetch a fixed admin with role_id = 3 (Adjust role_id if different)\r\n-        $admin = User::where('role_id', 3)->first();\r\n-        if (!$admin) {\r\n-            return response()->json(['error' => 'No admin user available'], 500);\r\n-        }\r\n-\r\n-        // Query for existing chat with both user and admin IDs non-null and matching exactly\r\n-        $chat = Chat::where('user_id', $memberId)\r\n-                    ->where('admin_id', $admin->id)\r\n-                    ->first();\r\n-\r\n-        if (!$chat) {\r\n-            // Use DB transaction to prevent race conditions creating multiple chats on concurrent requests\r\n-            $chat = \\DB::transaction(function() use ($memberId, $admin) {\r\n-                return Chat::create([\r\n-                    'user_id' => $memberId,\r\n-                    'admin_id' => $admin->id,\r\n-                    'support_staff_id' => null,\r\n-                ]);\r\n-            });\r\n-        }\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id,\r\n-        ]);\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n-    }\r\n-}\r\n-\r\n-    // FETCH CHAT HISTORY\r\n-    public function getChatHistory($chatId)\r\n+    // GET CHAT FOR MEMBER (no creation)\r\n+    public function getChat()\r\n     {\r\n         try {\r\n-            $messages = Message::with('user:id,name,role_id')\r\n-                ->where('chat_id', $chatId)\r\n-                ->orderBy('created_at', 'asc')\r\n-                ->get();\r\n+            $memberId = auth()->id();\r\n+            if (!$memberId) {\r\n+                return response()->json(['error' => 'Unauthorized user'], 401);\r\n+            }\r\n \r\n-            return response()->json($messages);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // SEND MESSAGE\r\n-    public function sendMessage(Request $request)\r\n-    {\r\n-        $validated = $request->validate([\r\n-            'chat_id' => 'required|integer',\r\n-            'message' => 'required|string',\r\n-            'user_id' => 'nullable|integer',\r\n-        ]);\r\n-\r\n-        try {\r\n-            $senderId = $validated['user_id'] ?? auth()->id();\r\n-\r\n-            $message = Message::create([\r\n-                'chat_id' => $validated['chat_id'],\r\n-                'user_id' => $senderId,\r\n-                'message' => $validated['message'],\r\n-                'is_read' => 0,\r\n-            ]);\r\n-\r\n-            $message->load('user');\r\n-            broadcast(new MessageSent($message))->toOthers();\r\n-\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'message' => $message,\r\n-            ]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // MARK MESSAGES AS READ\r\n-    public function markAsRead(Request $request)\r\n-    {\r\n-        try {\r\n-            $chatId = $request->input('chat_id');\r\n-            $chat = Chat::findOrFail($chatId);\r\n-            $userId = auth()->id();\r\n-\r\n-            $chat->messages()\r\n-                ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', false)\r\n-                ->update(['is_read' => true]);\r\n-\r\n-            return response()->json(['success' => true]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // GET QUICK REPLIES\r\n-    public function getQuickReplies($roleId)\r\n-    {\r\n-        try {\r\n-            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n-                ->select('id', 'question', 'answer', 'for_role_id')\r\n-                ->get();\r\n-\r\n-            return response()->json($quickReplies);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-}\r\n-<?php\r\n-\r\n-namespace App\\Http\\Controllers\\mobile;\r\n-\r\n-use App\\Http\\Controllers\\Controller;\r\n-use Illuminate\\Http\\Request;\r\n-use App\\Models\\Chat;\r\n-use App\\Models\\Message;\r\n-use App\\Models\\QuickReply;\r\n-use App\\Models\\User;\r\n-use App\\Events\\MessageSent;\r\n-\r\n-class MobileChatController extends Controller\r\n-{\r\n-    // GET OR CREATE CHAT FOR MEMBER\r\n-    public function getOrCreateChat()\r\n-    {\r\n-        try {\r\n-            $memberId = auth()->id();\r\n+            // Fetch fixed admin by role_id = 3\r\n             $admin = User::where('role_id', 3)->first();\r\n+            if (!$admin) {\r\n+                return response()->json(['error' => 'No admin user available'], 500);\r\n+            }\r\n \r\n+            // Retrieve existing chat ONLY, no creation\r\n             $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin?->id)\r\n+                        ->where('admin_id', $admin->id)\r\n                         ->first();\r\n \r\n             if (!$chat) {\r\n-                $chat = Chat::create([\r\n-                    'user_id' => $memberId,\r\n-                    'admin_id' => $admin?->id,\r\n-                    'support_staff_id' => null,\r\n-                ]);\r\n+                return response()->json([\r\n+                    'success' => false,\r\n+                    'message' => 'No chat found for this user and admin.',\r\n+                ], 404);\r\n             }\r\n \r\n             return response()->json([\r\n                 'success' => true,\r\n"
                },
                {
                    "date": 1763540064113,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -51,9 +51,10 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n-            $messages = Message::with('user:id,name,role_id')\r\n+            // Eager load user relation with correct columns matching your users table schema\r\n+            $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n \r\n"
                },
                {
                    "date": 1763540349598,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -51,10 +51,9 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n-            // Eager load user relation with correct columns matching your users table schema\r\n-            $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n+            $messages = Message::with('user:id,name,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n \r\n"
                },
                {
                    "date": 1763540378159,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -51,9 +51,10 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n-            $messages = Message::with('user:id,name,role_id')\r\n+            // Eager load user relation with correct columns matching your users table schema\r\n+            $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n \r\n"
                },
                {
                    "date": 1765180886915,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,5 +126,46 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n+\r\n+    /**\r\n+ * Get or create chat for authenticated member with admin\r\n+ */\r\n+public function getOrCreateChat()\r\n+{\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['error' => 'Unauthorized user'], 401);\r\n+        }\r\n+\r\n+        // Fetch fixed admin by role_id = 3\r\n+        $admin = User::where('role_id', 3)->first();\r\n+        if (!$admin) {\r\n+            return response()->json(['error' => 'No admin user available'], 500);\r\n+        }\r\n+\r\n+        // Retrieve existing chat\r\n+        $chat = Chat::where('user_id', $memberId)\r\n+                    ->where('admin_id', $admin->id)\r\n+                    ->first();\r\n+\r\n+        // Create chat if it doesn't exist\r\n+        if (!$chat) {\r\n+            $chat = Chat::create([\r\n+                'user_id' => $memberId,\r\n+                'admin_id' => $admin->id,\r\n+                'support_staff_id' => null, // optional if your schema has this\r\n+            ]);\r\n+        }\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id,\r\n+        ]);\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n+    }\r\n }\r\n+\r\n+}\r\n"
                },
                {
                    "date": 1765181072901,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -127,45 +127,6 @@\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    /**\r\n- * Get or create chat for authenticated member with admin\r\n- */\r\n-public function getOrCreateChat()\r\n-{\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['error' => 'Unauthorized user'], 401);\r\n-        }\r\n-\r\n-        // Fetch fixed admin by role_id = 3\r\n-        $admin = User::where('role_id', 3)->first();\r\n-        if (!$admin) {\r\n-            return response()->json(['error' => 'No admin user available'], 500);\r\n-        }\r\n-\r\n-        // Retrieve existing chat\r\n-        $chat = Chat::where('user_id', $memberId)\r\n-                    ->where('admin_id', $admin->id)\r\n-                    ->first();\r\n-\r\n-        // Create chat if it doesn't exist\r\n-        if (!$chat) {\r\n-            $chat = Chat::create([\r\n-                'user_id' => $memberId,\r\n-                'admin_id' => $admin->id,\r\n-                'support_staff_id' => null, // optional if your schema has this\r\n-            ]);\r\n-        }\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id,\r\n-        ]);\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n-    }\r\n+    \r\n }\r\n-\r\n-}\r\n"
                },
                {
                    "date": 1765181195206,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,7 +126,5 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-\r\n-    \r\n }\r\n"
                },
                {
                    "date": 1765181295247,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,5 +126,6 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n+    \r\n }\r\n"
                },
                {
                    "date": 1765181303118,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,6 +126,49 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-    \r\n+    // CREATE CHAT RELATION AFTER USER AGREES\r\n+public function createChat(Request $request)\r\n+{\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['error' => 'Unauthorized user'], 401);\r\n+        }\r\n+\r\n+        // Fetch fixed admin by role_id = 3\r\n+        $admin = User::where('role_id', 3)->first();\r\n+        if (!$admin) {\r\n+            return response()->json(['error' => 'No admin user available'], 500);\r\n+        }\r\n+\r\n+        // Check if chat already exists\r\n+        $chat = Chat::where('user_id', $memberId)\r\n+                    ->where('admin_id', $admin->id)\r\n+                    ->first();\r\n+\r\n+        if ($chat) {\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $chat->id,\r\n+                'message' => 'Chat already exists',\r\n+            ]);\r\n+        }\r\n+\r\n+        // Create new chat\r\n+        $chat = Chat::create([\r\n+            'user_id' => $memberId,\r\n+            'admin_id' => $admin->id,\r\n+        ]);\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id,\r\n+            'message' => 'Chat created successfully',\r\n+        ]);\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n+    }\r\n }\r\n+\r\n+}\r\n"
                },
                {
                    "date": 1765181603158,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,10 +126,10 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-    // CREATE CHAT RELATION AFTER USER AGREES\r\n-public function createChat(Request $request)\r\n+    // CREATE CHAT IF NOT EXISTS (new relation)\r\n+public function createChat()\r\n {\r\n     try {\r\n         $memberId = auth()->id();\r\n         if (!$memberId) {\r\n@@ -146,26 +146,19 @@\n         $chat = Chat::where('user_id', $memberId)\r\n                     ->where('admin_id', $admin->id)\r\n                     ->first();\r\n \r\n-        if ($chat) {\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $chat->id,\r\n-                'message' => 'Chat already exists',\r\n+        if (!$chat) {\r\n+            // Create new chat\r\n+            $chat = Chat::create([\r\n+                'user_id' => $memberId,\r\n+                'admin_id' => $admin->id,\r\n             ]);\r\n         }\r\n \r\n-        // Create new chat\r\n-        $chat = Chat::create([\r\n-            'user_id' => $memberId,\r\n-            'admin_id' => $admin->id,\r\n-        ]);\r\n-\r\n         return response()->json([\r\n             'success' => true,\r\n             'chat_id' => $chat->id,\r\n-            'message' => 'Chat created successfully',\r\n         ]);\r\n     } catch (\\Exception $e) {\r\n         return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n"
                },
                {
                    "date": 1765181825188,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,32 +126,32 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-    // CREATE CHAT IF NOT EXISTS (new relation)\r\n-public function createChat()\r\n+    // CREATE (OR GET) CHAT AFTER USER AGREES\r\n+public function createOrGetChat(Request $request)\r\n {\r\n     try {\r\n         $memberId = auth()->id();\r\n         if (!$memberId) {\r\n             return response()->json(['error' => 'Unauthorized user'], 401);\r\n         }\r\n \r\n-        // Fetch fixed admin by role_id = 3\r\n+        // Fixed admin with role_id = 3\r\n         $admin = User::where('role_id', 3)->first();\r\n         if (!$admin) {\r\n             return response()->json(['error' => 'No admin user available'], 500);\r\n         }\r\n \r\n-        // Check if chat already exists\r\n+        // Check if chat already exists between this member and admin\r\n         $chat = Chat::where('user_id', $memberId)\r\n                     ->where('admin_id', $admin->id)\r\n                     ->first();\r\n \r\n+        // If no chat yet, create a new relation\r\n         if (!$chat) {\r\n-            // Create new chat\r\n             $chat = Chat::create([\r\n-                'user_id' => $memberId,\r\n+                'user_id'  => $memberId,\r\n                 'admin_id' => $admin->id,\r\n             ]);\r\n         }\r\n \r\n"
                },
                {
                    "date": 1765182096837,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,42 +126,5 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-    // CREATE (OR GET) CHAT AFTER USER AGREES\r\n-public function createOrGetChat(Request $request)\r\n-{\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['error' => 'Unauthorized user'], 401);\r\n-        }\r\n-\r\n-        // Fixed admin with role_id = 3\r\n-        $admin = User::where('role_id', 3)->first();\r\n-        if (!$admin) {\r\n-            return response()->json(['error' => 'No admin user available'], 500);\r\n-        }\r\n-\r\n-        // Check if chat already exists between this member and admin\r\n-        $chat = Chat::where('user_id', $memberId)\r\n-                    ->where('admin_id', $admin->id)\r\n-                    ->first();\r\n-\r\n-        // If no chat yet, create a new relation\r\n-        if (!$chat) {\r\n-            $chat = Chat::create([\r\n-                'user_id'  => $memberId,\r\n-                'admin_id' => $admin->id,\r\n-            ]);\r\n-        }\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id,\r\n-        ]);\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n-    }\r\n }\r\n-\r\n-}\r\n"
                },
                {
                    "date": 1765197227728,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,129 @@\n+<?php\r\n+\r\n+namespace App\\Http\\Controllers\\mobile;\r\n+\r\n+use App\\Http\\Controllers\\Controller;\r\n+use Illuminate\\Http\\Request;\r\n+use App\\Models\\Chat;\r\n+use App\\Models\\Message;\r\n+use App\\Models\\QuickReply;\r\n+use App\\Models\\User;\r\n+use App\\Events\\MessageSent;\r\n+\r\n+class MobileChatController extends Controller\r\n+{\r\n+    public function getChat()\r\n+    {\r\n+        try {\r\n+            $memberId = auth()->id();\r\n+            if (!$memberId) {\r\n+                return response()->json(['error' => 'Unauthorized user'], 401);\r\n+            }\r\n+\r\n+            // Fetch fixed admin by role_id = 3\r\n+            $admin = User::where('role_id', 3)->first();\r\n+            if (!$admin) {\r\n+                return response()->json(['error' => 'No admin user available'], 500);\r\n+            }\r\n+\r\n+            // Retrieve existing chat ONLY, no creation\r\n+            $chat = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $admin->id)\r\n+                        ->first();\r\n+\r\n+            if (!$chat) {\r\n+                return response()->json([\r\n+                    'success' => false,\r\n+                    'message' => 'No chat found for this user and admin.',\r\n+                ], 404);\r\n+            }\r\n+\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $chat->id,\r\n+            ]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // FETCH CHAT HISTORY\r\n+    public function getChatHistory($chatId)\r\n+    {\r\n+        try {\r\n+            // Eager load user relation with correct columns matching your users table schema\r\n+            $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n+                ->where('chat_id', $chatId)\r\n+                ->orderBy('created_at', 'asc')\r\n+                ->get();\r\n+\r\n+            return response()->json($messages);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // SEND MESSAGE\r\n+    public function sendMessage(Request $request)\r\n+    {\r\n+        $validated = $request->validate([\r\n+            'chat_id' => 'required|integer',\r\n+            'message' => 'required|string',\r\n+            'user_id' => 'nullable|integer',\r\n+        ]);\r\n+\r\n+        try {\r\n+            $senderId = $validated['user_id'] ?? auth()->id();\r\n+\r\n+            $message = Message::create([\r\n+                'chat_id' => $validated['chat_id'],\r\n+                'user_id' => $senderId,\r\n+                'message' => $validated['message'],\r\n+                'is_read' => 0,\r\n+            ]);\r\n+\r\n+            $message->load('user');\r\n+            broadcast(new MessageSent($message))->toOthers();\r\n+\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'message' => $message,\r\n+            ]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // MARK MESSAGES AS READ\r\n+    public function markAsRead(Request $request)\r\n+    {\r\n+        try {\r\n+            $chatId = $request->input('chat_id');\r\n+            $chat = Chat::findOrFail($chatId);\r\n+            $userId = auth()->id();\r\n+\r\n+            $chat->messages()\r\n+                ->where('user_id', '!=', $userId)\r\n+                ->where('is_read', false)\r\n+                ->update(['is_read' => true]);\r\n+\r\n+            return response()->json(['success' => true]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // GET QUICK REPLIES\r\n+    public function getQuickReplies($roleId)\r\n+    {\r\n+        try {\r\n+            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n+                ->select('id', 'question', 'answer', 'for_role_id')\r\n+                ->get();\r\n+\r\n+            return response()->json($quickReplies);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1765198070041,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -125,135 +125,45 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-}\r\n-<?php\r\n-\r\n-namespace App\\Http\\Controllers\\mobile;\r\n-\r\n-use App\\Http\\Controllers\\Controller;\r\n-use Illuminate\\Http\\Request;\r\n-use App\\Models\\Chat;\r\n-use App\\Models\\Message;\r\n-use App\\Models\\QuickReply;\r\n-use App\\Models\\User;\r\n-use App\\Events\\MessageSent;\r\n-\r\n-class MobileChatController extends Controller\r\n+    public function createChat()\r\n {\r\n-    // GET CHAT FOR MEMBER (no creation)\r\n-    public function getChat()\r\n-    {\r\n-        try {\r\n-            $memberId = auth()->id();\r\n-            if (!$memberId) {\r\n-                return response()->json(['error' => 'Unauthorized user'], 401);\r\n-            }\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['error' => 'Unauthorized'], 401);\r\n+        }\r\n \r\n-            // Fetch fixed admin by role_id = 3\r\n-            $admin = User::where('role_id', 3)->first();\r\n-            if (!$admin) {\r\n-                return response()->json(['error' => 'No admin user available'], 500);\r\n-            }\r\n+        // fixed admin id = 1\r\n+        $adminId = 1;\r\n \r\n-            // Retrieve existing chat ONLY, no creation\r\n-            $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin->id)\r\n+        // check if chat already exists\r\n+        $existing = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $adminId)\r\n                         ->first();\r\n \r\n-            if (!$chat) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No chat found for this user and admin.',\r\n-                ], 404);\r\n-            }\r\n-\r\n+        if ($existing) {\r\n             return response()->json([\r\n                 'success' => true,\r\n-                'chat_id' => $chat->id,\r\n+                'chat_id' => $existing->id,\r\n+                'message' => 'Chat already exists.'\r\n             ]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n-    }\r\n \r\n-    // FETCH CHAT HISTORY\r\n-    public function getChatHistory($chatId)\r\n-    {\r\n-        try {\r\n-            // Eager load user relation with correct columns matching your users table schema\r\n-            $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n-                ->where('chat_id', $chatId)\r\n-                ->orderBy('created_at', 'asc')\r\n-                ->get();\r\n+        // create new chat\r\n+        $chat = Chat::create([\r\n+            'user_id' => $memberId,\r\n+            'admin_id' => $adminId,\r\n+        ]);\r\n \r\n-            return response()->json($messages);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // SEND MESSAGE\r\n-    public function sendMessage(Request $request)\r\n-    {\r\n-        $validated = $request->validate([\r\n-            'chat_id' => 'required|integer',\r\n-            'message' => 'required|string',\r\n-            'user_id' => 'nullable|integer',\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id,\r\n         ]);\r\n \r\n-        try {\r\n-            $senderId = $validated['user_id'] ?? auth()->id();\r\n-\r\n-            $message = Message::create([\r\n-                'chat_id' => $validated['chat_id'],\r\n-                'user_id' => $senderId,\r\n-                'message' => $validated['message'],\r\n-                'is_read' => 0,\r\n-            ]);\r\n-\r\n-            $message->load('user');\r\n-            broadcast(new MessageSent($message))->toOthers();\r\n-\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'message' => $message,\r\n-            ]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n+}\r\n \r\n-    // MARK MESSAGES AS READ\r\n-    public function markAsRead(Request $request)\r\n-    {\r\n-        try {\r\n-            $chatId = $request->input('chat_id');\r\n-            $chat = Chat::findOrFail($chatId);\r\n-            $userId = auth()->id();\r\n-\r\n-            $chat->messages()\r\n-                ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', false)\r\n-                ->update(['is_read' => true]);\r\n-\r\n-            return response()->json(['success' => true]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // GET QUICK REPLIES\r\n-    public function getQuickReplies($roleId)\r\n-    {\r\n-        try {\r\n-            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n-                ->select('id', 'question', 'answer', 'for_role_id')\r\n-                ->get();\r\n-\r\n-            return response()->json($quickReplies);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n }\r\n"
                },
                {
                    "date": 1765198505372,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -125,45 +125,21 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-    public function createChat()\r\n+public function createChat()\r\n {\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['error' => 'Unauthorized'], 401);\r\n-        }\r\n+    $memberId = auth()->id();\r\n \r\n-        // fixed admin id = 1\r\n-        $adminId = 1;\r\n+    $chat = Chat::create([\r\n+        'user_id' => $memberId,   // <-- must match table column\r\n+        'admin_id' => 1,\r\n+    ]);\r\n \r\n-        // check if chat already exists\r\n-        $existing = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $adminId)\r\n-                        ->first();\r\n+    return response()->json([\r\n+        'success' => true,\r\n+        'chat_id' => $chat->id,\r\n+    ]);\r\n+}\r\n \r\n-        if ($existing) {\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $existing->id,\r\n-                'message' => 'Chat already exists.'\r\n-            ]);\r\n-        }\r\n \r\n-        // create new chat\r\n-        $chat = Chat::create([\r\n-            'user_id' => $memberId,\r\n-            'admin_id' => $adminId,\r\n-        ]);\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id,\r\n-        ]);\r\n-\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n-    }\r\n }\r\n-\r\n-}\r\n"
                },
                {
                    "date": 1765198587960,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -125,21 +125,45 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-public function createChat()\r\n+    public function createChat()\r\n {\r\n-    $memberId = auth()->id();\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['error' => 'Unauthorized'], 401);\r\n+        }\r\n \r\n-    $chat = Chat::create([\r\n-        'user_id' => $memberId,   // <-- must match table column\r\n-        'admin_id' => 1,\r\n-    ]);\r\n+        // fixed admin id = 1\r\n+        $adminId = 1;\r\n \r\n-    return response()->json([\r\n-        'success' => true,\r\n-        'chat_id' => $chat->id,\r\n-    ]);\r\n-}\r\n+        // check if chat already exists\r\n+        $existing = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $adminId)\r\n+                        ->first();\r\n \r\n+        if ($existing) {\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $existing->id,\r\n+                'message' => 'Chat already exists.'\r\n+            ]);\r\n+        }\r\n \r\n+        // create new chat\r\n+        $chat = Chat::create([\r\n+            'user_id' => $memberId,\r\n+            'admin_id' => $adminId,\r\n+        ]);\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id,\r\n+        ]);\r\n+\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n+    }\r\n }\r\n+\r\n+}\r\n"
                },
                {
                    "date": 1765198662956,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,25 +11,21 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n+    // GET CHAT OR 404\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n             if (!$memberId) {\r\n                 return response()->json(['error' => 'Unauthorized user'], 401);\r\n             }\r\n \r\n-            // Fetch fixed admin by role_id = 3\r\n-            $admin = User::where('role_id', 3)->first();\r\n-            if (!$admin) {\r\n-                return response()->json(['error' => 'No admin user available'], 500);\r\n-            }\r\n+            $adminId = 1; // fixed\r\n \r\n-            // Retrieve existing chat ONLY, no creation\r\n             $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin->id)\r\n+                        ->where('admin_id', $adminId)\r\n                         ->first();\r\n \r\n             if (!$chat) {\r\n                 return response()->json([\r\n@@ -41,40 +37,42 @@\n             return response()->json([\r\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n+\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n+\r\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n-            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n \r\n             return response()->json($messages);\r\n+\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n+\r\n     // SEND MESSAGE\r\n     public function sendMessage(Request $request)\r\n     {\r\n         $validated = $request->validate([\r\n             'chat_id' => 'required|integer',\r\n             'message' => 'required|string',\r\n-            'user_id' => 'nullable|integer',\r\n         ]);\r\n \r\n         try {\r\n-            $senderId = $validated['user_id'] ?? auth()->id();\r\n+            $senderId = auth()->id();\r\n \r\n             $message = Message::create([\r\n                 'chat_id' => $validated['chat_id'],\r\n                 'user_id' => $senderId,\r\n@@ -88,32 +86,36 @@\n             return response()->json([\r\n                 'success' => true,\r\n                 'message' => $message,\r\n             ]);\r\n+\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // MARK MESSAGES AS READ\r\n+\r\n+    // MARK AS READ\r\n     public function markAsRead(Request $request)\r\n     {\r\n         try {\r\n             $chatId = $request->input('chat_id');\r\n-            $chat = Chat::findOrFail($chatId);\r\n             $userId = auth()->id();\r\n \r\n-            $chat->messages()\r\n+            Chat::findOrFail($chatId)\r\n+                ->messages()\r\n                 ->where('user_id', '!=', $userId)\r\n                 ->where('is_read', false)\r\n                 ->update(['is_read' => true]);\r\n \r\n             return response()->json(['success' => true]);\r\n+\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n+\r\n     // GET QUICK REPLIES\r\n     public function getQuickReplies($roleId)\r\n     {\r\n         try {\r\n@@ -121,49 +123,50 @@\n                 ->select('id', 'question', 'answer', 'for_role_id')\r\n                 ->get();\r\n \r\n             return response()->json($quickReplies);\r\n+\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n+\r\n+\r\n+    // CREATE CHAT\r\n     public function createChat()\r\n-{\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['error' => 'Unauthorized'], 401);\r\n-        }\r\n+    {\r\n+        try {\r\n+            $memberId = auth()->id();\r\n+            if (!$memberId) {\r\n+                return response()->json(['error' => 'Unauthorized'], 401);\r\n+            }\r\n \r\n-        // fixed admin id = 1\r\n-        $adminId = 1;\r\n+            $adminId = 1; // fixed\r\n \r\n-        // check if chat already exists\r\n-        $existing = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $adminId)\r\n-                        ->first();\r\n+            // Check existing chat\r\n+            $existing = Chat::where('user_id', $memberId)\r\n+                            ->where('admin_id', $adminId)\r\n+                            ->first();\r\n \r\n-        if ($existing) {\r\n+            if ($existing) {\r\n+                return response()->json([\r\n+                    'success' => true,\r\n+                    'chat_id' => $existing->id,\r\n+                ]);\r\n+            }\r\n+\r\n+            // Create new chat\r\n+            $chat = Chat::create([\r\n+                'user_id' => $memberId,\r\n+                'admin_id' => $adminId,\r\n+            ]);\r\n+\r\n             return response()->json([\r\n                 'success' => true,\r\n-                'chat_id' => $existing->id,\r\n-                'message' => 'Chat already exists.'\r\n+                'chat_id' => $chat->id,\r\n             ]);\r\n+\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n-\r\n-        // create new chat\r\n-        $chat = Chat::create([\r\n-            'user_id' => $memberId,\r\n-            'admin_id' => $adminId,\r\n-        ]);\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id,\r\n-        ]);\r\n-\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n-\r\n-}\r\n"
                },
                {
                    "date": 1765198700237,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,21 +11,26 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET CHAT OR 404\r\n+    // GET CHAT FOR MEMBER (no creation)\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n             if (!$memberId) {\r\n                 return response()->json(['error' => 'Unauthorized user'], 401);\r\n             }\r\n \r\n-            $adminId = 1; // fixed\r\n+            // Fetch fixed admin by role_id = 3\r\n+            $admin = User::where('role_id', 3)->first();\r\n+            if (!$admin) {\r\n+                return response()->json(['error' => 'No admin user available'], 500);\r\n+            }\r\n \r\n+            // Retrieve existing chat ONLY, no creation\r\n             $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $adminId)\r\n+                        ->where('admin_id', $admin->id)\r\n                         ->first();\r\n \r\n             if (!$chat) {\r\n                 return response()->json([\r\n@@ -37,42 +42,40 @@\n             return response()->json([\r\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n-\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-\r\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n+            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n \r\n             return response()->json($messages);\r\n-\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-\r\n     // SEND MESSAGE\r\n     public function sendMessage(Request $request)\r\n     {\r\n         $validated = $request->validate([\r\n             'chat_id' => 'required|integer',\r\n             'message' => 'required|string',\r\n+            'user_id' => 'nullable|integer',\r\n         ]);\r\n \r\n         try {\r\n-            $senderId = auth()->id();\r\n+            $senderId = $validated['user_id'] ?? auth()->id();\r\n \r\n             $message = Message::create([\r\n                 'chat_id' => $validated['chat_id'],\r\n                 'user_id' => $senderId,\r\n@@ -86,36 +89,32 @@\n             return response()->json([\r\n                 'success' => true,\r\n                 'message' => $message,\r\n             ]);\r\n-\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-\r\n-    // MARK AS READ\r\n+    // MARK MESSAGES AS READ\r\n     public function markAsRead(Request $request)\r\n     {\r\n         try {\r\n             $chatId = $request->input('chat_id');\r\n+            $chat = Chat::findOrFail($chatId);\r\n             $userId = auth()->id();\r\n \r\n-            Chat::findOrFail($chatId)\r\n-                ->messages()\r\n+            $chat->messages()\r\n                 ->where('user_id', '!=', $userId)\r\n                 ->where('is_read', false)\r\n                 ->update(['is_read' => true]);\r\n \r\n             return response()->json(['success' => true]);\r\n-\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-\r\n     // GET QUICK REPLIES\r\n     public function getQuickReplies($roleId)\r\n     {\r\n         try {\r\n@@ -123,50 +122,9 @@\n                 ->select('id', 'question', 'answer', 'for_role_id')\r\n                 ->get();\r\n \r\n             return response()->json($quickReplies);\r\n-\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-\r\n-\r\n-    // CREATE CHAT\r\n-    public function createChat()\r\n-    {\r\n-        try {\r\n-            $memberId = auth()->id();\r\n-            if (!$memberId) {\r\n-                return response()->json(['error' => 'Unauthorized'], 401);\r\n-            }\r\n-\r\n-            $adminId = 1; // fixed\r\n-\r\n-            // Check existing chat\r\n-            $existing = Chat::where('user_id', $memberId)\r\n-                            ->where('admin_id', $adminId)\r\n-                            ->first();\r\n-\r\n-            if ($existing) {\r\n-                return response()->json([\r\n-                    'success' => true,\r\n-                    'chat_id' => $existing->id,\r\n-                ]);\r\n-            }\r\n-\r\n-            // Create new chat\r\n-            $chat = Chat::create([\r\n-                'user_id' => $memberId,\r\n-                'admin_id' => $adminId,\r\n-            ]);\r\n-\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $chat->id,\r\n-            ]);\r\n-\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n }\r\n"
                },
                {
                    "date": 1765198720380,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,9 +11,8 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET CHAT FOR MEMBER (no creation)\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n@@ -126,5 +125,45 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n+    public function createChat()\r\n+{\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['error' => 'Unauthorized'], 401);\r\n+        }\r\n+\r\n+        // fixed admin id = 1\r\n+        $adminId = 1;\r\n+\r\n+        // check if chat already exists\r\n+        $existing = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $adminId)\r\n+                        ->first();\r\n+\r\n+        if ($existing) {\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $existing->id,\r\n+                'message' => 'Chat already exists.'\r\n+            ]);\r\n+        }\r\n+\r\n+        // create new chat\r\n+        $chat = Chat::create([\r\n+            'user_id' => $memberId,\r\n+            'admin_id' => $adminId,\r\n+        ]);\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id,\r\n+        ]);\r\n+\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n+    }\r\n }\r\n+\r\n+}\r\n"
                },
                {
                    "date": 1765198863557,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,43 +11,44 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    public function getChat()\r\n-    {\r\n-        try {\r\n-            $memberId = auth()->id();\r\n-            if (!$memberId) {\r\n-                return response()->json(['error' => 'Unauthorized user'], 401);\r\n-            }\r\n+public function getChat()\r\n+{\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['success' => false, 'message' => 'Unauthorized'], 401);\r\n+        }\r\n \r\n-            // Fetch fixed admin by role_id = 3\r\n-            $admin = User::where('role_id', 3)->first();\r\n-            if (!$admin) {\r\n-                return response()->json(['error' => 'No admin user available'], 500);\r\n-            }\r\n+        // fixed admin id = 1\r\n+        $adminId = 1;\r\n \r\n-            // Retrieve existing chat ONLY, no creation\r\n-            $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin->id)\r\n-                        ->first();\r\n+        $chat = Chat::where('user_id', $memberId)\r\n+                    ->where('admin_id', $adminId)\r\n+                    ->first();\r\n \r\n-            if (!$chat) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No chat found for this user and admin.',\r\n-                ], 404);\r\n-            }\r\n-\r\n+        if (!$chat) {\r\n             return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $chat->id,\r\n-            ]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n+                'success' => false,\r\n+                'message' => 'No chat found'\r\n+            ], 404);\r\n         }\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id\r\n+        ]);\r\n+\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json([\r\n+            'success' => false,\r\n+            'message' => $e->getMessage()\r\n+        ], 500);\r\n     }\r\n+}\r\n \r\n+\r\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n"
                },
                {
                    "date": 1765198879259,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,44 +11,43 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-public function getChat()\r\n-{\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['success' => false, 'message' => 'Unauthorized'], 401);\r\n-        }\r\n+    public function getChat()\r\n+    {\r\n+        try {\r\n+            $memberId = auth()->id();\r\n+            if (!$memberId) {\r\n+                return response()->json(['error' => 'Unauthorized user'], 401);\r\n+            }\r\n \r\n-        // fixed admin id = 1\r\n-        $adminId = 1;\r\n+            // Fetch fixed admin by role_id = 3\r\n+            $admin = User::where('role_id', 3)->first();\r\n+            if (!$admin) {\r\n+                return response()->json(['error' => 'No admin user available'], 500);\r\n+            }\r\n \r\n-        $chat = Chat::where('user_id', $memberId)\r\n-                    ->where('admin_id', $adminId)\r\n-                    ->first();\r\n+            // Retrieve existing chat ONLY, no creation\r\n+            $chat = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $admin->id)\r\n+                        ->first();\r\n \r\n-        if (!$chat) {\r\n+            if (!$chat) {\r\n+                return response()->json([\r\n+                    'success' => false,\r\n+                    'message' => 'No chat found for this user and admin.',\r\n+                ], 404);\r\n+            }\r\n+\r\n             return response()->json([\r\n-                'success' => false,\r\n-                'message' => 'No chat found'\r\n-            ], 404);\r\n+                'success' => true,\r\n+                'chat_id' => $chat->id,\r\n+            ]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id\r\n-        ]);\r\n-\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json([\r\n-            'success' => false,\r\n-            'message' => $e->getMessage()\r\n-        ], 500);\r\n     }\r\n-}\r\n \r\n-\r\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n"
                },
                {
                    "date": 1765199125869,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,169 +0,0 @@\n-<?php\r\n-\r\n-namespace App\\Http\\Controllers\\mobile;\r\n-\r\n-use App\\Http\\Controllers\\Controller;\r\n-use Illuminate\\Http\\Request;\r\n-use App\\Models\\Chat;\r\n-use App\\Models\\Message;\r\n-use App\\Models\\QuickReply;\r\n-use App\\Models\\User;\r\n-use App\\Events\\MessageSent;\r\n-\r\n-class MobileChatController extends Controller\r\n-{\r\n-    public function getChat()\r\n-    {\r\n-        try {\r\n-            $memberId = auth()->id();\r\n-            if (!$memberId) {\r\n-                return response()->json(['error' => 'Unauthorized user'], 401);\r\n-            }\r\n-\r\n-            // Fetch fixed admin by role_id = 3\r\n-            $admin = User::where('role_id', 3)->first();\r\n-            if (!$admin) {\r\n-                return response()->json(['error' => 'No admin user available'], 500);\r\n-            }\r\n-\r\n-            // Retrieve existing chat ONLY, no creation\r\n-            $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin->id)\r\n-                        ->first();\r\n-\r\n-            if (!$chat) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No chat found for this user and admin.',\r\n-                ], 404);\r\n-            }\r\n-\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $chat->id,\r\n-            ]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // FETCH CHAT HISTORY\r\n-    public function getChatHistory($chatId)\r\n-    {\r\n-        try {\r\n-            // Eager load user relation with correct columns matching your users table schema\r\n-            $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n-                ->where('chat_id', $chatId)\r\n-                ->orderBy('created_at', 'asc')\r\n-                ->get();\r\n-\r\n-            return response()->json($messages);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // SEND MESSAGE\r\n-    public function sendMessage(Request $request)\r\n-    {\r\n-        $validated = $request->validate([\r\n-            'chat_id' => 'required|integer',\r\n-            'message' => 'required|string',\r\n-            'user_id' => 'nullable|integer',\r\n-        ]);\r\n-\r\n-        try {\r\n-            $senderId = $validated['user_id'] ?? auth()->id();\r\n-\r\n-            $message = Message::create([\r\n-                'chat_id' => $validated['chat_id'],\r\n-                'user_id' => $senderId,\r\n-                'message' => $validated['message'],\r\n-                'is_read' => 0,\r\n-            ]);\r\n-\r\n-            $message->load('user');\r\n-            broadcast(new MessageSent($message))->toOthers();\r\n-\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'message' => $message,\r\n-            ]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // MARK MESSAGES AS READ\r\n-    public function markAsRead(Request $request)\r\n-    {\r\n-        try {\r\n-            $chatId = $request->input('chat_id');\r\n-            $chat = Chat::findOrFail($chatId);\r\n-            $userId = auth()->id();\r\n-\r\n-            $chat->messages()\r\n-                ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', false)\r\n-                ->update(['is_read' => true]);\r\n-\r\n-            return response()->json(['success' => true]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-\r\n-    // GET QUICK REPLIES\r\n-    public function getQuickReplies($roleId)\r\n-    {\r\n-        try {\r\n-            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n-                ->select('id', 'question', 'answer', 'for_role_id')\r\n-                ->get();\r\n-\r\n-            return response()->json($quickReplies);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n-        }\r\n-    }\r\n-    public function createChat()\r\n-{\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['error' => 'Unauthorized'], 401);\r\n-        }\r\n-\r\n-        // fixed admin id = 1\r\n-        $adminId = 1;\r\n-\r\n-        // check if chat already exists\r\n-        $existing = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $adminId)\r\n-                        ->first();\r\n-\r\n-        if ($existing) {\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $existing->id,\r\n-                'message' => 'Chat already exists.'\r\n-            ]);\r\n-        }\r\n-\r\n-        // create new chat\r\n-        $chat = Chat::create([\r\n-            'user_id' => $memberId,\r\n-            'admin_id' => $adminId,\r\n-        ]);\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id,\r\n-        ]);\r\n-\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n-    }\r\n-}\r\n-\r\n-}\r\n\\ No newline at end of file\n"
                },
                {
                    "date": 1765199206919,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,130 @@\n-\n+<?php\r\n+\r\n+namespace App\\Http\\Controllers\\mobile;\r\n+\r\n+use App\\Http\\Controllers\\Controller;\r\n+use Illuminate\\Http\\Request;\r\n+use App\\Models\\Chat;\r\n+use App\\Models\\Message;\r\n+use App\\Models\\QuickReply;\r\n+use App\\Models\\User;\r\n+use App\\Events\\MessageSent;\r\n+\r\n+class MobileChatController extends Controller\r\n+{\r\n+    // GET CHAT FOR MEMBER (no creation)\r\n+    public function getChat()\r\n+    {\r\n+        try {\r\n+            $memberId = auth()->id();\r\n+            if (!$memberId) {\r\n+                return response()->json(['error' => 'Unauthorized user'], 401);\r\n+            }\r\n+\r\n+            // Fetch fixed admin by role_id = 3\r\n+            $admin = User::where('role_id', 3)->first();\r\n+            if (!$admin) {\r\n+                return response()->json(['error' => 'No admin user available'], 500);\r\n+            }\r\n+\r\n+            // Retrieve existing chat ONLY, no creation\r\n+            $chat = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $admin->id)\r\n+                        ->first();\r\n+\r\n+            if (!$chat) {\r\n+                return response()->json([\r\n+                    'success' => false,\r\n+                    'message' => 'No chat found for this user and admin.',\r\n+                ], 404);\r\n+            }\r\n+\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $chat->id,\r\n+            ]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // FETCH CHAT HISTORY\r\n+    public function getChatHistory($chatId)\r\n+    {\r\n+        try {\r\n+            // Eager load user relation with correct columns matching your users table schema\r\n+            $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n+                ->where('chat_id', $chatId)\r\n+                ->orderBy('created_at', 'asc')\r\n+                ->get();\r\n+\r\n+            return response()->json($messages);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // SEND MESSAGE\r\n+    public function sendMessage(Request $request)\r\n+    {\r\n+        $validated = $request->validate([\r\n+            'chat_id' => 'required|integer',\r\n+            'message' => 'required|string',\r\n+            'user_id' => 'nullable|integer',\r\n+        ]);\r\n+\r\n+        try {\r\n+            $senderId = $validated['user_id'] ?? auth()->id();\r\n+\r\n+            $message = Message::create([\r\n+                'chat_id' => $validated['chat_id'],\r\n+                'user_id' => $senderId,\r\n+                'message' => $validated['message'],\r\n+                'is_read' => 0,\r\n+            ]);\r\n+\r\n+            $message->load('user');\r\n+            broadcast(new MessageSent($message))->toOthers();\r\n+\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'message' => $message,\r\n+            ]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // MARK MESSAGES AS READ\r\n+    public function markAsRead(Request $request)\r\n+    {\r\n+        try {\r\n+            $chatId = $request->input('chat_id');\r\n+            $chat = Chat::findOrFail($chatId);\r\n+            $userId = auth()->id();\r\n+\r\n+            $chat->messages()\r\n+                ->where('user_id', '!=', $userId)\r\n+                ->where('is_read', false)\r\n+                ->update(['is_read' => true]);\r\n+\r\n+            return response()->json(['success' => true]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+\r\n+    // GET QUICK REPLIES\r\n+    public function getQuickReplies($roleId)\r\n+    {\r\n+        try {\r\n+            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n+                ->select('id', 'question', 'answer', 'for_role_id')\r\n+                ->get();\r\n+\r\n+            return response()->json($quickReplies);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n+        }\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1765199261985,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,5 +126,45 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n+    public function createChat()\r\n+{\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['error' => 'Unauthorized'], 401);\r\n+        }\r\n+\r\n+        // fixed admin id = 1\r\n+        $adminId = 1;\r\n+\r\n+        // check if chat already exists\r\n+        $existing = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $adminId)\r\n+                        ->first();\r\n+\r\n+        if ($existing) {\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $existing->id,\r\n+                'message' => 'Chat already exists.'\r\n+            ]);\r\n+        }\r\n+\r\n+        // create new chat\r\n+        $chat = Chat::create([\r\n+            'user_id' => $memberId,\r\n+            'admin_id' => $adminId,\r\n+        ]);\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id,\r\n+        ]);\r\n+\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n+    }\r\n }\r\n+\r\n+}\r\n"
                },
                {
                    "date": 1765199692522,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,45 +126,6 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-    public function createChat()\r\n-{\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['error' => 'Unauthorized'], 401);\r\n-        }\r\n-\r\n-        // fixed admin id = 1\r\n-        $adminId = 1;\r\n-\r\n-        // check if chat already exists\r\n-        $existing = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $adminId)\r\n-                        ->first();\r\n-\r\n-        if ($existing) {\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $existing->id,\r\n-                'message' => 'Chat already exists.'\r\n-            ]);\r\n-        }\r\n-\r\n-        // create new chat\r\n-        $chat = Chat::create([\r\n-            'user_id' => $memberId,\r\n-            'admin_id' => $adminId,\r\n-        ]);\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id,\r\n-        ]);\r\n-\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n-    }\r\n+    \r\n }\r\n-\r\n-}\r\n"
                },
                {
                    "date": 1765201059438,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,6 +126,42 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-    \r\n+    public function createChat()\r\n+{\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['error' => 'Unauthorized'], 401);\r\n+        }\r\n+\r\n+        $adminId = 1;\r\n+\r\n+        // check if chat already exists\r\n+        $existing = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $adminId)\r\n+                        ->first();\r\n+\r\n+        if ($existing) {\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $existing->id,\r\n+                'message' => 'Chat already exists.'\r\n+            ]);\r\n+        }\r\n+        $chat = Chat::create([\r\n+            'user_id' => $memberId,\r\n+            'admin_id' => $adminId,\r\n+        ]);\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id,\r\n+        ]);\r\n+\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n+    }\r\n }\r\n+\r\n+}\r\n"
                },
                {
                    "date": 1765201543754,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,9 +11,9 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET CHAT FOR MEMBER (no creation)\r\n+    // GET OR CREATE CHAT FOR MEMBER\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n@@ -26,20 +26,14 @@\n             if (!$admin) {\r\n                 return response()->json(['error' => 'No admin user available'], 500);\r\n             }\r\n \r\n-            // Retrieve existing chat ONLY, no creation\r\n-            $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin->id)\r\n-                        ->first();\r\n+            // Retrieve existing chat or create new one\r\n+            $chat = Chat::firstOrCreate(\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n+            );\r\n \r\n-            if (!$chat) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No chat found for this user and admin.',\r\n-                ], 404);\r\n-            }\r\n-\r\n             return response()->json([\r\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n@@ -51,9 +45,8 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n-            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n@@ -104,10 +97,10 @@\n             $userId = auth()->id();\r\n \r\n             $chat->messages()\r\n                 ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', false)\r\n-                ->update(['is_read' => true]);\r\n+                ->where('is_read', 0)\r\n+                ->update(['is_read' => 1]);\r\n \r\n             return response()->json(['success' => true]);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n@@ -126,42 +119,34 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n+\r\n+    // CREATE CHAT (fallback, optional)\r\n     public function createChat()\r\n-{\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['error' => 'Unauthorized'], 401);\r\n-        }\r\n+    {\r\n+        try {\r\n+            $memberId = auth()->id();\r\n+            if (!$memberId) {\r\n+                return response()->json(['error' => 'Unauthorized'], 401);\r\n+            }\r\n \r\n-        $adminId = 1;\r\n+            // Fixed admin by role_id = 3\r\n+            $admin = User::where('role_id', 3)->first();\r\n+            if (!$admin) {\r\n+                return response()->json(['error' => 'No admin user available'], 500);\r\n+            }\r\n \r\n-        // check if chat already exists\r\n-        $existing = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $adminId)\r\n-                        ->first();\r\n+            $chat = Chat::firstOrCreate(\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n+            );\r\n \r\n-        if ($existing) {\r\n             return response()->json([\r\n                 'success' => true,\r\n-                'chat_id' => $existing->id,\r\n-                'message' => 'Chat already exists.'\r\n+                'chat_id' => $chat->id,\r\n             ]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n-        $chat = Chat::create([\r\n-            'user_id' => $memberId,\r\n-            'admin_id' => $adminId,\r\n-        ]);\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id,\r\n-        ]);\r\n-\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n-\r\n-}\r\n"
                },
                {
                    "date": 1765201739718,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,9 +11,9 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET OR CREATE CHAT FOR MEMBER\r\n+    // GET CHAT FOR MEMBER (no creation)\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n@@ -26,14 +26,20 @@\n             if (!$admin) {\r\n                 return response()->json(['error' => 'No admin user available'], 500);\r\n             }\r\n \r\n-            // Retrieve existing chat or create new one\r\n-            $chat = Chat::firstOrCreate(\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n-            );\r\n+            // Retrieve existing chat ONLY, no creation\r\n+            $chat = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $admin->id)\r\n+                        ->first();\r\n \r\n+            if (!$chat) {\r\n+                return response()->json([\r\n+                    'success' => false,\r\n+                    'message' => 'No chat found for this user and admin.',\r\n+                ], 404);\r\n+            }\r\n+\r\n             return response()->json([\r\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n@@ -45,8 +51,9 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n+            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n@@ -97,10 +104,10 @@\n             $userId = auth()->id();\r\n \r\n             $chat->messages()\r\n                 ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', 0)\r\n-                ->update(['is_read' => 1]);\r\n+                ->where('is_read', false)\r\n+                ->update(['is_read' => true]);\r\n \r\n             return response()->json(['success' => true]);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n@@ -119,34 +126,42 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-\r\n-    // CREATE CHAT (fallback, optional)\r\n     public function createChat()\r\n-    {\r\n-        try {\r\n-            $memberId = auth()->id();\r\n-            if (!$memberId) {\r\n-                return response()->json(['error' => 'Unauthorized'], 401);\r\n-            }\r\n+{\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['error' => 'Unauthorized'], 401);\r\n+        }\r\n \r\n-            // Fixed admin by role_id = 3\r\n-            $admin = User::where('role_id', 3)->first();\r\n-            if (!$admin) {\r\n-                return response()->json(['error' => 'No admin user available'], 500);\r\n-            }\r\n+        $adminId = 1;\r\n \r\n-            $chat = Chat::firstOrCreate(\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n-            );\r\n+        // check if chat already exists\r\n+        $existing = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $adminId)\r\n+                        ->first();\r\n \r\n+        if ($existing) {\r\n             return response()->json([\r\n                 'success' => true,\r\n-                'chat_id' => $chat->id,\r\n+                'chat_id' => $existing->id,\r\n+                'message' => 'Chat already exists.'\r\n             ]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n+        $chat = Chat::create([\r\n+            'user_id' => $memberId,\r\n+            'admin_id' => $adminId,\r\n+        ]);\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id,\r\n+        ]);\r\n+\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n+\r\n+}\r\n"
                },
                {
                    "date": 1765202201821,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,35 +11,29 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET CHAT FOR MEMBER (no creation)\r\n+    // GET OR CREATE CHAT FOR MEMBER\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n             if (!$memberId) {\r\n                 return response()->json(['error' => 'Unauthorized user'], 401);\r\n             }\r\n \r\n-            // Fetch fixed admin by role_id = 3\r\n+            // Fetch first admin with role_id = 3\r\n             $admin = User::where('role_id', 3)->first();\r\n             if (!$admin) {\r\n                 return response()->json(['error' => 'No admin user available'], 500);\r\n             }\r\n \r\n-            // Retrieve existing chat ONLY, no creation\r\n-            $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin->id)\r\n-                        ->first();\r\n+            // Retrieve existing chat or create a new one\r\n+            $chat = Chat::firstOrCreate(\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n+            );\r\n \r\n-            if (!$chat) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No chat found for this user and admin.',\r\n-                ], 404);\r\n-            }\r\n-\r\n             return response()->json([\r\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n@@ -51,9 +45,8 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n-            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n@@ -67,9 +60,9 @@\n     // SEND MESSAGE\r\n     public function sendMessage(Request $request)\r\n     {\r\n         $validated = $request->validate([\r\n-            'chat_id' => 'required|integer',\r\n+            'chat_id' => 'required|integer|exists:chats,id',\r\n             'message' => 'required|string',\r\n             'user_id' => 'nullable|integer',\r\n         ]);\r\n \r\n@@ -104,62 +97,64 @@\n             $userId = auth()->id();\r\n \r\n             $chat->messages()\r\n                 ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', false)\r\n-                ->update(['is_read' => true]);\r\n+                ->where('is_read', 0)\r\n+                ->update(['is_read' => 1]);\r\n \r\n             return response()->json(['success' => true]);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // GET QUICK REPLIES\r\n-    public function getQuickReplies($roleId)\r\n+    // GET QUICK REPLIES FOR MEMBER\r\n+    public function getQuickReplies()\r\n     {\r\n         try {\r\n-            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n+            $userRoleId = auth()->user()->role_id;\r\n+            $quickReplies = QuickReply::where('for_role_id', $userRoleId)\r\n                 ->select('id', 'question', 'answer', 'for_role_id')\r\n                 ->get();\r\n \r\n             return response()->json($quickReplies);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-    public function createChat()\r\n+\r\n+    // CREATE CHAT MANUALLY (optional)\r\n+public function createChat()\r\n {\r\n     try {\r\n         $memberId = auth()->id();\r\n         if (!$memberId) {\r\n             return response()->json(['error' => 'Unauthorized'], 401);\r\n         }\r\n \r\n-        $adminId = 1;\r\n+        // Fetch the admin\r\n+        $admin = User::where('role_id', 3)->first();\r\n+        if (!$admin) {\r\n+            return response()->json(['error' => 'No admin user available'], 500);\r\n+        }\r\n \r\n-        // check if chat already exists\r\n-        $existing = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $adminId)\r\n-                        ->first();\r\n+        // Create or retrieve the chat and ensure support_staff_id is set\r\n+        $chat = Chat::firstOrCreate(\r\n+            [\r\n+                'user_id' => $memberId,\r\n+                'admin_id' => $admin->id,\r\n+            ],\r\n+            [\r\n+                'user_id' => $memberId,\r\n+                'admin_id' => $admin->id,\r\n+                'support_staff_id' => $memberId, // set support_staff_id to user_id\r\n+            ]\r\n+        );\r\n \r\n-        if ($existing) {\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $existing->id,\r\n-                'message' => 'Chat already exists.'\r\n-            ]);\r\n-        }\r\n-        $chat = Chat::create([\r\n-            'user_id' => $memberId,\r\n-            'admin_id' => $adminId,\r\n-        ]);\r\n-\r\n         return response()->json([\r\n             'success' => true,\r\n             'chat_id' => $chat->id,\r\n         ]);\r\n-\r\n     } catch (\\Exception $e) {\r\n         return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n"
                },
                {
                    "date": 1765202324775,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,29 +11,35 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET OR CREATE CHAT FOR MEMBER\r\n+    // GET CHAT FOR MEMBER (no creation)\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n             if (!$memberId) {\r\n                 return response()->json(['error' => 'Unauthorized user'], 401);\r\n             }\r\n \r\n-            // Fetch first admin with role_id = 3\r\n+            // Fetch fixed admin by role_id = 3\r\n             $admin = User::where('role_id', 3)->first();\r\n             if (!$admin) {\r\n                 return response()->json(['error' => 'No admin user available'], 500);\r\n             }\r\n \r\n-            // Retrieve existing chat or create a new one\r\n-            $chat = Chat::firstOrCreate(\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n-            );\r\n+            // Retrieve existing chat ONLY, no creation\r\n+            $chat = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $admin->id)\r\n+                        ->first();\r\n \r\n+            if (!$chat) {\r\n+                return response()->json([\r\n+                    'success' => false,\r\n+                    'message' => 'No chat found for this user and admin.',\r\n+                ], 404);\r\n+            }\r\n+\r\n             return response()->json([\r\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n@@ -45,8 +51,9 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n+            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n@@ -60,9 +67,9 @@\n     // SEND MESSAGE\r\n     public function sendMessage(Request $request)\r\n     {\r\n         $validated = $request->validate([\r\n-            'chat_id' => 'required|integer|exists:chats,id',\r\n+            'chat_id' => 'required|integer',\r\n             'message' => 'required|string',\r\n             'user_id' => 'nullable|integer',\r\n         ]);\r\n \r\n@@ -97,64 +104,62 @@\n             $userId = auth()->id();\r\n \r\n             $chat->messages()\r\n                 ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', 0)\r\n-                ->update(['is_read' => 1]);\r\n+                ->where('is_read', false)\r\n+                ->update(['is_read' => true]);\r\n \r\n             return response()->json(['success' => true]);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // GET QUICK REPLIES FOR MEMBER\r\n-    public function getQuickReplies()\r\n+    // GET QUICK REPLIES\r\n+    public function getQuickReplies($roleId)\r\n     {\r\n         try {\r\n-            $userRoleId = auth()->user()->role_id;\r\n-            $quickReplies = QuickReply::where('for_role_id', $userRoleId)\r\n+            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n                 ->select('id', 'question', 'answer', 'for_role_id')\r\n                 ->get();\r\n \r\n             return response()->json($quickReplies);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-\r\n-    // CREATE CHAT MANUALLY (optional)\r\n-public function createChat()\r\n+    public function createChat()\r\n {\r\n     try {\r\n         $memberId = auth()->id();\r\n         if (!$memberId) {\r\n             return response()->json(['error' => 'Unauthorized'], 401);\r\n         }\r\n \r\n-        // Fetch the admin\r\n-        $admin = User::where('role_id', 3)->first();\r\n-        if (!$admin) {\r\n-            return response()->json(['error' => 'No admin user available'], 500);\r\n+        $adminId = 1;\r\n+\r\n+        // check if chat already exists\r\n+        $existing = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $adminId)\r\n+                        ->first();\r\n+\r\n+        if ($existing) {\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $existing->id,\r\n+                'message' => 'Chat already exists.'\r\n+            ]);\r\n         }\r\n+        $chat = Chat::create([\r\n+            'user_id' => $memberId,\r\n+            'admin_id' => $adminId,\r\n+        ]);\r\n \r\n-        // Create or retrieve the chat and ensure support_staff_id is set\r\n-        $chat = Chat::firstOrCreate(\r\n-            [\r\n-                'user_id' => $memberId,\r\n-                'admin_id' => $admin->id,\r\n-            ],\r\n-            [\r\n-                'user_id' => $memberId,\r\n-                'admin_id' => $admin->id,\r\n-                'support_staff_id' => $memberId, // set support_staff_id to user_id\r\n-            ]\r\n-        );\r\n-\r\n         return response()->json([\r\n             'success' => true,\r\n             'chat_id' => $chat->id,\r\n         ]);\r\n+\r\n     } catch (\\Exception $e) {\r\n         return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n"
                },
                {
                    "date": 1765202375414,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -151,8 +151,9 @@\n         }\r\n         $chat = Chat::create([\r\n             'user_id' => $memberId,\r\n             'admin_id' => $adminId,\r\n+            'support_staff_id' => $memberId,\r\n         ]);\r\n \r\n         return response()->json([\r\n             'success' => true,\r\n"
                },
                {
                    "date": 1765202449602,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,35 +11,29 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET CHAT FOR MEMBER (no creation)\r\n+    // GET OR CREATE CHAT FOR MEMBER\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n             if (!$memberId) {\r\n                 return response()->json(['error' => 'Unauthorized user'], 401);\r\n             }\r\n \r\n-            // Fetch fixed admin by role_id = 3\r\n+            // Fetch first admin with role_id = 3\r\n             $admin = User::where('role_id', 3)->first();\r\n             if (!$admin) {\r\n                 return response()->json(['error' => 'No admin user available'], 500);\r\n             }\r\n \r\n-            // Retrieve existing chat ONLY, no creation\r\n-            $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin->id)\r\n-                        ->first();\r\n+            // Retrieve existing chat or create a new one\r\n+            $chat = Chat::firstOrCreate(\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n+            );\r\n \r\n-            if (!$chat) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No chat found for this user and admin.',\r\n-                ], 404);\r\n-            }\r\n-\r\n             return response()->json([\r\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n@@ -51,9 +45,8 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n-            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n@@ -67,9 +60,9 @@\n     // SEND MESSAGE\r\n     public function sendMessage(Request $request)\r\n     {\r\n         $validated = $request->validate([\r\n-            'chat_id' => 'required|integer',\r\n+            'chat_id' => 'required|integer|exists:chats,id',\r\n             'message' => 'required|string',\r\n             'user_id' => 'nullable|integer',\r\n         ]);\r\n \r\n@@ -104,65 +97,56 @@\n             $userId = auth()->id();\r\n \r\n             $chat->messages()\r\n                 ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', false)\r\n-                ->update(['is_read' => true]);\r\n+                ->where('is_read', 0)\r\n+                ->update(['is_read' => 1]);\r\n \r\n             return response()->json(['success' => true]);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // GET QUICK REPLIES\r\n-    public function getQuickReplies($roleId)\r\n+    // GET QUICK REPLIES FOR MEMBER\r\n+    public function getQuickReplies()\r\n     {\r\n         try {\r\n-            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n+            $userRoleId = auth()->user()->role_id;\r\n+            $quickReplies = QuickReply::where('for_role_id', $userRoleId)\r\n                 ->select('id', 'question', 'answer', 'for_role_id')\r\n                 ->get();\r\n \r\n             return response()->json($quickReplies);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n+\r\n+    // CREATE CHAT MANUALLY (optional)\r\n     public function createChat()\r\n-{\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['error' => 'Unauthorized'], 401);\r\n-        }\r\n+    {\r\n+        try {\r\n+            $memberId = auth()->id();\r\n+            if (!$memberId) {\r\n+                return response()->json(['error' => 'Unauthorized'], 401);\r\n+            }\r\n \r\n-        $adminId = 1;\r\n+            $admin = User::where('role_id', 3)->first();\r\n+            if (!$admin) {\r\n+                return response()->json(['error' => 'No admin user available'], 500);\r\n+            }\r\n \r\n-        // check if chat already exists\r\n-        $existing = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $adminId)\r\n-                        ->first();\r\n+            $chat = Chat::firstOrCreate(\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n+            );\r\n \r\n-        if ($existing) {\r\n             return response()->json([\r\n                 'success' => true,\r\n-                'chat_id' => $existing->id,\r\n-                'message' => 'Chat already exists.'\r\n+                'chat_id' => $chat->id,\r\n             ]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n-        $chat = Chat::create([\r\n-            'user_id' => $memberId,\r\n-            'admin_id' => $adminId,\r\n-            'support_staff_id' => $memberId,\r\n-        ]);\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id,\r\n-        ]);\r\n-\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n-\r\n-}\r\n"
                },
                {
                    "date": 1765202461706,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,29 +11,35 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET OR CREATE CHAT FOR MEMBER\r\n+    // GET CHAT FOR MEMBER (no creation)\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n             if (!$memberId) {\r\n                 return response()->json(['error' => 'Unauthorized user'], 401);\r\n             }\r\n \r\n-            // Fetch first admin with role_id = 3\r\n+            // Fetch fixed admin by role_id = 3\r\n             $admin = User::where('role_id', 3)->first();\r\n             if (!$admin) {\r\n                 return response()->json(['error' => 'No admin user available'], 500);\r\n             }\r\n \r\n-            // Retrieve existing chat or create a new one\r\n-            $chat = Chat::firstOrCreate(\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n-            );\r\n+            // Retrieve existing chat ONLY, no creation\r\n+            $chat = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $admin->id)\r\n+                        ->first();\r\n \r\n+            if (!$chat) {\r\n+                return response()->json([\r\n+                    'success' => false,\r\n+                    'message' => 'No chat found for this user and admin.',\r\n+                ], 404);\r\n+            }\r\n+\r\n             return response()->json([\r\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n@@ -45,8 +51,9 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n+            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n@@ -60,9 +67,9 @@\n     // SEND MESSAGE\r\n     public function sendMessage(Request $request)\r\n     {\r\n         $validated = $request->validate([\r\n-            'chat_id' => 'required|integer|exists:chats,id',\r\n+            'chat_id' => 'required|integer',\r\n             'message' => 'required|string',\r\n             'user_id' => 'nullable|integer',\r\n         ]);\r\n \r\n@@ -97,56 +104,65 @@\n             $userId = auth()->id();\r\n \r\n             $chat->messages()\r\n                 ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', 0)\r\n-                ->update(['is_read' => 1]);\r\n+                ->where('is_read', false)\r\n+                ->update(['is_read' => true]);\r\n \r\n             return response()->json(['success' => true]);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // GET QUICK REPLIES FOR MEMBER\r\n-    public function getQuickReplies()\r\n+    // GET QUICK REPLIES\r\n+    public function getQuickReplies($roleId)\r\n     {\r\n         try {\r\n-            $userRoleId = auth()->user()->role_id;\r\n-            $quickReplies = QuickReply::where('for_role_id', $userRoleId)\r\n+            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n                 ->select('id', 'question', 'answer', 'for_role_id')\r\n                 ->get();\r\n \r\n             return response()->json($quickReplies);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-\r\n-    // CREATE CHAT MANUALLY (optional)\r\n     public function createChat()\r\n-    {\r\n-        try {\r\n-            $memberId = auth()->id();\r\n-            if (!$memberId) {\r\n-                return response()->json(['error' => 'Unauthorized'], 401);\r\n-            }\r\n+{\r\n+    try {\r\n+        $memberId = auth()->id();\r\n+        if (!$memberId) {\r\n+            return response()->json(['error' => 'Unauthorized'], 401);\r\n+        }\r\n \r\n-            $admin = User::where('role_id', 3)->first();\r\n-            if (!$admin) {\r\n-                return response()->json(['error' => 'No admin user available'], 500);\r\n-            }\r\n+        $adminId = 1;\r\n \r\n-            $chat = Chat::firstOrCreate(\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n-            );\r\n+        // check if chat already exists\r\n+        $existing = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $adminId)\r\n+                        ->first();\r\n \r\n+        if ($existing) {\r\n             return response()->json([\r\n                 'success' => true,\r\n-                'chat_id' => $chat->id,\r\n+                'chat_id' => $existing->id,\r\n+                'message' => 'Chat already exists.'\r\n             ]);\r\n-        } catch (\\Exception $e) {\r\n-            return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n+        $chat = Chat::create([\r\n+            'user_id' => $memberId,\r\n+            'admin_id' => $adminId,\r\n+            'support_staff_id' => $memberId,\r\n+        ]);\r\n+\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'chat_id' => $chat->id,\r\n+        ]);\r\n+\r\n+    } catch (\\Exception $e) {\r\n+        return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n+\r\n+}\r\n"
                },
                {
                    "date": 1765202506866,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,35 +11,29 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET CHAT FOR MEMBER (no creation)\r\n+    // GET OR CREATE CHAT FOR MEMBER\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n             if (!$memberId) {\r\n                 return response()->json(['error' => 'Unauthorized user'], 401);\r\n             }\r\n \r\n-            // Fetch fixed admin by role_id = 3\r\n+            // Fetch first admin with role_id = 3\r\n             $admin = User::where('role_id', 3)->first();\r\n             if (!$admin) {\r\n                 return response()->json(['error' => 'No admin user available'], 500);\r\n             }\r\n \r\n-            // Retrieve existing chat ONLY, no creation\r\n-            $chat = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $admin->id)\r\n-                        ->first();\r\n+            // Retrieve existing chat or create a new one\r\n+            $chat = Chat::firstOrCreate(\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n+            );\r\n \r\n-            if (!$chat) {\r\n-                return response()->json([\r\n-                    'success' => false,\r\n-                    'message' => 'No chat found for this user and admin.',\r\n-                ], 404);\r\n-            }\r\n-\r\n             return response()->json([\r\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n@@ -51,9 +45,8 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n-            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n@@ -67,9 +60,9 @@\n     // SEND MESSAGE\r\n     public function sendMessage(Request $request)\r\n     {\r\n         $validated = $request->validate([\r\n-            'chat_id' => 'required|integer',\r\n+            'chat_id' => 'required|integer|exists:chats,id',\r\n             'message' => 'required|string',\r\n             'user_id' => 'nullable|integer',\r\n         ]);\r\n \r\n@@ -104,63 +97,59 @@\n             $userId = auth()->id();\r\n \r\n             $chat->messages()\r\n                 ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', false)\r\n-                ->update(['is_read' => true]);\r\n+                ->where('is_read', 0)\r\n+                ->update(['is_read' => 1]);\r\n \r\n             return response()->json(['success' => true]);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // GET QUICK REPLIES\r\n-    public function getQuickReplies($roleId)\r\n+    // GET QUICK REPLIES FOR MEMBER\r\n+    public function getQuickReplies()\r\n     {\r\n         try {\r\n-            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n+            $userRoleId = auth()->user()->role_id;\r\n+            $quickReplies = QuickReply::where('for_role_id', $userRoleId)\r\n                 ->select('id', 'question', 'answer', 'for_role_id')\r\n                 ->get();\r\n \r\n             return response()->json($quickReplies);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-    public function createChat()\r\n+\r\n+    // CREATE CHAT MANUALLY (optional)\r\n+public function createChat()\r\n {\r\n     try {\r\n         $memberId = auth()->id();\r\n         if (!$memberId) {\r\n             return response()->json(['error' => 'Unauthorized'], 401);\r\n         }\r\n \r\n-        $adminId = 1;\r\n+        $admin = User::where('role_id', 3)->first();\r\n+        if (!$admin) {\r\n+            return response()->json(['error' => 'No admin user available'], 500);\r\n+        }\r\n \r\n-        // check if chat already exists\r\n-        $existing = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $adminId)\r\n-                        ->first();\r\n+        $chat = Chat::firstOrCreate(\r\n+            ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n+            [\r\n+                'user_id' => $memberId,\r\n+                'admin_id' => $admin->id,\r\n+                'support_staff_id' => $memberId, // add this line\r\n+            ]\r\n+        );\r\n \r\n-        if ($existing) {\r\n-            return response()->json([\r\n-                'success' => true,\r\n-                'chat_id' => $existing->id,\r\n-                'message' => 'Chat already exists.'\r\n-            ]);\r\n-        }\r\n-        $chat = Chat::create([\r\n-            'user_id' => $memberId,\r\n-            'admin_id' => $adminId,\r\n-            'support_staff_id' => $memberId,\r\n-        ]);\r\n-\r\n         return response()->json([\r\n             'success' => true,\r\n             'chat_id' => $chat->id,\r\n         ]);\r\n-\r\n     } catch (\\Exception $e) {\r\n         return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n"
                },
                {
                    "date": 1765202552784,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -122,36 +122,42 @@\n         }\r\n     }\r\n \r\n     // CREATE CHAT MANUALLY (optional)\r\n-public function createChat()\r\n+    public function createChat()\r\n {\r\n     try {\r\n         $memberId = auth()->id();\r\n         if (!$memberId) {\r\n             return response()->json(['error' => 'Unauthorized'], 401);\r\n         }\r\n \r\n-        $admin = User::where('role_id', 3)->first();\r\n-        if (!$admin) {\r\n-            return response()->json(['error' => 'No admin user available'], 500);\r\n+        $adminId = 1;\r\n+\r\n+        // check if chat already exists\r\n+        $existing = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $adminId)\r\n+                        ->first();\r\n+\r\n+        if ($existing) {\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'chat_id' => $existing->id,\r\n+                'message' => 'Chat already exists.'\r\n+            ]);\r\n         }\r\n+        $chat = Chat::create([\r\n+            'user_id' => $memberId,\r\n+            'admin_id' => $adminId,\r\n+            'support_staff_id' => $memberId,\r\n+        ]);\r\n \r\n-        $chat = Chat::firstOrCreate(\r\n-            ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n-            [\r\n-                'user_id' => $memberId,\r\n-                'admin_id' => $admin->id,\r\n-                'support_staff_id' => $memberId, // add this line\r\n-            ]\r\n-        );\r\n-\r\n         return response()->json([\r\n             'success' => true,\r\n             'chat_id' => $chat->id,\r\n         ]);\r\n+\r\n     } catch (\\Exception $e) {\r\n         return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n-\r\n }\r\n"
                },
                {
                    "date": 1765202580041,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,29 +11,35 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET OR CREATE CHAT FOR MEMBER\r\n+    // GET CHAT FOR MEMBER (no creation)\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n             if (!$memberId) {\r\n                 return response()->json(['error' => 'Unauthorized user'], 401);\r\n             }\r\n \r\n-            // Fetch first admin with role_id = 3\r\n+            // Fetch fixed admin by role_id = 3\r\n             $admin = User::where('role_id', 3)->first();\r\n             if (!$admin) {\r\n                 return response()->json(['error' => 'No admin user available'], 500);\r\n             }\r\n \r\n-            // Retrieve existing chat or create a new one\r\n-            $chat = Chat::firstOrCreate(\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n-                ['user_id' => $memberId, 'admin_id' => $admin->id]\r\n-            );\r\n+            // Retrieve existing chat ONLY, no creation\r\n+            $chat = Chat::where('user_id', $memberId)\r\n+                        ->where('admin_id', $admin->id)\r\n+                        ->first();\r\n \r\n+            if (!$chat) {\r\n+                return response()->json([\r\n+                    'success' => false,\r\n+                    'message' => 'No chat found for this user and admin.',\r\n+                ], 404);\r\n+            }\r\n+\r\n             return response()->json([\r\n                 'success' => true,\r\n                 'chat_id' => $chat->id,\r\n             ]);\r\n@@ -45,8 +51,9 @@\n     // FETCH CHAT HISTORY\r\n     public function getChatHistory($chatId)\r\n     {\r\n         try {\r\n+            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n@@ -60,9 +67,9 @@\n     // SEND MESSAGE\r\n     public function sendMessage(Request $request)\r\n     {\r\n         $validated = $request->validate([\r\n-            'chat_id' => 'required|integer|exists:chats,id',\r\n+            'chat_id' => 'required|integer',\r\n             'message' => 'required|string',\r\n             'user_id' => 'nullable|integer',\r\n         ]);\r\n \r\n@@ -97,33 +104,30 @@\n             $userId = auth()->id();\r\n \r\n             $chat->messages()\r\n                 ->where('user_id', '!=', $userId)\r\n-                ->where('is_read', 0)\r\n-                ->update(['is_read' => 1]);\r\n+                ->where('is_read', false)\r\n+                ->update(['is_read' => true]);\r\n \r\n             return response()->json(['success' => true]);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // GET QUICK REPLIES FOR MEMBER\r\n-    public function getQuickReplies()\r\n+    // GET QUICK REPLIES\r\n+    public function getQuickReplies($roleId)\r\n     {\r\n         try {\r\n-            $userRoleId = auth()->user()->role_id;\r\n-            $quickReplies = QuickReply::where('for_role_id', $userRoleId)\r\n+            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n                 ->select('id', 'question', 'answer', 'for_role_id')\r\n                 ->get();\r\n \r\n             return response()->json($quickReplies);\r\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n-\r\n-    // CREATE CHAT MANUALLY (optional)\r\n     public function createChat()\r\n {\r\n     try {\r\n         $memberId = auth()->id();\r\n@@ -159,5 +163,6 @@\n     } catch (\\Exception $e) {\r\n         return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n+\r\n }\r\n"
                },
                {
                    "date": 1765202672375,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,24 +11,24 @@\n use App\\Events\\MessageSent;\r\n \r\n class MobileChatController extends Controller\r\n {\r\n-    // GET CHAT FOR MEMBER (no creation)\r\n+    /**\r\n+     * Get existing chat for member (no creation).\r\n+     */\r\n     public function getChat()\r\n     {\r\n         try {\r\n             $memberId = auth()->id();\r\n             if (!$memberId) {\r\n                 return response()->json(['error' => 'Unauthorized user'], 401);\r\n             }\r\n \r\n-            // Fetch fixed admin by role_id = 3\r\n             $admin = User::where('role_id', 3)->first();\r\n             if (!$admin) {\r\n                 return response()->json(['error' => 'No admin user available'], 500);\r\n             }\r\n \r\n-            // Retrieve existing chat ONLY, no creation\r\n             $chat = Chat::where('user_id', $memberId)\r\n                         ->where('admin_id', $admin->id)\r\n                         ->first();\r\n \r\n@@ -47,13 +47,14 @@\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // FETCH CHAT HISTORY\r\n-    public function getChatHistory($chatId)\r\n+    /**\r\n+     * Fetch chat history messages.\r\n+     */\r\n+    public function getChatHistory(int $chatId)\r\n     {\r\n         try {\r\n-            // Eager load user relation with correct columns matching your users table schema\r\n             $messages = Message::with('user:id,first_name,middle_name,last_name,suffix,role_id')\r\n                 ->where('chat_id', $chatId)\r\n                 ->orderBy('created_at', 'asc')\r\n                 ->get();\r\n@@ -63,9 +64,11 @@\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // SEND MESSAGE\r\n+    /**\r\n+     * Send a message in a chat.\r\n+     */\r\n     public function sendMessage(Request $request)\r\n     {\r\n         $validated = $request->validate([\r\n             'chat_id' => 'required|integer',\r\n@@ -79,9 +82,9 @@\n             $message = Message::create([\r\n                 'chat_id' => $validated['chat_id'],\r\n                 'user_id' => $senderId,\r\n                 'message' => $validated['message'],\r\n-                'is_read' => 0,\r\n+                'is_read' => false,\r\n             ]);\r\n \r\n             $message->load('user');\r\n             broadcast(new MessageSent($message))->toOthers();\r\n@@ -94,9 +97,11 @@\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // MARK MESSAGES AS READ\r\n+    /**\r\n+     * Mark all messages in a chat as read.\r\n+     */\r\n     public function markAsRead(Request $request)\r\n     {\r\n         try {\r\n             $chatId = $request->input('chat_id');\r\n@@ -113,10 +118,12 @@\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n \r\n-    // GET QUICK REPLIES\r\n-    public function getQuickReplies($roleId)\r\n+    /**\r\n+     * Get quick replies for a specific role.\r\n+     */\r\n+    public function getQuickReplies(int $roleId)\r\n     {\r\n         try {\r\n             $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n                 ->select('id', 'question', 'answer', 'for_role_id')\r\n@@ -126,43 +133,40 @@\n         } catch (\\Exception $e) {\r\n             return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n     }\r\n+\r\n+    /**\r\n+     * Create a new chat if it doesn't exist.\r\n+     */\r\n     public function createChat()\r\n-{\r\n-    try {\r\n-        $memberId = auth()->id();\r\n-        if (!$memberId) {\r\n-            return response()->json(['error' => 'Unauthorized'], 401);\r\n-        }\r\n+    {\r\n+        try {\r\n+            $memberId = auth()->id();\r\n+            if (!$memberId) {\r\n+                return response()->json(['error' => 'Unauthorized'], 401);\r\n+            }\r\n \r\n-        $adminId = 1;\r\n+            $admin = User::where('role_id', 3)->first();\r\n+            if (!$admin) {\r\n+                return response()->json(['error' => 'No admin user available'], 500);\r\n+            }\r\n \r\n-        // check if chat already exists\r\n-        $existing = Chat::where('user_id', $memberId)\r\n-                        ->where('admin_id', $adminId)\r\n-                        ->first();\r\n+            $chat = Chat::firstOrCreate(\r\n+                ['user_id' => $memberId, 'admin_id' => $admin->id],\r\n+                [\r\n+                    'user_id' => $memberId,\r\n+                    'admin_id' => $admin->id,\r\n+                    'support_staff_id' => $memberId, // ensure this is never null\r\n+                ]\r\n+            );\r\n \r\n-        if ($existing) {\r\n             return response()->json([\r\n                 'success' => true,\r\n-                'chat_id' => $existing->id,\r\n-                'message' => 'Chat already exists.'\r\n+                'chat_id' => $chat->id,\r\n+                'message' => $chat->wasRecentlyCreated ? 'Chat created successfully.' : 'Chat already exists.',\r\n             ]);\r\n+        } catch (\\Exception $e) {\r\n+            return response()->json(['error' => $e->getMessage()], 500);\r\n         }\r\n-        $chat = Chat::create([\r\n-            'user_id' => $memberId,\r\n-            'admin_id' => $adminId,\r\n-            'support_staff_id' => $memberId,\r\n-        ]);\r\n-\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'chat_id' => $chat->id,\r\n-        ]);\r\n-\r\n-    } catch (\\Exception $e) {\r\n-        return response()->json(['error' => $e->getMessage()], 500);\r\n     }\r\n }\r\n-\r\n-}\r\n"
                }
            ],
            "date": 1763535241324,
            "name": "Commit-0",
            "content": "<?php\r\n\r\nnamespace App\\Http\\Controllers\\mobile;\r\n\r\nuse App\\Http\\Controllers\\Controller;\r\nuse Illuminate\\Http\\Request;\r\nuse App\\Models\\Chat;\r\nuse App\\Models\\Message;\r\nuse App\\Models\\QuickReply;\r\nuse App\\Models\\User;\r\nuse App\\Events\\MessageSent;\r\n\r\nclass MobileChatController extends Controller\r\n{\r\n    // ==============================\r\n    // GET OR CREATE CHAT FOR MEMBER\r\n    // Accepts optional 'user_id' in request body if auth() isn't available.\r\n    // ==============================\r\n    public function getOrCreateChat(Request $request)\r\n    {\r\n        try {\r\n            // Prefer authenticated user id, fall back to user_id provided by client\r\n            $memberId = auth()->id() ?? $request->input('user_id');\r\n\r\n            if (!$memberId) {\r\n                return response()->json([\r\n                    'success' => false,\r\n                    'message' => 'No user id provided and user is not authenticated.'\r\n                ], 422);\r\n            }\r\n\r\n            $admin = User::where('role_id', 3)->first();\r\n\r\n            // Try to find existing chat between this member and admin\r\n            $chat = Chat::where('user_id', $memberId)\r\n                        ->where('admin_id', $admin?->id)\r\n                        ->first();\r\n\r\n            // If not found, create it\r\n            if (!$chat) {\r\n                $chat = Chat::create([\r\n                    'user_id' => $memberId,\r\n                    'admin_id' => $admin?->id,\r\n                    'support_staff_id' => null,\r\n                ]);\r\n            }\r\n\r\n            return response()->json([\r\n                'success' => true,\r\n                'chat_id' => $chat->id,\r\n            ]);\r\n        } catch (\\Exception $e) {\r\n            \\Log::error('getOrCreateChat error: ' . $e->getMessage());\r\n            return response()->json(['error' => $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    // ==============================\r\n    // FETCH CHAT HISTORY\r\n    // ==============================\r\n    public function getChatHistory($chatId)\r\n    {\r\n        try {\r\n            $messages = Message::with('user:id,first_name,last_name,role_id')\r\n                ->where('chat_id', $chatId)\r\n                ->orderBy('created_at', 'asc')\r\n                ->get();\r\n\r\n            return response()->json($messages);\r\n        } catch (\\Exception $e) {\r\n            \\Log::error('getChatHistory error: ' . $e->getMessage());\r\n            return response()->json(['error' => $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    // ==============================\r\n    // SEND MESSAGE\r\n    // ==============================\r\n    public function sendMessage(Request $request)\r\n    {\r\n        $validated = $request->validate([\r\n            'chat_id' => 'required|integer',\r\n            'message' => 'required|string',\r\n            'user_id' => 'nullable|integer', // optional: client can pass user_id\r\n        ]);\r\n\r\n        try {\r\n            // Prefer provided user_id, then authenticated user\r\n            $senderId = $validated['user_id'] ?? auth()->id();\r\n\r\n            if (!$senderId) {\r\n                return response()->json([\r\n                    'success' => false,\r\n                    'message' => 'No sender user id provided and user is not authenticated.'\r\n                ], 422);\r\n            }\r\n\r\n            // Ensure chat exists\r\n            $chat = Chat::find($validated['chat_id']);\r\n            if (!$chat) {\r\n                return response()->json([\r\n                    'success' => false,\r\n                    'message' => 'Chat not found.'\r\n                ], 404);\r\n            }\r\n\r\n            // If chat exists but user_id is null, attach the sender as chat.user_id\r\n            // (this prevents creating multiple empty chats if earlier chat was null)\r\n            if ($chat->user_id === null) {\r\n                // If the sender is not an admin/support staff, assume it's the member\r\n                // We'll only attach if sender is not role_id 3 (admin) or 2 (support)\r\n                $sender = User::find($senderId);\r\n                if ($sender && $sender->role_id == 1) {\r\n                    $chat->user_id = $senderId;\r\n                    $chat->save();\r\n                }\r\n            }\r\n\r\n            $message = Message::create([\r\n                'chat_id' => $validated['chat_id'],\r\n                'user_id' => $senderId,\r\n                'message' => $validated['message'],\r\n                'is_read' => 0,\r\n            ]);\r\n\r\n            $message->load('user');\r\n            broadcast(new MessageSent($message))->toOthers();\r\n\r\n            return response()->json([\r\n                'success' => true,\r\n                'message' => $message,\r\n            ]);\r\n        } catch (\\Exception $e) {\r\n            \\Log::error('sendMessage error: ' . $e->getMessage());\r\n            return response()->json(['error' => $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    // ==============================\r\n    // MARK MESSAGES AS READ\r\n    // expects 'chat_id' in request body\r\n    // ==============================\r\n    public function markAsRead(Request $request)\r\n    {\r\n        try {\r\n            $chatId = $request->input('chat_id');\r\n            if (!$chatId) {\r\n                return response()->json(['success' => false, 'message' => 'chat_id required'], 422);\r\n            }\r\n\r\n            $chat = Chat::findOrFail($chatId);\r\n            $userId = auth()->id();\r\n\r\n            $chat->messages()\r\n                ->where('user_id', '!=', $userId)\r\n                ->where('is_read', false)\r\n                ->update(['is_read' => true]);\r\n\r\n            return response()->json(['success' => true]);\r\n        } catch (\\Exception $e) {\r\n            \\Log::error('markAsRead error: ' . $e->getMessage());\r\n            return response()->json(['error' => $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    // ==============================\r\n    // GET QUICK REPLIES\r\n    // ==============================\r\n    public function getQuickReplies($roleId)\r\n    {\r\n        try {\r\n            $quickReplies = QuickReply::where('for_role_id', $roleId)\r\n                ->select('id', 'question', 'answer', 'for_role_id')\r\n                ->get();\r\n\r\n            return response()->json($quickReplies);\r\n        } catch (\\Exception $e) {\r\n            \\Log::error('getQuickReplies error: ' . $e->getMessage());\r\n            return response()->json(['error' => $e->getMessage()], 500);\r\n        }\r\n    }\r\n}\r\n"
        }
    ]
}
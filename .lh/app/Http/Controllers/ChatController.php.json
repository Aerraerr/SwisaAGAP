{
    "sourceFile": "app/Http/Controllers/ChatController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1765177371872,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1765200963151,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -133,8 +133,10 @@\n     public function load($userId)\n     {\n         $currentUser = auth()->user();\n         $otherUser = User::findOrFail($userId);\n+\n+        // ✅ If admin is logged in (role_id = 3), ensure chat relation exists\n         if ($currentUser->role_id == 3) {\n             // Check existing chat between admin and selected user (any role)\n             $chat = Chat::where(function ($q) use ($currentUser, $otherUser) {\n                     $q->where('admin_id', $currentUser->id)\n"
                }
            ],
            "date": 1765177371872,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace App\\Http\\Controllers;\n\nuse App\\Models\\Chat;\nuse App\\Models\\Message;\nuse App\\Models\\QuickReply;\nuse App\\Models\\User;\nuse Illuminate\\Http\\Request;\nuse App\\Events\\MessageSent;\n\nclass ChatController extends Controller\n{\n    // ==============================\n    // ADMIN WEB INTERFACE METHODS\n    // ==============================\n    public function index()\n    {\n        $user = auth()->user();\n\n        $chats = Chat::with([\n            'admin',\n            'supportStaff',\n            'messages' => fn($q) => $q->latest()->limit(1)\n        ])\n        ->when($user->role_id == 2, fn($q) => $q->where('support_staff_id', $user->id))\n        ->get()\n        ->sortByDesc(fn($chat) => optional($chat->messages->first())->created_at ?? now()->subYears(10))\n        ->values();\n\n        $chat = $chats->first();\n        $messages = $chat ? $chat->messages()->with('user')->oldest()->get() : collect();\n        $quickReplies = QuickReply::all();\n\n        return view('swisa-admin.messages', compact('chats', 'chat', 'messages', 'quickReplies'));\n    }\n\n    public function show($userId)\n    {\n        $currentUser = auth()->user();\n        $otherUser = User::findOrFail($userId);\n\n        // Find or create chat between admin and support staff\n        $chat = Chat::where(function ($q) use ($currentUser, $otherUser) {\n                $q->where('admin_id', $currentUser->id)\n                  ->where('support_staff_id', $otherUser->id);\n            })\n            ->orWhere(function ($q) use ($currentUser, $otherUser) {\n                $q->where('admin_id', $otherUser->id)\n                  ->where('support_staff_id', $currentUser->id);\n            })\n            ->first();\n\n        if (!$chat) {\n            $chat = Chat::create([\n                'admin_id' => $currentUser->role_id == 3 ? $currentUser->id : $otherUser->id,\n                'support_staff_id' => $currentUser->role_id == 2 ? $currentUser->id : $otherUser->id,\n            ]);\n        }\n\n        $chats = Chat::with(['admin', 'supportStaff', 'messages' => fn($q) => $q->latest()->limit(1)])\n            ->get()\n            ->sortByDesc(fn($chat) => optional($chat->messages->first())->created_at ?? now()->subYears(10))\n            ->values();\n\n        $messages = $chat->messages()->with('user')->oldest()->get();\n        $quickReplies = QuickReply::all();\n\n        return view('swisa-admin.messages', compact('chats', 'chat', 'messages', 'quickReplies'));\n    }\n\n    // ==============================\n    // MESSAGE HANDLING\n    // ==============================\n    public function sendMessage(Request $request, $chatId)\n    {\n        $request->validate(['message' => 'required|string']);\n\n        $message = Message::create([\n            'chat_id' => $chatId,\n            'user_id' => auth()->id(),\n            'message' => $request->message,\n            'is_read' => false,\n            'created_at' => now(),\n        ]);\n\n        $message->load('user');\n        broadcast(new MessageSent($message))->toOthers();\n\n        return response()->json([\n            'id' => $message->id,\n            'chat_id' => $message->chat_id,\n            'user_id' => $message->user_id,\n            'message' => $message->message,\n            'created_at' => $message->created_at->format('Y-m-d h:i A'),\n            'user' => [\n                'id' => $message->user->id,\n                'name' => $message->user->first_name . ' ' . $message->user->last_name,\n            ],\n        ]);\n    }\n\n    public function poll(Request $request, $chatId)\n    {\n        try {\n            $lastId = (int) $request->query('last_id', 0);\n            $chat = Chat::findOrFail($chatId);\n\n            $messages = $chat->messages()\n                ->with('user:id,first_name,last_name')\n                ->where('id', '>', $lastId)\n                ->orderBy('id', 'asc')\n                ->get();\n\n            $unreadCount = $chat->messages()\n                ->where('id', '>', $lastId)\n                ->where('user_id', '!=', auth()->id())\n                ->count();\n\n            return response()->json([\n                'messages' => $messages,\n                'unread' => $unreadCount,\n            ]);\n        } catch (\\Exception $e) {\n            \\Log::error('Poll error: '.$e->getMessage());\n            return response()->json(['error' => $e->getMessage()], 500);\n        }\n    }\n\n    // ==============================\n    // LOAD CHAT OR CREATE IF NOT EXIST (ADMIN AUTO-CREATION)\n    // ==============================\n    public function load($userId)\n    {\n        $currentUser = auth()->user();\n        $otherUser = User::findOrFail($userId);\n        if ($currentUser->role_id == 3) {\n            // Check existing chat between admin and selected user (any role)\n            $chat = Chat::where(function ($q) use ($currentUser, $otherUser) {\n                    $q->where('admin_id', $currentUser->id)\n                      ->where('support_staff_id', $otherUser->id);\n                })\n                ->orWhere(function ($q) use ($currentUser, $otherUser) {\n                    $q->where('admin_id', $otherUser->id)\n                      ->where('support_staff_id', $currentUser->id);\n                })\n                ->first();\n\n            // If no chat exists → create empty chat relation\n            if (!$chat) {\n                $chat = Chat::create([\n                    'admin_id' => $currentUser->id,\n                    'support_staff_id' => $otherUser->id,\n                ]);\n            }\n        } else {\n            // For support or member users, find or create based on existing logic\n            $chat = Chat::firstOrCreate([\n                'admin_id' => $currentUser->role_id == 3 ? $currentUser->id : $otherUser->id,\n                'support_staff_id' => $currentUser->role_id == 2 ? $currentUser->id : $otherUser->id,\n            ]);\n        }\n\n        $messages = $chat->messages()->with('user')->oldest()->get();\n        $quickReplies = QuickReply::all();\n        $html = view('partials.chat-panel', compact('chat', 'messages', 'quickReplies'))->render();\n\n        return response()->json([\n            'html' => $html,\n            'chat_id' => $chat->id,\n            'last_message_id' => $messages->last()->id ?? 0,\n        ]);\n    }\n\n    // ==============================\n    // UNREAD MESSAGE CHECK\n    // ==============================\n    public function checkUnread()\n    {\n        $currentUserId = auth()->id();\n        $users = User::all();\n        $result = [];\n\n        foreach ($users as $user) {\n            $chat = Chat::where(function ($q) use ($currentUserId, $user) {\n                    $q->where('admin_id', $currentUserId)\n                      ->where('support_staff_id', $user->id);\n                })\n                ->orWhere(function ($q) use ($currentUserId, $user) {\n                    $q->where('admin_id', $user->id)\n                      ->where('support_staff_id', $currentUserId);\n                })\n                ->first();\n\n            if (!$chat) {\n                $result[$user->id] = false;\n                continue;\n            }\n\n            $hasUnread = $chat->messages()\n                ->where('user_id', '!=', $currentUserId)\n                ->where('is_read', false)\n                ->exists();\n\n            $result[$user->id] = $hasUnread;\n        }\n\n        return response()->json($result);\n    }\n\n    // ==============================\n    // MARK AS READ\n    // ==============================\n    public function markAsRead($chatId)\n    {\n        $chat = Chat::findOrFail($chatId);\n        $userId = auth()->id();\n\n        $chat->messages()\n            ->where('user_id', '!=', $userId)\n            ->where('is_read', false)\n            ->update(['is_read' => true]);\n\n        return response()->json(['success' => true]);\n    }\n\n    // ==============================\n    // MOBILE QUICK REPLIES ENDPOINT\n    // ==============================\n    public function getQuickReplies()\n    {\n        $quickReplies = QuickReply::select('id', 'question', 'answer')->get();\n        return response()->json($quickReplies);\n    }\n}\n"
        }
    ]
}
{
    "sourceFile": "app/Http/Controllers/ReportRequestController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 45,
            "patches": [
                {
                    "date": 1764356558251,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764356695413,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,9 +23,33 @@\n         $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n \n         return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n     }\n+    public function requestStats()\n+{\n+    $requests = ReportRequest::all();\n \n+    $total = $requests->count();\n+    $approved = $requests->where('status', 'Approved')->count();\n+    $pending = $requests->where('status', 'Pending')->count();\n+    $denied = $requests->where('status', 'Denied')->count();\n+\n+    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+\n+    return response()->json([\n+        'total' => $total,\n+        'approved' => $approved,\n+        'pending' => $pending,\n+        'denied' => $denied,\n+        'approvalRate' => $approvalRate\n+    ]);\n+}\n+\n+\n+\n+\n+\n+\n     // --------------------------\n     // CSV Export\n     // --------------------------\n     public function exportCsv()\n"
                },
                {
                    "date": 1764356882739,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,22 +25,25 @@\n         return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n     }\n     public function requestStats()\n {\n-    $requests = ReportRequest::all();\n+    $total = \\App\\Models\\Application::count();\n \n-    $total = $requests->count();\n-    $approved = $requests->where('status', 'Approved')->count();\n-    $pending = $requests->where('status', 'Pending')->count();\n-    $denied = $requests->where('status', 'Denied')->count();\n+    $approved = \\App\\Models\\Application::where('status_id', 4)->count(); // Approved\n+    $pending = \\App\\Models\\Application::where('status_id', 3)->count(); // Pending\n+    $toBeReview = \\App\\Models\\Application::where('status_id', 7)->count(); // To be review\n+    $rejected = \\App\\Models\\Application::where('status_id', 6)->count(); // Rejected\n+    $released = \\App\\Models\\Application::where('status_id', 5)->count(); // Released\n \n     $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n     return response()->json([\n         'total' => $total,\n         'approved' => $approved,\n         'pending' => $pending,\n-        'denied' => $denied,\n+        'toBeReview' => $toBeReview,\n+        'rejected' => $rejected,\n+        'released' => $released,\n         'approvalRate' => $approvalRate\n     ]);\n }\n \n"
                },
                {
                    "date": 1764357441285,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,29 +24,29 @@\n \n         return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n     }\n     public function requestStats()\n-{\n-    $total = \\App\\Models\\Application::count();\n+    {\n+        $total = \\App\\Models\\Application::count();\n \n-    $approved = \\App\\Models\\Application::where('status_id', 4)->count(); // Approved\n-    $pending = \\App\\Models\\Application::where('status_id', 3)->count(); // Pending\n-    $toBeReview = \\App\\Models\\Application::where('status_id', 7)->count(); // To be review\n-    $rejected = \\App\\Models\\Application::where('status_id', 6)->count(); // Rejected\n-    $released = \\App\\Models\\Application::where('status_id', 5)->count(); // Released\n+        $approved = \\App\\Models\\Application::where('status_id', 4)->count(); // Approved\n+        $pending = \\App\\Models\\Application::where('status_id', 3)->count(); // Pending\n+        $toBeReview = \\App\\Models\\Application::where('status_id', 7)->count(); // To be review\n+        $rejected = \\App\\Models\\Application::where('status_id', 6)->count(); // Rejected\n+        $released = \\App\\Models\\Application::where('status_id', 5)->count(); // Released\n \n-    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+        $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n-    return response()->json([\n-        'total' => $total,\n-        'approved' => $approved,\n-        'pending' => $pending,\n-        'toBeReview' => $toBeReview,\n-        'rejected' => $rejected,\n-        'released' => $released,\n-        'approvalRate' => $approvalRate\n-    ]);\n-}\n+        return response()->json([\n+            'total' => $total,\n+            'approved' => $approved,\n+            'pending' => $pending,\n+            'toBeReview' => $toBeReview,\n+            'rejected' => $rejected,\n+            'released' => $released,\n+            'approvalRate' => $approvalRate\n+        ]);\n+    }\n \n \n \n \n"
                },
                {
                    "date": 1764357587687,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,36 +23,40 @@\n         $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n \n         return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n     }\n-    public function requestStats()\n-    {\n-        $total = \\App\\Models\\Application::count();\n+public function requestStats()\n+{\n+    $total = \\App\\Models\\Application::count();\n \n-        $approved = \\App\\Models\\Application::where('status_id', 4)->count(); // Approved\n-        $pending = \\App\\Models\\Application::where('status_id', 3)->count(); // Pending\n-        $toBeReview = \\App\\Models\\Application::where('status_id', 7)->count(); // To be review\n-        $rejected = \\App\\Models\\Application::where('status_id', 6)->count(); // Rejected\n-        $released = \\App\\Models\\Application::where('status_id', 5)->count(); // Released\n+    $approved = \\App\\Models\\Application::where('status_id', 4)->count(); // Approved\n+    $pending = \\App\\Models\\Application::where('status_id', 3)->count(); // Pending\n+    $toBeReview = \\App\\Models\\Application::where('status_id', 7)->count(); // To be review\n+    $rejected = \\App\\Models\\Application::where('status_id', 6)->count(); // Rejected\n+    $released = \\App\\Models\\Application::where('status_id', 5)->count(); // Released\n \n-        $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+    $completed = $approved + $released; // Completed requests\n \n-        return response()->json([\n-            'total' => $total,\n-            'approved' => $approved,\n-            'pending' => $pending,\n-            'toBeReview' => $toBeReview,\n-            'rejected' => $rejected,\n-            'released' => $released,\n-            'approvalRate' => $approvalRate\n-        ]);\n-    }\n+    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n+    return response()->json([\n+        'total' => $total,\n+        'approved' => $approved,\n+        'pending' => $pending,\n+        'toBeReview' => $toBeReview,\n+        'rejected' => $rejected,\n+        'released' => $released,\n+        'completed' => $completed,\n+        'approvalRate' => $approvalRate\n+    ]);\n+}\n \n \n \n \n \n+\n+\n     // --------------------------\n     // CSV Export\n     // --------------------------\n     public function exportCsv()\n"
                },
                {
                    "date": 1764357710108,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,9 +33,9 @@\n     $toBeReview = \\App\\Models\\Application::where('status_id', 7)->count(); // To be review\n     $rejected = \\App\\Models\\Application::where('status_id', 6)->count(); // Rejected\n     $released = \\App\\Models\\Application::where('status_id', 5)->count(); // Released\n \n-    $completed = $approved + $released; // Completed requests\n+    $completed = $released; // Completed requests\n \n     $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n     return response()->json([\n"
                },
                {
                    "date": 1764357737312,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,33 +23,33 @@\n         $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n \n         return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n     }\n-public function requestStats()\n-{\n-    $total = \\App\\Models\\Application::count();\n+    public function requestStats()\n+    {\n+        $total = \\App\\Models\\Application::count();\n \n-    $approved = \\App\\Models\\Application::where('status_id', 4)->count(); // Approved\n-    $pending = \\App\\Models\\Application::where('status_id', 3)->count(); // Pending\n-    $toBeReview = \\App\\Models\\Application::where('status_id', 7)->count(); // To be review\n-    $rejected = \\App\\Models\\Application::where('status_id', 6)->count(); // Rejected\n-    $released = \\App\\Models\\Application::where('status_id', 5)->count(); // Released\n+        $approved = \\App\\Models\\Application::where('status_id', 4)->count(); // Approved\n+        $pending = \\App\\Models\\Application::where('status_id', 3)->count(); // Pending\n+        $toBeReview = \\App\\Models\\Application::where('status_id', 7)->count(); // To be review\n+        $rejected = \\App\\Models\\Application::where('status_id', 6)->count(); // Rejected\n+        $released = \\App\\Models\\Application::where('status_id', 5)->count(); // Released\n \n-    $completed = $released; // Completed requests\n+        $completed = $released; // Completed requests\n \n-    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+        $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n-    return response()->json([\n-        'total' => $total,\n-        'approved' => $approved,\n-        'pending' => $pending,\n-        'toBeReview' => $toBeReview,\n-        'rejected' => $rejected,\n-        'released' => $released,\n-        'completed' => $completed,\n-        'approvalRate' => $approvalRate\n-    ]);\n-}\n+        return response()->json([\n+            'total' => $total,\n+            'approved' => $approved,\n+            'pending' => $pending,\n+            'toBeReview' => $toBeReview,\n+            'rejected' => $rejected,\n+            'released' => $released,\n+            'completed' => $completed,\n+            'approvalRate' => $approvalRate\n+        ]);\n+    }\n \n \n \n \n"
                },
                {
                    "date": 1764357898237,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,40 +23,43 @@\n         $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n \n         return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n     }\n-    public function requestStats()\n-    {\n-        $total = \\App\\Models\\Application::count();\n+public function requestStats()\n+{\n+    $query = \\App\\Models\\Application::where('application_type', 'grant_request');\n \n-        $approved = \\App\\Models\\Application::where('status_id', 4)->count(); // Approved\n-        $pending = \\App\\Models\\Application::where('status_id', 3)->count(); // Pending\n-        $toBeReview = \\App\\Models\\Application::where('status_id', 7)->count(); // To be review\n-        $rejected = \\App\\Models\\Application::where('status_id', 6)->count(); // Rejected\n-        $released = \\App\\Models\\Application::where('status_id', 5)->count(); // Released\n+    $total = $query->count();\n \n-        $completed = $released; // Completed requests\n+    $approved = $query->where('status_id', 4)->count(); // Approved\n+    $pending = $query->where('status_id', 3)->count(); // Pending\n+    $toBeReview = $query->where('status_id', 7)->count(); // To be review\n+    $rejected = $query->where('status_id', 6)->count(); // Rejected\n+    $released = $query->where('status_id', 5)->count(); // Released\n \n-        $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+    $completed = $released; // Completed requests\n \n-        return response()->json([\n-            'total' => $total,\n-            'approved' => $approved,\n-            'pending' => $pending,\n-            'toBeReview' => $toBeReview,\n-            'rejected' => $rejected,\n-            'released' => $released,\n-            'completed' => $completed,\n-            'approvalRate' => $approvalRate\n-        ]);\n-    }\n+    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n+    return response()->json([\n+        'total' => $total,\n+        'approved' => $approved,\n+        'pending' => $pending,\n+        'toBeReview' => $toBeReview,\n+        'rejected' => $rejected,\n+        'released' => $released,\n+        'completed' => $completed,\n+        'approvalRate' => $approvalRate\n+    ]);\n+}\n \n \n \n \n \n \n+\n+\n     // --------------------------\n     // CSV Export\n     // --------------------------\n     public function exportCsv()\n"
                },
                {
                    "date": 1764358121892,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,19 +25,21 @@\n         return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n     }\n public function requestStats()\n {\n-    $query = \\App\\Models\\Application::where('application_type', 'grant_request');\n+    // Base query for grant requests only\n+    $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n \n-    $total = $query->count();\n+    $total = (clone $baseQuery)->count();\n \n-    $approved = $query->where('status_id', 4)->count(); // Approved\n-    $pending = $query->where('status_id', 3)->count(); // Pending\n-    $toBeReview = $query->where('status_id', 7)->count(); // To be review\n-    $rejected = $query->where('status_id', 6)->count(); // Rejected\n-    $released = $query->where('status_id', 5)->count(); // Released\n+    $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n+    $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n+    $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n+    $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n+    $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n \n-    $completed = $released; // Completed requests\n+    // Completed = Released\n+    $completed = $released;\n \n     $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n     return response()->json([\n"
                },
                {
                    "date": 1764358643238,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,15 +53,51 @@\n         'approvalRate' => $approvalRate\n     ]);\n }\n \n+public function requestChartData(Request $request)\n+{\n+    $year = $request->year ?? date('Y');\n \n+    // Query only grant_request\n+    $applications = \\App\\Models\\Application::where('application_type', 'grant_request')\n+        ->whereYear('created_at', $year)\n+        ->get();\n \n+    // Initialize structure for months\n+    $monthly = collect(range(1, 12))->map(function ($m) {\n+        return [\n+            'month' => date('M', mktime(0, 0, 0, $m, 1)),\n+            'approved' => 0,\n+            'denied' => 0,\n+        ];\n+    });\n \n+    foreach ($applications as $app) {\n+        $monthIndex = intval(date('n', strtotime($app->created_at))) - 1;\n \n+        if ($app->status_id == 4) { // Approved\n+            $monthly[$monthIndex]['approved']++;\n+        }\n \n+        if ($app->status_id == 6) { // Denied\n+            $monthly[$monthIndex]['denied']++;\n+        }\n+    }\n \n+    return response()->json([\n+        'year' => $year,\n+        'data' => $monthly->values()\n+    ]);\n+}\n \n+\n+\n+\n+\n+\n+\n+\n     // --------------------------\n     // CSV Export\n     // --------------------------\n     public function exportCsv()\n"
                },
                {
                    "date": 1764358980383,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -57,47 +57,41 @@\n public function requestChartData(Request $request)\n {\n     $year = $request->year ?? date('Y');\n \n-    // Query only grant_request\n-    $applications = \\App\\Models\\Application::where('application_type', 'grant_request')\n+    // Only grant request applications\n+    $query = \\App\\Models\\Application::where('application_type', 'grant_request');\n+\n+    // Fetch all months for the year\n+    $data = $query\n+        ->selectRaw('MONTH(created_at) as month, \n+                     SUM(CASE WHEN status_id = 4 THEN 1 ELSE 0 END) as approved,\n+                     SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as denied')\n         ->whereYear('created_at', $year)\n+        ->groupBy('month')\n+        ->orderBy('month')\n         ->get();\n \n-    // Initialize structure for months\n-    $monthly = collect(range(1, 12))->map(function ($m) {\n-        return [\n-            'month' => date('M', mktime(0, 0, 0, $m, 1)),\n-            'approved' => 0,\n-            'denied' => 0,\n+    // Convert to chart format (ensure all 12 months exist)\n+    $formatted = [];\n+    for ($m = 1; $m <= 12; $m++) {\n+        $record = $data->firstWhere('month', $m);\n+        $formatted[] = [\n+            \"month\" => date('M', mktime(0, 0, 0, $m, 1)),\n+            \"approved\" => $record->approved ?? 0,\n+            \"denied\" => $record->denied ?? 0,\n         ];\n-    });\n-\n-    foreach ($applications as $app) {\n-        $monthIndex = intval(date('n', strtotime($app->created_at))) - 1;\n-\n-        if ($app->status_id == 4) { // Approved\n-            $monthly[$monthIndex]['approved']++;\n-        }\n-\n-        if ($app->status_id == 6) { // Denied\n-            $monthly[$monthIndex]['denied']++;\n-        }\n     }\n \n-    return response()->json([\n-        'year' => $year,\n-        'data' => $monthly->values()\n-    ]);\n+    return response()->json($formatted);\n }\n \n \n \n \n \n \n \n-\n     // --------------------------\n     // CSV Export\n     // --------------------------\n     public function exportCsv()\n"
                },
                {
                    "date": 1764359210076,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,45 +53,16 @@\n         'approvalRate' => $approvalRate\n     ]);\n }\n \n-public function requestChartData(Request $request)\n-{\n-    $year = $request->year ?? date('Y');\n \n-    // Only grant request applications\n-    $query = \\App\\Models\\Application::where('application_type', 'grant_request');\n \n-    // Fetch all months for the year\n-    $data = $query\n-        ->selectRaw('MONTH(created_at) as month, \n-                     SUM(CASE WHEN status_id = 4 THEN 1 ELSE 0 END) as approved,\n-                     SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as denied')\n-        ->whereYear('created_at', $year)\n-        ->groupBy('month')\n-        ->orderBy('month')\n-        ->get();\n \n-    // Convert to chart format (ensure all 12 months exist)\n-    $formatted = [];\n-    for ($m = 1; $m <= 12; $m++) {\n-        $record = $data->firstWhere('month', $m);\n-        $formatted[] = [\n-            \"month\" => date('M', mktime(0, 0, 0, $m, 1)),\n-            \"approved\" => $record->approved ?? 0,\n-            \"denied\" => $record->denied ?? 0,\n-        ];\n-    }\n \n-    return response()->json($formatted);\n-}\n \n \n \n \n-\n-\n-\n     // --------------------------\n     // CSV Export\n     // --------------------------\n     public function exportCsv()\n"
                },
                {
                    "date": 1764359366324,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,16 +53,55 @@\n         'approvalRate' => $approvalRate\n     ]);\n }\n \n+public function requestChartData(Request $request)\n+{\n+    $year = $request->year ?? now()->year;\n \n+    // Filter only grant_request\n+    $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n+        ->whereYear('created_at', $year);\n \n+    // Group by month\n+    $monthly = $query->selectRaw(\"\n+        MONTH(created_at) as month,\n+        SUM(CASE WHEN status_id = 4 THEN 1 ELSE 0 END) as approved,\n+        SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as denied\n+    \")\n+    ->groupBy('month')\n+    ->orderBy('month')\n+    ->get();\n \n+    // Convert to chart-friendly format\n+    $formatted = [];\n \n+    $months = [\n+        1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n+        5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n+        9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n+    ];\n \n+    foreach ($months as $num => $name) {\n+        $row = $monthly->firstWhere('month', $num);\n \n+        $formatted[] = [\n+            'month'    => $name,\n+            'approved' => $row->approved ?? 0,\n+            'denied'   => $row->denied ?? 0,\n+        ];\n+    }\n \n+    return response()->json($formatted);\n+}\n \n+\n+\n+\n+\n+\n+\n+\n     // --------------------------\n     // CSV Export\n     // --------------------------\n     public function exportCsv()\n"
                },
                {
                    "date": 1764359656596,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,38 +23,49 @@\n         $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n \n         return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n     }\n-public function requestStats()\n+public function requestChartData(Request $request)\n {\n-    // Base query for grant requests only\n-    $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n+    $year = $request->year ?? now()->year;\n \n-    $total = (clone $baseQuery)->count();\n+    // Query only \"grant_request\" applications for the chosen year\n+    $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n+        ->whereYear('created_at', $year);\n \n-    $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n-    $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n-    $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n-    $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n-    $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n+    // Monthly aggregated data\n+    $monthly = $query->selectRaw(\"\n+        MONTH(created_at) as month,\n+        SUM(CASE WHEN status_id = 4 THEN 1 ELSE 0 END) as approved,\n+        SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n+    \")\n+    ->groupBy('month')\n+    ->orderBy('month')\n+    ->get();\n \n-    // Completed = Released\n-    $completed = $released;\n+    // Prepare final formatted output\n+    $formatted = [];\n \n-    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+    $months = [\n+        1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n+        5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n+        9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n+    ];\n \n-    return response()->json([\n-        'total' => $total,\n-        'approved' => $approved,\n-        'pending' => $pending,\n-        'toBeReview' => $toBeReview,\n-        'rejected' => $rejected,\n-        'released' => $released,\n-        'completed' => $completed,\n-        'approvalRate' => $approvalRate\n-    ]);\n+    foreach ($months as $num => $name) {\n+        $row = $monthly->firstWhere('month', $num);\n+\n+        $formatted[] = [\n+            'month'    => $name,\n+            'approved' => $row->approved ?? 0,\n+            'denied'   => $row->rejected ?? 0,  // chart uses 'denied', but status_id is rejected\n+        ];\n+    }\n+\n+    return response()->json($formatted);\n }\n \n+\n public function requestChartData(Request $request)\n {\n     $year = $request->year ?? now()->year;\n \n"
                },
                {
                    "date": 1764398916099,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,49 +23,38 @@\n         $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n \n         return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n     }\n-public function requestChartData(Request $request)\n+public function requestStats()\n {\n-    $year = $request->year ?? now()->year;\n+    // Base query for grant requests only\n+    $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n \n-    // Query only \"grant_request\" applications for the chosen year\n-    $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n-        ->whereYear('created_at', $year);\n+    $total = (clone $baseQuery)->count();\n \n-    // Monthly aggregated data\n-    $monthly = $query->selectRaw(\"\n-        MONTH(created_at) as month,\n-        SUM(CASE WHEN status_id = 4 THEN 1 ELSE 0 END) as approved,\n-        SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n-    \")\n-    ->groupBy('month')\n-    ->orderBy('month')\n-    ->get();\n+    $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n+    $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n+    $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n+    $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n+    $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n \n-    // Prepare final formatted output\n-    $formatted = [];\n+    // Completed = Released\n+    $completed = $released;\n \n-    $months = [\n-        1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n-        5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n-        9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n-    ];\n+    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n-    foreach ($months as $num => $name) {\n-        $row = $monthly->firstWhere('month', $num);\n-\n-        $formatted[] = [\n-            'month'    => $name,\n-            'approved' => $row->approved ?? 0,\n-            'denied'   => $row->rejected ?? 0,  // chart uses 'denied', but status_id is rejected\n-        ];\n-    }\n-\n-    return response()->json($formatted);\n+    return response()->json([\n+        'total' => $total,\n+        'approved' => $approved,\n+        'pending' => $pending,\n+        'toBeReview' => $toBeReview,\n+        'rejected' => $rejected,\n+        'released' => $released,\n+        'completed' => $completed,\n+        'approvalRate' => $approvalRate\n+    ]);\n }\n \n-\n public function requestChartData(Request $request)\n {\n     $year = $request->year ?? now()->year;\n \n"
                },
                {
                    "date": 1764399041321,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -61,19 +61,19 @@\n     // Filter only grant_request\n     $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n         ->whereYear('created_at', $year);\n \n-    // Group by month\n+    // Group by month using new statuses\n     $monthly = $query->selectRaw(\"\n         MONTH(created_at) as month,\n-        SUM(CASE WHEN status_id = 4 THEN 1 ELSE 0 END) as approved,\n-        SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as denied\n+        SUM(CASE WHEN status_id = 5 THEN 1 ELSE 0 END) as completed,\n+        SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n     \")\n     ->groupBy('month')\n     ->orderBy('month')\n     ->get();\n \n-    // Convert to chart-friendly format\n+    // Convert months for the chart\n     $formatted = [];\n \n     $months = [\n         1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n@@ -84,11 +84,11 @@\n     foreach ($months as $num => $name) {\n         $row = $monthly->firstWhere('month', $num);\n \n         $formatted[] = [\n-            'month'    => $name,\n-            'approved' => $row->approved ?? 0,\n-            'denied'   => $row->denied ?? 0,\n+            'month'     => $name,\n+            'completed' => $row->completed ?? 0,\n+            'rejected'  => $row->rejected ?? 0,\n         ];\n     }\n \n     return response()->json($formatted);\n@@ -100,8 +100,9 @@\n \n \n \n \n+\n     // --------------------------\n     // CSV Export\n     // --------------------------\n     public function exportCsv()\n"
                },
                {
                    "date": 1764428956200,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -92,17 +92,8 @@\n     }\n \n     return response()->json($formatted);\n }\n-\n-\n-\n-\n-\n-\n-\n-\n-\n     // --------------------------\n     // CSV Export\n     // --------------------------\n     public function exportCsv()\n"
                },
                {
                    "date": 1764429111970,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -179,5 +179,50 @@\n         $requests = ReportRequest::all();\n         $pdf = Pdf::loadView('reports.requests-pdf', compact('requests'));\n         return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n     }\n+\n+\n+\n+public function recentTransactions()\n+{\n+    $transactions = DB::table('applications as a')\n+        ->join('grants as g', 'a.grant_id', '=', 'g.id')\n+        ->where('a.application_type', 'Grant Request') // ✔ Only Grant Request\n+        ->select(\n+            DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n+            DB::raw(\"'Grant Request' as type\"),\n+            DB::raw(\"(g.unit_per_request * g.amount_per_quantity) as amount\"),\n+            'a.updated_at as date',\n+            'a.status_id'\n+        )\n+        ->orderBy('a.updated_at', 'desc')\n+        ->limit(500)\n+        ->get()\n+        ->map(function ($t) {\n+\n+            $status = (int) $t->status_id;\n+\n+            // ✔ Status Mapping\n+            $statusText = match ($status) {\n+                7 => 'To be review',\n+                6 => 'Rejected',\n+                5 => 'Released',\n+                4 => 'Approved',\n+                3 => 'Pending',\n+                default => 'Unknown',\n+            };\n+\n+            return [\n+                'transaction_id' => $t->transaction_id,\n+                'type' => $t->type,\n+                'amount' => $t->amount,\n+                'date' => date('F d, Y', strtotime($t->date)),\n+                'status' => $statusText,\n+            ];\n+        });\n+\n+    return $transactions;\n }\n+\n+\n+}\n"
                },
                {
                    "date": 1764429205470,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,41 +182,41 @@\n     }\n \n \n \n-public function recentTransactions()\n+public function recentGrantRequests()\n {\n     $transactions = DB::table('applications as a')\n         ->join('grants as g', 'a.grant_id', '=', 'g.id')\n-        ->where('a.application_type', 'Grant Request') // ✔ Only Grant Request\n+        ->join('users as u', 'a.user_id', '=', 'u.id') // requester\n+        ->join('grant_items as gi', 'g.item_id', '=', 'gi.id') // item\n         ->select(\n             DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n-            DB::raw(\"'Grant Request' as type\"),\n-            DB::raw(\"(g.unit_per_request * g.amount_per_quantity) as amount\"),\n+            'gi.item_name as item',\n+            DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n             'a.updated_at as date',\n             'a.status_id'\n         )\n         ->orderBy('a.updated_at', 'desc')\n-        ->limit(500)\n+        ->limit(100)\n         ->get()\n         ->map(function ($t) {\n \n             $status = (int) $t->status_id;\n \n-            // ✔ Status Mapping\n             $statusText = match ($status) {\n-                7 => 'To be review',\n+                5 => 'Completed',\n                 6 => 'Rejected',\n-                5 => 'Released',\n+                7 => 'To be reviewed',\n                 4 => 'Approved',\n                 3 => 'Pending',\n                 default => 'Unknown',\n             };\n \n             return [\n                 'transaction_id' => $t->transaction_id,\n-                'type' => $t->type,\n-                'amount' => $t->amount,\n+                'item' => $t->item,\n+                'requester' => $t->requester,\n                 'date' => date('F d, Y', strtotime($t->date)),\n                 'status' => $statusText,\n             ];\n         });\n"
                },
                {
                    "date": 1764429542686,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -184,30 +184,30 @@\n \n \n public function recentGrantRequests()\n {\n-    $transactions = DB::table('applications as a')\n+    $transactions = \\DB::table('applications as a')\n         ->join('grants as g', 'a.grant_id', '=', 'g.id')\n-        ->join('users as u', 'a.user_id', '=', 'u.id') // requester\n-        ->join('grant_items as gi', 'g.item_id', '=', 'gi.id') // item\n+        ->join('users as u', 'a.user_id', '=', 'u.id')\n+        ->where('a.application_type', 'grant_request')\n         ->select(\n-            DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n-            'gi.item_name as item',\n-            DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n+            \\DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n+            'g.item as item',\n+            \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n             'a.updated_at as date',\n             'a.status_id'\n         )\n         ->orderBy('a.updated_at', 'desc')\n-        ->limit(100)\n+        ->limit(1000)\n         ->get()\n         ->map(function ($t) {\n \n             $status = (int) $t->status_id;\n \n-            $statusText = match ($status) {\n-                5 => 'Completed',\n+            $statusText = match($status) {\n+                7 => 'To be review',\n                 6 => 'Rejected',\n-                7 => 'To be reviewed',\n+                5 => 'Completed', // Released = Completed\n                 4 => 'Approved',\n                 3 => 'Pending',\n                 default => 'Unknown',\n             };\n@@ -215,9 +215,9 @@\n             return [\n                 'transaction_id' => $t->transaction_id,\n                 'item' => $t->item,\n                 'requester' => $t->requester,\n-                'date' => date('F d, Y', strtotime($t->date)),\n+                'date' => date('Y-m-d', strtotime($t->date)),\n                 'status' => $statusText,\n             ];\n         });\n \n"
                },
                {
                    "date": 1764429580682,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,47 +182,15 @@\n     }\n \n \n \n-public function recentGrantRequests()\n+    public function requestTableData()\n {\n-    $transactions = \\DB::table('applications as a')\n-        ->join('grants as g', 'a.grant_id', '=', 'g.id')\n-        ->join('users as u', 'a.user_id', '=', 'u.id')\n-        ->where('a.application_type', 'grant_request')\n-        ->select(\n-            \\DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n-            'g.item as item',\n-            \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n-            'a.updated_at as date',\n-            'a.status_id'\n-        )\n-        ->orderBy('a.updated_at', 'desc')\n-        ->limit(1000)\n-        ->get()\n-        ->map(function ($t) {\n+    // Only grant requests\n+    $requests = \\App\\Models\\Application::where('application_type', 'grant_request')\n+        ->orderBy('created_at', 'desc')\n+        ->get();\n \n-            $status = (int) $t->status_id;\n-\n-            $statusText = match($status) {\n-                7 => 'To be review',\n-                6 => 'Rejected',\n-                5 => 'Completed', // Released = Completed\n-                4 => 'Approved',\n-                3 => 'Pending',\n-                default => 'Unknown',\n-            };\n-\n-            return [\n-                'transaction_id' => $t->transaction_id,\n-                'item' => $t->item,\n-                'requester' => $t->requester,\n-                'date' => date('Y-m-d', strtotime($t->date)),\n-                'status' => $statusText,\n-            ];\n-        });\n-\n-    return $transactions;\n+    return response()->json($requests);\n }\n \n-\n }\n"
                },
                {
                    "date": 1764429734513,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,226 @@\n+<?php\n+\n+namespace App\\Http\\Controllers;\n+\n+use Illuminate\\Http\\Request;\n+use App\\Models\\ReportRequest;\n+use Response;\n+use PhpOffice\\PhpSpreadsheet\\Spreadsheet;\n+use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n+use Barryvdh\\DomPDF\\Facade\\Pdf;\n+\n+class ReportRequestController extends Controller\n+{\n+    public function index()\n+    {\n+        $requests = ReportRequest::all();\n+\n+        // Stats\n+        $total = $requests->count();\n+        $approved = $requests->where('status', 'Approved')->count();\n+        $pending = $requests->where('status', 'Pending')->count();\n+        $denied = $requests->where('status', 'Denied')->count();\n+        $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n+\n+        return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n+    }\n+public function requestStats()\n+{\n+    // Base query for grant requests only\n+    $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n+\n+    $total = (clone $baseQuery)->count();\n+\n+    $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n+    $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n+    $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n+    $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n+    $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n+\n+    // Completed = Released\n+    $completed = $released;\n+\n+    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+\n+    return response()->json([\n+        'total' => $total,\n+        'approved' => $approved,\n+        'pending' => $pending,\n+        'toBeReview' => $toBeReview,\n+        'rejected' => $rejected,\n+        'released' => $released,\n+        'completed' => $completed,\n+        'approvalRate' => $approvalRate\n+    ]);\n+}\n+\n+public function requestChartData(Request $request)\n+{\n+    $year = $request->year ?? now()->year;\n+\n+    // Filter only grant_request\n+    $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n+        ->whereYear('created_at', $year);\n+\n+    // Group by month using new statuses\n+    $monthly = $query->selectRaw(\"\n+        MONTH(created_at) as month,\n+        SUM(CASE WHEN status_id = 5 THEN 1 ELSE 0 END) as completed,\n+        SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n+    \")\n+    ->groupBy('month')\n+    ->orderBy('month')\n+    ->get();\n+\n+    // Convert months for the chart\n+    $formatted = [];\n+\n+    $months = [\n+        1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n+        5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n+        9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n+    ];\n+\n+    foreach ($months as $num => $name) {\n+        $row = $monthly->firstWhere('month', $num);\n+\n+        $formatted[] = [\n+            'month'     => $name,\n+            'completed' => $row->completed ?? 0,\n+            'rejected'  => $row->rejected ?? 0,\n+        ];\n+    }\n+\n+    return response()->json($formatted);\n+}\n+    // --------------------------\n+    // CSV Export\n+    // --------------------------\n+    public function exportCsv()\n+    {\n+        $requests = ReportRequest::all();\n+        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n+        $headers = [\n+            'Content-Type' => 'text/csv',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+        ];\n+\n+        $callback = function() use ($requests) {\n+            $file = fopen('php://output', 'w');\n+\n+            fputcsv($file, ['SwisaAGAP Requests Report']);\n+            fputcsv($file, []);\n+\n+            // Table header\n+            fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n+\n+            foreach($requests as $r) {\n+                fputcsv($file, [\n+                    $r->request_id,\n+                    $r->item,\n+                    $r->requester_name,\n+                    $r->date_submitted,\n+                    $r->status,\n+                ]);\n+            }\n+\n+            fputcsv($file, []);\n+            fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n+\n+            fclose($file);\n+        };\n+\n+        return Response::stream($callback, 200, $headers);\n+    }\n+\n+    // --------------------------\n+    // Excel Export\n+    // --------------------------\n+    public function exportExcel()\n+    {\n+        $requests = ReportRequest::all();\n+        $spreadsheet = new Spreadsheet();\n+        $sheet = $spreadsheet->getActiveSheet();\n+\n+        $row = 1;\n+        $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n+        $row++;\n+\n+        // Table header\n+        $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n+        foreach($requests as $r) {\n+            $sheet->fromArray([\n+                $r->request_id,\n+                $r->item,\n+                $r->requester_name,\n+                $r->date_submitted,\n+                $r->status,\n+            ], null, 'A'.$row++);\n+        }\n+\n+        $row++;\n+        $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n+\n+        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n+        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n+        header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n+        header('Cache-Control: max-age=0');\n+\n+        $writer = new Xlsx($spreadsheet);\n+        $writer->save('php://output');\n+        exit;\n+    }\n+\n+    // --------------------------\n+    // PDF Export\n+    // --------------------------\n+    public function exportPdf()\n+    {\n+        $requests = ReportRequest::all();\n+        $pdf = Pdf::loadView('reports.requests-pdf', compact('requests'));\n+        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n+    }\n+\n+\n+    public function recentGrantRequests()\n+{\n+    $requests = DB::table('applications as a')\n+        ->join('grants as g', 'a.grant_id', '=', 'g.id')\n+        ->join('users as u', 'a.user_id', '=', 'u.id')\n+        ->where('a.application_type', 'grant_request')\n+        ->select(\n+            DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n+            'g.item as item',\n+            DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n+            'a.updated_at as date',\n+            'a.status_id'\n+        )\n+        ->orderBy('a.updated_at', 'desc')\n+        ->limit(1000)\n+        ->get()\n+        ->map(function ($t) {\n+\n+            $status = (int) $t->status_id;\n+\n+            $statusText = match($status) {\n+                7 => 'To be review',\n+                6 => 'Rejected',\n+                5 => 'Completed', // Released = Completed\n+                4 => 'Approved',\n+                3 => 'Pending',\n+                default => 'Unknown',\n+            };\n+\n+            return [\n+                'transaction_id' => $t->transaction_id,\n+                'item' => $t->item,\n+                'requester' => $t->requester,\n+                'date' => date('Y-m-d', strtotime($t->date)),\n+                'status' => $statusText,\n+            ];\n+        });\n+\n+    return $requests;\n+}\n+\n+}\n"
                },
                {
                    "date": 1764429779845,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,8 +3,9 @@\n namespace App\\Http\\Controllers;\n \n use Illuminate\\Http\\Request;\n use App\\Models\\ReportRequest;\n+use Illuminate\\Support\\Facades\\DB;\n use Response;\n use PhpOffice\\PhpSpreadsheet\\Spreadsheet;\n use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n use Barryvdh\\DomPDF\\Facade\\Pdf;\n@@ -223,200 +224,4 @@\n     return $requests;\n }\n \n }\n-<?php\n-\n-namespace App\\Http\\Controllers;\n-\n-use Illuminate\\Http\\Request;\n-use App\\Models\\ReportRequest;\n-use Response;\n-use PhpOffice\\PhpSpreadsheet\\Spreadsheet;\n-use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n-use Barryvdh\\DomPDF\\Facade\\Pdf;\n-\n-class ReportRequestController extends Controller\n-{\n-    public function index()\n-    {\n-        $requests = ReportRequest::all();\n-\n-        // Stats\n-        $total = $requests->count();\n-        $approved = $requests->where('status', 'Approved')->count();\n-        $pending = $requests->where('status', 'Pending')->count();\n-        $denied = $requests->where('status', 'Denied')->count();\n-        $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n-\n-        return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n-    }\n-public function requestStats()\n-{\n-    // Base query for grant requests only\n-    $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n-\n-    $total = (clone $baseQuery)->count();\n-\n-    $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n-    $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n-    $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n-    $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n-    $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n-\n-    // Completed = Released\n-    $completed = $released;\n-\n-    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n-\n-    return response()->json([\n-        'total' => $total,\n-        'approved' => $approved,\n-        'pending' => $pending,\n-        'toBeReview' => $toBeReview,\n-        'rejected' => $rejected,\n-        'released' => $released,\n-        'completed' => $completed,\n-        'approvalRate' => $approvalRate\n-    ]);\n-}\n-\n-public function requestChartData(Request $request)\n-{\n-    $year = $request->year ?? now()->year;\n-\n-    // Filter only grant_request\n-    $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n-        ->whereYear('created_at', $year);\n-\n-    // Group by month using new statuses\n-    $monthly = $query->selectRaw(\"\n-        MONTH(created_at) as month,\n-        SUM(CASE WHEN status_id = 5 THEN 1 ELSE 0 END) as completed,\n-        SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n-    \")\n-    ->groupBy('month')\n-    ->orderBy('month')\n-    ->get();\n-\n-    // Convert months for the chart\n-    $formatted = [];\n-\n-    $months = [\n-        1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n-        5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n-        9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n-    ];\n-\n-    foreach ($months as $num => $name) {\n-        $row = $monthly->firstWhere('month', $num);\n-\n-        $formatted[] = [\n-            'month'     => $name,\n-            'completed' => $row->completed ?? 0,\n-            'rejected'  => $row->rejected ?? 0,\n-        ];\n-    }\n-\n-    return response()->json($formatted);\n-}\n-    // --------------------------\n-    // CSV Export\n-    // --------------------------\n-    public function exportCsv()\n-    {\n-        $requests = ReportRequest::all();\n-        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n-        $headers = [\n-            'Content-Type' => 'text/csv',\n-            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-        ];\n-\n-        $callback = function() use ($requests) {\n-            $file = fopen('php://output', 'w');\n-\n-            fputcsv($file, ['SwisaAGAP Requests Report']);\n-            fputcsv($file, []);\n-\n-            // Table header\n-            fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n-\n-            foreach($requests as $r) {\n-                fputcsv($file, [\n-                    $r->request_id,\n-                    $r->item,\n-                    $r->requester_name,\n-                    $r->date_submitted,\n-                    $r->status,\n-                ]);\n-            }\n-\n-            fputcsv($file, []);\n-            fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n-\n-            fclose($file);\n-        };\n-\n-        return Response::stream($callback, 200, $headers);\n-    }\n-\n-    // --------------------------\n-    // Excel Export\n-    // --------------------------\n-    public function exportExcel()\n-    {\n-        $requests = ReportRequest::all();\n-        $spreadsheet = new Spreadsheet();\n-        $sheet = $spreadsheet->getActiveSheet();\n-\n-        $row = 1;\n-        $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n-        $row++;\n-\n-        // Table header\n-        $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n-        foreach($requests as $r) {\n-            $sheet->fromArray([\n-                $r->request_id,\n-                $r->item,\n-                $r->requester_name,\n-                $r->date_submitted,\n-                $r->status,\n-            ], null, 'A'.$row++);\n-        }\n-\n-        $row++;\n-        $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n-\n-        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n-        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n-        header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n-        header('Cache-Control: max-age=0');\n-\n-        $writer = new Xlsx($spreadsheet);\n-        $writer->save('php://output');\n-        exit;\n-    }\n-\n-    // --------------------------\n-    // PDF Export\n-    // --------------------------\n-    public function exportPdf()\n-    {\n-        $requests = ReportRequest::all();\n-        $pdf = Pdf::loadView('reports.requests-pdf', compact('requests'));\n-        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n-    }\n-\n-\n-\n-    public function requestTableData()\n-{\n-    // Only grant requests\n-    $requests = \\App\\Models\\Application::where('application_type', 'grant_request')\n-        ->orderBy('created_at', 'desc')\n-        ->get();\n-\n-    return response()->json($requests);\n-}\n-\n-}\n"
                },
                {
                    "date": 1764429929422,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,46 +182,47 @@\n         return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n     }\n \n \n-    public function recentGrantRequests()\n+   public function recentGrantRequests()\n {\n-    $requests = DB::table('applications as a')\n+    $requests = \\DB::table('applications as a')\n         ->join('grants as g', 'a.grant_id', '=', 'g.id')\n         ->join('users as u', 'a.user_id', '=', 'u.id')\n         ->where('a.application_type', 'grant_request')\n         ->select(\n-            DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n+            \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n             'g.item as item',\n-            DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n+            \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n             'a.updated_at as date',\n             'a.status_id'\n         )\n         ->orderBy('a.updated_at', 'desc')\n         ->limit(1000)\n         ->get()\n-        ->map(function ($t) {\n+        ->map(function ($r) {\n \n-            $status = (int) $t->status_id;\n+            $status = (int) $r->status_id;\n \n             $statusText = match($status) {\n                 7 => 'To be review',\n                 6 => 'Rejected',\n-                5 => 'Completed', // Released = Completed\n+                5 => 'Completed',   // Released treated as Completed\n                 4 => 'Approved',\n                 3 => 'Pending',\n                 default => 'Unknown',\n             };\n \n             return [\n-                'transaction_id' => $t->transaction_id,\n-                'item' => $t->item,\n-                'requester' => $t->requester,\n-                'date' => date('Y-m-d', strtotime($t->date)),\n+                'request_id' => $r->request_id,\n+                'item' => $r->item,\n+                'requester' => $r->requester,\n+                'date' => date('Y-m-d', strtotime($r->date)),\n                 'status' => $statusText,\n             ];\n         });\n \n     return $requests;\n }\n \n+\n }\n"
                },
                {
                    "date": 1764430338547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -190,9 +190,9 @@\n         ->join('users as u', 'a.user_id', '=', 'u.id')\n         ->where('a.application_type', 'grant_request')\n         ->select(\n             \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n-            'g.item as item',\n+            'g.title as grant_title', // <-- use title instead of item\n             \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n             'a.updated_at as date',\n             'a.status_id'\n         )\n@@ -213,9 +213,9 @@\n             };\n \n             return [\n                 'request_id' => $r->request_id,\n-                'item' => $r->item,\n+                'grant_title' => $r->grant_title, // updated key\n                 'requester' => $r->requester,\n                 'date' => date('Y-m-d', strtotime($r->date)),\n                 'status' => $statusText,\n             ];\n"
                },
                {
                    "date": 1764430571910,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,22 +182,46 @@\n         return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n     }\n \n \n-   public function recentGrantRequests()\n+   public function recentGrantRequests($search = null, $statusFilter = null)\n {\n-    $requests = \\DB::table('applications as a')\n+    $query = \\DB::table('applications as a')\n         ->join('grants as g', 'a.grant_id', '=', 'g.id')\n         ->join('users as u', 'a.user_id', '=', 'u.id')\n         ->where('a.application_type', 'grant_request')\n         ->select(\n             \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n-            'g.title as grant_title', // <-- use title instead of item\n+            'g.title as grant_title',\n             \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n             'a.updated_at as date',\n             'a.status_id'\n-        )\n-        ->orderBy('a.updated_at', 'desc')\n+        );\n+\n+    // Apply search\n+    if ($search) {\n+        $query->where(function($q) use ($search) {\n+            $q->where('g.title', 'like', \"%$search%\")\n+              ->orWhere('u.first_name', 'like', \"%$search%\")\n+              ->orWhere('u.last_name', 'like', \"%$search%\")\n+              ->orWhere('a.id', 'like', \"%$search%\");\n+        });\n+    }\n+\n+    // Apply status filter\n+    if ($statusFilter) {\n+        $statusMap = [\n+            'approved' => [4],\n+            'pending' => [3, 7],\n+            'denied' => [6],\n+        ];\n+\n+        if (isset($statusMap[$statusFilter])) {\n+            $query->whereIn('a.status_id', $statusMap[$statusFilter]);\n+        }\n+    }\n+\n+    $requests = $query->orderBy('a.updated_at', 'desc')\n         ->limit(1000)\n         ->get()\n         ->map(function ($r) {\n \n@@ -205,17 +229,17 @@\n \n             $statusText = match($status) {\n                 7 => 'To be review',\n                 6 => 'Rejected',\n-                5 => 'Completed',   // Released treated as Completed\n+                5 => 'Completed',\n                 4 => 'Approved',\n                 3 => 'Pending',\n                 default => 'Unknown',\n             };\n \n             return [\n                 'request_id' => $r->request_id,\n-                'grant_title' => $r->grant_title, // updated key\n+                'grant_title' => $r->grant_title,\n                 'requester' => $r->requester,\n                 'date' => date('Y-m-d', strtotime($r->date)),\n                 'status' => $statusText,\n             ];\n"
                },
                {
                    "date": 1764430724999,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,71 +182,46 @@\n         return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n     }\n \n \n-   public function recentGrantRequests($search = null, $statusFilter = null)\n+    public function recentGrantRequests()\n {\n-    $query = \\DB::table('applications as a')\n+    $requests = DB::table('applications as a')\n         ->join('grants as g', 'a.grant_id', '=', 'g.id')\n         ->join('users as u', 'a.user_id', '=', 'u.id')\n         ->where('a.application_type', 'grant_request')\n         ->select(\n-            \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n-            'g.title as grant_title',\n-            \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n+            DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n+            'g.item as item',\n+            DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n             'a.updated_at as date',\n             'a.status_id'\n-        );\n-\n-    // Apply search\n-    if ($search) {\n-        $query->where(function($q) use ($search) {\n-            $q->where('g.title', 'like', \"%$search%\")\n-              ->orWhere('u.first_name', 'like', \"%$search%\")\n-              ->orWhere('u.last_name', 'like', \"%$search%\")\n-              ->orWhere('a.id', 'like', \"%$search%\");\n-        });\n-    }\n-\n-    // Apply status filter\n-    if ($statusFilter) {\n-        $statusMap = [\n-            'approved' => [4],\n-            'pending' => [3, 7],\n-            'denied' => [6],\n-        ];\n-\n-        if (isset($statusMap[$statusFilter])) {\n-            $query->whereIn('a.status_id', $statusMap[$statusFilter]);\n-        }\n-    }\n-\n-    $requests = $query->orderBy('a.updated_at', 'desc')\n+        )\n+        ->orderBy('a.updated_at', 'desc')\n         ->limit(1000)\n         ->get()\n-        ->map(function ($r) {\n+        ->map(function ($t) {\n \n-            $status = (int) $r->status_id;\n+            $status = (int) $t->status_id;\n \n             $statusText = match($status) {\n                 7 => 'To be review',\n                 6 => 'Rejected',\n-                5 => 'Completed',\n+                5 => 'Completed', // Released = Completed\n                 4 => 'Approved',\n                 3 => 'Pending',\n                 default => 'Unknown',\n             };\n \n             return [\n-                'request_id' => $r->request_id,\n-                'grant_title' => $r->grant_title,\n-                'requester' => $r->requester,\n-                'date' => date('Y-m-d', strtotime($r->date)),\n+                'transaction_id' => $t->transaction_id,\n+                'item' => $t->item,\n+                'requester' => $t->requester,\n+                'date' => date('Y-m-d', strtotime($t->date)),\n                 'status' => $statusText,\n             ];\n         });\n \n     return $requests;\n }\n \n-\n }\n"
                },
                {
                    "date": 1764430822022,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,46 +182,71 @@\n         return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n     }\n \n \n-    public function recentGrantRequests()\n+   public function recentGrantRequests($search = null, $statusFilter = null)\n {\n-    $requests = DB::table('applications as a')\n+    $query = \\DB::table('applications as a')\n         ->join('grants as g', 'a.grant_id', '=', 'g.id')\n         ->join('users as u', 'a.user_id', '=', 'u.id')\n         ->where('a.application_type', 'grant_request')\n         ->select(\n-            DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n-            'g.item as item',\n-            DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n+            \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n+            'g.title as grant_title',\n+            \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n             'a.updated_at as date',\n             'a.status_id'\n-        )\n-        ->orderBy('a.updated_at', 'desc')\n+        );\n+\n+    // Apply search\n+    if ($search) {\n+        $query->where(function($q) use ($search) {\n+            $q->where('g.title', 'like', \"%$search%\")\n+              ->orWhere('u.first_name', 'like', \"%$search%\")\n+              ->orWhere('u.last_name', 'like', \"%$search%\")\n+              ->orWhere('a.id', 'like', \"%$search%\");\n+        });\n+    }\n+\n+    // Apply status filter\n+    if ($statusFilter) {\n+        $statusMap = [\n+            'approved' => [4],\n+            'pending' => [3, 7],\n+            'denied' => [6],\n+        ];\n+\n+        if (isset($statusMap[$statusFilter])) {\n+            $query->whereIn('a.status_id', $statusMap[$statusFilter]);\n+        }\n+    }\n+\n+    $requests = $query->orderBy('a.updated_at', 'desc')\n         ->limit(1000)\n         ->get()\n-        ->map(function ($t) {\n+        ->map(function ($r) {\n \n-            $status = (int) $t->status_id;\n+            $status = (int) $r->status_id;\n \n             $statusText = match($status) {\n                 7 => 'To be review',\n                 6 => 'Rejected',\n-                5 => 'Completed', // Released = Completed\n+                5 => 'Completed',\n                 4 => 'Approved',\n                 3 => 'Pending',\n                 default => 'Unknown',\n             };\n \n             return [\n-                'transaction_id' => $t->transaction_id,\n-                'item' => $t->item,\n-                'requester' => $t->requester,\n-                'date' => date('Y-m-d', strtotime($t->date)),\n+                'request_id' => $r->request_id,\n+                'grant_title' => $r->grant_title,\n+                'requester' => $r->requester,\n+                'date' => date('Y-m-d', strtotime($r->date)),\n                 'status' => $statusText,\n             ];\n         });\n \n     return $requests;\n }\n \n+\n }\n"
                },
                {
                    "date": 1764430832114,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,71 +182,46 @@\n         return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n     }\n \n \n-   public function recentGrantRequests($search = null, $statusFilter = null)\n+    public function recentGrantRequests()\n {\n-    $query = \\DB::table('applications as a')\n+    $requests = DB::table('applications as a')\n         ->join('grants as g', 'a.grant_id', '=', 'g.id')\n         ->join('users as u', 'a.user_id', '=', 'u.id')\n         ->where('a.application_type', 'grant_request')\n         ->select(\n-            \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n-            'g.title as grant_title',\n-            \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n+            DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n+            'g.item as item',\n+            DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n             'a.updated_at as date',\n             'a.status_id'\n-        );\n-\n-    // Apply search\n-    if ($search) {\n-        $query->where(function($q) use ($search) {\n-            $q->where('g.title', 'like', \"%$search%\")\n-              ->orWhere('u.first_name', 'like', \"%$search%\")\n-              ->orWhere('u.last_name', 'like', \"%$search%\")\n-              ->orWhere('a.id', 'like', \"%$search%\");\n-        });\n-    }\n-\n-    // Apply status filter\n-    if ($statusFilter) {\n-        $statusMap = [\n-            'approved' => [4],\n-            'pending' => [3, 7],\n-            'denied' => [6],\n-        ];\n-\n-        if (isset($statusMap[$statusFilter])) {\n-            $query->whereIn('a.status_id', $statusMap[$statusFilter]);\n-        }\n-    }\n-\n-    $requests = $query->orderBy('a.updated_at', 'desc')\n+        )\n+        ->orderBy('a.updated_at', 'desc')\n         ->limit(1000)\n         ->get()\n-        ->map(function ($r) {\n+        ->map(function ($t) {\n \n-            $status = (int) $r->status_id;\n+            $status = (int) $t->status_id;\n \n             $statusText = match($status) {\n                 7 => 'To be review',\n                 6 => 'Rejected',\n-                5 => 'Completed',\n+                5 => 'Completed', // Released = Completed\n                 4 => 'Approved',\n                 3 => 'Pending',\n                 default => 'Unknown',\n             };\n \n             return [\n-                'request_id' => $r->request_id,\n-                'grant_title' => $r->grant_title,\n-                'requester' => $r->requester,\n-                'date' => date('Y-m-d', strtotime($r->date)),\n+                'transaction_id' => $t->transaction_id,\n+                'item' => $t->item,\n+                'requester' => $t->requester,\n+                'date' => date('Y-m-d', strtotime($t->date)),\n                 'status' => $statusText,\n             ];\n         });\n \n     return $requests;\n }\n \n-\n }\n"
                },
                {
                    "date": 1764430850927,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,46 +182,47 @@\n         return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n     }\n \n \n-    public function recentGrantRequests()\n+   public function recentGrantRequests()\n {\n-    $requests = DB::table('applications as a')\n+    $requests = \\DB::table('applications as a')\n         ->join('grants as g', 'a.grant_id', '=', 'g.id')\n         ->join('users as u', 'a.user_id', '=', 'u.id')\n         ->where('a.application_type', 'grant_request')\n         ->select(\n-            DB::raw(\"CONCAT('REQ-0000', a.id) as transaction_id\"),\n-            'g.item as item',\n-            DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n+            \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n+            'g.title as grant_title', // <-- use title instead of item\n+            \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n             'a.updated_at as date',\n             'a.status_id'\n         )\n         ->orderBy('a.updated_at', 'desc')\n         ->limit(1000)\n         ->get()\n-        ->map(function ($t) {\n+        ->map(function ($r) {\n \n-            $status = (int) $t->status_id;\n+            $status = (int) $r->status_id;\n \n             $statusText = match($status) {\n                 7 => 'To be review',\n                 6 => 'Rejected',\n-                5 => 'Completed', // Released = Completed\n+                5 => 'Completed',   // Released treated as Completed\n                 4 => 'Approved',\n                 3 => 'Pending',\n                 default => 'Unknown',\n             };\n \n             return [\n-                'transaction_id' => $t->transaction_id,\n-                'item' => $t->item,\n-                'requester' => $t->requester,\n-                'date' => date('Y-m-d', strtotime($t->date)),\n+                'request_id' => $r->request_id,\n+                'grant_title' => $r->grant_title, // updated key\n+                'requester' => $r->requester,\n+                'date' => date('Y-m-d', strtotime($r->date)),\n                 'status' => $statusText,\n             ];\n         });\n \n     return $requests;\n }\n \n+\n }\n"
                },
                {
                    "date": 1764431607046,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -174,16 +174,88 @@\n \n     // --------------------------\n     // PDF Export\n     // --------------------------\n-    public function exportPdf()\n-    {\n-        $requests = ReportRequest::all();\n-        $pdf = Pdf::loadView('reports.requests-pdf', compact('requests'));\n-        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n+public function exportPdf()\n+{\n+    $requests = $this->recentGrantRequests() ?? [];\n+\n+    $logoPath = public_path('images/swisa-agap5.png');\n+\n+    // --- HTML ---\n+    $html = '\n+    <html>\n+    <head>\n+        <meta charset=\"utf-8\">\n+        <title>SwisaAGAP Requests Report</title>\n+        <style>\n+            body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n+            .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n+            .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n+            .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n+            .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n+            .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n+            .modern-table tr:nth-child(even) { background:#f9f9f9; }\n+            .modern-table tr:nth-child(odd) { background:#ffffff; }\n+            .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n+        </style>\n+    </head>\n+    <body>\n+        <div style=\"text-align:center; margin-bottom:10px;\">\n+            <img src=\"' . $logoPath . '\" width=\"120\">\n+        </div>\n+\n+        <div style=\"margin-bottom:20px; text-align:start;\">\n+            <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n+            <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n+        </div>\n+\n+        <div class=\"section\">\n+            <h3 class=\"modern-header\">Recent Grant Requests</h3>\n+            <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n+                <thead>\n+                    <tr>\n+                        <th>Request ID</th>\n+                        <th>Item</th>\n+                        <th>Requester</th>\n+                        <th>Date</th>\n+                        <th>Status</th>\n+                    </tr>\n+                </thead>\n+                <tbody>';\n+    \n+    foreach ($requests as $r) {\n+        $color = match($r['status']) {\n+            'Completed', 'Approved' => '#2C6E49',\n+            'Pending', 'To be review' => '#FFC107',\n+            'Rejected', 'Denied' => '#FF3B30',\n+            default => '#333'\n+        };\n+\n+        $html .= '<tr>\n+            <td>' . $r['request_id'] . '</td>\n+            <td>' . $r['grant_title'] . '</td>\n+            <td>' . $r['requester'] . '</td>\n+            <td>' . $r['date'] . '</td>\n+            <td style=\"font-weight:bold; color:' . $color . ';\">' . $r['status'] . '</td>\n+        </tr>';\n     }\n \n+    $html .= '\n+                </tbody>\n+            </table>\n+        </div>\n \n+        <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n+    </body>\n+    </html>';\n+\n+    $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n+    return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n+}\n+\n+\n+\n    public function recentGrantRequests()\n {\n     $requests = \\DB::table('applications as a')\n         ->join('grants as g', 'a.grant_id', '=', 'g.id')\n"
                },
                {
                    "date": 1764431725015,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -96,44 +96,43 @@\n }\n     // --------------------------\n     // CSV Export\n     // --------------------------\n-    public function exportCsv()\n-    {\n-        $requests = ReportRequest::all();\n-        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n-        $headers = [\n-            'Content-Type' => 'text/csv',\n-            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-        ];\n+public function exportCsv()\n+{\n+    $requests = $this->recentGrantRequests() ?? [];\n+    $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n+    $headers = [\n+        'Content-Type' => 'text/csv',\n+        'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+    ];\n \n-        $callback = function() use ($requests) {\n-            $file = fopen('php://output', 'w');\n+    $callback = function() use ($requests) {\n+        $file = fopen('php://output', 'w');\n \n-            fputcsv($file, ['SwisaAGAP Requests Report']);\n-            fputcsv($file, []);\n+        fputcsv($file, ['SwisaAGAP Requests Report']);\n+        fputcsv($file, []);\n \n-            // Table header\n-            fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n+        fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n \n-            foreach($requests as $r) {\n-                fputcsv($file, [\n-                    $r->request_id,\n-                    $r->item,\n-                    $r->requester_name,\n-                    $r->date_submitted,\n-                    $r->status,\n-                ]);\n-            }\n+        foreach($requests as $r) {\n+            fputcsv($file, [\n+                $r['request_id'],\n+                $r['grant_title'],\n+                $r['requester'],\n+                $r['date'],\n+                $r['status'],\n+            ]);\n+        }\n \n-            fputcsv($file, []);\n-            fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n+        fputcsv($file, []);\n+        fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n+        fclose($file);\n+    };\n \n-            fclose($file);\n-        };\n+    return Response::stream($callback, 200, $headers);\n+}\n \n-        return Response::stream($callback, 200, $headers);\n-    }\n \n     // --------------------------\n     // Excel Export\n     // --------------------------\n"
                },
                {
                    "date": 1764431753116,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -135,43 +135,47 @@\n \n     // --------------------------\n     // Excel Export\n     // --------------------------\n-    public function exportExcel()\n-    {\n-        $requests = ReportRequest::all();\n-        $spreadsheet = new Spreadsheet();\n-        $sheet = $spreadsheet->getActiveSheet();\n+public function exportExcel()\n+{\n+    $requests = $this->recentGrantRequests() ?? [];\n+    $spreadsheet = new Spreadsheet();\n+    $sheet = $spreadsheet->getActiveSheet();\n+    $row = 1;\n \n-        $row = 1;\n-        $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n-        $row++;\n+    // Title\n+    $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n+    $row++; // blank row\n \n-        // Table header\n-        $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n-        foreach($requests as $r) {\n-            $sheet->fromArray([\n-                $r->request_id,\n-                $r->item,\n-                $r->requester_name,\n-                $r->date_submitted,\n-                $r->status,\n-            ], null, 'A'.$row++);\n-        }\n+    // Table header\n+    $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n \n-        $row++;\n-        $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n+    // Rows\n+    foreach($requests as $r) {\n+        $sheet->fromArray([\n+            $r['request_id'],\n+            $r['grant_title'],\n+            $r['requester'],\n+            $r['date'],\n+            $r['status'],\n+        ], null, 'A'.$row++);\n+    }\n \n-        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n-        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n-        header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n-        header('Cache-Control: max-age=0');\n+    $row++; // blank row\n+    $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n \n-        $writer = new Xlsx($spreadsheet);\n-        $writer->save('php://output');\n-        exit;\n-    }\n+    $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n+    header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n+    header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n+    header('Cache-Control: max-age=0');\n \n+    $writer = new Xlsx($spreadsheet);\n+    $writer->save('php://output');\n+    exit;\n+}\n+\n+\n     // --------------------------\n     // PDF Export\n     // --------------------------\n public function exportPdf()\n"
                },
                {
                    "date": 1764431806593,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,280 +24,280 @@\n         $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n \n         return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n     }\n-public function requestStats()\n-{\n-    // Base query for grant requests only\n-    $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n+    public function requestStats()\n+    {\n+        // Base query for grant requests only\n+        $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n \n-    $total = (clone $baseQuery)->count();\n+        $total = (clone $baseQuery)->count();\n \n-    $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n-    $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n-    $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n-    $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n-    $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n+        $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n+        $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n+        $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n+        $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n+        $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n \n-    // Completed = Released\n-    $completed = $released;\n+        // Completed = Released\n+        $completed = $released;\n \n-    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+        $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n-    return response()->json([\n-        'total' => $total,\n-        'approved' => $approved,\n-        'pending' => $pending,\n-        'toBeReview' => $toBeReview,\n-        'rejected' => $rejected,\n-        'released' => $released,\n-        'completed' => $completed,\n-        'approvalRate' => $approvalRate\n-    ]);\n-}\n+        return response()->json([\n+            'total' => $total,\n+            'approved' => $approved,\n+            'pending' => $pending,\n+            'toBeReview' => $toBeReview,\n+            'rejected' => $rejected,\n+            'released' => $released,\n+            'completed' => $completed,\n+            'approvalRate' => $approvalRate\n+        ]);\n+    }\n \n-public function requestChartData(Request $request)\n-{\n-    $year = $request->year ?? now()->year;\n+    public function requestChartData(Request $request)\n+    {\n+        $year = $request->year ?? now()->year;\n \n-    // Filter only grant_request\n-    $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n-        ->whereYear('created_at', $year);\n+        // Filter only grant_request\n+        $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n+            ->whereYear('created_at', $year);\n \n-    // Group by month using new statuses\n-    $monthly = $query->selectRaw(\"\n-        MONTH(created_at) as month,\n-        SUM(CASE WHEN status_id = 5 THEN 1 ELSE 0 END) as completed,\n-        SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n-    \")\n-    ->groupBy('month')\n-    ->orderBy('month')\n-    ->get();\n+        // Group by month using new statuses\n+        $monthly = $query->selectRaw(\"\n+            MONTH(created_at) as month,\n+            SUM(CASE WHEN status_id = 5 THEN 1 ELSE 0 END) as completed,\n+            SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n+        \")\n+        ->groupBy('month')\n+        ->orderBy('month')\n+        ->get();\n \n-    // Convert months for the chart\n-    $formatted = [];\n+        // Convert months for the chart\n+        $formatted = [];\n \n-    $months = [\n-        1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n-        5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n-        9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n-    ];\n+        $months = [\n+            1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n+            5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n+            9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n+        ];\n \n-    foreach ($months as $num => $name) {\n-        $row = $monthly->firstWhere('month', $num);\n+        foreach ($months as $num => $name) {\n+            $row = $monthly->firstWhere('month', $num);\n \n-        $formatted[] = [\n-            'month'     => $name,\n-            'completed' => $row->completed ?? 0,\n-            'rejected'  => $row->rejected ?? 0,\n+            $formatted[] = [\n+                'month'     => $name,\n+                'completed' => $row->completed ?? 0,\n+                'rejected'  => $row->rejected ?? 0,\n+            ];\n+        }\n+\n+        return response()->json($formatted);\n+    }\n+        // --------------------------\n+        // CSV Export\n+        // --------------------------\n+    public function exportCsv()\n+    {\n+        $requests = $this->recentGrantRequests() ?? [];\n+        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n+        $headers = [\n+            'Content-Type' => 'text/csv',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n         ];\n+\n+        $callback = function() use ($requests) {\n+            $file = fopen('php://output', 'w');\n+\n+            fputcsv($file, ['SwisaAGAP Requests Report']);\n+            fputcsv($file, []);\n+\n+            fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n+\n+            foreach($requests as $r) {\n+                fputcsv($file, [\n+                    $r['request_id'],\n+                    $r['grant_title'],\n+                    $r['requester'],\n+                    $r['date'],\n+                    $r['status'],\n+                ]);\n+            }\n+\n+            fputcsv($file, []);\n+            fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n+            fclose($file);\n+        };\n+\n+        return Response::stream($callback, 200, $headers);\n     }\n \n-    return response()->json($formatted);\n-}\n+\n     // --------------------------\n-    // CSV Export\n+    // Excel Export\n     // --------------------------\n-public function exportCsv()\n-{\n-    $requests = $this->recentGrantRequests() ?? [];\n-    $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n-    $headers = [\n-        'Content-Type' => 'text/csv',\n-        'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-    ];\n+    public function exportExcel()\n+    {\n+        $requests = $this->recentGrantRequests() ?? [];\n+        $spreadsheet = new Spreadsheet();\n+        $sheet = $spreadsheet->getActiveSheet();\n+        $row = 1;\n \n-    $callback = function() use ($requests) {\n-        $file = fopen('php://output', 'w');\n+        // Title\n+        $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n+        $row++; // blank row\n \n-        fputcsv($file, ['SwisaAGAP Requests Report']);\n-        fputcsv($file, []);\n+        // Table header\n+        $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n \n-        fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n-\n+        // Rows\n         foreach($requests as $r) {\n-            fputcsv($file, [\n+            $sheet->fromArray([\n                 $r['request_id'],\n                 $r['grant_title'],\n                 $r['requester'],\n                 $r['date'],\n                 $r['status'],\n-            ]);\n+            ], null, 'A'.$row++);\n         }\n \n-        fputcsv($file, []);\n-        fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n-        fclose($file);\n-    };\n+        $row++; // blank row\n+        $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n \n-    return Response::stream($callback, 200, $headers);\n-}\n+        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n+        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n+        header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n+        header('Cache-Control: max-age=0');\n \n-\n-    // --------------------------\n-    // Excel Export\n-    // --------------------------\n-public function exportExcel()\n-{\n-    $requests = $this->recentGrantRequests() ?? [];\n-    $spreadsheet = new Spreadsheet();\n-    $sheet = $spreadsheet->getActiveSheet();\n-    $row = 1;\n-\n-    // Title\n-    $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n-    $row++; // blank row\n-\n-    // Table header\n-    $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n-\n-    // Rows\n-    foreach($requests as $r) {\n-        $sheet->fromArray([\n-            $r['request_id'],\n-            $r['grant_title'],\n-            $r['requester'],\n-            $r['date'],\n-            $r['status'],\n-        ], null, 'A'.$row++);\n+        $writer = new Xlsx($spreadsheet);\n+        $writer->save('php://output');\n+        exit;\n     }\n \n-    $row++; // blank row\n-    $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n \n-    $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n-    header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n-    header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n-    header('Cache-Control: max-age=0');\n-\n-    $writer = new Xlsx($spreadsheet);\n-    $writer->save('php://output');\n-    exit;\n-}\n-\n-\n     // --------------------------\n     // PDF Export\n     // --------------------------\n-public function exportPdf()\n-{\n-    $requests = $this->recentGrantRequests() ?? [];\n+    public function exportPdf()\n+    {\n+        $requests = $this->recentGrantRequests() ?? [];\n \n-    $logoPath = public_path('images/swisa-agap5.png');\n+        $logoPath = public_path('images/swisa-agap5.png');\n \n-    // --- HTML ---\n-    $html = '\n-    <html>\n-    <head>\n-        <meta charset=\"utf-8\">\n-        <title>SwisaAGAP Requests Report</title>\n-        <style>\n-            body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n-            .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n-            .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n-            .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n-            .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n-            .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n-            .modern-table tr:nth-child(even) { background:#f9f9f9; }\n-            .modern-table tr:nth-child(odd) { background:#ffffff; }\n-            .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n-        </style>\n-    </head>\n-    <body>\n-        <div style=\"text-align:center; margin-bottom:10px;\">\n-            <img src=\"' . $logoPath . '\" width=\"120\">\n-        </div>\n+        // --- HTML ---\n+        $html = '\n+        <html>\n+        <head>\n+            <meta charset=\"utf-8\">\n+            <title>SwisaAGAP Requests Report</title>\n+            <style>\n+                body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n+                .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n+                .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n+                .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n+                .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n+                .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n+                .modern-table tr:nth-child(even) { background:#f9f9f9; }\n+                .modern-table tr:nth-child(odd) { background:#ffffff; }\n+                .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n+            </style>\n+        </head>\n+        <body>\n+            <div style=\"text-align:center; margin-bottom:10px;\">\n+                <img src=\"' . $logoPath . '\" width=\"120\">\n+            </div>\n \n-        <div style=\"margin-bottom:20px; text-align:start;\">\n-            <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n-            <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n-        </div>\n+            <div style=\"margin-bottom:20px; text-align:start;\">\n+                <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n+                <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n+            </div>\n \n-        <div class=\"section\">\n-            <h3 class=\"modern-header\">Recent Grant Requests</h3>\n-            <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n-                <thead>\n-                    <tr>\n-                        <th>Request ID</th>\n-                        <th>Item</th>\n-                        <th>Requester</th>\n-                        <th>Date</th>\n-                        <th>Status</th>\n-                    </tr>\n-                </thead>\n-                <tbody>';\n-    \n-    foreach ($requests as $r) {\n-        $color = match($r['status']) {\n-            'Completed', 'Approved' => '#2C6E49',\n-            'Pending', 'To be review' => '#FFC107',\n-            'Rejected', 'Denied' => '#FF3B30',\n-            default => '#333'\n-        };\n+            <div class=\"section\">\n+                <h3 class=\"modern-header\">Recent Grant Requests</h3>\n+                <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n+                    <thead>\n+                        <tr>\n+                            <th>Request ID</th>\n+                            <th>Item</th>\n+                            <th>Requester</th>\n+                            <th>Date</th>\n+                            <th>Status</th>\n+                        </tr>\n+                    </thead>\n+                    <tbody>';\n+        \n+        foreach ($requests as $r) {\n+            $color = match($r['status']) {\n+                'Completed', 'Approved' => '#2C6E49',\n+                'Pending', 'To be review' => '#FFC107',\n+                'Rejected', 'Denied' => '#FF3B30',\n+                default => '#333'\n+            };\n \n-        $html .= '<tr>\n-            <td>' . $r['request_id'] . '</td>\n-            <td>' . $r['grant_title'] . '</td>\n-            <td>' . $r['requester'] . '</td>\n-            <td>' . $r['date'] . '</td>\n-            <td style=\"font-weight:bold; color:' . $color . ';\">' . $r['status'] . '</td>\n-        </tr>';\n-    }\n+            $html .= '<tr>\n+                <td>' . $r['request_id'] . '</td>\n+                <td>' . $r['grant_title'] . '</td>\n+                <td>' . $r['requester'] . '</td>\n+                <td>' . $r['date'] . '</td>\n+                <td style=\"font-weight:bold; color:' . $color . ';\">' . $r['status'] . '</td>\n+            </tr>';\n+        }\n \n-    $html .= '\n-                </tbody>\n-            </table>\n-        </div>\n+        $html .= '\n+                    </tbody>\n+                </table>\n+            </div>\n \n-        <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n-    </body>\n-    </html>';\n+            <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n+        </body>\n+        </html>';\n \n-    $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n-    return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n-}\n+        $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n+        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n+    }\n \n \n \n-   public function recentGrantRequests()\n-{\n-    $requests = \\DB::table('applications as a')\n-        ->join('grants as g', 'a.grant_id', '=', 'g.id')\n-        ->join('users as u', 'a.user_id', '=', 'u.id')\n-        ->where('a.application_type', 'grant_request')\n-        ->select(\n-            \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n-            'g.title as grant_title', // <-- use title instead of item\n-            \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n-            'a.updated_at as date',\n-            'a.status_id'\n-        )\n-        ->orderBy('a.updated_at', 'desc')\n-        ->limit(1000)\n-        ->get()\n-        ->map(function ($r) {\n+    public function recentGrantRequests()\n+    {\n+        $requests = \\DB::table('applications as a')\n+            ->join('grants as g', 'a.grant_id', '=', 'g.id')\n+            ->join('users as u', 'a.user_id', '=', 'u.id')\n+            ->where('a.application_type', 'grant_request')\n+            ->select(\n+                \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n+                'g.title as grant_title', // <-- use title instead of item\n+                \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n+                'a.updated_at as date',\n+                'a.status_id'\n+            )\n+            ->orderBy('a.updated_at', 'desc')\n+            ->limit(1000)\n+            ->get()\n+            ->map(function ($r) {\n \n-            $status = (int) $r->status_id;\n+                $status = (int) $r->status_id;\n \n-            $statusText = match($status) {\n-                7 => 'To be review',\n-                6 => 'Rejected',\n-                5 => 'Completed',   // Released treated as Completed\n-                4 => 'Approved',\n-                3 => 'Pending',\n-                default => 'Unknown',\n-            };\n+                $statusText = match($status) {\n+                    7 => 'To be review',\n+                    6 => 'Rejected',\n+                    5 => 'Completed',   // Released treated as Completed\n+                    4 => 'Approved',\n+                    3 => 'Pending',\n+                    default => 'Unknown',\n+                };\n \n-            return [\n-                'request_id' => $r->request_id,\n-                'grant_title' => $r->grant_title, // updated key\n-                'requester' => $r->requester,\n-                'date' => date('Y-m-d', strtotime($r->date)),\n-                'status' => $statusText,\n-            ];\n-        });\n+                return [\n+                    'request_id' => $r->request_id,\n+                    'grant_title' => $r->grant_title, // updated key\n+                    'requester' => $r->requester,\n+                    'date' => date('Y-m-d', strtotime($r->date)),\n+                    'status' => $statusText,\n+                ];\n+            });\n \n-    return $requests;\n-}\n+        return $requests;\n+    }\n \n \n }\n"
                },
                {
                    "date": 1764432074878,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,88 +177,124 @@\n \n     // --------------------------\n     // PDF Export\n     // --------------------------\n-    public function exportPdf()\n-    {\n-        $requests = $this->recentGrantRequests() ?? [];\n+public function exportPdf()\n+{\n+    $requests = $this->recentGrantRequests() ?? [];\n \n-        $logoPath = public_path('images/swisa-agap5.png');\n+    $logoPath = public_path('images/swisa-agap5.png');\n \n-        // --- HTML ---\n-        $html = '\n-        <html>\n-        <head>\n-            <meta charset=\"utf-8\">\n-            <title>SwisaAGAP Requests Report</title>\n-            <style>\n-                body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n-                .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n-                .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n-                .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n-                .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n-                .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n-                .modern-table tr:nth-child(even) { background:#f9f9f9; }\n-                .modern-table tr:nth-child(odd) { background:#ffffff; }\n-                .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n-            </style>\n-        </head>\n-        <body>\n-            <div style=\"text-align:center; margin-bottom:10px;\">\n-                <img src=\"' . $logoPath . '\" width=\"120\">\n-            </div>\n+    // --- HTML ---\n+    $html = '\n+    <html>\n+    <head>\n+        <meta charset=\"utf-8\">\n+        <title>SwisaAGAP Requests Report</title>\n+        <style>\n+            body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n+            .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n+            .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n+            .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n+            .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n+            .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n+            .modern-table tr:nth-child(even) { background:#f9f9f9; }\n+            .modern-table tr:nth-child(odd) { background:#ffffff; }\n+            .status-green { color:#2C6E49; font-weight:bold; }\n+            .status-yellow { color:#FFC107; font-weight:bold; }\n+            .status-red { color:#FF3B30; font-weight:bold; }\n+            .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n+        </style>\n+    </head>\n+    <body>\n+        <div style=\"text-align:center; margin-bottom:10px;\">\n+            <img src=\"' . $logoPath . '\" width=\"120\">\n+        </div>\n \n-            <div style=\"margin-bottom:20px; text-align:start;\">\n-                <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n-                <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n-            </div>\n+        <div style=\"margin-bottom:20px; text-align:start;\">\n+            <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n+            <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n+        </div>\n \n-            <div class=\"section\">\n-                <h3 class=\"modern-header\">Recent Grant Requests</h3>\n-                <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n-                    <thead>\n-                        <tr>\n-                            <th>Request ID</th>\n-                            <th>Item</th>\n-                            <th>Requester</th>\n-                            <th>Date</th>\n-                            <th>Status</th>\n-                        </tr>\n-                    </thead>\n-                    <tbody>';\n-        \n-        foreach ($requests as $r) {\n-            $color = match($r['status']) {\n-                'Completed', 'Approved' => '#2C6E49',\n-                'Pending', 'To be review' => '#FFC107',\n-                'Rejected', 'Denied' => '#FF3B30',\n-                default => '#333'\n-            };\n+        <!-- STATS CARDS -->\n+        <table style=\"width:100%; border-collapse:collapse; margin-bottom:20px;\">\n+            <tr>';\n \n-            $html .= '<tr>\n-                <td>' . $r['request_id'] . '</td>\n-                <td>' . $r['grant_title'] . '</td>\n-                <td>' . $r['requester'] . '</td>\n-                <td>' . $r['date'] . '</td>\n-                <td style=\"font-weight:bold; color:' . $color . ';\">' . $r['status'] . '</td>\n-            </tr>';\n-        }\n+    // Calculate stats\n+    $total = count($requests);\n+    $approved = count(array_filter($requests, fn($r) => $r['status'] === 'Approved' || $r['status'] === 'Completed'));\n+    $pending = count(array_filter($requests, fn($r) => $r['status'] === 'Pending' || $r['status'] === 'To be review'));\n+    $completed = $approved;\n+    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n+    $stats = [\n+        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#22c55e'], // green\n+        ['label' => 'Total Requests', 'value' => $total, 'color' => '#16a34a'], // dark green\n+        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2563eb'], // blue\n+        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#facc15'], // yellow\n+    ];\n+\n+    foreach ($stats as $s) {\n         $html .= '\n-                    </tbody>\n-                </table>\n-            </div>\n+        <td class=\"card\" style=\"border-top:4px solid ' . $s['color'] . ';\">\n+            <h3>' . $s['label'] . '</h3>\n+            <p>' . $s['value'] . '</p>\n+        </td>';\n+    }\n \n-            <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n-        </body>\n-        </html>';\n+    $html .= '\n+            </tr>\n+        </table>\n \n-        $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n-        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n+        <!-- REQUESTS TABLE -->\n+        <div class=\"section\">\n+            <h3 class=\"modern-header\">Recent Grant Requests</h3>\n+            <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n+                <thead>\n+                    <tr>\n+                        <th>Request ID</th>\n+                        <th>Item</th>\n+                        <th>Requester</th>\n+                        <th>Date</th>\n+                        <th>Status</th>\n+                    </tr>\n+                </thead>\n+                <tbody>';\n+\n+    foreach ($requests as $r) {\n+        $statusClass = match($r['status']) {\n+            'Approved', 'Completed' => 'status-green',\n+            'Pending', 'To be review' => 'status-yellow',\n+            'Rejected', 'Denied' => 'status-red',\n+            default => ''\n+        };\n+\n+        $html .= '\n+        <tr>\n+            <td>' . $r['request_id'] . '</td>\n+            <td>' . $r['grant_title'] . '</td>\n+            <td>' . $r['requester'] . '</td>\n+            <td>' . $r['date'] . '</td>\n+            <td class=\"' . $statusClass . '\">' . $r['status'] . '</td>\n+        </tr>';\n     }\n \n+    $html .= '\n+                </tbody>\n+            </table>\n+        </div>\n \n+        <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n+    </body>\n+    </html>';\n \n+    $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n+    return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n+}\n+\n+\n+\n+\n     public function recentGrantRequests()\n     {\n         $requests = \\DB::table('applications as a')\n             ->join('grants as g', 'a.grant_id', '=', 'g.id')\n"
                },
                {
                    "date": 1764432146105,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,124 +177,88 @@\n \n     // --------------------------\n     // PDF Export\n     // --------------------------\n-public function exportPdf()\n-{\n-    $requests = $this->recentGrantRequests() ?? [];\n+    public function exportPdf()\n+    {\n+        $requests = $this->recentGrantRequests() ?? [];\n \n-    $logoPath = public_path('images/swisa-agap5.png');\n+        $logoPath = public_path('images/swisa-agap5.png');\n \n-    // --- HTML ---\n-    $html = '\n-    <html>\n-    <head>\n-        <meta charset=\"utf-8\">\n-        <title>SwisaAGAP Requests Report</title>\n-        <style>\n-            body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n-            .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n-            .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n-            .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n-            .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n-            .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n-            .modern-table tr:nth-child(even) { background:#f9f9f9; }\n-            .modern-table tr:nth-child(odd) { background:#ffffff; }\n-            .status-green { color:#2C6E49; font-weight:bold; }\n-            .status-yellow { color:#FFC107; font-weight:bold; }\n-            .status-red { color:#FF3B30; font-weight:bold; }\n-            .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n-        </style>\n-    </head>\n-    <body>\n-        <div style=\"text-align:center; margin-bottom:10px;\">\n-            <img src=\"' . $logoPath . '\" width=\"120\">\n-        </div>\n+        // --- HTML ---\n+        $html = '\n+        <html>\n+        <head>\n+            <meta charset=\"utf-8\">\n+            <title>SwisaAGAP Requests Report</title>\n+            <style>\n+                body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n+                .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n+                .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n+                .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n+                .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n+                .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n+                .modern-table tr:nth-child(even) { background:#f9f9f9; }\n+                .modern-table tr:nth-child(odd) { background:#ffffff; }\n+                .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n+            </style>\n+        </head>\n+        <body>\n+            <div style=\"text-align:center; margin-bottom:10px;\">\n+                <img src=\"' . $logoPath . '\" width=\"120\">\n+            </div>\n \n-        <div style=\"margin-bottom:20px; text-align:start;\">\n-            <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n-            <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n-        </div>\n+            <div style=\"margin-bottom:20px; text-align:start;\">\n+                <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n+                <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n+            </div>\n \n-        <!-- STATS CARDS -->\n-        <table style=\"width:100%; border-collapse:collapse; margin-bottom:20px;\">\n-            <tr>';\n+            <div class=\"section\">\n+                <h3 class=\"modern-header\">Recent Grant Requests</h3>\n+                <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n+                    <thead>\n+                        <tr>\n+                            <th>Request ID</th>\n+                            <th>Item</th>\n+                            <th>Requester</th>\n+                            <th>Date</th>\n+                            <th>Status</th>\n+                        </tr>\n+                    </thead>\n+                    <tbody>';\n+        \n+        foreach ($requests as $r) {\n+            $color = match($r['status']) {\n+                'Completed', 'Approved' => '#2C6E49',\n+                'Pending', 'To be review' => '#FFC107',\n+                'Rejected', 'Denied' => '#FF3B30',\n+                default => '#333'\n+            };\n \n-    // Calculate stats\n-    $total = count($requests);\n-    $approved = count(array_filter($requests, fn($r) => $r['status'] === 'Approved' || $r['status'] === 'Completed'));\n-    $pending = count(array_filter($requests, fn($r) => $r['status'] === 'Pending' || $r['status'] === 'To be review'));\n-    $completed = $approved;\n-    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+            $html .= '<tr>\n+                <td>' . $r['request_id'] . '</td>\n+                <td>' . $r['grant_title'] . '</td>\n+                <td>' . $r['requester'] . '</td>\n+                <td>' . $r['date'] . '</td>\n+                <td style=\"font-weight:bold; color:' . $color . ';\">' . $r['status'] . '</td>\n+            </tr>';\n+        }\n \n-    $stats = [\n-        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#22c55e'], // green\n-        ['label' => 'Total Requests', 'value' => $total, 'color' => '#16a34a'], // dark green\n-        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2563eb'], // blue\n-        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#facc15'], // yellow\n-    ];\n-\n-    foreach ($stats as $s) {\n         $html .= '\n-        <td class=\"card\" style=\"border-top:4px solid ' . $s['color'] . ';\">\n-            <h3>' . $s['label'] . '</h3>\n-            <p>' . $s['value'] . '</p>\n-        </td>';\n-    }\n+                    </tbody>\n+                </table>\n+            </div>\n \n-    $html .= '\n-            </tr>\n-        </table>\n+            <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n+        </body>\n+        </html>';\n \n-        <!-- REQUESTS TABLE -->\n-        <div class=\"section\">\n-            <h3 class=\"modern-header\">Recent Grant Requests</h3>\n-            <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n-                <thead>\n-                    <tr>\n-                        <th>Request ID</th>\n-                        <th>Item</th>\n-                        <th>Requester</th>\n-                        <th>Date</th>\n-                        <th>Status</th>\n-                    </tr>\n-                </thead>\n-                <tbody>';\n-\n-    foreach ($requests as $r) {\n-        $statusClass = match($r['status']) {\n-            'Approved', 'Completed' => 'status-green',\n-            'Pending', 'To be review' => 'status-yellow',\n-            'Rejected', 'Denied' => 'status-red',\n-            default => ''\n-        };\n-\n-        $html .= '\n-        <tr>\n-            <td>' . $r['request_id'] . '</td>\n-            <td>' . $r['grant_title'] . '</td>\n-            <td>' . $r['requester'] . '</td>\n-            <td>' . $r['date'] . '</td>\n-            <td class=\"' . $statusClass . '\">' . $r['status'] . '</td>\n-        </tr>';\n+        $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n+        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n     }\n \n-    $html .= '\n-                </tbody>\n-            </table>\n-        </div>\n \n-        <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n-    </body>\n-    </html>';\n \n-    $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n-    return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n-}\n-\n-\n-\n-\n     public function recentGrantRequests()\n     {\n         $requests = \\DB::table('applications as a')\n             ->join('grants as g', 'a.grant_id', '=', 'g.id')\n"
                },
                {
                    "date": 1764432156034,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,88 +177,124 @@\n \n     // --------------------------\n     // PDF Export\n     // --------------------------\n-    public function exportPdf()\n-    {\n-        $requests = $this->recentGrantRequests() ?? [];\n+public function exportPdf()\n+{\n+    $requests = $this->recentGrantRequests() ?? collect(); // ensure it's a collection\n \n-        $logoPath = public_path('images/swisa-agap5.png');\n+    $logoPath = public_path('images/swisa-agap5.png');\n \n-        // --- HTML ---\n-        $html = '\n-        <html>\n-        <head>\n-            <meta charset=\"utf-8\">\n-            <title>SwisaAGAP Requests Report</title>\n-            <style>\n-                body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n-                .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n-                .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n-                .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n-                .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n-                .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n-                .modern-table tr:nth-child(even) { background:#f9f9f9; }\n-                .modern-table tr:nth-child(odd) { background:#ffffff; }\n-                .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n-            </style>\n-        </head>\n-        <body>\n-            <div style=\"text-align:center; margin-bottom:10px;\">\n-                <img src=\"' . $logoPath . '\" width=\"120\">\n-            </div>\n+    // --- HTML ---\n+    $html = '\n+    <html>\n+    <head>\n+        <meta charset=\"utf-8\">\n+        <title>SwisaAGAP Requests Report</title>\n+        <style>\n+            body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n+            .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n+            .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n+            .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n+            .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n+            .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n+            .modern-table tr:nth-child(even) { background:#f9f9f9; }\n+            .modern-table tr:nth-child(odd) { background:#ffffff; }\n+            .status-green { color:#2C6E49; font-weight:bold; }\n+            .status-yellow { color:#FFC107; font-weight:bold; }\n+            .status-red { color:#FF3B30; font-weight:bold; }\n+            .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n+        </style>\n+    </head>\n+    <body>\n+        <div style=\"text-align:center; margin-bottom:10px;\">\n+            <img src=\"' . $logoPath . '\" width=\"120\">\n+        </div>\n \n-            <div style=\"margin-bottom:20px; text-align:start;\">\n-                <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n-                <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n-            </div>\n+        <div style=\"margin-bottom:20px; text-align:start;\">\n+            <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n+            <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n+        </div>\n \n-            <div class=\"section\">\n-                <h3 class=\"modern-header\">Recent Grant Requests</h3>\n-                <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n-                    <thead>\n-                        <tr>\n-                            <th>Request ID</th>\n-                            <th>Item</th>\n-                            <th>Requester</th>\n-                            <th>Date</th>\n-                            <th>Status</th>\n-                        </tr>\n-                    </thead>\n-                    <tbody>';\n-        \n-        foreach ($requests as $r) {\n-            $color = match($r['status']) {\n-                'Completed', 'Approved' => '#2C6E49',\n-                'Pending', 'To be review' => '#FFC107',\n-                'Rejected', 'Denied' => '#FF3B30',\n-                default => '#333'\n-            };\n+        <!-- STATS CARDS -->\n+        <table style=\"width:100%; border-collapse:collapse; margin-bottom:20px;\">\n+            <tr>';\n \n-            $html .= '<tr>\n-                <td>' . $r['request_id'] . '</td>\n-                <td>' . $r['grant_title'] . '</td>\n-                <td>' . $r['requester'] . '</td>\n-                <td>' . $r['date'] . '</td>\n-                <td style=\"font-weight:bold; color:' . $color . ';\">' . $r['status'] . '</td>\n-            </tr>';\n-        }\n+    // Calculate stats using Collection methods\n+    $total = $requests->count();\n+    $approved = $requests->filter(fn($r) => $r['status'] === 'Approved' || $r['status'] === 'Completed')->count();\n+    $pending = $requests->filter(fn($r) => $r['status'] === 'Pending' || $r['status'] === 'To be review')->count();\n+    $completed = $approved;\n+    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n+    $stats = [\n+        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#22c55e'], // green\n+        ['label' => 'Total Requests', 'value' => $total, 'color' => '#16a34a'], // dark green\n+        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2563eb'], // blue\n+        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#facc15'], // yellow\n+    ];\n+\n+    foreach ($stats as $s) {\n         $html .= '\n-                    </tbody>\n-                </table>\n-            </div>\n+        <td class=\"card\" style=\"border-top:4px solid ' . $s['color'] . ';\">\n+            <h3>' . $s['label'] . '</h3>\n+            <p>' . $s['value'] . '</p>\n+        </td>';\n+    }\n \n-            <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n-        </body>\n-        </html>';\n+    $html .= '\n+            </tr>\n+        </table>\n \n-        $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n-        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n+        <!-- REQUESTS TABLE -->\n+        <div class=\"section\">\n+            <h3 class=\"modern-header\">Recent Grant Requests</h3>\n+            <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n+                <thead>\n+                    <tr>\n+                        <th>Request ID</th>\n+                        <th>Item</th>\n+                        <th>Requester</th>\n+                        <th>Date</th>\n+                        <th>Status</th>\n+                    </tr>\n+                </thead>\n+                <tbody>';\n+\n+    foreach ($requests as $r) {\n+        $statusClass = match($r['status']) {\n+            'Approved', 'Completed' => 'status-green',\n+            'Pending', 'To be review' => 'status-yellow',\n+            'Rejected', 'Denied' => 'status-red',\n+            default => ''\n+        };\n+\n+        $html .= '\n+        <tr>\n+            <td>' . $r['request_id'] . '</td>\n+            <td>' . $r['grant_title'] . '</td>\n+            <td>' . $r['requester'] . '</td>\n+            <td>' . $r['date'] . '</td>\n+            <td class=\"' . $statusClass . '\">' . $r['status'] . '</td>\n+        </tr>';\n     }\n \n+    $html .= '\n+                </tbody>\n+            </table>\n+        </div>\n \n+        <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n+    </body>\n+    </html>';\n \n+    $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n+    return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n+}\n+\n+\n+\n+\n     public function recentGrantRequests()\n     {\n         $requests = \\DB::table('applications as a')\n             ->join('grants as g', 'a.grant_id', '=', 'g.id')\n"
                },
                {
                    "date": 1764432377496,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -183,8 +183,41 @@\n     $requests = $this->recentGrantRequests() ?? collect(); // ensure it's a collection\n \n     $logoPath = public_path('images/swisa-agap5.png');\n \n+    // --- STATS ---\n+    $total = $requests->count();\n+    $approved = $requests->filter(fn($r) => $r['status'] === 'Approved' || $r['status'] === 'Completed')->count();\n+    $pending = $requests->filter(fn($r) => $r['status'] === 'Pending' || $r['status'] === 'To be review')->count();\n+    $completed = $approved;\n+    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+\n+    $stats = [\n+        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#22c55e'], \n+        ['label' => 'Total Requests', 'value' => $total, 'color' => '#16a34a'], \n+        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2563eb'], \n+        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#facc15'], \n+    ];\n+\n+    // --- CHART IMAGE ---\n+    // Example: use QuickChart.io\n+    $chartData = [\n+        'type' => 'line',\n+        'data' => [\n+            'labels' => ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],\n+            'datasets' => [\n+                ['label' => 'Completed', 'data' => $requests->groupBy(fn($r) => \\Carbon\\Carbon::parse($r['date'])->format('n'))->map(fn($m) => count($m))->values()->toArray(), 'borderColor' => '#16a34a', 'fill' => false],\n+                ['label' => 'Rejected', 'data' => $requests->filter(fn($r) => in_array($r['status'], ['Rejected','Denied']))->groupBy(fn($r) => \\Carbon\\Carbon::parse($r['date'])->format('n'))->map(fn($m) => count($m))->values()->toArray(), 'borderColor' => '#ef4444', 'fill' => false],\n+            ]\n+        ],\n+        'options' => [\n+            'responsive' => true,\n+            'plugins' => ['legend' => ['display' => true]]\n+        ]\n+    ];\n+\n+    $chartUrl = 'https://quickchart.io/chart?c=' . urlencode(json_encode($chartData));\n+\n     // --- HTML ---\n     $html = '\n     <html>\n     <head>\n@@ -215,51 +248,42 @@\n             <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n         </div>\n \n         <!-- STATS CARDS -->\n-        <table style=\"width:100%; border-collapse:collapse; margin-bottom:20px;\">\n-            <tr>';\n+        <table style=\"width:100%; border-collapse:collapse; margin-bottom:20px;\"><tr>';\n \n-    // Calculate stats using Collection methods\n-    $total = $requests->count();\n-    $approved = $requests->filter(fn($r) => $r['status'] === 'Approved' || $r['status'] === 'Completed')->count();\n-    $pending = $requests->filter(fn($r) => $r['status'] === 'Pending' || $r['status'] === 'To be review')->count();\n-    $completed = $approved;\n-    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n-\n-    $stats = [\n-        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#22c55e'], // green\n-        ['label' => 'Total Requests', 'value' => $total, 'color' => '#16a34a'], // dark green\n-        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2563eb'], // blue\n-        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#facc15'], // yellow\n-    ];\n-\n     foreach ($stats as $s) {\n         $html .= '\n         <td class=\"card\" style=\"border-top:4px solid ' . $s['color'] . ';\">\n             <h3>' . $s['label'] . '</h3>\n             <p>' . $s['value'] . '</p>\n         </td>';\n     }\n \n+    $html .= '</tr></table>';\n+\n+    // --- CHART ---\n     $html .= '\n-            </tr>\n-        </table>\n+    <div style=\"margin-bottom:20px; text-align:center;\">\n+        <h3 class=\"modern-header\">Request Over Time</h3>\n+        <img src=\"' . $chartUrl . '\" style=\"width:100%; max-width:900px; height:auto;\">\n+    </div>';\n \n-        <!-- REQUESTS TABLE -->\n-        <div class=\"section\">\n-            <h3 class=\"modern-header\">Recent Grant Requests</h3>\n-            <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n-                <thead>\n-                    <tr>\n-                        <th>Request ID</th>\n-                        <th>Item</th>\n-                        <th>Requester</th>\n-                        <th>Date</th>\n-                        <th>Status</th>\n-                    </tr>\n-                </thead>\n-                <tbody>';\n+    // --- REQUESTS TABLE ---\n+    $html .= '\n+    <div class=\"section\">\n+        <h3 class=\"modern-header\">Recent Grant Requests</h3>\n+        <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n+            <thead>\n+                <tr>\n+                    <th>Request ID</th>\n+                    <th>Item</th>\n+                    <th>Requester</th>\n+                    <th>Date</th>\n+                    <th>Status</th>\n+                </tr>\n+            </thead>\n+            <tbody>';\n \n     foreach ($requests as $r) {\n         $statusClass = match($r['status']) {\n             'Approved', 'Completed' => 'status-green',\n@@ -278,13 +302,13 @@\n         </tr>';\n     }\n \n     $html .= '\n-                </tbody>\n-            </table>\n-        </div>\n+            </tbody>\n+        </table>\n+    </div>\n \n-        <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n+    <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n     </body>\n     </html>';\n \n     $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n"
                },
                {
                    "date": 1764432395062,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -183,41 +183,8 @@\n     $requests = $this->recentGrantRequests() ?? collect(); // ensure it's a collection\n \n     $logoPath = public_path('images/swisa-agap5.png');\n \n-    // --- STATS ---\n-    $total = $requests->count();\n-    $approved = $requests->filter(fn($r) => $r['status'] === 'Approved' || $r['status'] === 'Completed')->count();\n-    $pending = $requests->filter(fn($r) => $r['status'] === 'Pending' || $r['status'] === 'To be review')->count();\n-    $completed = $approved;\n-    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n-\n-    $stats = [\n-        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#22c55e'], \n-        ['label' => 'Total Requests', 'value' => $total, 'color' => '#16a34a'], \n-        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2563eb'], \n-        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#facc15'], \n-    ];\n-\n-    // --- CHART IMAGE ---\n-    // Example: use QuickChart.io\n-    $chartData = [\n-        'type' => 'line',\n-        'data' => [\n-            'labels' => ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],\n-            'datasets' => [\n-                ['label' => 'Completed', 'data' => $requests->groupBy(fn($r) => \\Carbon\\Carbon::parse($r['date'])->format('n'))->map(fn($m) => count($m))->values()->toArray(), 'borderColor' => '#16a34a', 'fill' => false],\n-                ['label' => 'Rejected', 'data' => $requests->filter(fn($r) => in_array($r['status'], ['Rejected','Denied']))->groupBy(fn($r) => \\Carbon\\Carbon::parse($r['date'])->format('n'))->map(fn($m) => count($m))->values()->toArray(), 'borderColor' => '#ef4444', 'fill' => false],\n-            ]\n-        ],\n-        'options' => [\n-            'responsive' => true,\n-            'plugins' => ['legend' => ['display' => true]]\n-        ]\n-    ];\n-\n-    $chartUrl = 'https://quickchart.io/chart?c=' . urlencode(json_encode($chartData));\n-\n     // --- HTML ---\n     $html = '\n     <html>\n     <head>\n@@ -248,42 +215,51 @@\n             <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n         </div>\n \n         <!-- STATS CARDS -->\n-        <table style=\"width:100%; border-collapse:collapse; margin-bottom:20px;\"><tr>';\n+        <table style=\"width:100%; border-collapse:collapse; margin-bottom:20px;\">\n+            <tr>';\n \n+    // Calculate stats using Collection methods\n+    $total = $requests->count();\n+    $approved = $requests->filter(fn($r) => $r['status'] === 'Approved' || $r['status'] === 'Completed')->count();\n+    $pending = $requests->filter(fn($r) => $r['status'] === 'Pending' || $r['status'] === 'To be review')->count();\n+    $completed = $approved;\n+    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+\n+    $stats = [\n+        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#22c55e'], // green\n+        ['label' => 'Total Requests', 'value' => $total, 'color' => '#16a34a'], // dark green\n+        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2563eb'], // blue\n+        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#facc15'], // yellow\n+    ];\n+\n     foreach ($stats as $s) {\n         $html .= '\n         <td class=\"card\" style=\"border-top:4px solid ' . $s['color'] . ';\">\n             <h3>' . $s['label'] . '</h3>\n             <p>' . $s['value'] . '</p>\n         </td>';\n     }\n \n-    $html .= '</tr></table>';\n-\n-    // --- CHART ---\n     $html .= '\n-    <div style=\"margin-bottom:20px; text-align:center;\">\n-        <h3 class=\"modern-header\">Request Over Time</h3>\n-        <img src=\"' . $chartUrl . '\" style=\"width:100%; max-width:900px; height:auto;\">\n-    </div>';\n+            </tr>\n+        </table>\n \n-    // --- REQUESTS TABLE ---\n-    $html .= '\n-    <div class=\"section\">\n-        <h3 class=\"modern-header\">Recent Grant Requests</h3>\n-        <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n-            <thead>\n-                <tr>\n-                    <th>Request ID</th>\n-                    <th>Item</th>\n-                    <th>Requester</th>\n-                    <th>Date</th>\n-                    <th>Status</th>\n-                </tr>\n-            </thead>\n-            <tbody>';\n+        <!-- REQUESTS TABLE -->\n+        <div class=\"section\">\n+            <h3 class=\"modern-header\">Recent Grant Requests</h3>\n+            <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n+                <thead>\n+                    <tr>\n+                        <th>Request ID</th>\n+                        <th>Item</th>\n+                        <th>Requester</th>\n+                        <th>Date</th>\n+                        <th>Status</th>\n+                    </tr>\n+                </thead>\n+                <tbody>';\n \n     foreach ($requests as $r) {\n         $statusClass = match($r['status']) {\n             'Approved', 'Completed' => 'status-green',\n@@ -302,13 +278,13 @@\n         </tr>';\n     }\n \n     $html .= '\n-            </tbody>\n-        </table>\n-    </div>\n+                </tbody>\n+            </table>\n+        </div>\n \n-    <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n+        <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n     </body>\n     </html>';\n \n     $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n"
                },
                {
                    "date": 1764432477944,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,124 +177,88 @@\n \n     // --------------------------\n     // PDF Export\n     // --------------------------\n-public function exportPdf()\n-{\n-    $requests = $this->recentGrantRequests() ?? collect(); // ensure it's a collection\n+    public function exportPdf()\n+    {\n+        $requests = $this->recentGrantRequests() ?? [];\n \n-    $logoPath = public_path('images/swisa-agap5.png');\n+        $logoPath = public_path('images/swisa-agap5.png');\n \n-    // --- HTML ---\n-    $html = '\n-    <html>\n-    <head>\n-        <meta charset=\"utf-8\">\n-        <title>SwisaAGAP Requests Report</title>\n-        <style>\n-            body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n-            .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n-            .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n-            .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n-            .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n-            .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n-            .modern-table tr:nth-child(even) { background:#f9f9f9; }\n-            .modern-table tr:nth-child(odd) { background:#ffffff; }\n-            .status-green { color:#2C6E49; font-weight:bold; }\n-            .status-yellow { color:#FFC107; font-weight:bold; }\n-            .status-red { color:#FF3B30; font-weight:bold; }\n-            .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n-        </style>\n-    </head>\n-    <body>\n-        <div style=\"text-align:center; margin-bottom:10px;\">\n-            <img src=\"' . $logoPath . '\" width=\"120\">\n-        </div>\n+        // --- HTML ---\n+        $html = '\n+        <html>\n+        <head>\n+            <meta charset=\"utf-8\">\n+            <title>SwisaAGAP Requests Report</title>\n+            <style>\n+                body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n+                .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n+                .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n+                .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n+                .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n+                .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n+                .modern-table tr:nth-child(even) { background:#f9f9f9; }\n+                .modern-table tr:nth-child(odd) { background:#ffffff; }\n+                .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n+            </style>\n+        </head>\n+        <body>\n+            <div style=\"text-align:center; margin-bottom:10px;\">\n+                <img src=\"' . $logoPath . '\" width=\"120\">\n+            </div>\n \n-        <div style=\"margin-bottom:20px; text-align:start;\">\n-            <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n-            <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n-        </div>\n+            <div style=\"margin-bottom:20px; text-align:start;\">\n+                <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n+                <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n+            </div>\n \n-        <!-- STATS CARDS -->\n-        <table style=\"width:100%; border-collapse:collapse; margin-bottom:20px;\">\n-            <tr>';\n+            <div class=\"section\">\n+                <h3 class=\"modern-header\">Recent Grant Requests</h3>\n+                <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n+                    <thead>\n+                        <tr>\n+                            <th>Request ID</th>\n+                            <th>Item</th>\n+                            <th>Requester</th>\n+                            <th>Date</th>\n+                            <th>Status</th>\n+                        </tr>\n+                    </thead>\n+                    <tbody>';\n+        \n+        foreach ($requests as $r) {\n+            $color = match($r['status']) {\n+                'Completed', 'Approved' => '#2C6E49',\n+                'Pending', 'To be review' => '#FFC107',\n+                'Rejected', 'Denied' => '#FF3B30',\n+                default => '#333'\n+            };\n \n-    // Calculate stats using Collection methods\n-    $total = $requests->count();\n-    $approved = $requests->filter(fn($r) => $r['status'] === 'Approved' || $r['status'] === 'Completed')->count();\n-    $pending = $requests->filter(fn($r) => $r['status'] === 'Pending' || $r['status'] === 'To be review')->count();\n-    $completed = $approved;\n-    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+            $html .= '<tr>\n+                <td>' . $r['request_id'] . '</td>\n+                <td>' . $r['grant_title'] . '</td>\n+                <td>' . $r['requester'] . '</td>\n+                <td>' . $r['date'] . '</td>\n+                <td style=\"font-weight:bold; color:' . $color . ';\">' . $r['status'] . '</td>\n+            </tr>';\n+        }\n \n-    $stats = [\n-        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#22c55e'], // green\n-        ['label' => 'Total Requests', 'value' => $total, 'color' => '#16a34a'], // dark green\n-        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2563eb'], // blue\n-        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#facc15'], // yellow\n-    ];\n-\n-    foreach ($stats as $s) {\n         $html .= '\n-        <td class=\"card\" style=\"border-top:4px solid ' . $s['color'] . ';\">\n-            <h3>' . $s['label'] . '</h3>\n-            <p>' . $s['value'] . '</p>\n-        </td>';\n-    }\n+                    </tbody>\n+                </table>\n+            </div>\n \n-    $html .= '\n-            </tr>\n-        </table>\n+            <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n+        </body>\n+        </html>';\n \n-        <!-- REQUESTS TABLE -->\n-        <div class=\"section\">\n-            <h3 class=\"modern-header\">Recent Grant Requests</h3>\n-            <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n-                <thead>\n-                    <tr>\n-                        <th>Request ID</th>\n-                        <th>Item</th>\n-                        <th>Requester</th>\n-                        <th>Date</th>\n-                        <th>Status</th>\n-                    </tr>\n-                </thead>\n-                <tbody>';\n-\n-    foreach ($requests as $r) {\n-        $statusClass = match($r['status']) {\n-            'Approved', 'Completed' => 'status-green',\n-            'Pending', 'To be review' => 'status-yellow',\n-            'Rejected', 'Denied' => 'status-red',\n-            default => ''\n-        };\n-\n-        $html .= '\n-        <tr>\n-            <td>' . $r['request_id'] . '</td>\n-            <td>' . $r['grant_title'] . '</td>\n-            <td>' . $r['requester'] . '</td>\n-            <td>' . $r['date'] . '</td>\n-            <td class=\"' . $statusClass . '\">' . $r['status'] . '</td>\n-        </tr>';\n+        $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n+        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n     }\n \n-    $html .= '\n-                </tbody>\n-            </table>\n-        </div>\n \n-        <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n-    </body>\n-    </html>';\n \n-    $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n-    return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n-}\n-\n-\n-\n-\n     public function recentGrantRequests()\n     {\n         $requests = \\DB::table('applications as a')\n             ->join('grants as g', 'a.grant_id', '=', 'g.id')\n"
                },
                {
                    "date": 1764432502721,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -228,10 +228,10 @@\n         \n         foreach ($requests as $r) {\n             $color = match($r['status']) {\n                 'Completed', 'Approved' => '#2C6E49',\n-                'Pending', 'To be review' => '#FFC107',\n-                'Rejected', 'Denied' => '#FF3B30',\n+                'Pending', 'To be review' => '#2C6E49',\n+                'Rejected', 'Denied' => '#2C6E49',\n                 default => '#333'\n             };\n \n             $html .= '<tr>\n"
                },
                {
                    "date": 1764432517684,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -229,9 +229,9 @@\n         foreach ($requests as $r) {\n             $color = match($r['status']) {\n                 'Completed', 'Approved' => '#2C6E49',\n                 'Pending', 'To be review' => '#2C6E49',\n-                'Rejected', 'Denied' => '#2C6E49',\n+                'Rejected', 'Denied' => '#FF3B30',\n                 default => '#333'\n             };\n \n             $html .= '<tr>\n"
                },
                {
                    "date": 1764432565805,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -229,9 +229,9 @@\n         foreach ($requests as $r) {\n             $color = match($r['status']) {\n                 'Completed', 'Approved' => '#2C6E49',\n                 'Pending', 'To be review' => '#2C6E49',\n-                'Rejected', 'Denied' => '#FF3B30',\n+                'Rejected', 'Denied' => '#2C6E49',\n                 default => '#333'\n             };\n \n             $html .= '<tr>\n"
                },
                {
                    "date": 1764432575120,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,303 @@\n+<?php\n+\n+namespace App\\Http\\Controllers;\n+\n+use Illuminate\\Http\\Request;\n+use App\\Models\\ReportRequest;\n+use Illuminate\\Support\\Facades\\DB;\n+use Response;\n+use PhpOffice\\PhpSpreadsheet\\Spreadsheet;\n+use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n+use Barryvdh\\DomPDF\\Facade\\Pdf;\n+\n+class ReportRequestController extends Controller\n+{\n+    public function index()\n+    {\n+        $requests = ReportRequest::all();\n+\n+        // Stats\n+        $total = $requests->count();\n+        $approved = $requests->where('status', 'Approved')->count();\n+        $pending = $requests->where('status', 'Pending')->count();\n+        $denied = $requests->where('status', 'Denied')->count();\n+        $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n+\n+        return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n+    }\n+    public function requestStats()\n+    {\n+        // Base query for grant requests only\n+        $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n+\n+        $total = (clone $baseQuery)->count();\n+\n+        $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n+        $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n+        $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n+        $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n+        $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n+\n+        // Completed = Released\n+        $completed = $released;\n+\n+        $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+\n+        return response()->json([\n+            'total' => $total,\n+            'approved' => $approved,\n+            'pending' => $pending,\n+            'toBeReview' => $toBeReview,\n+            'rejected' => $rejected,\n+            'released' => $released,\n+            'completed' => $completed,\n+            'approvalRate' => $approvalRate\n+        ]);\n+    }\n+\n+    public function requestChartData(Request $request)\n+    {\n+        $year = $request->year ?? now()->year;\n+\n+        // Filter only grant_request\n+        $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n+            ->whereYear('created_at', $year);\n+\n+        // Group by month using new statuses\n+        $monthly = $query->selectRaw(\"\n+            MONTH(created_at) as month,\n+            SUM(CASE WHEN status_id = 5 THEN 1 ELSE 0 END) as completed,\n+            SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n+        \")\n+        ->groupBy('month')\n+        ->orderBy('month')\n+        ->get();\n+\n+        // Convert months for the chart\n+        $formatted = [];\n+\n+        $months = [\n+            1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n+            5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n+            9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n+        ];\n+\n+        foreach ($months as $num => $name) {\n+            $row = $monthly->firstWhere('month', $num);\n+\n+            $formatted[] = [\n+                'month'     => $name,\n+                'completed' => $row->completed ?? 0,\n+                'rejected'  => $row->rejected ?? 0,\n+            ];\n+        }\n+\n+        return response()->json($formatted);\n+    }\n+        // --------------------------\n+        // CSV Export\n+        // --------------------------\n+    public function exportCsv()\n+    {\n+        $requests = $this->recentGrantRequests() ?? [];\n+        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n+        $headers = [\n+            'Content-Type' => 'text/csv',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+        ];\n+\n+        $callback = function() use ($requests) {\n+            $file = fopen('php://output', 'w');\n+\n+            fputcsv($file, ['SwisaAGAP Requests Report']);\n+            fputcsv($file, []);\n+\n+            fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n+\n+            foreach($requests as $r) {\n+                fputcsv($file, [\n+                    $r['request_id'],\n+                    $r['grant_title'],\n+                    $r['requester'],\n+                    $r['date'],\n+                    $r['status'],\n+                ]);\n+            }\n+\n+            fputcsv($file, []);\n+            fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n+            fclose($file);\n+        };\n+\n+        return Response::stream($callback, 200, $headers);\n+    }\n+\n+\n+    // --------------------------\n+    // Excel Export\n+    // --------------------------\n+    public function exportExcel()\n+    {\n+        $requests = $this->recentGrantRequests() ?? [];\n+        $spreadsheet = new Spreadsheet();\n+        $sheet = $spreadsheet->getActiveSheet();\n+        $row = 1;\n+\n+        // Title\n+        $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n+        $row++; // blank row\n+\n+        // Table header\n+        $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n+\n+        // Rows\n+        foreach($requests as $r) {\n+            $sheet->fromArray([\n+                $r['request_id'],\n+                $r['grant_title'],\n+                $r['requester'],\n+                $r['date'],\n+                $r['status'],\n+            ], null, 'A'.$row++);\n+        }\n+\n+        $row++; // blank row\n+        $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n+\n+        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n+        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n+        header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n+        header('Cache-Control: max-age=0');\n+\n+        $writer = new Xlsx($spreadsheet);\n+        $writer->save('php://output');\n+        exit;\n+    }\n+\n+\n+    // --------------------------\n+    // PDF Export\n+    // --------------------------\n+    public function exportPdf()\n+    {\n+        $requests = $this->recentGrantRequests() ?? [];\n+\n+        $logoPath = public_path('images/swisa-agap5.png');\n+\n+        // --- HTML ---\n+        $html = '\n+        <html>\n+        <head>\n+            <meta charset=\"utf-8\">\n+            <title>SwisaAGAP Requests Report</title>\n+            <style>\n+                body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n+                .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n+                .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n+                .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n+                .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n+                .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n+                .modern-table tr:nth-child(even) { background:#f9f9f9; }\n+                .modern-table tr:nth-child(odd) { background:#ffffff; }\n+                .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n+            </style>\n+        </head>\n+        <body>\n+            <div style=\"text-align:center; margin-bottom:10px;\">\n+                <img src=\"' . $logoPath . '\" width=\"120\">\n+            </div>\n+\n+            <div style=\"margin-bottom:20px; text-align:start;\">\n+                <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n+                <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n+            </div>\n+\n+            <div class=\"section\">\n+                <h3 class=\"modern-header\">Recent Grant Requests</h3>\n+                <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n+                    <thead>\n+                        <tr>\n+                            <th>Request ID</th>\n+                            <th>Item</th>\n+                            <th>Requester</th>\n+                            <th>Date</th>\n+                            <th>Status</th>\n+                        </tr>\n+                    </thead>\n+                    <tbody>';\n+        \n+        foreach ($requests as $r) {\n+            $color = match($r['status']) {\n+                'Completed', 'Approved' => '#2C6E49',\n+                'Pending', 'To be review' => '#2C6E49',\n+                'Rejected', 'Denied' => '#FF3B30',\n+                default => '#333'\n+            };\n+\n+            $html .= '<tr>\n+                <td>' . $r['request_id'] . '</td>\n+                <td>' . $r['grant_title'] . '</td>\n+                <td>' . $r['requester'] . '</td>\n+                <td>' . $r['date'] . '</td>\n+                <td style=\"font-weight:bold; color:' . $color . ';\">' . $r['status'] . '</td>\n+            </tr>';\n+        }\n+\n+        $html .= '\n+                    </tbody>\n+                </table>\n+            </div>\n+\n+            <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n+        </body>\n+        </html>';\n+\n+        $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n+        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n+    }\n+\n+\n+\n+    public function recentGrantRequests()\n+    {\n+        $requests = \\DB::table('applications as a')\n+            ->join('grants as g', 'a.grant_id', '=', 'g.id')\n+            ->join('users as u', 'a.user_id', '=', 'u.id')\n+            ->where('a.application_type', 'grant_request')\n+            ->select(\n+                \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n+                'g.title as grant_title', // <-- use title instead of item\n+                \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n+                'a.updated_at as date',\n+                'a.status_id'\n+            )\n+            ->orderBy('a.updated_at', 'desc')\n+            ->limit(1000)\n+            ->get()\n+            ->map(function ($r) {\n+\n+                $status = (int) $r->status_id;\n+\n+                $statusText = match($status) {\n+                    7 => 'To be review',\n+                    6 => 'Rejected',\n+                    5 => 'Completed',   // Released treated as Completed\n+                    4 => 'Approved',\n+                    3 => 'Pending',\n+                    default => 'Unknown',\n+                };\n+\n+                return [\n+                    'request_id' => $r->request_id,\n+                    'grant_title' => $r->grant_title, // updated key\n+                    'requester' => $r->requester,\n+                    'date' => date('Y-m-d', strtotime($r->date)),\n+                    'status' => $statusText,\n+                ];\n+            });\n+\n+        return $requests;\n+    }\n+\n+\n+}\n"
                },
                {
                    "date": 1764432604250,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,339 @@\n+<?php\n+\n+namespace App\\Http\\Controllers;\n+\n+use Illuminate\\Http\\Request;\n+use App\\Models\\ReportRequest;\n+use Illuminate\\Support\\Facades\\DB;\n+use Response;\n+use PhpOffice\\PhpSpreadsheet\\Spreadsheet;\n+use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n+use Barryvdh\\DomPDF\\Facade\\Pdf;\n+\n+class ReportRequestController extends Controller\n+{\n+    public function index()\n+    {\n+        $requests = ReportRequest::all();\n+\n+        // Stats\n+        $total = $requests->count();\n+        $approved = $requests->where('status', 'Approved')->count();\n+        $pending = $requests->where('status', 'Pending')->count();\n+        $denied = $requests->where('status', 'Denied')->count();\n+        $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n+\n+        return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n+    }\n+    public function requestStats()\n+    {\n+        // Base query for grant requests only\n+        $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n+\n+        $total = (clone $baseQuery)->count();\n+\n+        $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n+        $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n+        $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n+        $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n+        $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n+\n+        // Completed = Released\n+        $completed = $released;\n+\n+        $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+\n+        return response()->json([\n+            'total' => $total,\n+            'approved' => $approved,\n+            'pending' => $pending,\n+            'toBeReview' => $toBeReview,\n+            'rejected' => $rejected,\n+            'released' => $released,\n+            'completed' => $completed,\n+            'approvalRate' => $approvalRate\n+        ]);\n+    }\n+\n+    public function requestChartData(Request $request)\n+    {\n+        $year = $request->year ?? now()->year;\n+\n+        // Filter only grant_request\n+        $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n+            ->whereYear('created_at', $year);\n+\n+        // Group by month using new statuses\n+        $monthly = $query->selectRaw(\"\n+            MONTH(created_at) as month,\n+            SUM(CASE WHEN status_id = 5 THEN 1 ELSE 0 END) as completed,\n+            SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n+        \")\n+        ->groupBy('month')\n+        ->orderBy('month')\n+        ->get();\n+\n+        // Convert months for the chart\n+        $formatted = [];\n+\n+        $months = [\n+            1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n+            5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n+            9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n+        ];\n+\n+        foreach ($months as $num => $name) {\n+            $row = $monthly->firstWhere('month', $num);\n+\n+            $formatted[] = [\n+                'month'     => $name,\n+                'completed' => $row->completed ?? 0,\n+                'rejected'  => $row->rejected ?? 0,\n+            ];\n+        }\n+\n+        return response()->json($formatted);\n+    }\n+        // --------------------------\n+        // CSV Export\n+        // --------------------------\n+    public function exportCsv()\n+    {\n+        $requests = $this->recentGrantRequests() ?? [];\n+        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n+        $headers = [\n+            'Content-Type' => 'text/csv',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+        ];\n+\n+        $callback = function() use ($requests) {\n+            $file = fopen('php://output', 'w');\n+\n+            fputcsv($file, ['SwisaAGAP Requests Report']);\n+            fputcsv($file, []);\n+\n+            fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n+\n+            foreach($requests as $r) {\n+                fputcsv($file, [\n+                    $r['request_id'],\n+                    $r['grant_title'],\n+                    $r['requester'],\n+                    $r['date'],\n+                    $r['status'],\n+                ]);\n+            }\n+\n+            fputcsv($file, []);\n+            fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n+            fclose($file);\n+        };\n+\n+        return Response::stream($callback, 200, $headers);\n+    }\n+\n+\n+    // --------------------------\n+    // Excel Export\n+    // --------------------------\n+    public function exportExcel()\n+    {\n+        $requests = $this->recentGrantRequests() ?? [];\n+        $spreadsheet = new Spreadsheet();\n+        $sheet = $spreadsheet->getActiveSheet();\n+        $row = 1;\n+\n+        // Title\n+        $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n+        $row++; // blank row\n+\n+        // Table header\n+        $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n+\n+        // Rows\n+        foreach($requests as $r) {\n+            $sheet->fromArray([\n+                $r['request_id'],\n+                $r['grant_title'],\n+                $r['requester'],\n+                $r['date'],\n+                $r['status'],\n+            ], null, 'A'.$row++);\n+        }\n+\n+        $row++; // blank row\n+        $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n+\n+        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n+        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n+        header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n+        header('Cache-Control: max-age=0');\n+\n+        $writer = new Xlsx($spreadsheet);\n+        $writer->save('php://output');\n+        exit;\n+    }\n+\n+\n+    // --------------------------\n+    // PDF Export\n+    // --------------------------\n+public function exportPdf()\n+{\n+    $requests = $this->recentGrantRequests() ?? collect(); // ensure it's a collection\n+\n+    $logoPath = public_path('images/swisa-agap5.png');\n+\n+    // --- HTML ---\n+    $html = '\n+    <html>\n+    <head>\n+        <meta charset=\"utf-8\">\n+        <title>SwisaAGAP Requests Report</title>\n+        <style>\n+            body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n+            .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n+            .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n+            .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n+            .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n+            .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n+            .modern-table tr:nth-child(even) { background:#f9f9f9; }\n+            .modern-table tr:nth-child(odd) { background:#ffffff; }\n+            .status-green { color:#2C6E49; font-weight:bold; }\n+            .status-yellow { color:#FFC107; font-weight:bold; }\n+            .status-red { color:#FF3B30; font-weight:bold; }\n+            .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n+        </style>\n+    </head>\n+    <body>\n+        <div style=\"text-align:center; margin-bottom:10px;\">\n+            <img src=\"' . $logoPath . '\" width=\"120\">\n+        </div>\n+\n+        <div style=\"margin-bottom:20px; text-align:start;\">\n+            <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n+            <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n+        </div>\n+\n+        <!-- STATS CARDS -->\n+        <table style=\"width:100%; border-collapse:collapse; margin-bottom:20px;\">\n+            <tr>';\n+\n+    // Calculate stats using Collection methods\n+    $total = $requests->count();\n+    $approved = $requests->filter(fn($r) => $r['status'] === 'Approved' || $r['status'] === 'Completed')->count();\n+    $pending = $requests->filter(fn($r) => $r['status'] === 'Pending' || $r['status'] === 'To be review')->count();\n+    $completed = $approved;\n+    $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n+\n+    $stats = [\n+        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#22c55e'], // green\n+        ['label' => 'Total Requests', 'value' => $total, 'color' => '#16a34a'], // dark green\n+        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2563eb'], // blue\n+        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#facc15'], // yellow\n+    ];\n+\n+    foreach ($stats as $s) {\n+        $html .= '\n+        <td class=\"card\" style=\"border-top:4px solid ' . $s['color'] . ';\">\n+            <h3>' . $s['label'] . '</h3>\n+            <p>' . $s['value'] . '</p>\n+        </td>';\n+    }\n+\n+    $html .= '\n+            </tr>\n+        </table>\n+\n+        <!-- REQUESTS TABLE -->\n+        <div class=\"section\">\n+            <h3 class=\"modern-header\">Recent Grant Requests</h3>\n+            <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n+                <thead>\n+                    <tr>\n+                        <th>Request ID</th>\n+                        <th>Item</th>\n+                        <th>Requester</th>\n+                        <th>Date</th>\n+                        <th>Status</th>\n+                    </tr>\n+                </thead>\n+                <tbody>';\n+\n+    foreach ($requests as $r) {\n+        $statusClass = match($r['status']) {\n+            'Approved', 'Completed' => 'status-green',\n+            'Pending', 'To be review' => 'status-yellow',\n+            'Rejected', 'Denied' => 'status-red',\n+            default => ''\n+        };\n+\n+        $html .= '\n+        <tr>\n+            <td>' . $r['request_id'] . '</td>\n+            <td>' . $r['grant_title'] . '</td>\n+            <td>' . $r['requester'] . '</td>\n+            <td>' . $r['date'] . '</td>\n+            <td class=\"' . $statusClass . '\">' . $r['status'] . '</td>\n+        </tr>';\n+    }\n+\n+    $html .= '\n+                </tbody>\n+            </table>\n+        </div>\n+\n+        <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n+    </body>\n+    </html>';\n+\n+    $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n+    return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n+}\n+\n+\n+\n+\n+    public function recentGrantRequests()\n+    {\n+        $requests = \\DB::table('applications as a')\n+            ->join('grants as g', 'a.grant_id', '=', 'g.id')\n+            ->join('users as u', 'a.user_id', '=', 'u.id')\n+            ->where('a.application_type', 'grant_request')\n+            ->select(\n+                \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n+                'g.title as grant_title', // <-- use title instead of item\n+                \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n+                'a.updated_at as date',\n+                'a.status_id'\n+            )\n+            ->orderBy('a.updated_at', 'desc')\n+            ->limit(1000)\n+            ->get()\n+            ->map(function ($r) {\n+\n+                $status = (int) $r->status_id;\n+\n+                $statusText = match($status) {\n+                    7 => 'To be review',\n+                    6 => 'Rejected',\n+                    5 => 'Completed',   // Released treated as Completed\n+                    4 => 'Approved',\n+                    3 => 'Pending',\n+                    default => 'Unknown',\n+                };\n+\n+                return [\n+                    'request_id' => $r->request_id,\n+                    'grant_title' => $r->grant_title, // updated key\n+                    'requester' => $r->requester,\n+                    'date' => date('Y-m-d', strtotime($r->date)),\n+                    'status' => $statusText,\n+                ];\n+            });\n+\n+        return $requests;\n+    }\n+\n+\n+}\n"
                },
                {
                    "date": 1764432653789,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -226,12 +226,12 @@\n     $completed = $approved;\n     $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n \n     $stats = [\n-        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#22c55e'], // green\n-        ['label' => 'Total Requests', 'value' => $total, 'color' => '#16a34a'], // dark green\n-        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2563eb'], // blue\n-        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#facc15'], // yellow\n+        ['label' => 'Completed Requests', 'value' => $completed, 'color' => '#2C6E49'], // green\n+        ['label' => 'Total Requests', 'value' => $total, 'color' => '#2C6E49'], // dark green\n+        ['label' => 'Approved Requests', 'value' => $approved, 'color' => '#2C6E49'], // blue\n+        ['label' => 'Pending Requests', 'value' => $pending, 'color' => '#2C6E49'], // yellow\n     ];\n \n     foreach ($stats as $s) {\n         $html .= '\n@@ -336,610 +336,4 @@\n     }\n \n \n }\n-<?php\n-\n-namespace App\\Http\\Controllers;\n-\n-use Illuminate\\Http\\Request;\n-use App\\Models\\ReportRequest;\n-use Illuminate\\Support\\Facades\\DB;\n-use Response;\n-use PhpOffice\\PhpSpreadsheet\\Spreadsheet;\n-use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n-use Barryvdh\\DomPDF\\Facade\\Pdf;\n-\n-class ReportRequestController extends Controller\n-{\n-    public function index()\n-    {\n-        $requests = ReportRequest::all();\n-\n-        // Stats\n-        $total = $requests->count();\n-        $approved = $requests->where('status', 'Approved')->count();\n-        $pending = $requests->where('status', 'Pending')->count();\n-        $denied = $requests->where('status', 'Denied')->count();\n-        $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n-\n-        return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n-    }\n-    public function requestStats()\n-    {\n-        // Base query for grant requests only\n-        $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n-\n-        $total = (clone $baseQuery)->count();\n-\n-        $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n-        $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n-        $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n-        $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n-        $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n-\n-        // Completed = Released\n-        $completed = $released;\n-\n-        $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n-\n-        return response()->json([\n-            'total' => $total,\n-            'approved' => $approved,\n-            'pending' => $pending,\n-            'toBeReview' => $toBeReview,\n-            'rejected' => $rejected,\n-            'released' => $released,\n-            'completed' => $completed,\n-            'approvalRate' => $approvalRate\n-        ]);\n-    }\n-\n-    public function requestChartData(Request $request)\n-    {\n-        $year = $request->year ?? now()->year;\n-\n-        // Filter only grant_request\n-        $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n-            ->whereYear('created_at', $year);\n-\n-        // Group by month using new statuses\n-        $monthly = $query->selectRaw(\"\n-            MONTH(created_at) as month,\n-            SUM(CASE WHEN status_id = 5 THEN 1 ELSE 0 END) as completed,\n-            SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n-        \")\n-        ->groupBy('month')\n-        ->orderBy('month')\n-        ->get();\n-\n-        // Convert months for the chart\n-        $formatted = [];\n-\n-        $months = [\n-            1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n-            5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n-            9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n-        ];\n-\n-        foreach ($months as $num => $name) {\n-            $row = $monthly->firstWhere('month', $num);\n-\n-            $formatted[] = [\n-                'month'     => $name,\n-                'completed' => $row->completed ?? 0,\n-                'rejected'  => $row->rejected ?? 0,\n-            ];\n-        }\n-\n-        return response()->json($formatted);\n-    }\n-        // --------------------------\n-        // CSV Export\n-        // --------------------------\n-    public function exportCsv()\n-    {\n-        $requests = $this->recentGrantRequests() ?? [];\n-        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n-        $headers = [\n-            'Content-Type' => 'text/csv',\n-            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-        ];\n-\n-        $callback = function() use ($requests) {\n-            $file = fopen('php://output', 'w');\n-\n-            fputcsv($file, ['SwisaAGAP Requests Report']);\n-            fputcsv($file, []);\n-\n-            fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n-\n-            foreach($requests as $r) {\n-                fputcsv($file, [\n-                    $r['request_id'],\n-                    $r['grant_title'],\n-                    $r['requester'],\n-                    $r['date'],\n-                    $r['status'],\n-                ]);\n-            }\n-\n-            fputcsv($file, []);\n-            fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n-            fclose($file);\n-        };\n-\n-        return Response::stream($callback, 200, $headers);\n-    }\n-\n-\n-    // --------------------------\n-    // Excel Export\n-    // --------------------------\n-    public function exportExcel()\n-    {\n-        $requests = $this->recentGrantRequests() ?? [];\n-        $spreadsheet = new Spreadsheet();\n-        $sheet = $spreadsheet->getActiveSheet();\n-        $row = 1;\n-\n-        // Title\n-        $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n-        $row++; // blank row\n-\n-        // Table header\n-        $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n-\n-        // Rows\n-        foreach($requests as $r) {\n-            $sheet->fromArray([\n-                $r['request_id'],\n-                $r['grant_title'],\n-                $r['requester'],\n-                $r['date'],\n-                $r['status'],\n-            ], null, 'A'.$row++);\n-        }\n-\n-        $row++; // blank row\n-        $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n-\n-        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n-        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n-        header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n-        header('Cache-Control: max-age=0');\n-\n-        $writer = new Xlsx($spreadsheet);\n-        $writer->save('php://output');\n-        exit;\n-    }\n-\n-\n-    // --------------------------\n-    // PDF Export\n-    // --------------------------\n-    public function exportPdf()\n-    {\n-        $requests = $this->recentGrantRequests() ?? [];\n-\n-        $logoPath = public_path('images/swisa-agap5.png');\n-\n-        // --- HTML ---\n-        $html = '\n-        <html>\n-        <head>\n-            <meta charset=\"utf-8\">\n-            <title>SwisaAGAP Requests Report</title>\n-            <style>\n-                body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n-                .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n-                .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n-                .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n-                .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n-                .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n-                .modern-table tr:nth-child(even) { background:#f9f9f9; }\n-                .modern-table tr:nth-child(odd) { background:#ffffff; }\n-                .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n-            </style>\n-        </head>\n-        <body>\n-            <div style=\"text-align:center; margin-bottom:10px;\">\n-                <img src=\"' . $logoPath . '\" width=\"120\">\n-            </div>\n-\n-            <div style=\"margin-bottom:20px; text-align:start;\">\n-                <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n-                <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n-            </div>\n-\n-            <div class=\"section\">\n-                <h3 class=\"modern-header\">Recent Grant Requests</h3>\n-                <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n-                    <thead>\n-                        <tr>\n-                            <th>Request ID</th>\n-                            <th>Item</th>\n-                            <th>Requester</th>\n-                            <th>Date</th>\n-                            <th>Status</th>\n-                        </tr>\n-                    </thead>\n-                    <tbody>';\n-        \n-        foreach ($requests as $r) {\n-            $color = match($r['status']) {\n-                'Completed', 'Approved' => '#2C6E49',\n-                'Pending', 'To be review' => '#2C6E49',\n-                'Rejected', 'Denied' => '#FF3B30',\n-                default => '#333'\n-            };\n-\n-            $html .= '<tr>\n-                <td>' . $r['request_id'] . '</td>\n-                <td>' . $r['grant_title'] . '</td>\n-                <td>' . $r['requester'] . '</td>\n-                <td>' . $r['date'] . '</td>\n-                <td style=\"font-weight:bold; color:' . $color . ';\">' . $r['status'] . '</td>\n-            </tr>';\n-        }\n-\n-        $html .= '\n-                    </tbody>\n-                </table>\n-            </div>\n-\n-            <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n-        </body>\n-        </html>';\n-\n-        $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n-        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n-    }\n-\n-\n-\n-    public function recentGrantRequests()\n-    {\n-        $requests = \\DB::table('applications as a')\n-            ->join('grants as g', 'a.grant_id', '=', 'g.id')\n-            ->join('users as u', 'a.user_id', '=', 'u.id')\n-            ->where('a.application_type', 'grant_request')\n-            ->select(\n-                \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n-                'g.title as grant_title', // <-- use title instead of item\n-                \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n-                'a.updated_at as date',\n-                'a.status_id'\n-            )\n-            ->orderBy('a.updated_at', 'desc')\n-            ->limit(1000)\n-            ->get()\n-            ->map(function ($r) {\n-\n-                $status = (int) $r->status_id;\n-\n-                $statusText = match($status) {\n-                    7 => 'To be review',\n-                    6 => 'Rejected',\n-                    5 => 'Completed',   // Released treated as Completed\n-                    4 => 'Approved',\n-                    3 => 'Pending',\n-                    default => 'Unknown',\n-                };\n-\n-                return [\n-                    'request_id' => $r->request_id,\n-                    'grant_title' => $r->grant_title, // updated key\n-                    'requester' => $r->requester,\n-                    'date' => date('Y-m-d', strtotime($r->date)),\n-                    'status' => $statusText,\n-                ];\n-            });\n-\n-        return $requests;\n-    }\n-\n-\n-}\n-<?php\n-\n-namespace App\\Http\\Controllers;\n-\n-use Illuminate\\Http\\Request;\n-use App\\Models\\ReportRequest;\n-use Illuminate\\Support\\Facades\\DB;\n-use Response;\n-use PhpOffice\\PhpSpreadsheet\\Spreadsheet;\n-use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n-use Barryvdh\\DomPDF\\Facade\\Pdf;\n-\n-class ReportRequestController extends Controller\n-{\n-    public function index()\n-    {\n-        $requests = ReportRequest::all();\n-\n-        // Stats\n-        $total = $requests->count();\n-        $approved = $requests->where('status', 'Approved')->count();\n-        $pending = $requests->where('status', 'Pending')->count();\n-        $denied = $requests->where('status', 'Denied')->count();\n-        $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n-\n-        return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n-    }\n-    public function requestStats()\n-    {\n-        // Base query for grant requests only\n-        $baseQuery = \\App\\Models\\Application::where('application_type', 'grant_request');\n-\n-        $total = (clone $baseQuery)->count();\n-\n-        $approved = (clone $baseQuery)->where('status_id', 4)->count();    // Approved\n-        $pending = (clone $baseQuery)->where('status_id', 3)->count();     // Pending\n-        $toBeReview = (clone $baseQuery)->where('status_id', 7)->count();  // To be review\n-        $rejected = (clone $baseQuery)->where('status_id', 6)->count();    // Rejected\n-        $released = (clone $baseQuery)->where('status_id', 5)->count();    // Released\n-\n-        // Completed = Released\n-        $completed = $released;\n-\n-        $approvalRate = $total ? round(($approved / $total) * 100, 2) : 0;\n-\n-        return response()->json([\n-            'total' => $total,\n-            'approved' => $approved,\n-            'pending' => $pending,\n-            'toBeReview' => $toBeReview,\n-            'rejected' => $rejected,\n-            'released' => $released,\n-            'completed' => $completed,\n-            'approvalRate' => $approvalRate\n-        ]);\n-    }\n-\n-    public function requestChartData(Request $request)\n-    {\n-        $year = $request->year ?? now()->year;\n-\n-        // Filter only grant_request\n-        $query = \\App\\Models\\Application::where('application_type', 'grant_request')\n-            ->whereYear('created_at', $year);\n-\n-        // Group by month using new statuses\n-        $monthly = $query->selectRaw(\"\n-            MONTH(created_at) as month,\n-            SUM(CASE WHEN status_id = 5 THEN 1 ELSE 0 END) as completed,\n-            SUM(CASE WHEN status_id = 6 THEN 1 ELSE 0 END) as rejected\n-        \")\n-        ->groupBy('month')\n-        ->orderBy('month')\n-        ->get();\n-\n-        // Convert months for the chart\n-        $formatted = [];\n-\n-        $months = [\n-            1 => \"Jan\", 2 => \"Feb\", 3 => \"Mar\", 4 => \"Apr\",\n-            5 => \"May\", 6 => \"Jun\", 7 => \"Jul\", 8 => \"Aug\",\n-            9 => \"Sept\", 10 => \"Oct\", 11 => \"Nov\", 12 => \"Dec\",\n-        ];\n-\n-        foreach ($months as $num => $name) {\n-            $row = $monthly->firstWhere('month', $num);\n-\n-            $formatted[] = [\n-                'month'     => $name,\n-                'completed' => $row->completed ?? 0,\n-                'rejected'  => $row->rejected ?? 0,\n-            ];\n-        }\n-\n-        return response()->json($formatted);\n-    }\n-        // --------------------------\n-        // CSV Export\n-        // --------------------------\n-    public function exportCsv()\n-    {\n-        $requests = $this->recentGrantRequests() ?? [];\n-        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n-        $headers = [\n-            'Content-Type' => 'text/csv',\n-            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-        ];\n-\n-        $callback = function() use ($requests) {\n-            $file = fopen('php://output', 'w');\n-\n-            fputcsv($file, ['SwisaAGAP Requests Report']);\n-            fputcsv($file, []);\n-\n-            fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n-\n-            foreach($requests as $r) {\n-                fputcsv($file, [\n-                    $r['request_id'],\n-                    $r['grant_title'],\n-                    $r['requester'],\n-                    $r['date'],\n-                    $r['status'],\n-                ]);\n-            }\n-\n-            fputcsv($file, []);\n-            fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n-            fclose($file);\n-        };\n-\n-        return Response::stream($callback, 200, $headers);\n-    }\n-\n-\n-    // --------------------------\n-    // Excel Export\n-    // --------------------------\n-    public function exportExcel()\n-    {\n-        $requests = $this->recentGrantRequests() ?? [];\n-        $spreadsheet = new Spreadsheet();\n-        $sheet = $spreadsheet->getActiveSheet();\n-        $row = 1;\n-\n-        // Title\n-        $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n-        $row++; // blank row\n-\n-        // Table header\n-        $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n-\n-        // Rows\n-        foreach($requests as $r) {\n-            $sheet->fromArray([\n-                $r['request_id'],\n-                $r['grant_title'],\n-                $r['requester'],\n-                $r['date'],\n-                $r['status'],\n-            ], null, 'A'.$row++);\n-        }\n-\n-        $row++; // blank row\n-        $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n-\n-        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n-        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n-        header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n-        header('Cache-Control: max-age=0');\n-\n-        $writer = new Xlsx($spreadsheet);\n-        $writer->save('php://output');\n-        exit;\n-    }\n-\n-\n-    // --------------------------\n-    // PDF Export\n-    // --------------------------\n-    public function exportPdf()\n-    {\n-        $requests = $this->recentGrantRequests() ?? [];\n-\n-        $logoPath = public_path('images/swisa-agap5.png');\n-\n-        // --- HTML ---\n-        $html = '\n-        <html>\n-        <head>\n-            <meta charset=\"utf-8\">\n-            <title>SwisaAGAP Requests Report</title>\n-            <style>\n-                body { font-family: DejaVu Sans, sans-serif; font-size: 10px; margin:0; padding:0; }\n-                .card { background:white; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; }\n-                .card h3 { color:#2C6E49; margin:5px 0; font-size:12px; }\n-                .card p { margin:0; font-weight:bold; font-size:14px; color:#2C6E49; }\n-                .modern-table th { background:#2C6E49; color:white; padding:8px; font-size:11px; text-align:left; }\n-                .modern-table td { padding:7px; font-size:10px; color:#333; border-bottom:1px solid #e5e7eb; }\n-                .modern-table tr:nth-child(even) { background:#f9f9f9; }\n-                .modern-table tr:nth-child(odd) { background:#ffffff; }\n-                .modern-header { margin:20px 0 10px 0; font-weight:bold; color:#2C6E49; font-size:14px; }\n-            </style>\n-        </head>\n-        <body>\n-            <div style=\"text-align:center; margin-bottom:10px;\">\n-                <img src=\"' . $logoPath . '\" width=\"120\">\n-            </div>\n-\n-            <div style=\"margin-bottom:20px; text-align:start;\">\n-                <h2 style=\"color:#2c6e49; margin-bottom:5px;\">Requests Reports</h2>\n-                <p style=\"color:#555; margin-top:-5px;\">Track requests and their approval status</p>\n-            </div>\n-\n-            <div class=\"section\">\n-                <h3 class=\"modern-header\">Recent Grant Requests</h3>\n-                <table class=\"modern-table\" style=\"width:100%; border-collapse:collapse;\">\n-                    <thead>\n-                        <tr>\n-                            <th>Request ID</th>\n-                            <th>Item</th>\n-                            <th>Requester</th>\n-                            <th>Date</th>\n-                            <th>Status</th>\n-                        </tr>\n-                    </thead>\n-                    <tbody>';\n-        \n-        foreach ($requests as $r) {\n-            $color = match($r['status']) {\n-                'Completed', 'Approved' => '#2C6E49',\n-                'Pending', 'To be review' => '#2C6E49',\n-                'Rejected', 'Denied' => '#2C6E49',\n-                default => '#333'\n-            };\n-\n-            $html .= '<tr>\n-                <td>' . $r['request_id'] . '</td>\n-                <td>' . $r['grant_title'] . '</td>\n-                <td>' . $r['requester'] . '</td>\n-                <td>' . $r['date'] . '</td>\n-                <td style=\"font-weight:bold; color:' . $color . ';\">' . $r['status'] . '</td>\n-            </tr>';\n-        }\n-\n-        $html .= '\n-                    </tbody>\n-                </table>\n-            </div>\n-\n-            <p style=\"margin-top:15px;\">Latest as of ' . now()->format('F d, Y') . '</p>\n-        </body>\n-        </html>';\n-\n-        $pdf = Pdf::loadHTML($html)->setPaper('A4', 'landscape');\n-        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n-    }\n-\n-\n-\n-    public function recentGrantRequests()\n-    {\n-        $requests = \\DB::table('applications as a')\n-            ->join('grants as g', 'a.grant_id', '=', 'g.id')\n-            ->join('users as u', 'a.user_id', '=', 'u.id')\n-            ->where('a.application_type', 'grant_request')\n-            ->select(\n-                \\DB::raw(\"CONCAT('REQ-0000', a.id) as request_id\"),\n-                'g.title as grant_title', // <-- use title instead of item\n-                \\DB::raw(\"CONCAT(u.first_name, ' ', u.last_name) as requester\"),\n-                'a.updated_at as date',\n-                'a.status_id'\n-            )\n-            ->orderBy('a.updated_at', 'desc')\n-            ->limit(1000)\n-            ->get()\n-            ->map(function ($r) {\n-\n-                $status = (int) $r->status_id;\n-\n-                $statusText = match($status) {\n-                    7 => 'To be review',\n-                    6 => 'Rejected',\n-                    5 => 'Completed',   // Released treated as Completed\n-                    4 => 'Approved',\n-                    3 => 'Pending',\n-                    default => 'Unknown',\n-                };\n-\n-                return [\n-                    'request_id' => $r->request_id,\n-                    'grant_title' => $r->grant_title, // updated key\n-                    'requester' => $r->requester,\n-                    'date' => date('Y-m-d', strtotime($r->date)),\n-                    'status' => $statusText,\n-                ];\n-            });\n-\n-        return $requests;\n-    }\n-\n-\n-}\n"
                }
            ],
            "date": 1764356558251,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace App\\Http\\Controllers;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\ReportRequest;\nuse Response;\nuse PhpOffice\\PhpSpreadsheet\\Spreadsheet;\nuse PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\nuse Barryvdh\\DomPDF\\Facade\\Pdf;\n\nclass ReportRequestController extends Controller\n{\n    public function index()\n    {\n        $requests = ReportRequest::all();\n\n        // Stats\n        $total = $requests->count();\n        $approved = $requests->where('status', 'Approved')->count();\n        $pending = $requests->where('status', 'Pending')->count();\n        $denied = $requests->where('status', 'Denied')->count();\n        $approvalRate = $total ? round($approved / $total * 100, 2) : 0;\n\n        return view('reports.requests', compact('requests', 'total', 'approved', 'pending', 'denied', 'approvalRate'));\n    }\n\n    // --------------------------\n    // CSV Export\n    // --------------------------\n    public function exportCsv()\n    {\n        $requests = ReportRequest::all();\n        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.csv';\n        $headers = [\n            'Content-Type' => 'text/csv',\n            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n        ];\n\n        $callback = function() use ($requests) {\n            $file = fopen('php://output', 'w');\n\n            fputcsv($file, ['SwisaAGAP Requests Report']);\n            fputcsv($file, []);\n\n            // Table header\n            fputcsv($file, ['Request ID','Item','Requester','Date','Status']);\n\n            foreach($requests as $r) {\n                fputcsv($file, [\n                    $r->request_id,\n                    $r->item,\n                    $r->requester_name,\n                    $r->date_submitted,\n                    $r->status,\n                ]);\n            }\n\n            fputcsv($file, []);\n            fputcsv($file, ['Latest as of ' . now()->format('F d, Y')]);\n\n            fclose($file);\n        };\n\n        return Response::stream($callback, 200, $headers);\n    }\n\n    // --------------------------\n    // Excel Export\n    // --------------------------\n    public function exportExcel()\n    {\n        $requests = ReportRequest::all();\n        $spreadsheet = new Spreadsheet();\n        $sheet = $spreadsheet->getActiveSheet();\n\n        $row = 1;\n        $sheet->setCellValue('A'.$row++, 'SwisaAGAP Requests Report');\n        $row++;\n\n        // Table header\n        $sheet->fromArray([['Request ID','Item','Requester','Date','Status']], null, 'A'.$row++);\n        foreach($requests as $r) {\n            $sheet->fromArray([\n                $r->request_id,\n                $r->item,\n                $r->requester_name,\n                $r->date_submitted,\n                $r->status,\n            ], null, 'A'.$row++);\n        }\n\n        $row++;\n        $sheet->setCellValue('A'.$row, 'Latest as of '.now()->format('F d, Y'));\n\n        $filename = 'swisa_requests_report_' . now()->format('Ymd_His') . '.xlsx';\n        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n        header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n        header('Cache-Control: max-age=0');\n\n        $writer = new Xlsx($spreadsheet);\n        $writer->save('php://output');\n        exit;\n    }\n\n    // --------------------------\n    // PDF Export\n    // --------------------------\n    public function exportPdf()\n    {\n        $requests = ReportRequest::all();\n        $pdf = Pdf::loadView('reports.requests-pdf', compact('requests'));\n        return $pdf->download('swisa_requests_report_' . now()->format('Ymd_His') . '.pdf');\n    }\n}\n"
        }
    ]
}
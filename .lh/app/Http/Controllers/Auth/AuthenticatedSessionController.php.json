{
    "sourceFile": "app/Http/Controllers/Auth/AuthenticatedSessionController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1764681727334,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764681736827,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,9 +81,8 @@\n     {\n         if (auth()->check()) {\n             $user = auth()->user();\n \n-            // ðŸ“ Role mapping again for logout\n             $roleMap = [\n                 'admin'          => 'Administrator',\n                 'member'         => 'SWISA Member',\n                 'officer'        => 'System Officer',\n"
                }
            ],
            "date": 1764681727334,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace App\\Http\\Controllers\\Auth;\n\nuse App\\Http\\Controllers\\Controller;\nuse App\\Http\\Requests\\Auth\\LoginRequest;\nuse Illuminate\\Http\\RedirectResponse;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Illuminate\\Validation\\ValidationException;\nuse Illuminate\\View\\View;\nuse App\\Models\\Log;\n\nclass AuthenticatedSessionController extends Controller\n{\n    /**\n     * Display the login view.\n     */\n    public function create(): View\n    {\n        return view('auth.login');\n    }\n\n    /**\n     * Handle an incoming authentication request.\n     */\n    public function store(LoginRequest $request): RedirectResponse\n    {\n        try {\n            // Attempt to authenticate\n            $request->authenticate();\n\n            // Regenerate session to prevent fixation attacks\n            $request->session()->regenerate();\n\n            $user = auth()->user();\n\n            $roleMap = [\n                'admin'          => 'Administrator',\n                'member'         => 'SWISA Member',\n                'support_staff'  => 'Support Staff',\n            ];\n\n            $rawRole = is_object($user->role) ? $user->role->role_name : $user->role;\n            $displayRole = $roleMap[$rawRole] ?? ucfirst($rawRole ?? 'Member');\n\n            Log::create([\n                'user_id'   => $user->id,\n                'user_name' => trim($user->first_name . ' ' . $user->last_name) ?: $user->email,\n                'role'      => $displayRole,\n                'activity'  => 'Logged In',\n                'ip_address'=> $request->ip(),\n                'status'    => 'success',\n                'activity_timestamp' => now(),\n                'details'   => null,\n            ]);\n\n            return redirect()->intended(route('dashboard'));\n\n        } catch (ValidationException $e) {\n            // âœ… Log failed login attempt (user not authenticated yet)\n            Log::create([\n                'user_id'   => null,\n                'user_name' => $request->email ?? 'Unknown',\n                'role'      => null,\n                'activity'  => 'Login Attempt',\n                'ip_address'=> $request->ip(),\n                'status'    => 'failed',\n                'activity_timestamp' => now(),\n                'details'   => ['error' => 'Invalid credentials'],\n            ]);\n\n            throw $e; // continue with Laravel's normal validation error handling\n        }\n    }\n\n    /**\n     * Destroy an authenticated session.\n     */\n    public function destroy(Request $request): RedirectResponse\n    {\n        if (auth()->check()) {\n            $user = auth()->user();\n\n            // ðŸ“ Role mapping again for logout\n            $roleMap = [\n                'admin'          => 'Administrator',\n                'member'         => 'SWISA Member',\n                'officer'        => 'System Officer',\n                'support_staff'  => 'Support Staff',\n            ];\n\n            $rawRole = is_object($user->role) ? $user->role->role_name : $user->role;\n            $displayRole = $roleMap[$rawRole] ?? ucfirst($rawRole ?? 'Member');\n\n            Log::create([\n                'user_id'   => $user->id,\n                'user_name' => trim($user->first_name . ' ' . $user->last_name) ?: $user->email,\n                'role'      => $displayRole,\n                'activity'  => 'Logged Out',\n                'ip_address'=> $request->ip(),\n                'status'    => 'success',\n                'activity_timestamp' => now(),\n                'details'   => null,\n            ]);\n        }\n\n        Auth::guard('web')->logout();\n        $request->session()->invalidate();\n        $request->session()->regenerateToken();\n\n        return redirect('/');\n    }\n}\n"
        }
    ]
}
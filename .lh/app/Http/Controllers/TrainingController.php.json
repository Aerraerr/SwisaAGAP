{
    "sourceFile": "app/Http/Controllers/TrainingController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763818752561,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763818752561,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace App\\Http\\Controllers\\Web;\n\nuse App\\Http\\Controllers\\Controller;\nuse App\\Models\\Participant;\nuse App\\Models\\Sector;\nuse App\\Models\\Training;\nuse App\\Models\\User;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Facades\\Log;\nuse Illuminate\\Support\\Facades\\Auth;\nuse App\\Services\\SMSService;\n\nclass TrainingController extends Controller\n{\n    //show member with documents (if any)\n    public function showTrainings(){\n        return Training::with('documents', 'sector')->get();\n    }\n\n    public function showSectors(){\n        return Sector::all();\n    }\n\n    //pass the 'members' variable to the members page for data display\n    public function displayTraining(){\n        $trainings = $this->showTrainings();\n        $sectors = $this->showSectors();\n        $upcomingEvents = Training::whereDate('date', '>=', now())->count();\n        $completedEvents = Training::whereDate('date', '<', now())->count();\n\n        return view('swisa-admin.training-workshop', compact('trainings', 'sectors', 'upcomingEvents', 'completedEvents'));\n    }\n\n    //add event function\n    public function addTraining(Request $request){\n        try{\n            // validate the form data/input\n            $request->validate([\n                'event_name' => 'required|string|max:255',\n                'sector' => 'required|exists:sectors,id',\n                'description' => 'nullable|string',\n                'venue' => 'required|string|max:255',\n                'date' => 'required|date',\n                'time' => 'required|date_format:H:i',\n                'event_image' => 'nullable|image|mimes:jpeg,png,jpg|max:5760',\n            ]);\n\n            //store to table 'training'\n            $event = Training::create([\n                'title' => $request->event_name,\n                'sector_id' => $request->sector,\n                'description'   => $request->description,\n                'venue' => $request->venue,\n                'date' => $request->date,\n                'time' => $request->time,\n            ]);\n\n            //handle the file upload\n            if ($request->hasFile('event_image')) {\n                $file = $request->file('event_image');\n                $path = $file->store('events', 'public'); // saves in storage/app/public/events\n\n                $event->documents()->create([\n                    'file_path'  => $path,\n                    'file_name'  => $file->getClientOriginalName(), //gets the file name (e.g. docs.jpg)\n                ]);\n            }\n\n            //send sms test\n            $user = Auth::user();\n\n            if ($user && $user->phone_number) {\n\n                //dd('SMS code reached', $user->phone_number);\n                \n                $number = $user->phone_number;\n                $message = 'Test SMS: A new event was published!';\n\n                SMSService::send($number, $message);\n            }\n\n            return redirect()->back()->with('success', 'Initiative/Event Added!');\n        }catch(\\Exception $error){\n            Log::error('Event Creation Error: ' . $error->getMessage());\n            return redirect()->back()->with('error', 'Something went wrong while creating initiative/event.');\n        }\n    }\n\n    //function to show specific data viewed in training\n    public function viewTrainingDetails($id){\n        $training = Training::with(['sector', 'documents', 'participants'])->findOrFail($id);\n        $isFinished = now()->greaterThan($training->date);\n        $sectors = Sector::all();      \n        $participants = Participant::all();\n\n        return view('swisa-admin.view-training', compact('training', 'sectors', 'participants', 'isFinished'));\n    }\n\n    //function to edit info of the grant\n    public function editTrainingInfo(Request $request, $id){\n        \n        try{\n            // validate the form data/input\n            $request->validate([\n                'event_name' => 'required|string|max:255',\n                'sector' => 'required|exists:sectors,id',\n                'description' => 'nullable|string',\n                'venue' => 'required|string|max:255',\n                'date' => 'required|date',\n                'time' => 'required|date_format:H:i',\n            ]);\n\n            $training = Training::findOrFail($id);\n\n            //store to table 'grants'\n            $training->update([\n                'title' => $request->event_name,\n                'sector_id' => $request->sector,\n                'description'   => $request->description,\n                'venue' => $request->venue,\n                'date' => $request->date,\n                'time' => $request->time,\n            ]);\n\n            //handle the file upload\n            if ($request->hasFile('event_image')) {\n                $file = $request->file('event_image');\n                $path = $file->store('events', 'public'); // saves in storage/app/public/grants\n\n                // replace old file if new file is inputed\n                $training->documents()->delete();\n\n                $training->documents()->create([\n                    'file_path'  => $path,\n                    'file_name'  => $file->getClientOriginalName(), //gets the file name (e.g. docs.jpg)\n                ]);\n            }\n\n            // Attach requirements (if any selected)\n            if ($request->has('requirements')) {\n                $training->requirements()->sync($request->requirements); //syncs to the pivot table 'grant_requirements'\n            }\n\n            return redirect()->back()->with('success', 'Training Updated!');\n        }catch(\\Exception $error){\n            Log::error('Event Update Error: ' . $error->getMessage());\n            return redirect()->back()->with('error', 'Something went wrong while updating initiative/event.');\n        }\n    }\n\n     //delete Training\n    public function deleteTraining($id){\n        try{\n            $training = Training::findOrFail($id);\n\n            $training->delete();\n\n            return redirect()->route('training-workshop')->with('success', 'Training Deleted!');\n        }catch(\\Exception $error){\n            Log::error('Event Deletion Error: ' . $error->getMessage());\n            return redirect()->back()->with('error', 'Something went wrong while deleting initiative/event.');\n        }\n    }\n}\n"
        }
    ]
}
{
    "sourceFile": "app/Http/Controllers/AttendanceController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 13,
            "patches": [
                {
                    "date": 1763840436157,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764007080261,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,28 +8,36 @@\n \r\n class AttendanceController extends Controller\r\n {\r\n     // Route: /scan-qr-user/{qr_code}\r\n-    public function scanQr($qr_code)\r\n-    {\r\n-        // Find user by QR code\r\n-        $user = UserInfo::where('qr_code', $qr_code)->first();\r\n+public function scanQr($qr_code)\r\n+{\r\n+    // Find user info by QR code\r\n+    $userInfo = UserInfo::where('qr_code', $qr_code)->first();\r\n \r\n-        if (!$user) {\r\n-            return response()->json(['success' => false, 'message' => 'User not found.']);\r\n-        }\r\n+    if (!$userInfo) {\r\n+        return response()->json(['success' => false, 'message' => 'User not found.']);\r\n+    }\r\n \r\n-        // Check if user is in participants table\r\n-        $participant = Participant::where('user_id', $user->user_id)->first();\r\n+    // Get the related user\r\n+    $user = $userInfo->user; // assumes UserInfo has a belongsTo(User::class) relationship\r\n \r\n-        if (!$participant) {\r\n-            return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n-        }\r\n+    if (!$user) {\r\n+        return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n+    }\r\n \r\n-        // Return user details\r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'member_id' => $user->user_id,\r\n-            'name' => $user->fname . ' ' . $user->lname\r\n-        ]);\r\n+    // Check if user is in participants table\r\n+    $participant = Participant::where('user_id', $user->id)->first();\r\n+\r\n+    if (!$participant) {\r\n+        return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n     }\r\n+\r\n+    // Return user details including formatted ID\r\n+    return response()->json([\r\n+        'success' => true,\r\n+        'member_id' => $user->formatted_id, // ✅ Use accessor here\r\n+        'name' => $user->first_name . ' ' . $user->last_name\r\n+    ]);\r\n }\r\n+\r\n+}\r\n"
                },
                {
                    "date": 1764007282348,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,27 +17,36 @@\n     if (!$userInfo) {\r\n         return response()->json(['success' => false, 'message' => 'User not found.']);\r\n     }\r\n \r\n-    // Get the related user\r\n-    $user = $userInfo->user; // assumes UserInfo has a belongsTo(User::class) relationship\r\n+    // Get the related User\r\n+    $user = $userInfo->user; // Make sure UserInfo has a belongsTo(User::class) relation\r\n \r\n     if (!$user) {\r\n         return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n     }\r\n \r\n-    // Check if user is in participants table\r\n-    $participant = Participant::where('user_id', $user->id)->first();\r\n+    // Find participant record\r\n+    $participant = Participant::where('user_id', $user->id)\r\n+                    ->where('training_id', request()->get('training_id')) // optional if you want to specify the training\r\n+                    ->first();\r\n \r\n     if (!$participant) {\r\n         return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n     }\r\n \r\n-    // Return user details including formatted ID\r\n+    // Update participant to mark QR scanned and check-in time\r\n+    $participant->qr_scanned = 1;\r\n+    $participant->check_in_at = now();\r\n+    $participant->save();\r\n+\r\n+    // Return success with user info\r\n     return response()->json([\r\n         'success' => true,\r\n-        'member_id' => $user->formatted_id, // ✅ Use accessor here\r\n-        'name' => $user->first_name . ' ' . $user->last_name\r\n+        'member_id' => $user->formatted_id,\r\n+        'name' => $user->first_name . ' ' . $user->last_name,\r\n+        'check_in_at' => $participant->check_in_at->format('F d, Y g:i A')\r\n     ]);\r\n }\r\n \r\n+\r\n }\r\n"
                },
                {
                    "date": 1764007314520,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,36 +17,27 @@\n     if (!$userInfo) {\r\n         return response()->json(['success' => false, 'message' => 'User not found.']);\r\n     }\r\n \r\n-    // Get the related User\r\n-    $user = $userInfo->user; // Make sure UserInfo has a belongsTo(User::class) relation\r\n+    // Get the related user\r\n+    $user = $userInfo->user; // assumes UserInfo has a belongsTo(User::class) relationship\r\n \r\n     if (!$user) {\r\n         return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n     }\r\n \r\n-    // Find participant record\r\n-    $participant = Participant::where('user_id', $user->id)\r\n-                    ->where('training_id', request()->get('training_id')) // optional if you want to specify the training\r\n-                    ->first();\r\n+    // Check if user is in participants table\r\n+    $participant = Participant::where('user_id', $user->id)->first();\r\n \r\n     if (!$participant) {\r\n         return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n     }\r\n \r\n-    // Update participant to mark QR scanned and check-in time\r\n-    $participant->qr_scanned = 1;\r\n-    $participant->check_in_at = now();\r\n-    $participant->save();\r\n-\r\n-    // Return success with user info\r\n+    // Return user details including formatted ID\r\n     return response()->json([\r\n         'success' => true,\r\n-        'member_id' => $user->formatted_id,\r\n-        'name' => $user->first_name . ' ' . $user->last_name,\r\n-        'check_in_at' => $participant->check_in_at->format('F d, Y g:i A')\r\n+        'member_id' => $user->formatted_id, // ✅ Use accessor here\r\n+        'name' => $user->first_name . ' ' . $user->last_name\r\n     ]);\r\n }\r\n \r\n-\r\n }\r\n"
                },
                {
                    "date": 1764007382486,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,5 +39,46 @@\n         'name' => $user->first_name . ' ' . $user->last_name\r\n     ]);\r\n }\r\n \r\n+public function markAttendance($qr_code)\r\n+{\r\n+    // Find user info by QR code\r\n+    $userInfo = UserInfo::where('qr_code', $qr_code)->first();\r\n+\r\n+    if (!$userInfo) {\r\n+        return response()->json(['success' => false, 'message' => 'User not found.']);\r\n+    }\r\n+\r\n+    // Get the related user\r\n+    $user = $userInfo->user;\r\n+\r\n+    if (!$user) {\r\n+        return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n+    }\r\n+\r\n+    // Find participant record for this training (you need training_id in request or decoded from QR)\r\n+    $participant = Participant::where('user_id', $user->id)\r\n+                              ->where('training_id', session('current_training_id')) // example: set current training\r\n+                              ->first();\r\n+\r\n+    if (!$participant) {\r\n+        return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n+    }\r\n+\r\n+    // Update attendance\r\n+    $participant->update([\r\n+        'qr_scanned' => 1,\r\n+        'check_in_at' => now(),\r\n+    ]);\r\n+\r\n+    return response()->json([\r\n+        'success' => true,\r\n+        'message' => 'Attendance recorded successfully!',\r\n+        'member_id' => $user->formatted_id,\r\n+        'name' => $user->first_name . ' ' . $user->last_name,\r\n+        'check_in_at' => $participant->check_in_at->format('F d, Y g:i A')\r\n+    ]);\r\n }\r\n+\r\n+\r\n+}\r\n"
                },
                {
                    "date": 1764007455618,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,46 +39,7 @@\n         'name' => $user->first_name . ' ' . $user->last_name\r\n     ]);\r\n }\r\n \r\n-public function markAttendance($qr_code)\r\n-{\r\n-    // Find user info by QR code\r\n-    $userInfo = UserInfo::where('qr_code', $qr_code)->first();\r\n \r\n-    if (!$userInfo) {\r\n-        return response()->json(['success' => false, 'message' => 'User not found.']);\r\n-    }\r\n \r\n-    // Get the related user\r\n-    $user = $userInfo->user;\r\n-\r\n-    if (!$user) {\r\n-        return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n-    }\r\n-\r\n-    // Find participant record for this training (you need training_id in request or decoded from QR)\r\n-    $participant = Participant::where('user_id', $user->id)\r\n-                              ->where('training_id', session('current_training_id')) // example: set current training\r\n-                              ->first();\r\n-\r\n-    if (!$participant) {\r\n-        return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n-    }\r\n-\r\n-    // Update attendance\r\n-    $participant->update([\r\n-        'qr_scanned' => 1,\r\n-        'check_in_at' => now(),\r\n-    ]);\r\n-\r\n-    return response()->json([\r\n-        'success' => true,\r\n-        'message' => 'Attendance recorded successfully!',\r\n-        'member_id' => $user->formatted_id,\r\n-        'name' => $user->first_name . ' ' . $user->last_name,\r\n-        'check_in_at' => $participant->check_in_at->format('F d, Y g:i A')\r\n-    ]);\r\n }\r\n-\r\n-\r\n-}\r\n"
                },
                {
                    "date": 1764007613879,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,45 +1,46 @@\n <?php\r\n \r\n-namespace App\\Http\\Controllers;\r\n-\r\n-use Illuminate\\Http\\Request;\r\n+use Illuminate\\Support\\Carbon;\r\n+use App\\Models\\Participant;\r\n use App\\Models\\UserInfo;\r\n-use App\\Models\\Participant;\r\n \r\n-class AttendanceController extends Controller\r\n+public function scanQr($qr_code, $training_id)\r\n {\r\n-    // Route: /scan-qr-user/{qr_code}\r\n-public function scanQr($qr_code)\r\n-{\r\n-    // Find user info by QR code\r\n+    // 1. Find user info by QR code\r\n     $userInfo = UserInfo::where('qr_code', $qr_code)->first();\r\n \r\n     if (!$userInfo) {\r\n         return response()->json(['success' => false, 'message' => 'User not found.']);\r\n     }\r\n \r\n-    // Get the related user\r\n-    $user = $userInfo->user; // assumes UserInfo has a belongsTo(User::class) relationship\r\n+    // 2. Get the related user\r\n+    $user = $userInfo->user;\r\n \r\n     if (!$user) {\r\n         return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n     }\r\n \r\n-    // Check if user is in participants table\r\n-    $participant = Participant::where('user_id', $user->id)->first();\r\n+    // 3. Find participant record for this training\r\n+    $participant = Participant::where('user_id', $user->id)\r\n+        ->where('training_id', $training_id)\r\n+        ->first();\r\n \r\n     if (!$participant) {\r\n         return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n     }\r\n \r\n-    // Return user details including formatted ID\r\n+    // 4. Update participant: set qr_scanned = 1 and check_in_at = current timestamp\r\n+    $participant->update([\r\n+        'qr_scanned' => 1,\r\n+        'check_in_at' => Carbon::now(),\r\n+    ]);\r\n+\r\n+    // 5. Return success\r\n     return response()->json([\r\n         'success' => true,\r\n-        'member_id' => $user->formatted_id, // ✅ Use accessor here\r\n-        'name' => $user->first_name . ' ' . $user->last_name\r\n+        'member_id' => $user->formatted_id,\r\n+        'name' => $user->first_name . ' ' . $user->last_name,\r\n+        'message' => 'QR scanned and attendance recorded successfully.'\r\n     ]);\r\n }\r\n \r\n-\r\n-\r\n-}\r\n"
                },
                {
                    "date": 1764007888063,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,44 +3,33 @@\n use Illuminate\\Support\\Carbon;\r\n use App\\Models\\Participant;\r\n use App\\Models\\UserInfo;\r\n \r\n-public function scanQr($qr_code, $training_id)\r\n+public function scanQr($qr_code)\r\n {\r\n-    // 1. Find user info by QR code\r\n-    $userInfo = UserInfo::where('qr_code', $qr_code)->first();\r\n+    try {\r\n+        $user = UserInfo::where('qr_code', $qr_code)->first();\r\n \r\n-    if (!$userInfo) {\r\n-        return response()->json(['success' => false, 'message' => 'User not found.']);\r\n-    }\r\n+        if (!$user) {\r\n+            return response()->json(['success' => false, 'message' => 'User not found.']);\r\n+        }\r\n \r\n-    // 2. Get the related user\r\n-    $user = $userInfo->user;\r\n+        $participant = Participant::where('user_id', $user->user_id)->first();\r\n \r\n-    if (!$user) {\r\n-        return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n-    }\r\n+        if (!$participant) {\r\n+            return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n+        }\r\n \r\n-    // 3. Find participant record for this training\r\n-    $participant = Participant::where('user_id', $user->id)\r\n-        ->where('training_id', $training_id)\r\n-        ->first();\r\n-\r\n-    if (!$participant) {\r\n-        return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'member_id' => $user->user->formatted_id ?? $user->user_id,\r\n+            'name' => $user->fname . ' ' . $user->lname\r\n+        ]);\r\n+    } catch (\\Exception $e) {\r\n+        // Always return JSON even on error\r\n+        return response()->json([\r\n+            'success' => false,\r\n+            'message' => 'Server error: ' . $e->getMessage()\r\n+        ]);\r\n     }\r\n-\r\n-    // 4. Update participant: set qr_scanned = 1 and check_in_at = current timestamp\r\n-    $participant->update([\r\n-        'qr_scanned' => 1,\r\n-        'check_in_at' => Carbon::now(),\r\n-    ]);\r\n-\r\n-    // 5. Return success\r\n-    return response()->json([\r\n-        'success' => true,\r\n-        'member_id' => $user->formatted_id,\r\n-        'name' => $user->first_name . ' ' . $user->last_name,\r\n-        'message' => 'QR scanned and attendance recorded successfully.'\r\n-    ]);\r\n }\r\n \r\n"
                },
                {
                    "date": 1764007918014,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,35 +1,43 @@\n <?php\r\n \r\n-use Illuminate\\Support\\Carbon;\r\n+namespace App\\Http\\Controllers;\r\n+\r\n+use Illuminate\\Http\\Request;\r\n+use App\\Models\\UserInfo;\r\n use App\\Models\\Participant;\r\n-use App\\Models\\UserInfo;\r\n \r\n+class AttendanceController extends Controller\r\n+{\r\n+    // Route: /scan-qr-user/{qr_code}\r\n public function scanQr($qr_code)\r\n {\r\n-    try {\r\n-        $user = UserInfo::where('qr_code', $qr_code)->first();\r\n+    // Find user info by QR code\r\n+    $userInfo = UserInfo::where('qr_code', $qr_code)->first();\r\n \r\n-        if (!$user) {\r\n-            return response()->json(['success' => false, 'message' => 'User not found.']);\r\n-        }\r\n+    if (!$userInfo) {\r\n+        return response()->json(['success' => false, 'message' => 'User not found.']);\r\n+    }\r\n \r\n-        $participant = Participant::where('user_id', $user->user_id)->first();\r\n+    // Get the related user\r\n+    $user = $userInfo->user; // assumes UserInfo has a belongsTo(User::class) relationship\r\n \r\n-        if (!$participant) {\r\n-            return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n-        }\r\n+    if (!$user) {\r\n+        return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n+    }\r\n \r\n-        return response()->json([\r\n-            'success' => true,\r\n-            'member_id' => $user->user->formatted_id ?? $user->user_id,\r\n-            'name' => $user->fname . ' ' . $user->lname\r\n-        ]);\r\n-    } catch (\\Exception $e) {\r\n-        // Always return JSON even on error\r\n-        return response()->json([\r\n-            'success' => false,\r\n-            'message' => 'Server error: ' . $e->getMessage()\r\n-        ]);\r\n+    // Check if user is in participants table\r\n+    $participant = Participant::where('user_id', $user->id)->first();\r\n+\r\n+    if (!$participant) {\r\n+        return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n     }\r\n+\r\n+    // Return user details including formatted ID\r\n+    return response()->json([\r\n+        'success' => true,\r\n+        'member_id' => $user->formatted_id, // ✅ Use accessor here\r\n+        'name' => $user->first_name . ' ' . $user->last_name\r\n+    ]);\r\n }\r\n \r\n+}\r\n"
                },
                {
                    "date": 1764007939087,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,36 +8,28 @@\n \r\n class AttendanceController extends Controller\r\n {\r\n     // Route: /scan-qr-user/{qr_code}\r\n-public function scanQr($qr_code)\r\n-{\r\n-    // Find user info by QR code\r\n-    $userInfo = UserInfo::where('qr_code', $qr_code)->first();\r\n+    public function scanQr($qr_code)\r\n+    {\r\n+        // Find user by QR code\r\n+        $user = UserInfo::where('qr_code', $qr_code)->first();\r\n \r\n-    if (!$userInfo) {\r\n-        return response()->json(['success' => false, 'message' => 'User not found.']);\r\n-    }\r\n+        if (!$user) {\r\n+            return response()->json(['success' => false, 'message' => 'User not found.']);\r\n+        }\r\n \r\n-    // Get the related user\r\n-    $user = $userInfo->user; // assumes UserInfo has a belongsTo(User::class) relationship\r\n+        // Check if user is in participants table\r\n+        $participant = Participant::where('user_id', $user->user_id)->first();\r\n \r\n-    if (!$user) {\r\n-        return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n-    }\r\n+        if (!$participant) {\r\n+            return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n+        }\r\n \r\n-    // Check if user is in participants table\r\n-    $participant = Participant::where('user_id', $user->id)->first();\r\n-\r\n-    if (!$participant) {\r\n-        return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n+        // Return user details\r\n+        return response()->json([\r\n+            'success' => true,\r\n+            'member_id' => $user->user_id,\r\n+            'name' => $user->fname . ' ' . $user->lname\r\n+        ]);\r\n     }\r\n-\r\n-    // Return user details including formatted ID\r\n-    return response()->json([\r\n-        'success' => true,\r\n-        'member_id' => $user->formatted_id, // ✅ Use accessor here\r\n-        'name' => $user->first_name . ' ' . $user->last_name\r\n-    ]);\r\n }\r\n-\r\n-}\r\n"
                },
                {
                    "date": 1764008133392,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,32 +4,48 @@\n \r\n use Illuminate\\Http\\Request;\r\n use App\\Models\\UserInfo;\r\n use App\\Models\\Participant;\r\n+use Carbon\\Carbon;\r\n \r\n class AttendanceController extends Controller\r\n {\r\n     // Route: /scan-qr-user/{qr_code}\r\n     public function scanQr($qr_code)\r\n     {\r\n         // Find user by QR code\r\n-        $user = UserInfo::where('qr_code', $qr_code)->first();\r\n+        $userInfo = UserInfo::where('qr_code', $qr_code)->first();\r\n \r\n-        if (!$user) {\r\n+        if (!$userInfo) {\r\n             return response()->json(['success' => false, 'message' => 'User not found.']);\r\n         }\r\n \r\n-        // Check if user is in participants table\r\n-        $participant = Participant::where('user_id', $user->user_id)->first();\r\n+        // Get related user\r\n+        $user = $userInfo->user; // assuming UserInfo belongsTo User\r\n \r\n+        if (!$user) {\r\n+            return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n+        }\r\n+\r\n+        // Find participant record\r\n+        $participant = Participant::where('user_id', $user->id)\r\n+                                  ->where('training_id', request()->get('training_id')) // optional if multiple trainings\r\n+                                  ->first();\r\n+\r\n         if (!$participant) {\r\n             return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n         }\r\n \r\n-        // Return user details\r\n+        // Update participant: mark QR scanned and timestamp check-in\r\n+        $participant->qr_scanned = 1;\r\n+        $participant->check_in_at = Carbon::now();\r\n+        $participant->save();\r\n+\r\n+        // Return response with formatted ID\r\n         return response()->json([\r\n             'success' => true,\r\n-            'member_id' => $user->user_id,\r\n-            'name' => $user->fname . ' ' . $user->lname\r\n+            'member_id' => $user->formatted_id, // show MEM-000123\r\n+            'name' => $user->first_name . ' ' . $user->last_name,\r\n+            'message' => 'Attendance successfully recorded!'\r\n         ]);\r\n     }\r\n }\r\n"
                },
                {
                    "date": 1764008365954,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,44 +8,40 @@\n use Carbon\\Carbon;\r\n \r\n class AttendanceController extends Controller\r\n {\r\n-    // Route: /scan-qr-user/{qr_code}\r\n-    public function scanQr($qr_code)\r\n+    // Route: /scan-qr-user/{qr_code}?training_id=...\r\n+    public function scanQr($qr_code, Request $request)\r\n     {\r\n+        // Optional: training_id from query string\r\n+        $trainingId = $request->query('training_id');\r\n+\r\n         // Find user by QR code\r\n-        $userInfo = UserInfo::where('qr_code', $qr_code)->first();\r\n-\r\n-        if (!$userInfo) {\r\n+        $user = UserInfo::where('qr_code', $qr_code)->first();\r\n+        if (!$user) {\r\n             return response()->json(['success' => false, 'message' => 'User not found.']);\r\n         }\r\n \r\n-        // Get related user\r\n-        $user = $userInfo->user; // assuming UserInfo belongsTo User\r\n-\r\n-        if (!$user) {\r\n-            return response()->json(['success' => false, 'message' => 'User record not found.']);\r\n+        // Find participant\r\n+        $participantQuery = Participant::where('user_id', $user->user_id);\r\n+        if ($trainingId) {\r\n+            $participantQuery->where('training_id', $trainingId);\r\n         }\r\n+        $participant = $participantQuery->first();\r\n \r\n-        // Find participant record\r\n-        $participant = Participant::where('user_id', $user->id)\r\n-                                  ->where('training_id', request()->get('training_id')) // optional if multiple trainings\r\n-                                  ->first();\r\n-\r\n         if (!$participant) {\r\n             return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n         }\r\n \r\n-        // Update participant: mark QR scanned and timestamp check-in\r\n+        // Update attendance\r\n         $participant->qr_scanned = 1;\r\n         $participant->check_in_at = Carbon::now();\r\n         $participant->save();\r\n \r\n-        // Return response with formatted ID\r\n+        // Return user info\r\n         return response()->json([\r\n             'success' => true,\r\n-            'member_id' => $user->formatted_id, // show MEM-000123\r\n-            'name' => $user->first_name . ' ' . $user->last_name,\r\n-            'message' => 'Attendance successfully recorded!'\r\n+            'member_id' => $user->formatted_id, // uses accessor\r\n+            'name' => $user->fname . ' ' . $user->lname\r\n         ]);\r\n     }\r\n }\r\n"
                },
                {
                    "date": 1764008888069,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,44 +4,32 @@\n \r\n use Illuminate\\Http\\Request;\r\n use App\\Models\\UserInfo;\r\n use App\\Models\\Participant;\r\n-use Carbon\\Carbon;\r\n \r\n class AttendanceController extends Controller\r\n {\r\n-    // Route: /scan-qr-user/{qr_code}?training_id=...\r\n-    public function scanQr($qr_code, Request $request)\r\n+    // Route: /scan-qr-user/{qr_code}\r\n+    public function scanQr($qr_code)\r\n     {\r\n-        // Optional: training_id from query string\r\n-        $trainingId = $request->query('training_id');\r\n-\r\n         // Find user by QR code\r\n         $user = UserInfo::where('qr_code', $qr_code)->first();\r\n+\r\n         if (!$user) {\r\n             return response()->json(['success' => false, 'message' => 'User not found.']);\r\n         }\r\n \r\n-        // Find participant\r\n-        $participantQuery = Participant::where('user_id', $user->user_id);\r\n-        if ($trainingId) {\r\n-            $participantQuery->where('training_id', $trainingId);\r\n-        }\r\n-        $participant = $participantQuery->first();\r\n+        // Check if user is in participants table\r\n+        $participant = Participant::where('user_id', $user->user_id)->first();\r\n \r\n         if (!$participant) {\r\n             return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n         }\r\n \r\n-        // Update attendance\r\n-        $participant->qr_scanned = 1;\r\n-        $participant->check_in_at = Carbon::now();\r\n-        $participant->save();\r\n-\r\n-        // Return user info\r\n+        // Return user details\r\n         return response()->json([\r\n             'success' => true,\r\n-            'member_id' => $user->formatted_id, // uses accessor\r\n+            'member_id' => $user->user_id,\r\n             'name' => $user->fname . ' ' . $user->lname\r\n         ]);\r\n     }\r\n }\r\n"
                },
                {
                    "date": 1764009000893,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,32 +4,61 @@\n \r\n use Illuminate\\Http\\Request;\r\n use App\\Models\\UserInfo;\r\n use App\\Models\\Participant;\r\n+use Carbon\\Carbon;\r\n \r\n class AttendanceController extends Controller\r\n {\r\n-    // Route: /scan-qr-user/{qr_code}\r\n-    public function scanQr($qr_code)\r\n+    public function scanQr(Request $request, $qr_code)\r\n     {\r\n-        // Find user by QR code\r\n+        $trainingId = $request->training_id;\r\n+\r\n+        // 1. FIND USER\r\n         $user = UserInfo::where('qr_code', $qr_code)->first();\r\n \r\n         if (!$user) {\r\n-            return response()->json(['success' => false, 'message' => 'User not found.']);\r\n+            return response()->json([\r\n+                'success' => false,\r\n+                'message' => 'User not found.'\r\n+            ]);\r\n         }\r\n \r\n-        // Check if user is in participants table\r\n-        $participant = Participant::where('user_id', $user->user_id)->first();\r\n+        // 2. FIND PARTICIPANT ENTRY\r\n+        $participant = Participant::where([\r\n+            'training_id' => $trainingId,\r\n+            'user_id'     => $user->user_id\r\n+        ])->first();\r\n \r\n         if (!$participant) {\r\n-            return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n+            return response()->json([\r\n+                'success' => false,\r\n+                'message' => 'User is not registered for this training.'\r\n+            ]);\r\n         }\r\n \r\n-        // Return user details\r\n+        // 3. CHECK IF ALREADY SCANNED\r\n+        if ($participant->qr_scanned == 1) {\r\n+            return response()->json([\r\n+                'success' => true,\r\n+                'already_scanned' => true,\r\n+                'member_id' => $user->user_id,\r\n+                'name' => $user->fname . ' ' . $user->lname,\r\n+                'message' => 'User already checked in.'\r\n+            ]);\r\n+        }\r\n+\r\n+        // 4. UPDATE SCAN STATUS\r\n+        $participant->qr_scanned = 1;\r\n+        $participant->check_in_at = Carbon::now();\r\n+        $participant->save();\r\n+\r\n+        // 5. RETURN SUCCESS\r\n         return response()->json([\r\n             'success' => true,\r\n+            'already_scanned' => false,\r\n             'member_id' => $user->user_id,\r\n-            'name' => $user->fname . ' ' . $user->lname\r\n+            'name' => $user->fname . ' ' . $user->lname,\r\n+            'message' => 'Attendance recorded successfully!'\r\n         ]);\r\n     }\r\n }\r\n"
                }
            ],
            "date": 1763840436157,
            "name": "Commit-0",
            "content": "<?php\r\n\r\nnamespace App\\Http\\Controllers;\r\n\r\nuse Illuminate\\Http\\Request;\r\nuse App\\Models\\UserInfo;\r\nuse App\\Models\\Participant;\r\n\r\nclass AttendanceController extends Controller\r\n{\r\n    // Route: /scan-qr-user/{qr_code}\r\n    public function scanQr($qr_code)\r\n    {\r\n        // Find user by QR code\r\n        $user = UserInfo::where('qr_code', $qr_code)->first();\r\n\r\n        if (!$user) {\r\n            return response()->json(['success' => false, 'message' => 'User not found.']);\r\n        }\r\n\r\n        // Check if user is in participants table\r\n        $participant = Participant::where('user_id', $user->user_id)->first();\r\n\r\n        if (!$participant) {\r\n            return response()->json(['success' => false, 'message' => 'User not registered as participant.']);\r\n        }\r\n\r\n        // Return user details\r\n        return response()->json([\r\n            'success' => true,\r\n            'member_id' => $user->user_id,\r\n            'name' => $user->fname . ' ' . $user->lname\r\n        ]);\r\n    }\r\n}\r\n"
        }
    ]
}